/**
 * @author : bo.hu@opi-corp.com
 *
 * 解释 ： emoticon 是由 emotion 与 icon拼合成的名词
 *
 * 表情控件
 *
 * ********************************************************
 *
 * 使用说明：
 *
 * ********************************************************
 *
 *  @require  
 *    http://s.xnimg.cn/csspro/module/minieditor.css
 *  
 *  最简使用
 *  new XN.ui.emoticons({
 *    input :$('cmtbody'), //必需，参数
 *    button:$('emoBtn'), //必需，点击显示表情弹层按钮 
 *  });
 *
 *  参数说明:
 *     必需参数:
 *       input //表情UBB要插入的地方
 *       button //触发表情弹层的元素，接受HTMLElement 或者 元素的ID
 *
 *    可选参数:
 *       //获取表情的地址，默认地址会显示三组表情
 *       url : 'http://status.' + XN.env.domain + '/getubblist.do?type=2'
 *
 *              //这个地址显示与publisher一样的表情,带各种活动表情
 *              http://status.renren.com/getdoingubblist.do
 *
 *              //这个地址只显示小贴表情
 *              http://status.renren.com/getubblist.do?type=5
 *
 *       keepShow: true, // 选择表情后是否关闭表情框
 *       emoPopDelay: 0, // 延时多久出现弹出，一般用来兼容动画效果，保证动画效果后再出现。
 *
 *       emoPopFixed : false, //表情弹层是否是固定定位
 *
 *       btnAlignWith : null, // 弹层对齐的元素
 *       btnAlignType:'3-2', // 弹层对齐类型
 *       btnOffsetX:0, //弹层在使用上面的对齐类型与对齐元素位置的基础上的X方向的偏移
 *       btnOffsetY:-1, //弹层在使用上面的对齐类型与对齐元素位置的基础上的Y方向的偏移 
 *       
 *       onShowEmoPop : XN.func.empty, //表情弹层展示时回调
 *       onEmoTabSwitch : XN.func.empty, //Tab切换时回调
 *       onEmoTabClick : XN.func.empty, //Tab点击时回调
 *       onEmoConClick : XN.func.empty, //表情区域点击时回调
 *       onEmoNotVip : XN.func.empty //非vip时提示
 *
 *    静态方法:
 *       window.getEmoticonsInstance( emoid ) 
 *       表情初始化后会在input上加上eicons_obj_id, 取到这个属性值后可以用这个方法取到表情实例
 *
 *    事件:
 *        renderEmotions  //分发所有表情渲染结束的事件
 *        tabSwitch       //切换表情时的事件，第一个参数为tab,第二个参数为emolist
          tabClick        //点击切换表情组Tab时的事件，第一个参数为tab,第二个参数为emolist 
 *        emoConClick     //表情点击的时候
 *        showNotVip      //非vip用户提示展示
 *	      hideEmoticons   //隐藏表情
 *	      showEmoticons   //显示表情弹层
 *
 *	  一个小例子:
 *	  在弹层展示的时候更改它的Y位置
 *
 *      new XN.ui.emoticons({
 *        input :$('cmtbody'),
 *        button:$('emoBtn'), 
 *        onShowEmoPop : function(){
 *           var emoCon = this.emotionsContainer;
 *           emoCon.setOffsetY( emoCon.offsetY + XN.event.scrollTop() ); 
 *         }
 *      });
 *
 *
 * TODO:
 * 可以使用享元模式优化一下性能
 */(function(){function e(){this._cache={}}function n(e){var t=function(t){return this instanceof arguments.callee?(this.config={},$extend(this.config,e),this.ID=XN.util.createObjID(),$extend(this.config,t),this.init()):new arguments.callee(t)};return $extend(t.prototype,{name:"",init:function(){},getConfig:function(e){return this.config[e]},setConfig:function(e,t){return this.config[e]=t,this},getId:function(e){return this.name+"_"+this.ID+"_"+e},getEl:function(e){return $(this.getId(e))}}),t}function r(e){var t=!1,n=$extend({},e),r=null,i;return e.waitTime&&e.onTimeout&&(t=!0,n.onSuccess=function(t){window.clearTimeout(i),e.onSuccess(t)},n.onError=function(t){window.clearTimeout(i),e.onError(t)},i=setTimeout(function(){e.onTimeout.call(r);try{r.abort()}catch(t){XN.log(t)}},e.waitTime)),r=new XN.net.xmlhttp(n),r}e.prototype={add:function(e,t){this._cache[e]=t},del:function(e){return delete this._cache[e],null},get:function(e){return this._cache[e]}};var t=function(e){var t=Object.prototype.toString.call(e).replace(/\[object ([^\]]*)\]/,"$1").toLowerCase();return t.indexOf("html")!=-1&&(t="element"),t},i=new e,s=new e;XN.ui.emotions=n({url:"http://status."+XN.env.domain+"/getubblist.do?type=1&t="+Math.random(),container:"",isShowVipEmos:!1,emoKind:{0:{name:"默认表情",forvip:0,active:1},1:{name:"阿狸",forvip:1},2:{name:"囧囧熊",forvip:1}},onParseEmo:function(e,t){XN.log(e)}}),$extend(XN.ui.emotions.prototype,{name:"emotions",emoList:[],init:function(){return this.getConfig("container").getAttribute("emo_obj_id")?s.get(this.getConfig("container").getAttribute("emo_obj_id")):(this.getEmotions(),this)},getEmotions:function(){var e=this,t=this.getConfig("url"),n=function(){XN.DO.showError("获取表情列表失败，请稍候重试")};if(i.get(t)&&i.get(t).ubbList&&i.get(t).ubbList.length>0)return e.buildPanelHtml(),!1;new r({url:t,method:"GET",onSuccess:function(n){window.setTimeout(function(){i.add(t,n.responseText),e.buildPanelHtml()},0)},onError:n,waitTime:5e3,onTimeout:n})},formatData:function(e){var t=$extend({},this.getConfig("emoKind")),n;for(var r in t)t[r].data=[];for(var i=0,s=e.length;i<s;i++)n=e[i],t[n.kind].data.push(n);for(var r in t)t[r].data.length||delete t[r];return t},getSingleEmoHtml:function(e,t){var n=XN.browser.IE6?" onmouseover=\"this.style.borderColor='#808080'\" onmouseout=\"this.style.borderColor='#B8D4E8'\"":"",r='<li title={{alt}} {{_ie6patch}}><img emosrc="http://a.xnimg.cn{{src}}" alt="{{alt}}" emotion="{{ubb}}" preview="{{preview}}" forvip="{{forvip}}" /></li>';e.preview=e.size==2?1:0,e.forvip=t.forvip?1:0,e._ie6patch=XN.browser.IE6?n:"",e.src=e.src||e.img;for(var i in e)r=r.replace(new RegExp("{{"+i+"}}","g"),e[i]);return r},buildPanelHtml:function(){var e=XN.json.parse(i.get(this.getConfig("url")));if(this.getConfig("allUbb")){this._buildAllUbb(e);return}e.emoKind&&(this.emoKind=e.emoKind),this.emoList=this.formatData(e.ubbList),this.config.isShowVipEmos=e.canParseVipEmos;var t=this.emoList,n=0,r=this,s=[],o=this.getConfig("emoKind"),u=[],a=[],f=0,l=null;for(var c in t){l=t[c],u.push('<ul class="emo-list" style="display:'+(l.active?"block":"none")+'" id="'+this.getId("emoList"+c)+'">'),f=0;while(l.data[f])u.push(this.getSingleEmoHtml(l.data[f],l)),f++;u.push("</ul>"),a.push('<li id="'+this.getId("emoTab"+c)+'"><a href="javascript:;" onfocus="this.blur()"> '+l.name+" </a></li>")}var h=['<div class="m-editor-emo-holder" id="'+this.getId("emoHolder")+'" style="padding:1px">','<div class="emo-header" id="'+this.getId("emoTabHolder")+'" style="display:none">','<ul class="emo-tab" id="'+this.getId("emoTab")+'">',a.join(""),"</ul>",'<div class="emo-tab-switch" id="'+this.getId("emoTabSwitch")+'" style="display:none">','<a href="javascript:;" title="前一组表情" class="left" id="'+this.getId("movLeft")+'" ><span ></span></a>','<a href="javascript:;" title="后一组表情" class="right" id="'+this.getId("movRight")+'" ><span ></span></a>',"</div>","</div>",'<div class="emo-holder" id="'+this.getId("emoList")+'">',u.join(""),"</div>",'<div class="notVip-tip clearfix" id="'+this.getId("notVipTip")+'" style="display:none;">','<div class="emotion-icon">','   <img src="http://xnimg.cn/imgpro/icons/grade/cjbq.png"  />',"	<p>超级表情</p>","</div>",'<p>对不起，该功能需要<span class="red">等级9级以上</span>或者<span class="red">开通VIP</span>才可以使用。</p>','	<p class="btn">','	<a href="http://i.renren.com/pay/pre?wc=370000" class="join-vip" target="_blank"></a>','	<a href="http://sc.renren.com/scores/myscore" class="lookup-class" target="_blank"></a>或',"</p>","</div>","</div>"].join("");this.getConfig("container").setContent(h),this.cacheEls(),this.showFirstGroupEmos(),setTimeout(function(){r.renderTabs(),r.fireEvent("renderEmotions")},0)},_buildAllUbb:function(e){var t=e.ubbArr,n=this,r=[],i=[],s=0,o=null,u;XN.array.each(t,function(e,n){n.name==="默认表情"&&(t.splice(e,1),t.unshift(n))}),this.emoList=t;for(var a=0;a<t.length;a++){o=t[a];if(/^辣辣|花叔|蛋仔|Z先森$/.test(o.name)){t.splice(a--,1);continue}u=a==0?"":"emo-list-super",r.push('<ul class="emo-list '+u+'" style="display:'+(a==0?"block":"none")+'" id="'+this.getId("emoList"+a)+'">'),s=0;while(o.emolist[s])r.push(this.getSingleEmoHtml(o.emolist[s],o)),s++;r.push("</ul>"),i.push('<li id="'+this.getId("emoTab"+a)+'"><a href="javascript:;" onfocus="this.blur()">'+o.name+"</a></li>")}t[0].active=!0;var f=['<div class="m-editor-emo-holder super-emo-holder" id="'+this.getId("emoHolder")+'" style="padding:1px">','<div class="emo-header" id="'+this.getId("emoTabHolder")+'" style="display:none">','<ul class="emo-tab" id="'+this.getId("emoTab")+'">',i.join(""),"</ul>","</div>",'<div class="emo-tab-switch" id="'+this.getId("emoTabSwitch")+'" style="display:none">','<a href="javascript:;" title="前一组表情" class="left" id="'+this.getId("movLeft")+'" ><span ></span></a>','<a href="javascript:;" title="后一组表情" class="right" id="'+this.getId("movRight")+'" ><span ></span></a>',"</div>",'<div class="emo-holder" id="'+this.getId("emoList")+'">',r.join(""),"</div>",'<div class="notVip-tip clearfix" id="'+this.getId("notVipTip")+'" style="display:none;">','<div class="emotion-icon">','   <img src="http://xnimg.cn/imgpro/icons/grade/cjbq.png"  />',"  <p>超级表情</p>","</div>",'<p>对不起，该功能需要<span class="red">等级9级以上</span>或者<span class="red">开通VIP</span>才可以使用。</p>','  <p class="btn">','  <a href="http://i.renren.com/pay/pre?wc=370000" class="join-vip" target="_blank"></a>','  <a href="http://sc.renren.com/scores/myscore" class="lookup-class" target="_blank"></a>或',"</p>","</div>","</div>"].join("");this.getConfig("container").setContent(f),this.cacheEls(),this.showFirstGroupEmos(),n.fireEvent("renderEmotions"),setTimeout(function(){n.renderTabs()},1)},renderTabs:function(){var e=0,t=this.tabView=new XN.ui.tabView({activeClass:"current"}),n="",r=this;if(this.emoList.length)for(var i=0;i<this.emoList.length;i++)t.addTab({label:r.getId("emoTab"+i),active:r.emoList[i].active,onActive:function(e){return function(){var n=t.getCurrentTab().label.id||t.getCurrentTab().label,i=$(r.getId("emoList"+e));r.curTab=e,i.show(),r.emoList.imgRended||(i.innerHTML=i.innerHTML.replace(/emosrc/g,"src"),r.emoList[e].imgRended=!0),$(n.replace("emoTab","emoList")).hide(),r._previewHolder&&r._previewHolder.hide(),r.hideNotVip(),r.fireEvent("tabSwitch",$(r.getId("emoTab"+e)),$(r.getId("emoList"+e)))}}(i),onClick:function(e){return function(){r.fireEvent("tabClick",$(r.getId("emoTab"+e)),$(r.getId("emoList"+e)))}}(i)}),e++;else for(var i in this.emoList)t.addTab({label:r.getId("emoTab"+i),active:r.emoList[i].active,onActive:function(e){return function(){var n=t.getCurrentTab().label.id||t.getCurrentTab().label,i=$(r.getId("emoList"+e));i.show(),r.emoList.imgRended||(i.innerHTML=i.innerHTML.replace(/emosrc/g,"src"),r.emoList[e].imgRended=!0),$(n.replace("emoTab","emoList")).hide(),r._previewHolder&&r._previewHolder.hide(),r.hideNotVip(),r.fireEvent("tabSwitch",$(r.getId("emoTab"+e)),$(r.getId("emoList"+e)))}}(i),onClick:function(e){return function(){r.fireEvent("tabClick",$(r.getId("emoTab"+e)),$(r.getId("emoList"+e)))}}(i)}),e++;this.uiEmoTabHolder[e>1?"show":"hide"](),e>0&&this.initTabSwitcher(),this._tabview=t},positiveClick:function(e,t){if(typeof e.click=="undefined"){if(document.createEvent){var n=document.createEvent("MouseEvents");n.initMouseEvent("click",e),e.dispatchEvent(n);return}}else e.click(t)},resetTabView:function(){var e=this._tabview.getCurrentTab();this.getEl("movLeft")&&(this.uiEmoTab.style.top=0,this.getEl("movLeft").getElementsByTagName("span")[0].style.borderRightColor="#ccc",this.getEl("movRight").getElementsByTagName("span")[0].style.borderLeftColor="#B8D4E8"),this.curTab=0,e!==this._tabview._tabs[0]&&(e.getEl("label")&&e.getEl("label").delClass(this._tabview.getConfig("activeClass")),e.content&&e.getEl("content").hide(),this._tabview._activeTab(this._tabview._tabs[0]),Sizzle("a",this.uiEmoTab)[0].click())},initTabSwitcher:function(){var e=!1,t=this;this.emoHolderInitX=this.getEl("emoTabHolder").realLeft(),this.emoHolderWidth=this.getEl("emoTabHolder").offsetWidth,this.emoHolderMaxX=this.emoHolderInitX+this.emoHolderWidth,this.tabArray=[],this.curTab=0;if(this.emoList.length)for(var n=0;n<this.emoList.length;n++)this.tabArray.push(n),this.tabArray.length>5&&(e=!0);else for(var n in this.emoList)this.tabArray.push(n),this.tabArray.length>5&&(e=!0);if(!e)return!1;this.getEl("emoTabSwitch").show(),XN.event.addEvent(t.getEl("movLeft"),"click",function(e){if(t.curTab<5)return;t.curTab-=5+t.curTab%5,t.curTab<5&&(this.getElementsByTagName("span")[0].style.borderRightColor="#CCC"),t.getEl("movRight").getElementsByTagName("span")[0].style.borderLeftColor="#B8D4E8";var n=$(t.getId("emoTab"+t.curTab));t.moveTab2(1),t.positiveClick(n)},2),XN.event.addEvent(t.getEl("movRight"),"click",function(e){var n=t.tabArray.length%5>0?t.tabArray.length%5:5;if(t.curTab>=t.tabArray.length-n)return;t.curTab+=5-t.curTab%5,t.curTab>=t.tabArray.length-n&&(this.getElementsByTagName("span")[0].style.borderLeftColor="#CCC"),t.getEl("movLeft").getElementsByTagName("span")[0].style.borderRightColor="#B8D4E8";var r=$(t.getId("emoTab"+t.curTab));t.moveTab2(-1),t.positiveClick(r)},2)},moveTab:function(e,t,n){var r=this.getEl("emoTab"+e).realLeft(),i=this.getEl("emoTab"+e).offsetWidth,s=0;s=this.emoHolderInitX-r,this.uiEmoTab.style.left=parseInt(XN.element.getStyle(this.uiEmoTab,"left")?XN.element.getStyle(this.uiEmoTab,"left"):0)+s+"px",this.tabView.setCurrentTab(this.getId("emoTab"+e))},moveTab2:function(e){var t=this.getEl("emoTab"+this.curTab).offsetHeight,n=parseInt(XN.element.getStyle(this.uiEmoTab,"top")?XN.element.getStyle(this.uiEmoTab,"top"):0);this.uiEmoTab.style.top=n+e*t+"px"},initEvent:function(){var e=this;object.use("dom",function(t){t.wrap(e.uiEmoHolder).addEvent("click",function(t){var n=t||window.event;e.parseEmotion(n),n.cancelBubbled?n.cancelBubbled=!0:n.stopPropagation()},2),e.uiEmoHolder.addEvent("mouseover",function(t){XN.event.stop(t||window.event),e.previewEmotion(t)},2),e.uiEmoHolder.addEvent("mouseout",function(t){e.hidePreviewEmotion(t)},2)})},parseEmotion:function(e){var t=XN.event.element(e),n=this,r=t.tagName.toLowerCase();this.fireEvent("emoConClick");if(!/li|img/.test(r))return!1;r=="li"&&(t=t.getElementsByTagName("img")[0]);if(!t)return!1;var i=parseInt(t.getAttribute("forvip")),s=t.getAttribute("emotion"),o=this.getConfig("isShowVipEmos"),u=$(t).parent("ul").hasClassName("emo-list-super");i&&!o?n.showNotVip(e):u?n.getConfig("onParseSuperEmo").call(n,{imgsrc:t.src,ubb:s,forvip:i},e):n.getConfig("onParseEmo").call(n,{imgsrc:t.src,ubb:s,forvip:i},e)},hide:function(){this.uiEmoHolder.hide(),this._previewHolder&&this._previewHolder.hide()},cacheEls:function(){this.uiEmoList=this.getEl("emoList"),this.uiEmoHolder=this.getEl("emoHolder"),this.uiEmoTabHolder=this.getEl("emoTabHolder"),this.uiEmoTab=this.getEl("emoTab"),this.uiNotVipTip=this.getEl("notVipTip")},showFirstGroupEmos:function(){var e=this,t;if(this.emoList.length)for(var n=0;n<this.emoList.length;n++)this.emoList[n].active&&(t=$(e.getId("emoList"+n)),t.innerHTML=t.innerHTML.replace(/emosrc/g,"src"));else for(var n in this.emoList)this.emoList[n].active&&(t=$(e.getId("emoList"+n)),t.innerHTML=t.innerHTML.replace(/emosrc/g,"src"));return this.uiEmoHolder.show(),this.initEvent(),!0},hideEmotion:function(){this._previewHolder&&this._previewHolder.hide(),this._emoHolder&&this._emoHolder.hide()},showNotVip:function(e){XN.event.stop(e||window.event),this.uiEmoList.hide(),this.uiNotVipTip.show(),this._previewHolder&&this._previewHolder.hide(),this.fireEvent("showNotVip")},hideNotVip:function(e){this.uiNotVipTip.hide(),this.uiEmoList.show()},previewEmotion:function(e){var t=XN.event.element(e),n=this,r=t.tagName.toLowerCase();r=="li"&&(t=t.getElementsByTagName("img")[0]);if(r!="li"&&r!="img")return this._previewHolder&&this._previewHolder.hide(),!1;if(!t)return!1;var i=parseInt(t.getAttribute("preview"));if(i){var s=this.config.container;if(!XN.element.hasClassName(s.parentNode,"emo-attach")){this._previewHolderAttach&&(this._previewHolderAttach.style.display="none");if(!this._previewHolder){var o=this._previewHolder=new XN.ui.fixPositionElement({alignWith:this.uiEmoList,tagName:"div",alignType:"2-2",offsetX:XN.browser.IE6?-1:XN.browser.IE?1:0,offsetY:XN.browser.IE?1:0});o.container.setStyle("background:#fff;padding:1px;width:50px;height:50px;border:1px solid #B8D4E8;"),o.container.className="meditor-emo-preview",o.container.id=this.getId("mEditorPreviewHolder"),o.setContent('<img id="'+this.getId("previewIMG")+'" class="m-editor-preview-img" src="'+t.src+'" />'),XN.event.addEvent(this.getEl("mEditorPreviewHolder"),"mouseover",function(){var e=o.alignType=="1-1"?"2-2":"1-1";if(XN.browser.IE6){var t=o.alignType=="1-1"?-1:1;o.setOffsetX(t)}o.setAlignType(e)},2)}this.getEl("previewIMG").src=t.src,this._previewHolder.show()}else{this._previewHolder&&this._previewHolder.hide();if(!this._previewHolderAttach){var o=this._previewHolderAttach=document.createElement("div");o.style.cssText="background:#fff;padding:1px;width:50px;height:50px;border:1px solid #B8D4E8;position:absolute;top:35px;",o.className="meditor-emo-preview",o.id=this.getId("mEditorPreviewHolder_attach"),o.innerHTML='<img id="'+this.getId("previewIMG_attach")+'" class="m-editor-preview-img" src="'+t.src+'" />',s.style.position="relative",s.appendChild(o),o.style.right="2px",o.style.left="auto",XN.event.addEvent(this.getEl("mEditorPreviewHolder_attach"),"mouseover",function(){o.style.left=="auto"?(o.style.right="auto",o.style.left="2px"):o.style.right=="auto"&&(o.style.right="2px",o.style.left="auto")},2)}this.getEl("previewIMG_attach").src=t.src,this._previewHolderAttach.style.display="block"}}},hidePreviewEmotion:function(e){el=XN.event.element(e);var t=this.config.container.parentNode,n=XN.element.hasClassName(t,"emo-attach");el.tagName.toLowerCase()=="ul"&&this._previewHolder&&!n&&this._previewHolder.hide(),el.tagName.toLowerCase()=="ul"&&this._previewHolderAttach&&n&&(this._previewHolderAttach.style.display="none")}}),XN.event.enableCustomEvent(XN.ui.emotions.prototype),XN.ui.quickSwfupload=n({uploadUrl:"http://upload."+XN.env.domain+"/uploadservice.fcgi?pagetype=gossipAddPhoto&societyguester="+XN.cookie.get("societyguester")+"&hostid="+XN.cookie.get("id")+"&t="+XN.cookie.get("t"),swfPath:"http://s.xnimg.cn/jspro/swfupload.v2.2.0.1/swfupload.swf",replaceElId:null,onUploadSuccess:function(e){XN.log(e)},onUploadProgress:function(e,t,n){XN.log(e,t,n)},buttonTxt:null,buttonWidth:null,buttonHeight:null,buttonStyle:".text {text-align:left;color:#005EAC;font-family:tahoma,simsun;font-size:12px;font-family:Tahoma,Verdana,simsun,sans-serif;}"}),$extend(XN.ui.quickSwfupload.prototype,{name:"miniUpload",init:function(){return $(this.getConfig("replaceElId"))?window.SWFUpload?(this.getConfig("buttonTxt")||(this.config.buttonTxt=$(this.getConfig("replaceElId")).innerHTML),this.getConfig("buttonWidth")||(this.config.buttonWidth=$(this.getConfig("replaceElId")).offsetWidth),this.getConfig("buttonHeight")||(this.config.buttonHeight=$(this.getConfig("replaceElId")).offsetHeight),this.renderUI(),this):(XN.log("依赖的swfupload.js没有引入"),!1):(XN.log("必须传入一个被flash替换的元素"),!1)},renderUI:function(){var e=this;this.uploader=new SWFUpload({upload_url:e.getConfig("uploadUrl"),flash_url:e.getConfig("swfPath"),file_size_limit:"10 MB",file_types:"*.jpg;*.jpeg;*.png;*.bmp;*.gif",file_types_description:"All Image Files",file_upload_limit:60,file_queue_limit:0,debug:!1,button_placeholder_id:e.getConfig("replaceElId"),button_cursor:SWFUpload.CURSOR.HAND,button_width:e.getConfig("buttonWidth"),button_height:e.getConfig("buttonHeight"),button_image_url:"http://a.xnimg.cn/a.gif",button_text:e.getConfig("buttonTxt"),button_text_style:e.getConfig("buttonStyle"),button_text_top_padding:2,button_action:SWFUpload.BUTTON_ACTION.SELECT_FILE,button_cursor:SWFUpload.CURSOR.HAND,button_window_mode:SWFUpload.WINDOW_MODE.TRANSPARENT,file_queued_handler:function(){this.startUpload()},upload_error_handler:function(e,t,n){XN.DO.showError(n+""+t+""+e)},upload_progress_handler:function(t,n,r){e.getConfig("onUploadProgress").call(e,t,n,r)},upload_success_handler:function(t,n){var r=XN.json.parse(n);$extend(r,{file:t}),e.getConfig("onUploadSuccess").call(e,r)}})}});var o=new e;getEmoticonsInstance=function(e){return o.get(e)},XN.ui.emoticons=n({input:null,button:null,atButton:null,isShowVipEmos:!1,showAddPhoto:!1,keepShow:!0,hideEmoBtn:!1,emoBtnDes:"表情",emoPopDelay:0,emoPopFixed:!1,btnAlignWith:null,btnAlignType:"3-2",btnOffsetX:0,btnOffsetY:-1,allUbb:!1,onShowEmoPop:XN.func.empty,onEmoTabSwitch:XN.func.empty,onEmoTabClick:XN.func.empty,onEmoConClick:XN.func.empty,onEmoNotVip:XN.func.empty}),$extend(XN.ui.emoticons.prototype,{name:"miniEditor",pos:{},init:function(){return $(this.getConfig("input"))?this.getConfig("input").getAttribute("eicons_obj_id")?o.get(this.getConfig("input").getAttribute("eicons_obj_id")):(this.setConfig("emoTrigger",[]),this.input=$(this.getConfig("input")),this.initEvent(),this.initEmotions(),this.getConfig("showAddPhoto")&&this.initQuickSwfupload(),this.getConfig("atBtn")&&this.initMentionBtn(),this.input.setAttribute("eicons_obj_id",this.ID),o.add(this.ID,this),this):(XN.log("必须传入要赋值的input"),!1)},initEvent:function(){var e=this.input,t=this.getInputPos.bind(this);XN.event.addEvent(e,"keyup",t),XN.browser.WebKit?XN.event.addEvent(e,"blur",t):XN.event.addEvent(e,"focus",t),XN.event.addEvent(e,"mouseup",t),XN.dom.ready(t)},initEmotions:function(){var e=this;this.emotionsContainer=new XN.ui.fixPositionElement({alignWith:e.getConfig("btnAlignWith")||e.input,tagName:"div",alignType:e.getConfig("btnAlignType"),offsetX:e.getConfig("btnOffsetX"),offsetY:e.getConfig("btnOffsetY")}),this.emotionsContainer.frame.style.width="338px",this.emotionsContainer.container.addClass("m-editor"),this.emotionsContainer.hide(),this.getConfig("emoPopFixed")&&(this.emotionsContainer.frame.style.position="fixed"),setTimeout(function(){e.initEmoEvents()},0)},hideEmoPop:function(){this.emotionsContainer.hide(),this.emotions&&this.emotions._previewHolder&&this.emotions._previewHolder.hide(),this.showEmoBtn(!0),this.fireEvent("hideEmoticons")},showEmoPop:function(e){var t=this,n=function(){setTimeout(function(){this.showEmoBtn(!1),this.emotionsContainer.show(),this.fireEvent("showEmoticons"),this.getConfig("onShowEmoPop").bind(this)()}.bind(this),this.getConfig("emoPopDelay"))}.bind(this),r=function(){this.getConfig("onEmoTabSwitch").bind(this)()}.bind(this);scProxy=function(){this.getConfig("onEmoTabClick").bind(this)()}.bind(this),sVipProxy=function(){this.getConfig("onEmoNotVip").bind(this)()}.bind(this),sECProxy=function(){this.getConfig("onEmoConClick").bind(this)()}.bind(this);if(!this.emotions){var t=this,i={container:t.emotionsContainer.container,isShowVipEmos:t.getConfig("isShowVipEmos"),allUbb:t.getConfig("allUbb"),onParseEmo:function(e,n){t.setValue(e.ubb),!n.ctrlKey&&!t.getConfig("keepShow")&&t.hideEmoPop()},onParseSuperEmo:function(){t.getConfig("onParseSuperEmo")&&t.getConfig("onParseSuperEmo").apply(t,arguments)}};$extend(i,this.getConfig("url")?{url:t.getConfig("url")}:{}),this.emotions=new XN.ui.emotions(i),this.emotions.addEvent("renderEmotions",n),this.emotions.addEvent("tabSwitch",r),this.emotions.addEvent("tabClick",scProxy),this.emotions.addEvent("showNotVip",sVipProxy),this.emotions.addEvent("emoConClick",sECProxy)}else n();XN.event.stop(e||window.event)},resetTabView:function(){this.emotions.resetTabView()},showEmoBtn:function(e){if(this.getConfig("hideEmoBtn"))return!1;this.getEl("emoBtn")&&this.getEl("emoBtn")[e===!0?"show":"hide"]()},initEmoEvents:function(){var e=this,n=this.showEmoPop.bind(this);this.getConfig("button")&&this.getConfig("emoTrigger").push({el:e.getConfig("button"),evt:"click"}),XN.array.each(this.getConfig("emoTrigger"),function(e,r){if(t(r)==="string"){var i=r.split(":");r={el:i[0],evt:i[1]}}r.evt.toLowerCase()=="focus"&&(r.evt="click"),XN.event.addEvent(r.el,r.evt,n)}),XN.event.addEvent(document,"click",this.hideEmoPop.bind(this)),this.input.mention&&this.input.mention.addEvent("refocus",function(){e.getInputPos()})},initQuickSwfupload:function(){},initMentionBtn:function(){var e=this;XN.event.addEvent(this.getConfig("atBtn"),"click",function(){var t="@",n=XN.form.help(e.input).getRealValue();n.slice(e.pos.start-1,e.pos.start)=="@"&&(t=""),e.setValue(t),setTimeout(function(){e.input.mention&&(e.input.mention.check(),e.input.mention.addEvent("refocus",function(){e.getInputPos()}))},0)})},pos:{},getInputPos:function(e){try{this.pos=XN.form.help(this.input).cursorPosition()}catch(t){this.pos={start:0,end:0,item:[0,0]},XN.log(t)}},setValue:function(e){var t=this.input,n=this,r=XN.form.help(t).getRealValue();t.value=r.slice(0,n.pos.start)+e+r.slice(n.pos.end),XN.form.help(t).focus(n.pos.start+e.length),XN.browser.WebKit?window.setTimeout(function(){n.getInputPos()},0):n.getInputPos()},fireFocus:function(){if(document.createEvent){var e=document.createEvent("MouseEvents");e.initEvent("click",!0,!1),this.input.dispatchEvent(e)}else this.input.fireEvent("onfocus")}}),XN.event.enableCustomEvent(XN.ui.emoticons.prototype)})();