object.define("webpager/lib/base","dom, events, net",function(require,e){if(window.asyncHTMLManager)var t=asyncHTMLManager.__timer.setTimeout,n=asyncHTMLManager.__timer.setInterval;else var t=window.setTimeout,n=window.setInterval;try{var i={setTimeout:t};i.setTimeout(function(){}),e.setTimeout=t,e.setInterval=n}catch(a){e.setTimeout=function(){return t.apply(window,arguments)},e.setInterval=function(){return n.apply(window,arguments)}}var r=function(e){e.readyQ=[],e.isReady=!1,e.ready=function(e){this.isReady?e.call(this):this.readyQ.push(e)},e.doReady=function(){for(var e=0;e<this.readyQ.length;e++)this.readyQ[e].call(this);this.isReady=!0}},o=require("dom"),s=require("events"),d=require("net");if(window.asyncHTMLManager&&window.asyncHTMLManager.dom)var o=window.asyncHTMLManager.dom;var l=o.Element.get("addEvent"),c=function(e,t,n){if(null==t||"object"!=typeof t)return t;var e=e||t.constructor();for(var i in t)t.hasOwnProperty(i)&&(!e[i]||n)&&(e[i]=t[i]);return e},u={site:"renren.com"},p=function(e){var t=document.createElement("div");t.style.display="none",document.body.appendChild(t),t.innerHTML=e;for(var n=document.createDocumentFragment();t.firstChild;)n.appendChild(t.firstChild);return t.parentNode.removeChild(t),n};e.dom=o,e.addEvent=l,e.events=s,e.net=d,e.extend=c,e.$extend=$extend,e.Sizzle=Sizzle,e.readly=r,e.ENV=u,e.XN=XN,e.parseHTML=p}),object.define("webpager/lib/base/logger",function(require,e){var t=50,n=window._log_data=[],i={_output_filter:"",_listener:null,log:function(e,i){var a=Array.prototype.slice.call(arguments,2),r={service:e,type:i,content:a,time:new Date-0};n.length>t&&n.shift(),n.push(r),this._listener&&this._listener.apply&&(!this._output_filter||this.check(r,this._output_filter))&&this._listener(r)},apply:function(e){this.log.apply(this,e)},check:function(){return!0},lookup:function(e,t,i){for(var a=0,r=[],o=n.length-t;o>=0;){if(n[o]&&this.check(n[o],e)){if(++a>i)break;r.push(n[o])}o--}return r},listen:function(e,t){"function"==typeof e&&(t=e,e=null),this._listener=t,this._output_filter=e}},a=function(e){return Array.prototype.slice.call(e,0)},r=function(e){this.service=e};r.prototype={log:function(){var e=a(arguments);e.unshift(this.service),i.apply(e)},tlog:function(e,t){var n=a(t);n=[this.service,e].concat(n),i.apply(n)},log1:function(){this.tlog("1",arguments)},log2:function(){this.tlog("2",arguments)},err:function(){this.tlog("error",arguments)},action:function(){this.tlog("useraction",arguments)},todo:function(){this.tlog("TODO",arguments)}};var o={};e.getInstance=function(e){if(o[e])return o[e];var t=new r(e);return o[e]=t,t},e.logger=i}),object.define("webpager/lib/tools","./base, ./base/logger, ./channel_api",function(require,exports,module){function two(e){return parseInt(e)>9?e:"0"+e}function scrub(e){return new Option(e).innerHTML.replace(/"/g,"&quot;")}function get_value(e,t){for(var e,n=t.split(".");n.length;){if(!(n[0]in e))return!1;e=e[n.shift()]}return e}var base=require("./base"),Log=require("./base/logger"),channel=require("./channel_api"),webpager=window.webpager,$extend=base.$extend,Logger=Log.logger,logger=Log.getInstance("tools"),debug={level:0,on:function(e){var t=this;this.level=e||1,exports.isDebugging=!0,Logger.listen(function(e){var n=[t.getLogTime(e.time)," : ","["+e.type+"]"+e.service];n=n.concat(e.content),t.writeLog(n)})},off:function(){exports.isDebugging=!1,this.level=0,Logger.listen(null)},getLogTime:function(e){var t=new Date(e);return t.getHours()+":"+t.getMinutes()+":"+t.getSeconds()}};window.webpager.debug=debug,function(){var e;e=!XN.browser.IE&&window.console&&window.console.log?function(e){console.log.apply(console,e)}:function(e){window.jash&&jash.print(e)},debug.writeLog=e}(),-1!=window.location.toString().indexOf("debug")&&(debug.on(),XN.DEBUG_MODE=!0);var QA={log:function(){},log2:function(){},expt:function(){}};QA.reportExpt=channel.imengine.WPC.reportExpt,QA.genTimer=function(){var e={start:new Date-0,logs:[],tags:{},_end:!1,tag:function(e){this.tags[e]=new Date-0},log:function(e){this._end&&(this.logs=[]);var t=this.tags[e]||this.start;this.logs.push(e+":"+(new Date-t)),this._end&&this.end()},end:function(){this._end=!0;var e="task=fbook_profile&uid="+User.id+"&start="+this.start,t="tags="+this.logs.join();try{window.imengine.WPC.reportLogMsg(e+"&"+t)}catch(n){}}};return e};var Bling=new Class(function(){this.__mixins__=[base.events.Events],this.fn0=null,this.fn1=null,this.onStart=null,this.initialize=function(e,t){base.extend(e,t,!0)},this.start=function(e){var t=0;e.inter&&clearInterval(e.inter),e.onStart&&e.onStart(),e.inter=setInterval(function(){t++%2?e.fn1():e.fn0()},e.timeInterv||1e3)},this.stop=function(e){clearInterval(e.inter),e.fireEvent("stop")}}),pagerTimer=new base.events.Events;pagerTimer.init=function(){var e=this;!function(){var t=arguments;base.setTimeout(function(){e.fireEvent("timeout"),t.callee()},1500)}(),function(){var t=arguments;base.setTimeout(function(){e.fireEvent("timeout10"),t.callee()},1e3)}()},pagerTimer.init();var resource={url:{NOTIFY:"http://notify."+XN.env.domain+"/get.notify?view=1&nid=0&limit=10&rand="+Math.random(),DEL_NOTIFY:"http://notify."+XN.env.domain+"/remove.notify",OFFLINE_IMG:"http://head.xiaonei.com/photos/0/0/men_tiny.gif",WEB_ONLINE:"http://s.xnimg.cn/imgpro/icons/web_online_std.png",WEB_ONLINE_IE6:"http://s.xnimg.cn/imgpro/icons/web_online_ie6.gif",RR_ONLINE:"http://s.xnimg.cn/imgpro/icons/rr_online_std.png",RR_ONLINE_IE6:"http://s.xnimg.cn/imgpro/icons/rr_online_ie6.gif",WPI_CLOSE:"http://s.xnimg.cn/imgpro/icons/wpi_close_std.png",WPI_CLOSE_IE6:"http://s.xnimg.cn/imgpro/icons/wpi_close_ie6.gif",WPI_STATUS_COMMON:"http://s.xnimg.cn/imgpro/icons/wpi_status_common.png",WPI_STATUS_HLIGHT:"http://s.xnimg.cn/imgpro/icons/wpi_status_hlight.png",WPI_WEBTALK_CAMERA:"http://s.xnimg.cn/imgpro/icons/webtalk_camera.png",WPI_PHOTO_COMMON:"http://s.xnimg.cn/imgpro/icons/wpi_photo_common.png",WPI_PHOTO_HLIGHT:"http://s.xnimg.cn/imgpro/icons/wpi_photo_hlight.png",WPI_SHARE_COMMON:"http://xnimg.cn/imgpro/icons/share.gif",WPI_BULB:"http://a.xnimg.cn/imgpro/icons/bulb.png"},msg:{INPUT_DEFAULT:"请输入聊天内容",TOO_LONG:"您发送的内容超过2000字, 发送失败",NOTICE:"为保护你的隐私，将默认此对话为悄悄话！",NOTICE2:"开启桌面通知，感受全新体验！",SPAM:{"-1":"您目前不在登录状态，请尝试重新登录后再试。如果您一直收到这个信息，请联系管理员",2:"该状态不存在",4:"请不要发布政治敏感内容、色情内容、商业广告或其他不恰当内容",5:"你短时间内发表了太多相同的内容"}}},u=XN.user,User={id:u.id,name:decodeURIComponent(u.name.replace(/\+/g," ")),head:u.tinyPic},isMyself=function(e){return User.id==e},getTime=function(e){if(e){if(!(e instanceof Date)){var t=e-0;if(!t)return e;var e=new Date(1e3*t)}}else var e=new Date;return two(e.getMonth()+1)+"-"+two(e.getDate())+" "+two(e.getHours())+":"+two(e.getMinutes())},getDate=function(e){var e=e&&new Date(e)||new Date;return e.getFullYear()+"-"+two(e.getMonth()+1)+"-"+two(e.getDate())},getDateTime=function(e){var e=e&&new Date(e)||new Date;return e.getFullYear()+"-"+two(e.getMonth()+1)+"-"+two(e.getDate())+" "+two(e.getHours())+":"+two(e.getMinutes())};getTime=getDateTime;var tryer=new Class({"@mixins":[base.events.Events],tryAWhile:function(e,t,n,i){e.clear(),e._inter=setInterval(function(){i()===!0&&(This.clear(),This.fireEvent("tryer_sus"))},t),e._timeout=base.setTimeout(function(){This.clear(),This.fireEvent("tryer_timeout")},n)},clear:function(e){clearInterval(e._inter),clearTimeout(e._timeout)}}),Cluster_Client=new Class(function(){function e(t,n){function i(){c=!1,channel.persistMgr.storageGet("cluster_"+n,1)==r?t(n):e(t,n)}if(!c){c=!0;for(var n=n||Math.floor(99*Math.random()),a=null;;){if(a=channel.persistMgr.storageGet("cluster_"+n,1),!a)break;n++}var r=Math.ceil(1e3*Math.random());channel.persistMgr.storageSet("cluster_"+n,r,1,1),base.setTimeout(i,2e3)}}function t(){if(logger.log1("Cluster : start_digestion >>>>>"),!u){if(!parseInt(d)){var t=parseInt(window.name);if(!t){var n=arguments.callee;return void e(function(e){d=e,n()})}d=t,a=!1}window.name=d,l.length&&(clearTimeout(u),u=base.setTimeout(function(){u=0;var e=l;l=[],logger.log1("Cluster : send queue",e),++o>20&&(o=1);var t="cluster_"+d+"_"+o;logger.log2("Cluster > broadcast Content :",JSON.stringify(e)),channel.persistMgr.storageSet(t,JSON.stringify(e),1)},200))}}function n(e,t,n){if(msg={service:e,t:new Date-0,s:d,m:t},l.push(msg),n){var a=i[e];a.fireEvent("message",{data:t,source:d})}}var i={},a=!0,r=[],o=0,s=channel.connectMgr.isLocalConnect(),d=0,l=[];webpager.addEvent("storage",function(e){for(var t,n,a=/cluster_(\d+)_\d+/g;t=a.exec(e.keys);)t[1]!=d&&(n=channel.persistMgr.storageGet(t[0],1),n=JSON.parse(n),logger.log2("Cluster > broadcast Recived :",n),n.forEach(function(e){var t=i[e.service];t&&t.fireEvent("message",{data:e.m,source:e.s})}));return;var t}),base.setTimeout(function(){var e=!1;if(s!=channel.connectMgr.isLocalConnect()){s=!s;for(var t in i)i[t].fireEvent("master",{ismaster:s});if(s){e=!0;var n=channel.persistMgr.storageGet("cluster",1);if(n)try{n=JSON.parse(n),r=r.concat(n)}catch(a){}}}return void base.setTimeout(arguments.callee,1500)},1500),base.setTimeout(function(){d&&channel.persistMgr.storageSet("cluster_"+d,new Date-0,1)},5e3);var c=!1,u=0;t(),this.__mixins__=[base.events.Events],this.initialize=function(e,t){return t in i?i[t]:(e.service=t,void(i[t]=e))},this.isMaster=function(){return s},this.isNew=function(){return a},this.broadcast=function(e,i,a){n(e.service,i,!!a),t()}});exports.unescapeHTML=function(e){var t=document.createElement("div");return t.innerHTML=e,XN.browser.IE?t.innerText:t.textContent},exports.htmlFilter=function(e){return e=e.replace(/&/g,"&amp;"),e=e.replace(/</g,"&lt;"),e=e.replace(/>/g,"&gt;")},exports.getDom=function(e){var t=document.createElement("div");t.style.display="none",document.body.appendChild(t),t.innerHTML=e;for(var n=document.createDocumentFragment();t.firstChild;)n.appendChild(t.firstChild);return t.parentNode.removeChild(t),n};var Focus=function(){function e(){a&&(o.broadcast(!1),a=!1,r--)}function t(){a||(o.broadcast(!0),a=!0,r++,i.fireEvent("focus",{data:!0,source:0}))}function n(){}var i=new base.events.Events,a=!1,r=0,o=new Cluster_Client("window_focus");return o.addEvent("message",function(e){e.data?(r++,i.fireEvent("focus",e)):r--}),window.addEvent("blur",e),window.addEvent("focus",t),window.addEvent("unload",function(){e()}),o.isNew()||o.broadcast(!1),n(),i.isFocusRR=function(){return r},i.isFocusMe=function(){return a},i},getWindowSize=function(){if(self.innerHeight)var e=self.innerWidth,t=self.innerHeight;else if(document.documentElement&&document.documentElement.clientHeight)var e=document.documentElement.clientWidth,t=document.documentElement.clientHeight;else if(document.body)var e=document.body.clientWidth,t=document.body.clientHeight;return{width:e,height:t}},winFrame=new Class(function(){this.__mixins__=[base.events.Events],this.frame=window,this.initialize=function(e){e.bindEvent()},this.bindEvent=function(e){if(XN.dom.ready(function(){base.addEvent(window,"resize",function(){e.fireEvent("resize",{data:getWindowSize()})})}),XN.browser.IE){var t=getWindowSize();pagerTimer.addEvent("timeout",function(){var n=getWindowSize();(t.width!=n.width||t.height!=n.height)&&(t=n,e.fireEvent("resize",{data:n}))})}}}),parseHTML=function(e){var t=document.createElement("div");t.style.display="none",document.body.appendChild(t),t.innerHTML=e;for(var n=document.createDocumentFragment();t.firstChild;)n.appendChild(t.firstChild);return t.parentNode.removeChild(t),n};exports.getClientHeight=function(){return document.documentElement?document.documentElement.clientHeight:void 0},exports.getClientWidth=function(){return document.documentElement?document.documentElement.clientWidth:void 0};var getPageScroll=function(){var e,t;return window.pageYOffset?(t=window.pageYOffset,e=window.pageXOffset):document.documentElement&&document.documentElement.scrollTop?(t=document.documentElement.scrollTop,e=document.documentElement.scrollLeft):document.body&&(t=document.body.scrollTop,e=document.body.scrollLeft),{x:e,y:t}};exports.inputPosition=function(e,t){var n=e;XN.isUndefined(t)&&(t=n.value.length);try{if(n.setSelectionRange)n.focus(),n.setSelectionRange(n.value.length,t);else if(n.createTextRange){var i=n.createTextRange();i.moveStart("character",t),i.collapse(!0),i.select(),n.focus()}else n.focus()}catch(a){}return this},exports.isInDom=function(e){for(var t=!1,n=e;n.parentNode;){if(n.parentNode===document.body){t=!0;break}n=n.parentNode}return t},exports.noMoreThan=function(e,t,n,i){return e?e&&e.aLength()<=t?e:n?e.aSubStringMiddle(t,"..."):i?e.aSubString(t):e.aSubStringTer(t,"..."):""};var AsyncMgr=function(e){e&&$extend(this,e),this.asyncs=[]};AsyncMgr.prototype={doneNum:0,timeout:2e3,register:function(e){this.asyncs.push({t:e,done:!1})},thisDone:function(e){for(var t=this.asyncs.length,n=0;t>n;n++)if(this.asyncs[n].t==e&&this.asyncs[n].done===!1){this.asyncs[n].done=!0,this.doneNum++;break}this.doneNum==t&&(this.doneNum=0,this.asyncs.length=0,this.stop(),this.fireEvent("asyncMgr_all_done"))},start:function(){var e=this;this.timer=setTimeout(function(){e.fireEvent("asyncMgr_timeout",e.asyncs)},this.timeout)},stop:function(){clearTimeout(this.timer)}},XN.event.enableCustomEvent(AsyncMgr.prototype),exports.makeHeadTinyurl=function(e){return e?(-1==e.indexOf("http://")&&(e=-1!=e.indexOf("_tiny.gif")?"http://head.xiaonei.com/photos/"+e:"http://hdn.xnimg.cn/photos/"+e),e):""},exports.makeProfileUrl=function(e){return"http://www.renren.com/profile.do?id="+e},exports.whiteList={_mice:!1,_spread:!1,spreadList:window.frames.imengine.shabby,list:["301005405","318504593","221751982","238995479","230961237"],checkMice:function(){if(this._mice)return!0;try{return this.list.indexOf(User.id)>=0?(this._mice=!0,!0):!1}catch(e){return!1}},checkSpread:function(){if(this.checkMice()||this._spread)return!0;try{return this.spreadList.indexOf(User.id)>=0?(this._spread=!0,!0):!1}catch(e){return!1}}},exports.isEmptyObject=function(e){for(var t in e)return!1;return!0};var renderTpl=function(fragment,vars){var blockregex=/\{\{(([@!]?)(.+?))\}\}(([\s\S]+?)(\{\{:\1\}\}([\s\S]+?))?)\{\{\/\1\}\}/g;return fragment.replace(/<script>[\w\W]*?<\/script>/gim,function(){return""}).replace(blockregex,function(e,t,n,i,a,r,o,s){var d,l=get_value(vars,i),c="";if(!l)return"!"==n?renderTpl(a,vars):o?renderTpl(s,vars):"";if(!n)return renderTpl(r,vars);if("@"==n){for(d in l)l.hasOwnProperty(d)&&(vars._key=d,vars._val=l[d],c+=renderTpl(a,vars));return delete vars._key,delete vars._val,c}}).replace(/\{\{([=%])(.+?)\}\}/gim,function(e,t,n){var i=get_value(vars,n);return i||0===i?"%"==t?scrub(i):i:""}).replace(/\[([^\]]*?)\]/gim,function(_,meta,key){var obj=eval("({"+meta.replace(/;/g,",")+"})"),ele=document.createElement("a");for(var i in obj)"btn"!=i&&ele.setAttribute(i,obj[i]);return ele.innerHTML=obj.btn,ele.href="javascript:;",ele.outerHTML})},replaceURLWithHTMLLinks=function(e){if(/<\/?[^>]*>/.test(e))return e;for(var t=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/i,e=e.split(" "),n=0,i=e.length;i>n;n++)e[n]=e[n].replace(t,"<a target= '_blank' href='$1'>$1</a>");return e.join(" ")};exports.AsyncMgr=AsyncMgr,exports.winFrame=new winFrame,exports.focused=Focus(),exports.resource=resource,exports.User=User,exports.Cluster_Client=Cluster_Client,exports.tryer=tryer,exports.pagerTimer=pagerTimer,exports.debug=debug,exports.QA=QA,exports.Bling=Bling,exports.isMyself=isMyself,exports.getTime=getTime,exports.getDate=getDate,exports.getDateTime=getDateTime,exports.parseHTML=parseHTML,exports.getPageScroll=getPageScroll,exports.getLogger=Log.getInstance,exports.renderTpl=renderTpl,exports.replaceURLWithHTMLLinks=replaceURLWithHTMLLinks}),String.prototype.nSubString=function(e){var t=this;if(!t||!e)return"";var n=0,i=0,a="";for(i=0;i<t.nLength(!1);i++){if(t.charCodeAt(i)>255?n+=2:n++,n>e)return a;a+=t.charAt(i)}return t},String.prototype.nSubStringTer=function(e,t){var n=this;return void 0==n||""==n||0>=e?"":n.nLength(!1)<=e?n:(e-=t.nLength(!1),n.nSubString(e)+t)},String.prototype.nLength=function(e){var t=this;if(void 0==t||""==t)return 0;var n=t,i=0;if(e)i=n.length;else for(var a=0;a<n.length;a++)n.charCodeAt(a)>=19968&&n.charCodeAt(a)<=40869?i+=2:i++;return i},String.prototype.aLength=function(){var e=this,t=arguments[0]===!0;if(void 0==e||""==e)return 0;for(var n=e,i=0,a=0;a<n.length;a++)i+=n.charCodeAt(a)>=48&&n.charCodeAt(a)<=57?6:n.charCodeAt(a)>=11904&&n.charCodeAt(a)<=40895||n.charCodeAt(a)>=65280&&n.charCodeAt(a)<=65519||n.charCodeAt(a)>=194560&&n.charCodeAt(a)<=195103||n.charCodeAt(a)>=131072&&n.charCodeAt(a)<=173791||"%"==n.charAt(a)||"@"==n.charAt(a)?10:"W"==n.charAt(a)?9:"w"==n.charAt(a)||"m"==n.charAt(a)||"Q"==n.charAt(a)||"O"==n.charAt(a)||"M"==n.charAt(a)||"#"==n.charAt(a)||"<"==n.charAt(a)||">"==n.charAt(a)||"+"==n.charAt(a)||"="==n.charAt(a)||"~"==n.charAt(a)?8:"U"==n.charAt(a)||"N"==n.charAt(a)||"H"==n.charAt(a)||"D"==n.charAt(a)||"A"==n.charAt(a)||"&"==n.charAt(a)||"G"==n.charAt(a)?7:"u"==n.charAt(a)||"q"==n.charAt(a)||"o"==n.charAt(a)||"n"==n.charAt(a)||"h"==n.charAt(a)||"d"==n.charAt(a)||"b"==n.charAt(a)||"X"==n.charAt(a)||"Y"==n.charAt(a)||"Z"==n.charAt(a)||"V"==n.charAt(a)||"T"==n.charAt(a)||"S"==n.charAt(a)||"R"==n.charAt(a)||"P"==n.charAt(a)||"K"==n.charAt(a)||"E"==n.charAt(a)||"C"==n.charAt(a)||"B"==n.charAt(a)||"w"==n.charAt(a)||"$"==n.charAt(a)||"*"==n.charAt(a)||"`"==n.charAt(a)||"g"==n.charAt(a)?6:"z"==n.charAt(a)||"y"==n.charAt(a)||"x"==n.charAt(a)||"v"==n.charAt(a)||"s"==n.charAt(a)||"k"==n.charAt(a)||"e"==n.charAt(a)||"c"==n.charAt(a)||"a"==n.charAt(a)||"L"==n.charAt(a)||"J"==n.charAt(a)||"F"==n.charAt(a)||"{"==n.charAt(a)||"}"==n.charAt(a)||"?"==n.charAt(a)?5:'"'==n.charAt(a)||"("==n.charAt(a)||")"==n.charAt(a)||"-"==n.charAt(a)||"/"==n.charAt(a)||"\\"==n.charAt(a)||":"==n.charAt(a)||";"==n.charAt(a)||"["==n.charAt(a)||"]"==n.charAt(a)||"|"==n.charAt(a)||"I"==n.charAt(a)||"r"==n.charAt(a)||" "==n.charAt(a)?4:"!"==n.charAt(a)||","==n.charAt(a)||"."==n.charAt(a)||"f"==n.charAt(a)||"i"==n.charAt(a)||"j"==n.charAt(a)||"l"==n.charAt(a)||"t"==n.charAt(a)?3:"'"==n.charAt(a)?2:8;return t?i:Math.ceil(i/10)},String.prototype.aSubString=function(e){var t=this,n=arguments[1]===!0;if(void 0==t||""==t||0>=e)return"";var i=10*e;n&&(i=e);for(var a=t,r="",o=0,s=0;s<a.length;s++){if(o+=a.charCodeAt(s)>=48&&a.charCodeAt(s)<=57?6:a.charCodeAt(s)>=11904&&a.charCodeAt(s)<=40895||a.charCodeAt(s)>=65280&&a.charCodeAt(s)<=65519||a.charCodeAt(s)>=194560&&a.charCodeAt(s)<=195103||a.charCodeAt(s)>=131072&&a.charCodeAt(s)<=173791||"%"==a.charAt(s)||"@"==a.charAt(s)?10:"W"==a.charAt(s)?9:"w"==a.charAt(s)||"m"==a.charAt(s)||"Q"==a.charAt(s)||"O"==a.charAt(s)||"M"==a.charAt(s)||"#"==a.charAt(s)||"<"==a.charAt(s)||">"==a.charAt(s)||"+"==a.charAt(s)||"="==a.charAt(s)||"~"==a.charAt(s)?8:"U"==a.charAt(s)||"N"==a.charAt(s)||"H"==a.charAt(s)||"D"==a.charAt(s)||"A"==a.charAt(s)||"&"==a.charAt(s)||"G"==a.charAt(s)?7:"u"==a.charAt(s)||"q"==a.charAt(s)||"o"==a.charAt(s)||"n"==a.charAt(s)||"h"==a.charAt(s)||"d"==a.charAt(s)||"b"==a.charAt(s)||"X"==a.charAt(s)||"Y"==a.charAt(s)||"Z"==a.charAt(s)||"V"==a.charAt(s)||"T"==a.charAt(s)||"S"==a.charAt(s)||"R"==a.charAt(s)||"P"==a.charAt(s)||"K"==a.charAt(s)||"E"==a.charAt(s)||"C"==a.charAt(s)||"B"==a.charAt(s)||"w"==a.charAt(s)||"$"==a.charAt(s)||"*"==a.charAt(s)||"`"==a.charAt(s)||"g"==a.charAt(s)?6:"z"==a.charAt(s)||"y"==a.charAt(s)||"x"==a.charAt(s)||"v"==a.charAt(s)||"s"==a.charAt(s)||"k"==a.charAt(s)||"e"==a.charAt(s)||"c"==a.charAt(s)||"a"==a.charAt(s)||"L"==a.charAt(s)||"J"==a.charAt(s)||"F"==a.charAt(s)||"{"==a.charAt(s)||"}"==a.charAt(s)||"?"==a.charAt(s)?5:'"'==a.charAt(s)||"("==a.charAt(s)||")"==a.charAt(s)||"-"==a.charAt(s)||"/"==a.charAt(s)||"\\"==a.charAt(s)||":"==a.charAt(s)||";"==a.charAt(s)||"["==a.charAt(s)||"]"==a.charAt(s)||"|"==a.charAt(s)||"I"==a.charAt(s)||"r"==a.charAt(s)||" "==a.charAt(s)?4:"!"==a.charAt(s)||","==a.charAt(s)||"."==a.charAt(s)||"f"==a.charAt(s)||"i"==a.charAt(s)||"j"==a.charAt(s)||"l"==a.charAt(s)||"t"==a.charAt(s)?3:"'"==a.charAt(s)?2:8,!(i>=o))return r;r+=a.charAt(s)}return r},String.prototype.aSubStringTer=function(e,t){var n=this;return e=10*e,void 0==n||""==n||0>=e?"":n.aLength(!0)<=e?n:(e-=t.aLength(!0),n.aSubString(e,!0)+t)},String.prototype.aSubStringMiddle=function(e,t){var n=this;if(e=10*e,void 0==n||""==n||0>=e)return"";var i=n.aLength(!0);if(e>=i)return n;var a=t.aLength(!0),r=Math.floor(e/2),o=10*Math.ceil((i-(e-r-a)+5)/10);return n.aSubString(r,!0)+t+n.replace(n.aSubString(o,!0),"")},object.define("webpager/lib/uikit","./uikit/common, ./uikit/window, ./uikit/pager, ./base, ./tools, ./emoticons, xn/mention",function(require,e){var t=require("./uikit/common");e.UIcommon=t.UIcommon,e.UIcomplex=t.UIcomplex,e.UIcontainer=t.UIcontainer;var n=require("./uikit/window");e.WinSlider=n.WinSlider,e.Window=n.Window,e.WindowWithDrawer=n.WindowWithDrawer;var i=require("./uikit/pager");e.WebPager=i.WebPager,e.PagerCase=i.PagerCase;var a=require("xn/mention").Mention,r=require("./base"),o=r.dom,s=(r.events,require("./tools")),d=s.getLogger("uikit"),l=r.XN,c=require("./emoticons"),u=new Class(t.UIcommon,function(){this.__mixins__=[t.UIcontainer],this.messages=[],this._scroll_bottom=!0,this.initialize=function(e,t){e.buildFrame(),e._container=e.frame,e.now=new Date,e.totalDialogs=0,e.firstDialog=0,e.config=t||{}},this.buildFrame=function(e){var t=o.wrap(document.createElement("article"));return t.addClass("dialogs"),e.frame=t,t},this.pushDialog=function(e,t,n){var i=n?n(t):e.buildDialog(t);e.messages.push(t);for(var a=(e._container,o.getElements("img",i.childNodes[i.childNodes.length-1])),r=0;r<a.length;r++)a[r].onload=function(){e.scrollBottom(),(l.browser.IE6||l.browser.IE7||l.browser.IE8)&&(this.onload=null)};return e._container.appendChild(i),e.scrollBottom(),i},this.scrollBottom=function(e){var t=e._container;t.scrollTop=t.scrollHeight},this.buildDialog=function(e,t){var n="";if("system"!=t.tag){e.totalDialogs++;var i=t.time.split(" "),a=i[0].split("-"),r=i[1].split(":"),o=parseInt(a[0]),d=parseInt(a[1])-1,c=parseInt(a[2]),u=parseInt(r[0]),p=parseInt(r[1]),r=new Date(o,d,c,u,p).getTime(),f=new Date(e.now.getFullYear(),e.now.getMonth(),e.now.getDate()),h=f.getTime()-864e5;beforYesterdayBegin=h-864e5,0==e.firstDialog?(e.baseTime=r,e.firstDialog=1,e.firstDialogTime=r):1==e.firstDialog&&(e.baseTime=e.firstDialogTime,e.firstDialog=2);var m=r-e.baseTime;if(1==e.firstDialog||m>=3e5||e.totalDialogs>10){var g="";g=r>f&&f+864e5>=g?t.time.split(" ")[1]:r>h&&f>=r?"昨天 "+t.time.split(" ")[1]:r>beforYesterdayBegin&&h>=r?"前天 "+t.time.split(" ")[1]:r>0&&beforYesterdayBegin>=r?t.time:"",n=g?['<section class="sys-info">',g,"</section>"].join(""):"",e.baseTime=r,1==e.firstDialog?"":e.totalDialogs=0}}if("system"==t.tag){var v=['<section class="sys-info">',t.content,"</section>"].join("");return s.parseHTML(v)}var b=(t.uid||t.id)==l.user.id?"wp-chatlist wp-chatlist-self":"wp-chatlist";if(t.msg_headsrc){l.browser.IE6&&(window.fixIE6Size=function(e){return e.width<100?void(e.style.height=e.height+"px"):(e.style.width="100px",void(e.style.height=100*e.height/e.width+"px"))});var w=l.browser.IE6?'onload="fixIE6Size(this);"':'width="100"',v=[n,'<section class="',b,'">','<figure class="avatar">','<a href="'+t.profile+'" target="_blank" title="'+t.name+'">','<img width="35" height="35" src="'+t.avatar+'"/>',"</a>","</figure>",'<section class="wp-chat-pic wp-chat-content"><em class="wp-arrow"></em><em class="wp-arrow wp-arrow-inner"></em>','<p class="wp-img-wrap clearfix">','<img class="wp-mini-pic" originalsrc="',t.msg_originalsrc,'" src="',t.msg_headsrc,'"',w," />","</p>","undefined"===t.content?"":"<p>"+t.content+"</p>","</section>","</section>"].join("");return s.parseHTML(v)}if(t.msg_audiosrc){var v=[n,'<section class="',b,'">','<figure class="avatar">','<a href="'+t.profile+'" target="_blank" title="'+t.name+'">','<img width="35" height="35" src="'+t.avatar+'"/>',"</a>","</figure>",'<section class="wp-chat-content"><em class="wp-arrow"></em><em class="wp-arrow wp-arrow-inner"></em>',"<p>",'<a href="#nogo" onclick="return false;" data-vocal="{\'url\': \'',t.msg_audiosrc,"', 'time': ",t.msg_audiotime,'}"  class="vocal-player float-left">','<span class="btn"></span><span class="time"><span class="num">',t.msg_audiotime,"</span></span></a>","</p></section>","</section>"].join("");return s.parseHTML(v)}var y=/<img.*src=\"(.*?)\".*originalsrc=\"(.*?)\".*\/>/gim;if(y.test(t.content)){var _,x;t.content.replace(y,function(e,t,n){x=t,_=n}),l.browser.IE6&&(window.fixIE6Size=function(e){return e.width<100?void(e.style.height=e.height+"px"):(e.style.width="100px",void(e.style.height=100*e.height/e.width+"px"))});var w=l.browser.IE6?'onload="fixIE6Size(this);"':'width="100"',v=[n,'<section class="',b,'">','<figure class="avatar">','<a href="'+t.profile+'" target="_blank" title="'+t.name+'">','<img width="35" height="35" src="'+t.avatar+'"/>',"</a>","</figure>",'<section class="wp-chat-pic wp-chat-content">','<em class="wp-arrow"></em><em class="wp-arrow wp-arrow-inner"></em>','<p class="wp-img-wrap clearfix">','<img class="wp-mini-pic " originalsrc="',_,'" src="',x,'"',w," />","</p>","</section>","</section>"].join("");return s.parseHTML(v)}var E=[n,'<section class="',b,'">','	<figure class="avatar">','		<a href="'+t.profile+'" target="_blank" title="'+t.name+'"><img width="35" height="35" src="'+t.avatar+'" /></a>',"	</figure>",'	<section class="wp-chat-content">','		<em class="wp-arrow"></em><em class="wp-arrow wp-arrow-inner"></em>',"		<p>"+t.content+"</p>","	</section>",'	<footer><span class="wp-chat-time">'+t.time+"</span></footer>","</section>"].join(""),k=s.parseHTML(E);return k},this.buildCutoff=function(e,t){var n=['<section style="position: relative; top: -6px; padding: 5px; margin:0 6px; background: white; ">','	<fieldset style="height: 27px; border-width: 1px 0 0; border-style: solid; border-color: #EEE; line-height: 27px; text-align:center">','	<legend style="padding: 0 14px; color: #EEE; font-weight: bold; ">'+t+"</legend>","</fieldset></section>"].join(""),i=s.parseHTML(n);return i},this.buildEarlyBtn=function(){var e=["<section>",'	<p class="wp-get-early">',"</p></section>"].join(""),t=s.parseHTML(e);return t},this.earlyContent=function(e,t,n){for(var i,a,r,s=document.createDocumentFragment(),d=[];r=t.shift();)a=n(r),i=a?a(r):e.buildDialog(r),s.appendChild(i),d.push(i);var l=e.buildCutoff("更早的记录").firstChild;s.appendChild(l);var c=e._container,u=o.getElement("section.wp-chatlist",c);u?c.insertBefore(s,u):c.appendChild(s),c.scrollTop=l.offsetTop-100},this.replaceContent=function(e,t,n){e.messages=t,e.refresh(n)},this.refresh=function(e,t){if(e.messages.length>20)var n=e.messages.slice(e.messages.length-19);else var n=e.messages;var i=e._container;if(i.innerHTML="",e.config.early_btn){e.frame.appendChild(e.buildEarlyBtn());var a=o.getElement("p.wp-get-early",e.frame);a.addEvent("click",function(){}),e.earlyBtn=a}n.forEach(function(n){var i,a=t(n);i=a?a(n):e.buildDialog(n),e._container.appendChild(i)}),e.scrollBottom()}});if(webpager.imRunning||void 0==window.frames.imengine.AD_FOR_RRZM)var p="";else{if("mac"==window.frames.imengine.AD_FOR_RRZM.platform)var f="http://im.renren.com/mac?word0";else var f="http://im.renren.com/desktop/rrsetup-11.exe?word04";var h="http://s.xnimg.cn/img/rrzm.png",m="color:#456B8A;height:26px;line-height:26px;padding-left:18px;background:url("+h+") no-repeat left;",g="padding-left:7px;width:200px;float:left;overflow:hidden;font-size:13px;_font-size:12px;",p='<div class="ad-button" style="'+g+'"><a target="_blank" title="点击下载" style="'+m+'" href="'+f+'">悄悄登录,隐身在线-人人桌面</a></div>'}var v=new Class(t.UIcommon,function(){this._disabled=!1,this._replyTo={},this._whisper=!1,this._features=["emotion","mention","uploader","invite","attachment","voice","history","capture"],this.features={},this._pluginFeatures={},this.maxinput=2e3,this.maxinput_tip="不能超过2000字符.",this.initialize=function(e,t){t.maxinput&&(e.maxinput=t.maxinput.num,e.maxinput_tip=t.maxinput.tip),e.buildFrame("footer"),e.frame.addClass("wp-edit-box"),e.getUIRef(),e.bindEvent(),e.buildFeatures(t)},this.makeFrameHTML=function(){var e=['	<div class="wp-chat-toolbar">',"	</div>",'	<form method="post" action="" class="editor">',"		<textarea></textarea>",'		<div class="wp-chat-send-box clearfix">'+p+'<a href="#nogo" onclick="return false;" class="wp-chat-send">发送</a></div>',"	</form>"].join("");return e},this.getUIRef=function(e){var t=e.frame,n={toolbar:t.getElement("div.wp-chat-toolbar"),form:t.getElement("form"),text:t.getElement("textarea")};n.sbtn=n.form.getElement("a.wp-chat-send"),e.nodes=n},this.bindEvent=function(e){var t=e.nodes,n=0;t.sbtn.addEvent("click",function(){clearTimeout(n),e._disabled||e._sendText()}),t.text.addEvent("keydown",function(n){if(e._disabled)return!1;if("13"==n.keyCode){if(n.shiftKey||n.ctrlKey)return;if(t.text.mention&&t.text.mention.selectorShow&&!t.text.mention.noMatch)return;e._sendText()}}),t.text.addEvent("paste",function(t){l.pasteUploader.previewSubmit=function(){var t={},n=jxn("#wppicbox img");n.attr("pasted")&&l.pasteUploader.upload(n.attr("src"),function(n){t.headsrc=n.headsrc,t.originalsrc=n.originalsrc,e._sendPic(e,t),l.pasteUploader.hideLayer()})},l.pasteUploader.pastePic(t)})},this.buildFeatures=function(e,t){t&&e._features.forEach(function(n){t[n]&&e.addFeature(n,t[n])})},this.plugFeature=function(e,t){e._features.push(t.name),e.features[t.name]=!0,e._pluginFeatures[t.name]=t},this.useFeature=function(e,t){var n=e._pluginFeatures[t];n&&(e.nodes.toolbar.appendChild(n.trigger),n.init.call(e,e,n.trigger))},this.addFeature=function(e,t,n){var i=e.nodes;if("emotion"==t){var r=document.createElement("div");r.innerHTML='<a href="#nogo" onclick="return false;" class="wp-chat-feelings" title="添加表情"></a><div class="emo_container"></div>',r=o.getElement("a",r),e.nodes.toolbar.appendChild(r),l.loadFile("http://s.xnimg.cn/csspro/module/minieditor.css",function(){window.webpager.emo=e.features.emotion=c.emoticons({input:e.nodes.text,button:r,url:"http://status.renren.com/getubblist.do?type=5",btnAlignType:"1-1",emoPopFixed:!0,btnOffsetY:-117,onShowEmoPop:function(){if(!l.browser.IE6){var e=this.emotionsContainer,t=jxn("#dropmenuHolder").offset().left;e.setOffsetX(t)}}})})}else if("mention"==t){var u=s.parseHTML('<a href="#nogo" onclick="return false;" class="wp-at" title="点名"></a>').childNodes[0];e.nodes.toolbar.appendChild(u),a.init([{obj:i.text,ugcId:n.ugcId,ugcType:n.ugcType,ownerId:n.ownerId,popTop:!0,scrollable:!0,whisper:!1,button:u,initCallback:function(){}}]),l.cookie.get("at")||l.cookie.set("at","1",1,"/","renren.com")}else if("history"==t){var r=document.createElement("div");r.innerHTML='<a href="#nogo" onclick="return false;" class="wp-chat-history">聊天记录</a>',r=o.getElement("a",r),e.nodes.toolbar.appendChild(r)}else if("uploader"==t){var r=document.createElement("div");r.innerHTML='<a href="#nogo" onclick="return false;" class="wp-add-pic" title="发送图片"></a>',r=o.getElement("a",r),e.nodes.toolbar.appendChild(r),l.loadFile("http://s.xnimg.cn/a59685/webpager/uploader-all.js",function(){l.pasteUploader.inited||l.pasteUploader.init();var t=document.createElement("div");t.className="fileCon";var n=o.getDom("<form target='webpager_uploader' action='"+l.pasteUploader.iframeUrl+"' method='post' enctype='multipart/form-data'><input type='file' name='file' class='file' title='发送图片'/></form>");t.appendChild(n);var i=t.childNodes[0],a=i.childNodes[0];a.addEvent("click",function(){l.pasteUploader.previewSubmit=function(){var t={},n=jxn("#wppicbox img");"true"!=n.attr("pasted")&&(t.headsrc=n.attr("headsrc"),t.originalsrc=n.attr("originalsrc"),e._sendPic(e,t),l.pasteUploader.hideLayer())}}),a.addEvent("change",function(){var e=a.value.substring(a.value.lastIndexOf(".")+1).toLowerCase();"gif"==e||"png"==e||"jpg"==e||"jpeg"==e||"bmp"==e?""!=a.value&&i.submit():(l.DO.showError("请选择一张图片（支持格式：jpg/png/gif/bmp）"),i.reset())}),a.addEvent("mouseover",function(){jxn(".wp-chat-toolbar a.wp-add-pic").addClass("wp-add-pic_hover")}),a.addEvent("mouseout",function(){jxn(".wp-chat-toolbar a.wp-add-pic").removeClass("wp-add-pic_hover")
}),e.nodes.toolbar.appendChild(t)})}else if("capture"==t){if(-1!=navigator.userAgent.toLowerCase().indexOf("mac",0))return;var r=document.createElement("div");r.innerHTML='<a href="#nogo" onclick="XN.pasteUploader.capture(this)" class="wp-add-pastepic" title="截屏发送"></a>',r=o.getElement("a",r),r.addEvent("click",function(){l.pasteUploader.previewSubmit=function(){var t={},n=jxn("#wppicbox img");"true"!=n.attr("pasted")&&(t.headsrc=n.attr("headsrc"),t.originalsrc=n.attr("originalsrc"),e._sendPic(e,t),l.pasteUploader.hideLayer())}}),e.nodes.toolbar.appendChild(r)}else if("attachment"==t);else if("audio"==t);else if("invite"==t){var r=document.createElement("div");r.innerHTML='<a href="#nogo" onclick="return false;" class="wp-add-chat" title="添加聊天"></a>',r=o.getElement("a",r);var p=e.features.invite=new w;e.frame.appendChild(p.frame),p.bindTrigger(r,function(t){d.log1("uikit/Inputer: 添加好友 ",t),e.fireEvent("invite",{data:t,close:function(){p.fold(),p.selector.reset()}})}),e.nodes.toolbar.appendChild(r),i.text.addEvent("focus",function(){p.getSelectedFrds()&&p.getSelectedFrds().length||p.fold()})}},this.reset=function(e,t){setTimeout(function(){e.nodes.text.value="",t&&e.nodes.text.focus()},10),e._replyTo=!1,e._whisper=!1},this._sendText=function(e){var t=e.nodes.text.value;if(!t.length)return e.reset(),void e.warnning();if(t.length>e.maxinput)return void l.DO.showError(e.maxinput_tip);""==t.trim()&&(t="　");var n=e._replyTo,i={content:t,isWhisper:e._whisper};n&&(i.replyTo=n.id,i.replyName=n.name,i.replyId=n.rid),e.fireEvent("send",{data:i})},this._sendPic=function(e,t,n){var i={content:"",pic:n};e.fireEvent("send",{data:i})},this.replyTo=function(e,t){e._replyTo=t,e._whisper=!!t.whisper,e._wrapText()},this._wrapText=function(e){var t=e._replyTo;if(t){var n=e.nodes.text,i=n.value;i=i.replace(/^回复.*：/,"");var a;e._whisper?(a="回复"+t.name+"(悄悄话)：",i=a+i):(a="回复"+t.name+"：",i=a+i),n.value=i,s.inputPosition(n)}},this.disable=function(e){e._disabled=!0,e.nodes.text.disabled=!0},this.enable=function(e){e._disabled=!1,e.nodes.text.disabled=!1},this.focus=function(e){e.nodes.text.focus()},this.warnning=function(e){l.Effect.gradient(e.nodes.text,255,255,215,function(){e.nodes.text.style.backgroundColor="#fff"})}}),b=function(){var e=new l.ui.multiFriendSelector;return l.browser.IE6||(e.autoComplete.menu.onShow=function(){var e=this.menu.frame;e.style.top=parseInt(e.style.top)+s.getPageScroll().y+"px"}),r.addEvent(window,"scroll",function(){e.autoComplete.frame.blur()}),e},w=new Class(t.UIcommon,function(){this.selector=null,this._fold=!0,this.initialize=function(e){e.frame=e.buildFrame()},this.buildFrame=function(e){var t=['<div class="wp-addchat-box" style="display:none">','	<div class="wp-addchat clearfix">','	<div class="wp-add-txt"></div>',"	</div>",'	<a href="#nogo" onclick="return false;" class="wp-addchat-btn">添加</a>',"</div>"].join(""),n=document.createElement("div");return n.innerHTML=t,n=o.getElement("div.wp-addchat-box",n),e.nodes={container:n.getElement("div.wp-add-txt"),sbtn:n.getElement("a")},n},this.newSelector=function(e){var t=b();e.selector=t;var n=e.nodes;n.container.appendChild(t.frame),n.sbtn.addEvent("click",function(){e.callback(t.getSelectedFriends())}),n.input=o.getElement("input",e.frame),n.container.addEvent("mouseup",function(){e.unfold()})},this.getSelectedFrds=function(e){return e.selector?e.selector.getSelectedFriends():[]},this.bindTrigger=function(e,t,n){t.addEvent("click",function(t){t.cancelBubble=!0,t.defaultPrevented=!0,e._fold?e.unfold():e.fold()}),e.callback=n},this.unfold=function(e){l.net.sendStats("http://message.renren.com/statistics/win/addfriend"),e.selector||e.newSelector(),e.frame.show(),e._fold=!1,e.nodes.input.focus()},this.fold=function(e){e.frame.hide(),e._fold=!0}}),y=new Class(w,function(){this.buildFrame=function(e){var t=['<div class="wp-addchat-box" style="display:none">','	<div class="wp-addchat clearfix">','	<div class="wp-add-txt"></div>',"	</div>",'	<a href="#nogo" onclick="return false;" class="wp-addchat-btn">添加</a>',"</div>"].join(""),n=document.createElement("div");return n.innerHTML=t,n=o.getElement("div.wp-addchat-box",n),e.nodes={container:n.getElement("div.wp-add-txt"),sbtn:n.getElement("a")},n}});e.TalkFlow=u,e.Inputer=v,e.IFeature_invite=w,e.IFeature_invite_set=y}),object.define("webpager/lib/uikit/common","../base, ../tools",function(require,e){var t=require("../base"),n=require("../tools"),i=t.dom,a=t.events,r=new Class(function(){this.__mixins__=[a.Events],this.frame=null,this.body=null,this.nodes={},this._on_render=[],this._hidden=!1,this.buildFrame=function(e,t,a){var t=t||"div",r=i.wrap(document.createElement(t));a&&(r.style.cssText=a);var o=e.makeFrameHTML();if(XN.browser.IE){var s=n.parseHTML(o);r.appendChild(s)}else r.innerHTML=o;return e.frame=r,r},this.makeFrameHTML=function(){var e="";return e},this.show=function(e){e.frame.style.display="",e._hidden=!1},this.slientShow=function(e){e.frame.style.display="",e._hidden=!1},this.hide=function(e){e.frame.style.display="none",e._hidden=!0},this.getWidth=function(e){return e.body.offsetWidth},this.getHeight=function(e){return e.body.offsetHeight},this.setWidth=function(e,t){var n=t+"px";e.body?e.body.style.width=n:e.frame.style.width=n,e.fireEvent("resize",{width:t})},this.setHeight=function(e,t){var n=t+"px";e.body?e.body.style.height=n:e.frame.style.heigth=n,e.fireEvent("resize",{height:t})},this.destroy=function(e){var t=e.frame;t.parentNode&&t.parentNode.removeChild(t),t=null}}),o=new Class(function(){this.name="M",this.initialize=function(e){e.components={}},this._assemble=function(e,t,n){e.components[t]=n}}),s=new Class(function(){this.initialize=function(e){e._pool=[],e._container=null},this.append=function(e,t){e._pool.push(t),e._container.appendChild(t.frame)},this.rise=function(e,t){e._pool.push(t),e._pool.length,e._container.appendChild(t.frame)},this.riseBefore=function(e,t,n){e._container.insertBefore(t.frame,n.frame)},this.remove=function(e,t){return e._container.removeChild(t.frame),!0}});e.UIcommon=r,e.UIcomplex=o,e.UIcontainer=s}),object.define("webpager/lib/uikit/pager","../base, ./common",function(require,e){var t=require("../base"),n=require("./common"),i=t.dom,a=new Class(n.UIcommon,function(){this.__mixins__=[n.UIcontainer],this.initialize=function(e,t){e.frame=t,e._container=t}}),r=new Class(n.UIcommon,function(){this.__mixins__=[n.UIcontainer],this.initialize=function(e){var t=i.wrap(document.createElement("div"));t.addClass("panelbarpanels"),e.frame=t,e._container=t},this.setContent=function(e,t){e._container.innerHTML="",e.append(t),e.content=t},this.setWidth=function(e,t){this.parent(e,t),e.content&&e.content.setWidth(t)}});e.WebPager=a,e.PagerCase=r}),object.define("webpager/lib/uikit/window","./common, ../base, ../tools",function(require,e){var t=require("./common"),n=require("../base"),i=n.dom,a=require("../tools"),r=a.getLogger("window"),o=new Class(t.UIcommon,function(){this.__mixins__=[t.UIcomplex],this.name="A",this._fold=!0,this._highlight=!1,this.id,this.rebuild_message,this._title="",this.initialize=function(e,t){r.log2("init Window");var n=e.buildFrame();n.addClass("popupwindow"),e.getUIRef(),e.bindEvent(),t&&e.applyConfig(t)},this.applyConfig=function(e,t,n){t.title&&e.setTitle(t.title),t.icon&&e.setIcon(t.icon),t.handler&&e.setHandler(t.handler),t.hlight&&e.highLight(n),t.fold&&(t.fold>0?e.fold(n):e.unfold(n)),t.no_xbtn&&(e.nodes.xbtn.hide(),e.nodes.xbtn2.hide()),t.max_msg_id&&(e.max_msg_id=t.max_msg_id)},this.getStat=function(e){var t={id:e.id,rebuild:e.rebuild_message,fold:e._fold?1:-1,hlight:e._highlight};return e.max_msg_id&&(t.max_msg_id=e.max_msg_id),t},this.makeFrameHTML=function(){var e=['<div class="panelbarbutton" onselectstart="return false;">','	<a href="#nogo" onclick="return false;" class="wp-chat-close">关闭</a>','	<p class="" title="窗口名">窗口名</p>',"</div>",'<article class="chat-window"'+(XN.browser.IE6?'style="overflow-x:hidden;"':"")+">","	<header>","		<h4></h4>","		<menu>",'			<li title="最小化" label="最小化" class="minimize">最小化</li>','			<li title="关闭" class="close">关闭</li>',"		</menu>",'		<div class="disconnect-tips"><img src="http://a.xnimg.cn/a.gif" class="error_notic" />您已经离线，无法发送消息，请上线后再次尝试</div>',"	</header>",'	<section> <div class="dialog"></div> </section>',"</article>"].join("");return e},this.disable=function(e,t,n){var t=t||{},i=e.nodes.shade||document.createElement("div");return i.innerHTML="",i.style.display="block",i.style.position="absolute",i.style.width="100%",i.style.height="100%",t.opacity&&(i.style.opacity="0.9",i.style.filter="alpha(opacity=90)"),i.style.background=t.color||"#FFF",e.nodes.section.appendChild(i),n&&(i.innerHTML=n),XN.browser.IE6&&(i.style.height=e.getHeight()+"px",e.addEvent("resize",function(e){e.height&&(i.style.height=e.height+"px")})),e.nodes.shade=i,i},this.enable=function(e){e.nodes.shade.style.display="none"},this.getUIRef=function(e){var t=e.frame,n={bar:t.getElement("div.panelbarbutton"),handler:t.getElement("div.panelbarbutton p"),body:t.getElement("article"),title:t.getElement("h4"),header:t.getElement("header"),container:t.getElement("section>div.dialog"),section:t.getElement("section"),wmenu:t.getElement("header>menu")};n.xbtn=n.header.getElement("menu>li.close"),n.xbtn2=t.getElement("a.wp-chat-close"),n.mbtn=n.header.getElement("menu>li.minimize"),e.body=n.body,e.nodes=n,e.panels={}},this.bindEvent=function(e){var t=e.nodes;t.bar.addEvent("click",function(){e._fold?e.unfold(null,!0,!0,!0):e.fold()}),t.body.addEvent("click",function(t){var t=i.wrap(t.target);(t.hasClass("close")||t.hasClass("wp-chat-close"))&&e.close(),t.hasClass("minimize")&&e.fold()}),t.xbtn2.addEvent("click",function(t){t.cancelBubble=!0,e.close()})},this.setTitle=function(e,t){e.nodes.title.innerHTML=t;var n=/<[^>]+>/g,i=t.replace(n,"");e.saveTitle(i)},this.saveTitle=function(e,t){e._title=t},this.loadTitle=function(e){return e._title},this.setIcon=function(e,t){e.nodes.handler.addClass(t)},this.setHandler=function(e,t,n){var n=n||t,i=e.nodes.handler;i.innerHTML=t,i.title=n},this.message=function(e){e.fireEvent("message",{})},this.fold=function(e,t){XN.browser.IE6&&(e.frame.style.overflowX="hidden"),e._fold||(e.frame.removeClass("actived"),e._fold=!0,e.message(),e.fireEvent("unfocus"),t||e.fireEvent("fold",{data:1}))},this.unfold=function(e,t,n,i){i||e.fireEvent("toChatPanel",{});var a=!0;XN.browser.IE6&&(e.frame.style.overflowX=""),t&&(a=!1),e._fold&&(e.frame.addClass("actived"),e._fold=!1,t||e.fireEvent("fold",{data:0}),e.fireEvent("focus",{focus:a}),e.highLight(-1))},this.show=function(e){e._fold||e.fireEvent("focus"),this.parent(e)},this.slientShow=function(e){this.parent(e)},this.close=function(e,t){e.hide(),t||(e.fireEvent("close"),XN.net.sendStats(e._fold?"http://message.renren.com/statistics/win/min":"http://message.renren.com/statistics/win/max")),e.fold(!0)},this.highLight=function(e,t){t?e._highlight&&(e._highlight=!1,e.frame.removeClass("wb-message-tip"),window.fireEvent("cancel_slider_folder_newmsg",{id:e.id})):(e._highlight=!0,e.frame.addClass("wb-message-tip"),window.fireEvent("slider_folder_newmsg",{id:e.id}))}}),s=new Class(o,{initialize:function(e){e.frame=document.createElement("div"),e.frame.style.display="none"}}),d=new Class(t.UIcommon,function(){this.__mixins__=[t.UIcontainer],this.windows={},this.order=[],this._placeholder=0,this._unfold_window=null,this._boundary=581,this._stack_left=[],this._stack_right=[],this._stack_left_num=0,this._stack_right_num=0,this._stack_folder=[],this._stack_folder_num=0,this.folder_active=!1,this.initialize=function(e){e.frame=e.buildFrame(),e.getUIRef(),e.bindEvent(),e._container=e.nodes.content},this.buildFrame=function(){var e=i.wrap(document.createElement("div"));e.id="tasks-panel",e.addClass("panel");var t=['<div class="slide_folder j_slide_folder"><div class="chat_folder_icon"></div><div class="slide_folder_number j_slide_folder_number"></div><div class="slide_folder_list"><ul></ul></div></div>','<div class="slide-box" style="display: none"><a href="#nogo" onclick="return false;" class="slide_left"></a></div> ','<div class="winslider"></div>','<div class="slide-box" style="display: none"><a href="#nogo" onclick="return false;" class="slide_right"></a></div>'].join("");return e.innerHTML=t,e},this.getUIRef=function(e){var t=e.frame,n={left:t.getElement("div.slide-box"),right:t.getElements("div.slide-box")[1],folder:t.getElements("div.j_slide_folder"),num_left:t.getElement("a.slide_left"),num_right:t.getElement("a.slide_right"),num_folder:t.getElement(".j_slide_folder_number"),content:t.getElement("div.winslider")};e.body=n.content,e.nodes=n},this.bindEvent=function(e){var t=e.nodes;window.addEvent("slider_folder_newmsg",function(t){setTimeout(function(){e.isInStack(t.id)&&(jxn(".j_slide_folder").hasClass("actived")||jxn(".j_slide_folder").addClass("unread"),jxn('.j_slide_folder li[data-uid="'+t.id+'"]').addClass("new_msg"))},300)}),window.addEvent("cancel_slider_folder_newmsg",function(t){setTimeout(function(){e.isInStack(t.id)&&(jxn(".j_slide_folder").removeClass("unread"),jxn('.j_slide_folder li[data-uid="'+t.id+'"]').removeClass("new_msg"))},300)}),t.folder.addEvent("click",function(t){var n=t.target.className;if(n.indexOf("j_slide_folder")>=0||n.indexOf("chat_folder_icon")>=0)e.folder_active?e.unactiveFolder():(e.foldAll("0"),e.activeFolder());else if(n.indexOf("j_panelbarTrigger")>=0)e.popFolderItem(t.target);else if(n.indexOf("remove_icon")>=0)return e.removeFoldedItem(t.target),!1})},this.getLength=function(e){return e.order.length-e._placeholder},this.slideFolder=function(){},this.showFolder=function(){jxn(".j_slide_folder").show()},this.hideFolder=function(){jxn(".j_slide_folder").hide()},this.activeFolder=function(e){jxn(".j_slide_folder").addClass("actived").removeClass("unread"),jxn(".slide_folder_list").show(),e.folder_active=!0,jxn(".j_need_render").length>0&&jxn(".j_need_render").each(function(e,t){console.log(t)})},this.unactiveFolder=function(e){jxn(".j_slide_folder").removeClass("actived"),jxn(".slide_folder_list").hide(),e.folder_active=!1},this.isOverflow=function(e){if(!e.order.length)return!1;var t=parseInt(e._boundary/111),n=e.getLength();r.log2("Winslider/isOverflow: 当前窗口个数 "+n+"; 当前容器最大宽度 "+e._boundary+"; 可容纳窗口个数 "+t);var i=n-t;return 0>=i?0:t},this.slideCheck=function(e){var t=e.isOverflow();if(t){e.show(),r.log2("Winslider/slideCheck: 发生overflow ",t);for(var n=0,i=e._stack_folder,a=e.windows,o=0;o<i.length;o++)a[i[o]]instanceof s&&n++;if(n=e.order.length-i.length-(e._placeholder-n)-t,n>0)for(;n--;)e.pushLeft();else for(n=-n;n--;)e.popLeft()}else e.hide(),e.popAll()},this.slideRight=function(e,t){if(!e._stack_right.length)return!1;e.pushLeft();var n=e.popRight();if(r.log2("viewer视窗向右滑动 ",e._stack_left,e._stack_right),!t){var i={lr:"right",target:"winslider_slide",to:n};e.fireEvent("changed",{data:i})}return n},this.slideLeft=function(e,t){if(!e._stack_left.length)return!1;e.pushRight();var n=e.popLeft();if(r.log2("viewer视窗向左滑动 ",e._stack_left,e._stack_right),!t){var i={lr:"left",target:"winslider_slide",to:n};e.fireEvent("changed",{data:i})}return n},this.pushToFolder=function(e){var t,n;do n=e.order[e._stack_folder.length],e._stack_folder.push(n),t=e.windows[n];while(t instanceof s);return t.hide(),e.updateStackNum("folder",1),e.buildFolderItem(t),n},this.pushLeft=function(e){var t;do{var n=e.order[e._stack_folder.length];e._stack_folder.push(n),t=e.windows[n],e.buildFolderItem(t)}while(t instanceof s);return t.hide(),e.updateStackNum("left",1),n},this.pushRight=function(e){var t,n;do{n=e.order.length;var i=e.order[n-1];e._stack_folder.push(i),t=e.windows[i],e.buildFolderItem(t)}while(t instanceof s);return t.hide(),e.updateStackNum("right",1),i},this.popRight=function(e){var t;do{var n=e._stack_folder.pop();if(!n)return!1;t=e.windows[n]}while(t instanceof s);return t.show(),e.updateStackNum("right",-1),n},this.popLeft=function(e){var t;do{var n=e._stack_folder.pop();if(!n)return!1;t=e.windows[n]}while(t instanceof s);return t&&(t.show(),e.removeFolderNode(t.id),e.updateStackNum("left",-1)),n},this.removeFolderNode=function(e,t){jxn(".j_panelbarTrigger"+t).hide()},this.shiftFolderItem=function(e){var t=jxn(".j_panelbarTrigger:last").data("uid"),n=e.windows[t];e.append(n),n.show(),n.unfold(),jxn(".j_panelbarTrigger:last").remove(),e.updateStackNum("folder",-1);var i=e.order.indexOf(t),a=e._stack_folder.indexOf(t);e._stack_folder.splice(a,1),e.order.splice(i,1),e.order.push(t)},this.calCNChar=function(e,t){for(var n=t.length,i=0,a=0;n>a;a++)t.charCodeAt(a)<27||t.charCodeAt(a)>126?i+=2:i++;return i},this.cutCNChar=function(e,t,n){for(var i=0,a="",r=0;r<t.length;r++)if(t.charCodeAt(r)<27||t.charCodeAt(r)>128?i+=2:i++,a+=t.charAt(r),i>=n)return a;return a},this.buildFolderItem=function(e,t){var n="";if(t.nodes.title)n=jxn(t.nodes.title).text();else{var i=t.id.split("_")[2];switch(i-=0){case 505:case 503:case 502:n="状态回复";break;case 701:case 708:case 709:n="照片回复";break;case 5030:case 110:n="分享视频回复";break;case 103:n="分享照片回复";break;case 209:n="小组回复";break;case 601:n="日志回复";break;case 102:n="日志分享回复";break;default:n="状态回复"}}n&&"undefined"!=n&&0!=n.length||setTimeout(function(){var n=jxn(t.nodes.title).text();("string"!=typeof n||n.length<=0)&&(n=jxn(".wp-frid-list dl dd[uid='u"+t.id+"']").attr("title"),"string"!=typeof n&&(n=jxn(".wp-frid-list dl dd[uid='g"+t.id+"']").find(".wp-f-info span").attr("title")),"string"!=typeof n&&(n=t._title));var i="",a=t._highlight?"new_msg":"";i=e.calCNChar(n)>20?e.cutCNChar(n,20)+"...":n,jxn(".j_panelbarTrigger"+t.id).attr("title",n),jxn(".j_panelbarTrigger"+t.id).addClass(a),jxn(".j_panelbarTrigger"+t.id).html(i+"<div class='remove_icon'>")},1500);var a="";a=e.calCNChar(n)>20?e.cutCNChar(n,20)+"...":n;var r=t._highlight?"new_msg":"";jxn(".j_slide_folder ul").append("<li class='j_panelbarTrigger j_panelbarTrigger"+t.id+" "+r+"' title='"+n+"' data-uid='"+t.id+"'>"+a+"<div class='remove_icon'></div></li>")},this.popFolderItem=function(e,t){{var n=jxn(t).data("uid"),i=e.windows[n];e.windows[e.order[0]]}e.append(i),i.show(),i.unfold(),jxn(t).remove(),e.updateStackNum("folder",-1),e.isOverflow?e.pushToFolder():e.hide();var a=e.order.indexOf(n),r=e._stack_folder.indexOf(n);e._stack_folder.splice(r,1),e.order.splice(a,1),e.order.push(n),e._stack_folder_num<=0&&e.hideFolder()},this.removeFoldedItem=function(e,t){var n=jxn(t).parent().data("uid"),i=e.windows[n],n=i.id,a=e.order.indexOf(n);e.order.splice(a,1),delete e.windows[n],i.fold(!0),e.remove(i);var r={act:"closefolded",target:n};e.fireEvent("changed",{data:r}),e.fireEvent("remove",{data:i.id,rest:e.getLength()});var o=e.isInStack(n);o&&e.updateStackNum(o,-1),e.removeFolderNode(n);var s=e._stack_folder.indexOf(n);e._stack_folder.splice(s,1),e._stack_folder_num<=0&&e.hideFolder()},this.removeFolded=function(e,t){var n=t.id,i=e.order.indexOf(n);e.order.splice(i,1),delete e.windows[n],t.fold(!0),e.remove(t);var a=e.isInStack(n);a&&e.updateStackNum(a,-1),e.removeFolderNode(n);var r=e._stack_folder.indexOf(n);e._stack_folder.splice(r,1),e._stack_folder_num<=0&&e.hideFolder()},this.updateStackNum=function(e,t,n){var n=e._stack_folder_num+=n;e.nodes.num_folder.innerHTML=n},this.isInStack=function(e,t){for(var n=0;n<e._stack_folder.length;n++)if(e._stack_folder[n]==t)return"folder";return!1},this.popAll=function(e){if(e._stack_folder.length)for(;e.popLeft(););},this.openFromFolder=function(e,t){{var n=e.windows[t];e.windows[e.order[0]]}e.append(n),n.slientShow(),jxn(".j_panelbarTrigger"+t).remove(),e.updateStackNum("folder",-1),e.isOverflow?e.pushToFolder():e.hide();var i=e.order.indexOf(t),a=e._stack_folder.indexOf(t);e._stack_folder.splice(a,1),e.order.splice(i,1),e.order.push(t),jxn(".new_msg").length<=0&&jxn(".j_slide_folder").removeClass("unread")},this.slideTo=function(e,t){var n,i;for(n=e.slideLeft;(i=n.call(e,!0))&&i!=t&&i;);},this.foldAll=function(e,t){var n=!!t,i=e._unfold_window;i&&i!=t&&e.windows[i]&&e.windows[i].fold(n),e._unfold_window=t||!1,e.fireEvent("foldAll"),e.unactiveFolder()},this.appendWindow=function(e,t,n,i){var n=t.id;if(e.windows[n]){var a=e.windows[n];if(a instanceof s){var o=a.stat;e.windows[n]=t,o.fold<0&&e.foldAll(n),t.applyConfig(o),e.riseBefore(t,a),e._placeholder--;var d=e.isInStack(n);d&&(t.hide(),e.updateStackNum(d,1))}else r.err(new Error("你怎么复写了一个窗口呢!!!! "+n));e.remove(a)}else e._stack_right.length&&(e._stack_right.unshift(n),t.hide(),e.updateStackNum("folder",1)),e.append(t),e.order.push(n);e.windows[n]=t,e.slideCheck(),e.fireEvent("append"),setTimeout(function(){e.fireEvent("changed")}),i||(t.addEvent("fold",function(t){r.log2("窗口折叠/展开: ",t.data);var i=[];i.push(t.data?{act:"fold",target:n}:{act:"unfold",target:n}),i.length&&e.fireEvent("changed",{data:i})}),t.addEvent("message",function(){e.fireEvent("changed",{})}),t.addEvent("focus",function(i){e.foldAll(n);var a=e.isInStack(t.id);a&&0==i.focus&&e.openFromFolder(t.id),e.fireEvent("focus")}),t.addEvent("close",function(){e.removeWindow(t);var i={act:"close",target:n};e.fireEvent("changed",{data:i})}))},this.addPlaceholder=function(e,t){var n=new s;n.id=t.id,n.stat=t,e.windows[t.id]=n,e.append(n),e.order.push(t.id),e._placeholder++},this.applyChange=function(e,t){var t=[].concat(t);r.log2("winslider正在applyChange: ",t),t.forEach(function(t){if("winslider"==t.target)e._unfold_window=t.stat._unfold_window;else if("winslider_slide"==t.target)e.isInStack(t.to)==t.lr&&e.slideTo(t.to,t.lr);else{var n=e.windows[t.target];if(!n)return;"closefolded"==t.act?e.removeFolded(n):(n[t.act](!0),"close"==t.act&&e.removeWindow(n))}})},this.appendAfter=function(e,t,n,i){e.parent(t,i),e.windows[n]=t},this.removeWindow=function(e,t){var n=t.id,i=e.order.indexOf(n);e.order.splice(i,1),delete e.windows[n],e.remove(t);var a=e.isInStack(n);a&&e.updateStackNum(a,-1),e.slideCheck(-1),e.fireEvent("remove",{data:n,rest:e.getLength()})},this.getStats=function(e){var t={};return e.getOrder().forEach(function(n){t[n]=e.windows[n].getStat()}),t.left=e._stack_left.length,t.right=e._stack_right.length,t},this.setWidth=function(e,t){var t=t-330;111>t&&(t=111),r.log2("设置winslider宽度 ",t),e._boundary=t,e.slideCheck(0)},this.show=function(e){e.nodes;e.updateStackNum("left",0),e.updateStackNum("right",0),e.showFolder()},this.hide=function(e){e.hideFolder()},this.getOrder=function(e){return e.order}}),l=new Class(o,function(){this.name="B",this.makeFrameHTML=function(){r.log2("init Drawer_Window");var e=['<div class="panelbarbutton">','	<a href="#nogo" onclick="return false;" class="wp-chat-close">关闭</a>','	<p class="" title="窗口名">窗口名</p>',"</div>",'<article class="chat-window"'+(XN.browser.IE6?'style="overflow-x:hidden;"':"")+">","	<header>","		<h4> </h4>","		<menu>",'			<li title="最小化" label="最小化" class="minimize">最小化</li>','			<li title="关闭" class="close">关闭</li>',"		</menu>",'		<div class="disconnect-tips"><img src="http://a.xnimg.cn/a.gif" class="error_notic" />您已经离线，无法发送消息，请上线后再次尝试</div>',"	</header>",'	<section> <div class="dialog with-topic"></div> ','	<article class="topic-box"> </article></section>',"</article>"].join("");return e},this.getUIRef=function(e){this.parent(e),e.nodes.drawer=e.frame.getElement("section>article.topic-box")},this.addExitBtn=function(e){var t=e.nodes,n=i.getDom('<li class="wp-quit" title="嫌他们烦,可以退出讨论">退出</li>');t.wmenu.insertBefore(n,t.mbtn),n=i.getElement("li.wp-quit",t.wmenu),n.addEvent("click",function(t){t.cancelBubble=!0,e.fireEvent("exit")})}});e.WinSlider=d,e.Window=o,e.WindowWithDrawer=l}),object.define("webpager/lib/emoticons","./base",function(require,e){var t=require("./base");!function(){function e(){this._cache={}}function n(e){var t=function(t){return this instanceof arguments.callee?(this.config={},$extend(this.config,e),this.ID=XN.util.createObjID(),$extend(this.config,t),this.init()):new arguments.callee(t)};return $extend(t.prototype,{name:"",init:function(){},getConfig:function(e){return this.config[e]},setConfig:function(e,t){return this.config[e]=t,this},getId:function(e){return this.name+"_"+this.ID+"_"+e},getEl:function(e){return $(this.getId(e))}}),t}function i(e){var t,n=!1,i=$extend({},e),a=null;return e.waitTime&&e.onTimeout&&(n=!0,i.onSuccess=function(n){window.clearTimeout(t),e.onSuccess(n)},i.onError=function(n){window.clearTimeout(t),e.onError(n)},t=setTimeout(function(){e.onTimeout.call(a);try{a.abort()}catch(t){XN.log(t)}},e.waitTime)),a=new XN.net.xmlhttp(i)}e.prototype={add:function(e,t){this._cache[e]=t},del:function(e){return delete this._cache[e],null},get:function(e){return this._cache[e]}};var a=function(e){var t=Object.prototype.toString.call(e).replace(/\[object ([^\]]*)\]/,"$1").toLowerCase();return-1!=t.indexOf("html")&&(t="element"),t},r=new e,o=new e;XN.ui.emotions=n({url:"http://status."+XN.env.domain+"/getubblist.do?type=1&t="+Math.random(),container:"",isShowVipEmos:!1,emoKind:{0:{name:"默认表情",forvip:0,active:1},1:{name:"阿狸",forvip:1},2:{name:"囧囧熊",forvip:1}},onParseEmo:function(e){XN.log(e)}}),$extend(XN.ui.emotions.prototype,{name:"emotions",emoList:[],init:function(){return this.getConfig("container").getAttribute("emo_obj_id")?o.get(this.getConfig("container").getAttribute("emo_obj_id")):(this.getEmotions(),this)},getEmotions:function(){var e=this,t=this.getConfig("url"),n=function(){XN.DO.showError("获取表情列表失败，请稍候重试")};return r.get(t)&&r.get(t).ubbList&&r.get(t).ubbList.length>0?(e.buildPanelHtml(),!1):void new i({url:t,method:"GET",onSuccess:function(n){window.setTimeout(function(){r.add(t,n.responseText),e.buildPanelHtml()},0)},onError:n,waitTime:5e3,onTimeout:n})},formatData:function(e){var t,n=$extend({},this.getConfig("emoKind"));for(var i in n)n[i].data=[];for(var a=0,r=e.length;r>a;a++)t=e[a],n[t.kind].data.push(t);for(var i in n)n[i].data.length||delete n[i];return n},getSingleEmoHtml:function(e,t){var n=XN.browser.IE6?" onmouseover=\"this.style.borderColor='#808080'\" onmouseout=\"this.style.borderColor='#B8D4E8'\"":"",i='<li title={{alt}} {{_ie6patch}}><img emosrc="http://a.xnimg.cn{{src}}" alt="{{alt}}" emotion="{{ubb}}" preview="{{preview}}" forvip="{{forvip}}" /></li>';e.preview=2==e.size?1:0,e.forvip=t.forvip?1:0,e._ie6patch=XN.browser.IE6?n:"";for(var a in e)i=i.replace(new RegExp("{{"+a+"}}","g"),e[a]);return i},buildPanelHtml:function(){var e=XN.json.parse(r.get(this.getConfig("url")));e.emoKind&&(this.emoKind=e.emoKind),this.emoList=this.formatData(e.ubbList),this.config.isShowVipEmos=e.canParseVipEmos;var t=this.emoList,n=this,i=(this.getConfig("emoKind"),[]),a=[],o=0,s=null;for(var d in t){for(s=t[d],i.push('<ul class="emo-list" style="display:'+(s.active?"block":"none")+'" id="'+this.getId("emoList"+d)+'">'),o=0;s.data[o];)i.push(this.getSingleEmoHtml(s.data[o],s)),o++;i.push("</ul>"),a.push('<li id="'+this.getId("emoTab"+d)+'"><a href="#nogo" onclick="return false;" onfocus="this.blur()"> '+s.name+" </a></li>")}var l=['<div class="m-editor-emo-holder" id="'+this.getId("emoHolder")+'" style="padding:1px">','<div class="emo-header" id="'+this.getId("emoTabHolder")+'" style="display:none">','<ul class="emo-tab" id="'+this.getId("emoTab")+'">',a.join(""),"</ul>",'<div class="emo-tab-switch" id="'+this.getId("emoTabSwitch")+'" style="display:none">','<a href="#nogo" onclick="return false;" title="前一组表情" class="left" id="'+this.getId("movLeft")+'" ><span ></span></a>','<a href="#nogo" onclick="return false;" title="后一组表情" class="right" id="'+this.getId("movRight")+'" ><span ></span></a>',"</div>","</div>",'<div class="emo-holder" id="'+this.getId("emoList")+'">',i.join(""),"</div>",'<div class="notVip-tip clearfix" id="'+this.getId("notVipTip")+'" style="display:none;">','<div class="emotion-icon">','   <img src="http://xnimg.cn/imgpro/icons/grade/cjbq.png"  />',"	<p>超级表情</p>","</div>",'<p>对不起，该功能需要<span class="red">等级9级以上</span>或者<span class="red">开通VIP</span>才可以使用。</p>','	<p class="btn">','	<a href="http://i.renren.com/pay/pre?wc=370000" class="join-vip" target="_blank"></a>','	<a href="http://sc.renren.com/scores/myscore" class="lookup-class" target="_blank"></a>或',"</p>","</div>","</div>"].join("");this.getConfig("container").setContent(l),this.cacheEls(),this.showFirstGroupEmos(),setTimeout(function(){n.renderTabs(),n.fireEvent("renderEmotions")},0)},renderTabs:function(){var e=0,t=this.tabView=new XN.ui.tabView({activeClass:"current"}),n=this;for(var i in this.emoList)t.addTab({label:n.getId("emoTab"+i),active:n.emoList[i].active,onActive:function(e){return function(){var i=t.getCurrentTab().label.id||t.getCurrentTab().label,a=$(n.getId("emoList"+e));a.show(),n.emoList.imgRended||(a.innerHTML=a.innerHTML.replace(/emosrc/g,"src"),n.emoList[e].imgRended=!0),$(i.replace("emoTab","emoList")).hide(),n._previewHolder&&n._previewHolder.hide(),n.hideNotVip(),n.fireEvent("tabSwitch",$(n.getId("emoTab"+e)),$(n.getId("emoList"+e)))}}(i),onClick:function(e){return function(){n.fireEvent("tabClick",$(n.getId("emoTab"+e)),$(n.getId("emoList"+e)))}}(i)}),e++;this.uiEmoTabHolder[e>1?"show":"hide"](),e>0&&this.initTabSwitcher()},initTabSwitcher:function(){var e=!1,n=this;this.emoHolderInitX=this.getEl("emoTabHolder").realLeft(),this.emoHolderWidth=this.getEl("emoTabHolder").offsetWidth,this.emoHolderMaxX=this.emoHolderInitX+this.emoHolderWidth;for(var i in this.emoList)e||(e=this.getEl("emoTab"+i).realLeft()+this.getEl("emoTab"+i).offsetWidth>this.emoHolderMaxX?!0:!1);if(!e)return!1;this.getEl("emoTabSwitch").show(),this.tabArray=[],this.curTab=0;for(var i in n.emoList)this.tabArray.push(i);t.addEvent(n.getEl("movLeft"),"click",function(){n.curTab=--n.curTab<=0?0:n.curTab,n.moveTab(n.tabArray[n.curTab],n.curTab,n.tabArray)}),t.addEvent(n.getEl("movRight"),"click",function(){n.curTab=++n.curTab==n.tabArray.length?n.tabArray.length-1:n.curTab,n.moveTab(n.tabArray[n.curTab],n.curTab,n.tabArray)})},moveTab:function(e,t,n){var i=this.getEl("emoTab"+e).realLeft(),a=(this.getEl("emoTab"+e).offsetWidth,0);t>0&&($(this.getEl("movLeft").getElementsByTagName("span")[0]).style.borderRightColor="#B8D4E8"),0==t&&($(this.getEl("movLeft").getElementsByTagName("span")[0]).style.borderRightColor="#CCC"),t==n.length-1&&($(this.getEl("movRight").getElementsByTagName("span")[0]).style.borderLeftColor="#CCC"),t<n.length-1&&($(this.getEl("movRight").getElementsByTagName("span")[0]).style.borderLeftColor="#B8D4E8"),a=this.emoHolderInitX-i,this.uiEmoTab.style.left=parseInt(XN.element.getStyle(this.uiEmoTab,"left"))+a+"px"},initEvent:function(){var e=this;t.addEvent(this.uiEmoHolder,"click",function(t){var n=t||window.event;e.parseEmotion(n),n.cancelBubbled?n.cancelBubbled=!0:n.stopPropagation()}),t.addEvent(this.uiEmoHolder,"mouseover",function(t){XN.event.stop(t||window.event),e.previewEmotion(t)}),t.addEvent(this.uiEmoHolder,"mouseout",function(t){e.hidePreviewEmotion(t)})},parseEmotion:function(e){var t=XN.event.element(e),n=this,i=t.tagName.toLowerCase();if(this.fireEvent("emoConClick"),!/li|img/.test(i))return!1;if("li"==i&&(t=t.getElementsByTagName("img")[0]),!t)return!1;var a=parseInt(t.getAttribute("forvip")),r=t.getAttribute("emotion"),o=this.getConfig("isShowVipEmos");a&&!o?n.showNotVip(e):n.getConfig("onParseEmo").call(n,{imgsrc:t.src,ubb:r,forvip:a},e)},hide:function(){this.uiEmoHolder.hide(),this._previewHolder&&this._previewHolder.hide()},cacheEls:function(){this.uiEmoList=this.getEl("emoList"),this.uiEmoHolder=this.getEl("emoHolder"),this.uiEmoTabHolder=this.getEl("emoTabHolder"),this.uiEmoTab=this.getEl("emoTab"),this.uiNotVipTip=this.getEl("notVipTip")},showFirstGroupEmos:function(){var e,t=this;for(var n in this.emoList)this.emoList[n].active&&(e=$(t.getId("emoList"+n)),e.innerHTML=e.innerHTML.replace(/emosrc/g,"src"));return this.uiEmoHolder.show(),this.initEvent(),!0},hideEmotion:function(){this._previewHolder&&this._previewHolder.hide(),this._emoHolder&&this._emoHolder.hide()},showNotVip:function(e){XN.event.stop(e||window.event),this.uiEmoList.hide(),this.uiNotVipTip.show(),this._previewHolder&&this._previewHolder.hide(),this.fireEvent("showNotVip")},hideNotVip:function(){this.uiNotVipTip.hide(),this.uiEmoList.show()},previewEmotion:function(e){var n=XN.event.element(e),i=n.tagName.toLowerCase();
if("li"==i&&(n=n.getElementsByTagName("img")[0]),"li"!=i&&"img"!=i)return this._previewHolder&&this._previewHolder.hide(),!1;if(!n)return!1;var a=parseInt(n.getAttribute("preview"));if(a){if(!this._previewHolder){var r=this._previewHolder=new XN.ui.fixPositionElement({alignWith:this.uiEmoList,tagName:"div",alignType:"2-2",offsetX:XN.browser.IE6?-1:XN.browser.IE?1:0,offsetY:XN.browser.IE?1:0});r.container.setStyle("background:#fff;padding:1px;width:50px;height:50px;border:1px solid #B8D4E8;"),r.container.className="meditor-emo-preview",r.container.id=this.getId("mEditorPreviewHolder"),r.setContent('<img id="'+this.getId("previewIMG")+'" class="m-editor-preview-img" src="'+n.src+'" />'),t.addEvent(this.getEl("mEditorPreviewHolder"),"mouseover",function(){var e="1-1"==r.alignType?"2-2":"1-1";if(XN.browser.IE6){var t="1-1"==r.alignType?-1:1;r.setOffsetX(t)}r.setAlignType(e)})}this.getEl("previewIMG").src=n.src,this._previewHolder.show()}},hidePreviewEmotion:function(e){el=XN.event.element(e),"ul"==el.tagName.toLowerCase()&&this._previewHolder&&this._previewHolder.hide()}}),XN.event.enableCustomEvent(XN.ui.emotions.prototype),XN.ui.quickSwfupload=n({uploadUrl:"http://upload."+XN.env.domain+"/uploadservice.fcgi?pagetype=gossipAddPhoto&societyguester="+XN.cookie.get("societyguester")+"&hostid="+XN.cookie.get("id")+"&t="+XN.cookie.get("t"),swfPath:"http://s.xnimg.cn/jspro/swfupload.v2.2.0.1/swfupload.swf",replaceElId:null,onUploadSuccess:function(e){XN.log(e)},onUploadProgress:function(e,t,n){XN.log(e,t,n)},buttonTxt:null,buttonWidth:null,buttonHeight:null,buttonStyle:".text {text-align:left;color:#005EAC;font-family:tahoma,simsun;font-size:12px;font-family:Tahoma,Verdana,simsun,sans-serif;}"}),$extend(XN.ui.quickSwfupload.prototype,{name:"miniUpload",init:function(){return $(this.getConfig("replaceElId"))?window.SWFUpload?(this.getConfig("buttonTxt")||(this.config.buttonTxt=$(this.getConfig("replaceElId")).innerHTML),this.getConfig("buttonWidth")||(this.config.buttonWidth=$(this.getConfig("replaceElId")).offsetWidth),this.getConfig("buttonHeight")||(this.config.buttonHeight=$(this.getConfig("replaceElId")).offsetHeight),this.renderUI(),this):(XN.log("依赖的swfupload.js没有引入"),!1):(XN.log("必须传入一个被flash替换的元素"),!1)},renderUI:function(){var e=this;this.uploader=new SWFUpload({upload_url:e.getConfig("uploadUrl"),flash_url:e.getConfig("swfPath"),file_size_limit:"10 MB",file_types:"*.jpg;*.jpeg;*.png;*.bmp;*.gif",file_types_description:"All Image Files",file_upload_limit:60,file_queue_limit:0,debug:!1,button_placeholder_id:e.getConfig("replaceElId"),button_cursor:SWFUpload.CURSOR.HAND,button_width:e.getConfig("buttonWidth"),button_height:e.getConfig("buttonHeight"),button_image_url:"http://a.xnimg.cn/a.gif",button_text:e.getConfig("buttonTxt"),button_text_style:e.getConfig("buttonStyle"),button_text_top_padding:2,button_action:SWFUpload.BUTTON_ACTION.SELECT_FILE,button_cursor:SWFUpload.CURSOR.HAND,button_window_mode:SWFUpload.WINDOW_MODE.TRANSPARENT,file_queued_handler:function(){this.startUpload()},upload_error_handler:function(e,t,n){XN.DO.showError(n+""+t+e)},upload_progress_handler:function(t,n,i){e.getConfig("onUploadProgress").call(e,t,n,i)},upload_success_handler:function(t,n){var i=XN.json.parse(n);$extend(i,{file:t}),e.getConfig("onUploadSuccess").call(e,i)}})}});var s=new e;getEmoticonsInstance=function(e){return s.get(e)},XN.ui.emoticons=n({input:null,button:null,atButton:null,isShowVipEmos:!1,showAddPhoto:!1,keepShow:!1,hideEmoBtn:!1,emoBtnDes:"表情",emoPopDelay:0,emoPopFixed:!1,btnAlignWith:null,btnAlignType:"3-2",btnOffsetX:0,btnOffsetY:-1,onShowEmoPop:XN.func.empty,onEmoTabSwitch:XN.func.empty,onEmoTabClick:XN.func.empty,onEmoConClick:XN.func.empty,onEmoNotVip:XN.func.empty}),$extend(XN.ui.emoticons.prototype,{name:"miniEditor",pos:{},init:function(){return $(this.getConfig("input"))?this.getConfig("input").getAttribute("eicons_obj_id")?s.get(this.getConfig("input").getAttribute("eicons_obj_id")):(this.setConfig("emoTrigger",[]),this.input=$(this.getConfig("input")),this.initEvent(),this.initEmotions(),this.getConfig("showAddPhoto")&&this.initQuickSwfupload(),this.getConfig("atBtn")&&this.initMentionBtn(),this.input.setAttribute("eicons_obj_id",this.ID),s.add(this.ID,this),this):(XN.log("必须传入要赋值的input"),!1)},initEvent:function(){var e=this.input,n=this.getInputPos.bind(this);t.addEvent(e,"keyup",n),XN.browser.WebKit?t.addEvent(e,"blur",n):t.addEvent(e,"focus",n),t.addEvent(e,"mouseup",n),XN.dom.ready(n)},initEmotions:function(){var e=this;this.emotionsContainer=new XN.ui.fixPositionElement({alignWith:e.getConfig("btnAlignWith")||e.input,tagName:"div",alignType:e.getConfig("btnAlignType"),offsetX:e.getConfig("btnOffsetX"),offsetY:e.getConfig("btnOffsetY")}),this.emotionsContainer.frame.style.width="338px",this.emotionsContainer.container.addClass("m-editor"),this.emotionsContainer.hide(),this.getConfig("emoPopFixed")&&(XN.browser.IE6?(this.emotionsContainer.frame.style.position="absolute",t.addEvent(window,"scroll",function(){e.hideEmoPop()})):this.emotionsContainer.frame.style.position="fixed"),setTimeout(function(){e.initEmoEvents()},0)},hideEmoPop:function(){this.emotionsContainer.hide(),this.emotions&&this.emotions._previewHolder&&this.emotions._previewHolder.hide(),this.showEmoBtn(!0),this.fireEvent("hideEmoticons")},showEmoPop:function(e){var t=this,n=function(){setTimeout(function(){this.showEmoBtn(!1),this.emotionsContainer.show(),this.fireEvent("showEmoticons"),this.getConfig("onShowEmoPop").bind(this)()}.bind(this),this.getConfig("emoPopDelay"))}.bind(this),i=function(){this.getConfig("onEmoTabSwitch").bind(this)()}.bind(this);if(scProxy=function(){this.getConfig("onEmoTabClick").bind(this)()}.bind(this),sVipProxy=function(){this.getConfig("onEmoNotVip").bind(this)()}.bind(this),sECProxy=function(){this.getConfig("onEmoConClick").bind(this)()}.bind(this),this.emotions)n();else{var t=this,a={container:t.emotionsContainer.container,isShowVipEmos:t.getConfig("isShowVipEmos"),onParseEmo:function(e,n){t.setValue(e.ubb),n.ctrlKey||t.getConfig("keepShow")||t.hideEmoPop()}};$extend(a,this.getConfig("url")?{url:t.getConfig("url")}:{}),this.emotions=new XN.ui.emotions(a),this.emotions.addEvent("renderEmotions",n),this.emotions.addEvent("tabSwitch",i),this.emotions.addEvent("tabClick",scProxy),this.emotions.addEvent("showNotVip",sVipProxy),this.emotions.addEvent("emoConClick",sECProxy)}XN.event.stop(e||window.event)},showEmoBtn:function(e){return this.getConfig("hideEmoBtn")?!1:void(this.getEl("emoBtn")&&this.getEl("emoBtn")[e===!0?"show":"hide"]())},initEmoEvents:function(){var e=this,n=this.showEmoPop.bind(this);this.getConfig("button")&&this.getConfig("emoTrigger").push({el:e.getConfig("button"),evt:"click"}),XN.array.each(this.getConfig("emoTrigger"),function(e,i){if("string"===a(i)){var r=i.split(":");i={el:r[0],evt:r[1]}}"focus"==i.evt.toLowerCase()&&(i.evt="click"),t.addEvent(i.el,i.evt,n)}),t.addEvent(document,"click",this.hideEmoPop.bind(this)),this.input.mention&&this.input.mention.addEvent("refocus",function(){e.getInputPos()})},initQuickSwfupload:function(){},initMentionBtn:function(){var e=this;t.addEvent(this.getConfig("atBtn"),"click",function(){var t="@",n=XN.form.help(e.input).getRealValue();"@"==n.slice(e.pos.start-1,e.pos.start)&&(t=""),e.setValue(t),setTimeout(function(){e.input.mention&&e.input.mention.check(),e.input.mention.addEvent("refocus",function(){e.getInputPos()})},0)})},pos:{},getInputPos:function(){try{this.pos=XN.form.help(this.input).cursorPosition()}catch(e){this.pos={start:0,end:0,item:[0,0]},XN.log(e)}},setValue:function(e){var t=this.input,n=this,i=XN.form.help(t).getRealValue();t.value=i.slice(0,n.pos.start)+e+i.slice(n.pos.end),XN.form.help(t).focus(n.pos.start+e.length),XN.browser.WebKit?window.setTimeout(function(){n.getInputPos()},0):n.getInputPos()},fireFocus:function(){if(document.createEvent){var e=document.createEvent("MouseEvents");e.initEvent("click",!0,!1),this.input.dispatchEvent(e)}else this.input.fireEvent("onfocus")}}),XN.event.enableCustomEvent(XN.ui.emoticons.prototype)}(),e.emoticons=XN.ui.emoticons}),object.define("webpager/lib/channel_api","./base",function(require,e){var t=(require("./base"),window.webpager),n={getWpiCookie:function(e){return window.imengine.imHelper.getCookie(e)},setWpiCookie:function(e,t,n,i){var a=this;this.cookieTimer&&clearTimeout(this.cookieTimer);var r=function(){window.imengine.imHelper.setCookie(e,t,n),a.preModelStatus=t};i?r():this.cookieTimer=setTimeout(function(){r()},50)},storageSet:function(){return window.webpager.setItem.apply(window.webpager,arguments)},storageGet:function(){return window.webpager.getItem.apply(window.webpager,arguments)}},i={isOnline:!1,connConf:1,init:function(){this.connTry=new XN.webpager.tryer,this.disconnTry=new XN.webpager.tryer,0===n.getWpiCookie("c")&&this.disConnect(),this.bindEvent()},bindEvent:function(){var e=this;n.addEvent("persist_conn_dif",function(n){n?e.fireEvent("mgr_connected"):(t.isLocalConnect()&&e.disConnect(),e.fireEvent("mgr_disConnected"))}),this.connTry.addEvent("tryer_timeout",function(){e.connectFaild()}),this.connTry.addEvent("tryer_sus",function(){e.fireEvent("mgr_connected")}),this.disconnTry.addEvent("tryer_sus",function(){e.fireEvent("mgr_disConnected")})},isLocalConnect:function(){return t.isLocalConnect()},connect:function(){var e=this;this.isOnline=!0,this.fireEvent("mgr_connecting"),t.enableConn(!0),this.connTry.tryAWhile(1e3,2e4,function(){return logger.log1("连接状态: "+t.getConnState()),t.getConnState()?(e.saveConn(!0),!0):void 0})},disConnect:function(e){var n=this;this.isOnline=!1,t.enableConn(!1),this.disconnTry.tryAWhile(1e3,2e4,function(){return logger.log1("连接状态: "+t.getConnState()),t.getConnState()?void 0:(e!==!1&&n.saveConn(!1),!0)})},saveConn:function(e){this.connConf=e,n.savethis("c",e?1:0)},getConnState:function(){return t.getConnState()},connectFaild:function(){this.isOnline=!1,this.fireEvent("mgr_connectFaild")}};XN.event.enableCustomEvent(i),e.connectMgr=i,e.persistMgr=n,e.playSound=function(){window.imengine.imHelper.playSound()},e.imengine=window.imengine}),object.define("webpager/lib/voice","./base, ./tools",function(require,e){function t(){var e=d.getAttribute("time");d.className="voice",d.innerHTML="<var>"+e+'</var><sub>"</sub>',d.title="点击播放语音"}var n=require("./base"),i=n.XN,a=(n.readly,n.dom),r=a.getElement("#bottombar"),o=document.createElement("span");voice_decode_obj=document.createElement("span"),o.id="voice_encode_obj",voice_decode_obj.id="voice_decode_obj",r.appendChild(o),document.getElementsByTagName("html")[0].appendChild(voice_decode_obj);var s=null,d=null,l=null,c=null,u=0;e.loadEncodeSwf=function(){e.getTicket(function(e){i.loadFile("http://s.xnimg.cn/n/lib/swfobject-2.2/swfobject.js",function(){var t={wmode:"transparent",allowscriptaccess:"always"},n={userId:i.user.id,userTick:e};swfobject.embedSWF("http://s.xnimg.cn/apps/session/res/swf/encode-voice.swf?v=48","voice_encode_obj","320","160","10.0.0","",n,t)})})},e.getTicket=function(t){new i.net.xmlhttp({url:"http://message.renren.com/message/ticket/voice",method:"get",onSuccess:function(n){t.call(e,n.responseText)}})},e.checkMicro=function(e){window.setTimeout(function(){l.style.visibility="visible",l.isSuportMic()?(u=0,e.onVoiceStart(l),l.startRecording()):e.noneMicroTip()},0)},e.sendOgg=function(){l.sendOgg()},e.prepVoice=function(t,n){return s?window.confirm("正在录音是否取消?")?void cancelVoice():void 0:(!l||u?n.onVoiceLoading():e.checkMicro(n),s=n,e.cur_obj=s,window.cancelVoice=function(t){t&&(u=1),l.style.visibility="hidden",s=null,e.cur_obj=null,e.pauseCurPlay()},window.sendVoice=function(t,i){l.style.visibility="hidden",n.onVoiceFinished(t,i),s=null,e.cur_obj=null},window.loadEncodeSwfSuc=function(){setTimeout(function(){a.getElement(".wp-voice-prep",s.frame).dispose(),l=document.getElementById("voice_encode_obj"),e.checkMicro(s)},0)},void(window.allowDevice=function(){setTimeout(function(){l.style.height="66px",l.style.overflow="hidden"},10)}))},e.loadDecodeSwf=function(){i.loadFile("http://s.xnimg.cn/n/lib/swfobject-2.2/swfobject.js",function(){var e={wmode:"transparent",allowscriptaccess:"always"};swfobject.embedSWF("http://s.xnimg.cn/apps/session/res/swf/decode-voice.swf?v=7","voice_decode_obj","1","1","10.0.0","","",e)})},e.playVoice=function(t){return c?(d&&d.getAttribute("path")!=t.getAttribute("path")&&e.pauseCurPlay(),d=t,t.className="play",t.innerHTML="",t.title="点击暂停播放",void setTimeout(function(){c.voicePlay(t.getAttribute("path"))},0)):(d=t,void e.loadDecodeSwf())},e.completePlay=function(){t(),d=null},e.pauseCurPlay=function(){d&&(t(),c.voicePlay(d.getAttribute("path")))},e.prepPlay=function(){window.loadDecodeSwfSuc=function(){c=document.getElementById("voice_decode_obj"),e.playVoice(d)},window.playFinish=function(){e.completePlay()}}}),function(){if(!XN.vocalPlayer){XN.namespace("XN.vocalPlayer");var e={flashSource:"",flashUrl:"http://s.xnimg.cn/n/apps/status/module/vocal/swf/player_v1.0.swf",swfobjectUrl:"http://s.xnimg.cn/xnapp/common/js/swfobjectv2.js",flashReady:!1,flashId:"vocalPlayerEl",flashvars:{},flashParams:{wmode:"transparent",allowscriptaccess:"always"},start:function(t){var n=this;t&&(this.flashSource=t),this.flashReady?(this.flashPlayerObj.setFileUrl(this.flashSource),this.play()):XN.loadFiles([this.swfobjectUrl],function(){e.flashReady=!0,n.initFlash()})},initFlash:function(){if(!swfobject.ua.pv[0])return XN.Do.alert({msg:'您未安装flash播放器，请<a href="http://www.adobe.com/go/getflash/" target="_blank">点击下载</a>安装最新的flash后刷新页面'}),this.fireEvent("flashFailed"),this.flashReady=!1,this.flashFailed=!0,!1;var e=document.createElement("div");e.style.cssText="position:absolute;left:0;top:0;width:1px;height:1px",e.setAttribute("id",this.flashId),document.body.appendChild(e),swfobject.embedSWF(this.flashUrl,this.flashId,"1","1","10.0.0","",this.flashvars,this.flashParams),XN.browser.IE6&&($(this.flashId).style.position="absolute",$(this.flashId).style.top=document.documentElement.scrollTop+"px")},play:function(){this.flashFailed||this.flashPlayerObj.fl_play()},pause:function(){this.flashFailed||this.flashPlayerObj.fl_pause()}};XN.vocalPlayer=e,XN.vocalPlayer.flashAdded=function(){e.flashPlayerObj=$(XN.vocalPlayer.flashId),e.start(),e.fireEvent("flashReady")},XN.vocalPlayer.mp3Added=function(){e.fireEvent("videoReady")},XN.vocalPlayer.playEnd=function(){e.fireEvent("videoEnd")},XN.event.enableCustomEvent(XN.vocalPlayer)}}(),object.add("xn.vocalPlayer","dom, events",function(e,t,n){var i=new Class({initialize:function(e,n){object.extend(e,n),e.total&&e.trigger&&e.url&&(t.wrap(e.trigger),e.bindClick(),i.instances.push(e),Sizzle(".vocal-count",e.trigger.parentNode).length>0&&(e.counter=Sizzle(".vocal-count",e.trigger.parentNode)[0]),Sizzle(".num",e.trigger).length>0&&(e.numer=Sizzle(".num",e.trigger)[0]),null!=e.trigger.hideFocus&&(e.trigger.hideFocus=!0))},bindClick:function(e){e.running=!1,e.lastPauseAt=0,XN.vocalPlayer.addEvent("videoReady",function(){e.endLoading(),e.isCurrent&&(e.run(),e.running=!0,XN.element.addClass(e.trigger,"vocal-running"))}),XN.vocalPlayer.addEvent("flashFailed",function(){e.end(),e.endLoading()}),e.trigger.addEvent("click",function(t){if(XN.event.stop(t),i.setCurrent(e),e.running)XN.vocalPlayer.pause(),e.pause(),e.running=!1,$(e.trigger).delClass("vocal-running");else{if(0===e.lastPauseAt?(e.startLoading(),XN.vocalPlayer.start(e.url)):XN.vocalPlayer.play(),XN.vocalPlayer.flashFailed)return;e.addCount()}},n.HOLD)},addCount:function(e){if(e.ownerId&&e.voiceId){e.psource||(e.psource="10001");var t,n="";if(e.trigger.hasClassName("vocal-player-tiny")?(t="http://voice.renren.com/comment/incPlayCount",n="replyer="+e.ownerId+"&commentId="+e.voiceId+"&owner="+e.sourceOwner+"&source="+e.sourceId+"&ugcType="+e.ugcType):t=e.photoId?"http://photo.renren.com/photo/"+e.ownerId+"/photo-"+e.photoId+"/addPlayCount?voiceId="+e.voiceId+"&psource="+e.psource:"http://voice.renren.com/"+e.ownerId+"/"+e.voiceId+"/addVC",new XN.net.xmlhttp({url:t,method:"POST",data:n}),e.counter){var i=e.counter.innerHTML.match(/\d+/)[0];e.counter.innerHTML=e.counter.innerHTML.replace(i,parseInt(i)+1)}}},startLoading:function(e){if(Sizzle(".time",e.trigger).length>0&&(Sizzle(".time",e.trigger)[0].style.display="none"),Sizzle(".loading",e.trigger).length>0)Sizzle(".loading",e.trigger)[0].style.display="block";else{var n=t.getDom('<div class="loading">···</div>');e.trigger.appendChild(n)}e.loadChange()},loadChange:function(e){var t=0,n=["","·","··","···"],i=Sizzle(".loading",e.trigger)[0];i&&(e.loadTimer=setInterval(function(){i.innerHTML=n[t++%4]},400))},endLoading:function(e){Sizzle(".time",e.trigger).length>0&&(Sizzle(".time",e.trigger)[0].style.display="block"),Sizzle(".loading",e.trigger).length>0&&(Sizzle(".loading",e.trigger)[0].style.display="none",clearInterval(e.loadTimer))},run:function(e){var t,n,i,a=(new Date).getTime();"undefined"==typeof e.lastPauseAt&&(e.lastPauseAt=0),e.runner=setInterval(function(){return t=(new Date).getTime(),e.percent=e.lastPauseAt+(t-a)/e.total/1e3,n=12-Math.floor(12*e.percent),e.numer&&(i=Math.round(e.total*(1-e.percent)),e.numer.innerHTML=i),e.percent>=1?(e.end(),!1):void 0},100)},pause:function(e){e.lastPauseAt=e.percent,clearInterval(e.runner)},end:function(e){e.pause(),clearInterval(e.runner),e.running=!1,e.lastPauseAt=e.percent=0,$(e.trigger).delClass("vocal-running"),e.endLoading(),e.isCurrent=!1,e.numer&&(e.numer.innerHTML=e.total)},reset:function(e,t){e.end(),object.extend(e,t),$(XN.vocalPlayer.flashId)&&($(XN.vocalPlayer.flashId).remove(),XN.vocalPlayer.flashReady=!1)}});i.instances=[],i.setCurrent=function(e){for(var t=i.instances.indexOf(e),n=i.instances.length,a=0;n>a;a++)a!=t?i.instances[a].end():i.instances[a].isCurrent=!0},e.Player=i}),object.use("xn/vocalPlayer, dom, events",function(e,t,n){t.ready(function(){t.wrap(document.body).delegate(".vocal-player","mouseover",function(){if(!this.playerInited){this.playerInited=!0;var t=XN.JSON.parse(this.getAttribute("data-vocal")),n=this;this.player=new e.Player({total:t.time,trigger:this,url:t.url,ownerId:t.ownerId,voiceId:t.voiceId,photoId:t.photoId||"",psource:t.psource||"",sourceOwner:t.sourceOwner||"",sourceId:t.sourceId||"",ugcType:t.ugcType||0}),window.asyncHTMLManager&&!e.Player.asyncInited&&(e.Player.asyncInited=!0,asyncHTMLManager.addEvent("beforeload",function(){e.Player.instances.forEach(function(e){e.reset()}),n.playerInited=!1})),window.newsfeed&&!e.Player.feedInited&&(e.Player.feedInited=!0,newsfeed.addEvent("beforereload",function(){e.Player.instances.forEach(function(e){e.reset()})}))}},n.HOLD)})}),object.define("webpager/FriendSelect","webpager/lib/base, webpager/lib/tools",function(require,e){{var t=require("webpager/lib/base");t.dom,require("webpager/lib/tools")}e.FriendSelect=new Class(function(){this.__mixins__=[t.events.Events],this.initialize=function(e,t,n){if(e.url="http://friend."+XN.env.domain+"/friendsSelector.do",n)for(var i in n)e[i]=n[i];e.p={init:!0,uid:!0,uhead:!0,uname:!0,page:"",query:"",param:{}},e.p2=encodeURIComponent(JSON.stringify(e.p)),e.friendList=null,e.allFriends=null,e.query=null,e.onChangeInterval=null,e.delayInterval=500,e.searcher=null,e.memberList=[],e.memberName=[],e.Memberlen=0,e.buildFrame(t)},this.clear=function(e){jxn(".wp-friend-slider .member").remove(),jxn(".wp-friend-list .selected").removeClass("selected"),e.members&&e.members.wrap.css("margin-left",0),e.prevBtn&&e.prevBtn.addClass("disabled"),e.nextBtn&&e.nextBtn.addClass("disabled"),e.confirmBtn&&e.confirmBtn.addClass("wp-friend-confirm-disable"),e.memberList=[],e.memberName=[],e.searcher&&e.searcher.val(""),e.resetList()},this.enableBtn=function(e){e.confirmBtn&&e.confirmBtn.removeClass("wp-friend-confirm-disable")},this.disableBtn=function(e){e.confirmBtn&&e.confirmBtn.addClass("wp-friend-confirm-disable")},this.resetList=function(e){e.initFriendList(e.p2)},this.buildFrame=function(e,t){var n=['<div id="wp-friend-select">','	<div class="wp-friend-search">','		<input type="text" value="" class="wp-friend-input">',"	</div>",'	<div class="wp-friend-list">','		<ul class="list">',"			<li>加载中...</li>","		</ul>","	</div>",'	<div class="wp-friend-footer">','		<div class="wp-friend-slider">','			<span class="wp-friend-slider-prev disabled"> < </span>','			<span class="wp-friend-slider-next disabled"> > </span>','			<div class="list-wrap"><ul class="clearfix">','			<li class="last"></li></ul></div>',"		</div>",'		<a href="#nogo" onclick="return false;" class="wp-friend-confirm wp-friend-confirm-disable btn">确定</a>',"	</div>","</div>"].join("");jxn(t).append(jxn(n)),setTimeout(function(){e.friendList=jxn(".wp-friend-list .list"),e.searcher=jxn(".wp-friend-input"),e.confirmBtn=jxn(".wp-friend-confirm"),e.members={wrap:jxn(".wp-friend-footer .list-wrap ul"),lastItem:jxn(".wp-friend-footer .list-wrap .last")},e.prevBtn=jxn(".wp-friend-slider-prev"),e.nextBtn=jxn(".wp-friend-slider-next"),e.initFriendList(),e.bindEvent()},0)},this.initFriendList=function(e,t){t||(t=encodeURIComponent(JSON.stringify(e.p))),new XN.NET.xmlhttp({url:e.url,method:"post",useCache:!0,data:"p="+t,onSuccess:function(t){t=JSON.parse(t.responseText),e.firstQuery||(e.firstQuery=!0,0==t.candidate.length&&(e.noFriends=!0)),e.allFriends=e.buildList(t),jxn(".wp-friend-list .list > li").each(function(){jxn(this).remove()}),e.friendList.append(e.allFriends),e.friendItem=jxn(".wp-friend-list li")},onError:function(){}})},this.rebuildFrame=function(e,t){return""==t&&e.inputSearchChanged?(e.resetList(),void(e.inputSearchChanged=!1)):(e.p.init=!1,e.p.limit=20,e.p.page=!1,e.p.qkey="friend",e.p.query=t||" ",e.inputSearchChanged=!0,void e.initFriendList())},this.buildList=function(e,t){var n=[];if(t.candidate.length>0){for(var i=0;i<t.candidate.length;i++){var a=t.candidate[i],r="";e.memberList.indexOf(String(a.id))>-1&&(r=' class="selected" ');var o=['<li data-id="',a.id,'"',r,'><span class="checkbox-wrap"></span><p><img src="',a.head,'" width="30" height="30" /><span>',a.name,"</span></p></li>"].join("");n.push(o)}n=n.join("")}else e.noFriends?(jxn(".wp-friend-list .list").empty(),n='<li class="no-click">您没有任何好友</li>'):n='<li class="no-click">您的好友中没有 '+e.p.query+"</li>";return jxn(n)},this.bindEvent=function(e){e.searcher.bind("blur",function(){clearInterval(e.onChangeInterval),e.query=""}),e.searcher.bind("focus",function(){clearInterval(e.onChangeInterval),e.onChangeInterval=setInterval(function(){e.searcher.val()!=e.query&&(e.query=e.searcher.val(),e.rebuildFrame(e.query))},e.delayInterval)}),e.addEvent("selectedItem",function(t){var n=t.data;e.addMembers(n),jxn(".wp-friend-list .list li[data-id = "+n.id+"]:first").addClass("selected")}),e.friendList.delegate("#wp-friend-select .wp-friend-list li","click",function(){if(!jxn(this).hasClass("no-click")){var t={id:jxn(this).attr("data-id"),portrait:jxn(this).find("img").attr("src"),name:jxn(this).find("p span").text()};jxn(this).hasClass("selected")?(e.removeMembers(t),jxn(this).removeClass("selected")):e.room?e.room.fireEvent("selected",{data:t}):e.fireEvent("selected",{data:t})}}),e.prevBtn.on("click",function(){if(!e.prevBtn.hasClass("disabled")){var t=parseInt(e.members.wrap.css("margin-left"))+e.perWidth;t=t>0?0:t,e.members.wrap.css("margin-left",t+"px"),e.page--,e.page<=0&&(e.page=0,e.prevBtn.addClass("disabled")),e.nextBtn.removeClass("disabled")}}),e.nextBtn.on("click",function(){if(!e.nextBtn.hasClass("disabled")){var t=parseInt(e.members.wrap.css("margin-left"))-e.perWidth;t=t>0?0:t,e.members.wrap.css("margin-left",t+"px"),e.page++,e.page>=e.totalWidth/e.perWidth-1&&(e.page=e.totalWidth/e.perWidth-1,e.nextBtn.addClass("disabled")),e.prevBtn.removeClass("disabled")}}),e.members.wrap.delegate(".wp-friend-slider .member","mouseover",function(){e.delBtn=jxn(this).find(".wp-friend-del"),e.delBtn.show()}),e.members.wrap.delegate(".wp-friend-slider .member","mouseleave",function(){e.delBtn.hide()}),e.members.wrap.delegate(".wp-friend-slider .member","click",function(){var t=jxn(this).attr("data-id"),n=jxn(this).attr("data-name"),i={id:t,portrait:jxn(this).find("img").attr("src"),name:n};e.removeMembers(e,i),jxn(this).remove(),jxn(".wp-friend-list .list li[data-id = "+t+"]:first").removeClass("selected"),e.setMemberList(),e.memberList.length<=0&&e.confirmBtn.addClass("wp-friend-confirm-disable")})},this.buildMemberList=function(e,t){return['<li class="member" data-id="',t.id,'" data-name="'+t.name+'"><img src="',t.portrait,'" width="30" height="30"><span class="wp-friend-del" title="删除"></span></li>'].join("")},this.addMembers=function(e,t){if(!(e.memberList.indexOf(t.id)>-1)){e.memberList.push(t.id),e.memberName.push(t.name);var n=e.buildMemberList(t);jxn(n).insertBefore(e.members.lastItem),e.setMemberList(),e.confirmBtn.removeClass("wp-friend-confirm-disable")}},this.removeMembers=function(e,t){var n=e.memberList.indexOf(t.id);jxn(".wp-friend-footer .list-wrap li:eq("+n+")").remove(),e.memberList.splice(e.memberList.indexOf(t.id),1),e.memberName.splice(e.memberName.indexOf(t.name),1),e.setMemberList(),e.memberList.length<=0&&e.confirmBtn.addClass("wp-friend-confirm-disable")},this.setMemberList=function(e){e.members.item=jxn("li",e.members.wrap),e.Memberlen=e.members.item.length,e.members.wrap.css("width",36*e.Memberlen+"px"),e.page=Math.floor(e.Memberlen/6),e.totalWidth=36*e.Memberlen,e.perWidth=216,e.Memberlen>6?(e.prevBtn.removeClass("disabled"),e.nextBtn.addClass("disabled"),e.members.wrap.css("margin-left",36*-(e.Memberlen-6)+"px")):(e.prevBtn.addClass("disabled"),e.members.wrap.css("margin-left",0))}})}),object.define("webpager/lib/jqtpl",function(require,e){function t(e){return e?e.replace(/\\'/g,"'").replace(/\\"/g,'"').replace(/\\\\/g,"\\"):null}function n(n){return new Function("$","$item",'var call,_=[],$data=$item.data;with($data){_.push("'+n.trim().replace(/([\\"])/g,"\\$1").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\$\{([^\}]*)\}/g,"{{= $1}}").replace(/\{\{(\/?)(\w+|.)(?:\(((?:[^\}]|\}(?!\}))*?)?\))?(?:\s+(.*?)?)?(\(((?:[^\}]|\}(?!\}))*?)\))?\s*\}\}/g,function(n,i,a,r,o,s,d){var l,c,u,p=e.tag[a];if(!p)throw new Error("Template command not found: "+a);return l=p._default||[],s&&!/\w$/.test(o)&&(o+=s,s=""),o?(o=t(o),d=d?","+t(d)+")":s?")":"",c=s?o.indexOf(".")>-1?o+t(s):"("+o+").call($item"+d:o,u=s?c:"(typeof("+o+')==="function"?('+o+").call($item):("+o+"))"):u=c=l.$1||"null",r=t(r),'");'+p[i?"close":"open"].split("$notnull_1").join(o?"typeof("+o+')!=="undefined" && ('+o+")!=null":"true").split("$1a").join(u).split("$1").join(c).split("$2").join(r||l.$2||"")+'_.push("'})+'");}return _.join("");')}function i(t,n,i){return e.tmpl(e.template(t),n,i)}var a=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)};e.each=function(e,t){var n;if(a(e))for(n=0;n<e.length;++n)t.call(e[n],n,e[n]);else for(n in e)t.call(e[n],n,e[n])},e.escape=function(e){return String(e).replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&#39;").replace(/"/g,"&quot;")},e.tag={tmpl:{_default:{$2:"null"},open:"if($notnull_1){_=_.concat($item.nest($1,$2));}"},wrap:{_default:{$2:"null"},open:"$item.calls(_,$1,$2);_=[];",close:"call=$item.calls();_=call._.concat($item.wrap(call,_));"},each:{_default:{$2:"$index, $value"},open:"if($notnull_1){$.each($1a,function($2){with(this){",close:"}});}"},"if":{open:"if(($notnull_1) && $1a){",close:"}"},"else":{_default:{$1:"true"},open:"}else if(($notnull_1) && $1a){"},html:{open:"if($notnull_1){_.push($1a);}"},"=":{_default:{$1:"$data"},open:"if($notnull_1){_.push($.escape($1a));}"},"!":{open:""}},e.template=function(e,t){e=e||t;var i=arguments.callee[e];return null==t||i||(i=arguments.callee[e]=n(t)),i},e.tmpl=function(t,n,r){var o,s="function"==typeof t?t:e.template(null,t),d="";if(n=n||{},r=r||{},r.data=n,r.nest=i,a(n))for(o=0;o<n.length;++o)r.data=n[o],d+=s.call(r.scope,e,r);else d=s.call(r.scope,e,r);return d}}),object.define("webpager/service","./lib/tools, ./service/messager, ./service/friendbook, ./service/notify, ./service/ubbparser",function(require,e){var t=require("./lib/tools"),n=t.getLogger("service");e.messager=require("./service/messager"),e.friendbook=require("./service/friendbook"),e.notify=require("./service/notify"),e.ubbparser=require("./service/ubbparser");var i={};e.regService=function(e,t){e&&(i[e]=t,n.log1("service注册了一个新服务 ",e))},e.request=function(e){if(!i[e])return void n.log1("调用了不存在的服务:  ",e);var t=Array.prototype.slice.call(arguments,1);return i[e].apply("",t)};var a={sKey:"preferences",preValue:{ban_stranger:!1,im_disabled:!1,quiet_mode:!1,quiet_birthday:!1,notify_viewer:!1},userPrefer:{},init:function(){var e=this;this.cluster=new t.Cluster_Client("preferences"),this.cluster.addEvent("message",function(t){"save"==t.data&&e.load()}),this.load()},load:function(){var e=window.webpager.getItem(this.sKey,1);if(e){try{var t=JSON.parse(e)}catch(n){return}this.userPrefer=t}},save:function(){window.webpager.setItem(this.sKey,JSON.stringify(this.userPrefer),1,1)},get:function(e){var t=null;return e in this.userPrefer?t=this.userPrefer[e]:e in this.preValue&&(t=this.preValue[e]),t},set:function(e,t){this.userPrefer[e]=t,"ban_stranger"!=e&&(this.save(),this.cluster.broadcast("save"))},isSet:function(e){return e in this.userPrefer}};a.init(),e.preferences=a}),object.define("webpager/service/friendbook","../lib/channel_api, ../lib/base, ../lib/tools, ./messager",function(require){function e(e){var t=0;return r.test(e)&&(t=e.replace(r,"")),t||e}var t=require("../lib/base"),n=require("../lib/tools"),i=(n.getLogger("friendbook"),require("../lib/channel_api"),require("./messager"),t.$extend,t.readly),a=t.XN,r=(n.AsyncMgr,n.QA,/[\u0000-\u001f]/g),o="http://a.xnimg.cn/webpager/res/group-avatar-new2.png",s=Class({"@mixins":[t.events.Events],table:{},list:[],cats:{},publics:[],teams:[],groups:[],UserGroups:[],recent:[],onlineCount:0,all:{},skey:"friendbook",ready:!1,superUser:!1,recentLoaded:!1,initialize:function(){}}),d=window.webpager.contacts=new s,l=null,c=new t.events.Events;return i(c),t.extend(c,{_pending:{},_getting:[],_pending_getting:0,_cache_search:{},_requesting_onlinecount:[],init:function(){window.webpager.addEvent("groupItemGot",function(e){window.webpager.callback&&window.webpager.callback.group_item&&(window.webpager.callback.group_item(e.data),window.webpager.callback.group_item=void 0)}),window.webpager.addEvent("groupListGot",function(e){clearTimeout(l),d.teams=[],e.list.forEach(function(e){var t={};t.userId=e.id,t.userName=e.name,t.tiny=o,t.type=2,d.teams.push(t)}),webpager.setItem("teams",JSON.stringify(d.teams)),window.webpager.callback&&window.webpager.callback.group_list&&window.webpager.callback.group_list(d.teams)})},update:function(){d.update()},getCats:function(){var e=["最近联系","在线好友"],t={};t[e[0]]=!0;for(cat in d.cats)t[cat]||(e.push(cat),t[cat]=!0);return e},getRecentNew_:function(t,n){var t=t||0;new a.net.xmlhttp({url:"http://notify.renren.com/wpi/getfullrecentfriends.do?opt="+t+"&t="+Math.random(),method:"get",onSuccess:function(t){var i=JSON.parse(e(t.responseText));i.online&&i.online.length?(d.online=i.online,n(i.online)):n&&n([])},onError:function(){a.DO.showMessage("获取最新在线列表失败,由于网络问题,请稍后再试。")}})},getRecentNew:function(e,t){return 0!==e?void this.getRecentNew_(e,t):d.recentLoaded?void(t&&t(d.recent)):void new a.net.xmlhttp({url:"http://webpager.renren.com/api/getRecent",method:"get",onSuccess:function(e){var n=JSON.parse(e.responseText);if(0==n.code){if(d.recentLoaded=!0,n.data.recents&&n.data.recents.length){var i=[],a=function(e){e.tiny=e.tiny_url,"muc"==e.type?(e.type=2,e.status=1,""==e.tiny_url&&(e.tiny=o)):e.type=1,e.userId=e.id,e.userName=e.name,i.push(e)};n.data.recents.forEach(function(e){var t=parseInt(e.id);t>=630000001&&639999999>=t?(e.type=3,a(e)):a(e)}),d.recent=i,t&&t(i)}}else d.recentLoaded=!1,t&&t([])},onError:function(){a.DO.showMessage("获取最新在线列表失败,由于网络问题,请稍后再试。")}})},getAll:function(t,i){var i=i||0,r=50,o=i*r;d.all[i]?t&&t(d.all[i]):new a.net.xmlhttp({url:"http://notify.renren.com/wpi/getallfullfriends.do?id="+n.User.id+"&begin="+o+"&limit="+r+"&t="+new Date%18e4,method:"get",onSuccess:function(n){var a=JSON.parse(e(n.responseText));
d.all[i]=a.friends,t&&t(d.all[i])},onError:function(){a.DO.showMessage("获取好友列表出错了，请稍后再试。")}})},updateTeams:function(e,t){if(t){var n=!1;if(d.teams.forEach(function(i){i.userId==e&&(n=!0,i.userName=t)}),!n&&e){var i={userId:e,userName:t,tiny:o,type:2};d.teams.push(i)}}else d.teams.forEach(function(t,n){t.userId==e&&d.teams.splice(n,1)})},getTeams:function(e,t){var n=null;d.teams.length>0?(t?d.teams.forEach(function(e){t==e.userId&&(n=e)}):n=d.teams,e(n)):new a.net.xmlhttp({url:"http://webpager.renren.com/api/userGroupInType?st=0&lt=100&type=-1",method:"get",onSuccess:function(i){var r=a.json.parse(i.responseText);if(0!=r.code)-1==r.code&&e?e([]):a.DO.showMessage("获取讨论组列表出错了，"+r.msg);else{for(var o,s=[],l=0,c=r.data.groups.length;c>l;l++){o=r.data.groups[l];var u={tiny:"http://a.xnimg.cn/webpager/res/group-avatar-new2.png",type:2,userId:o.gid,userName:o.name};s.push(u),o.gid==t&&(n=u)}d.teams=s,void 0===t&&(n=d.teams),e&&e(n)}},onError:function(){a.DO.showMessage("获取讨论组列表出错了，请稍后再试。")}})},updateGroupState:function(e,t){d.groups.length>0&&d.groups.forEach(function(n){e==n.userId&&(n.state=t)})},updateGroup:function(e){d.groups.length>0&&d.groups.forEach(function(t,n){e==t.userId&&d.groups.splice(n,1)})},getGroup:function(e,t){if(d.groups.length>0){var i=null;t?d.groups.forEach(function(e){t==e.userId&&(i=e)}):i=d.groups,e(i)}else new a.net.xmlhttp({url:"http://lbsgroup.renren.com/member/getJoinedGroups",method:"get",onSuccess:function(i){d.groups=[];var r=a.json.parse(i.responseText),o=null;r.status.code?(r.data.forEach(function(e){var i={};i.userId=e.id,i.userName=e.name,i.tiny=n.makeHeadTinyurl(e.head),i.type=2,i.state=e.state,t&&t==e.id&&(o=i),d.groups.push(i)}),null==o&&(o=d.groups),e&&e(o)):a.DO.showMessage("获取群列表出错了，请稍后再试。")}})},getPublic:function(e,t){if(d.publics.length>0){var i=null;t?d.publics.forEach(function(e){t==e.userId&&(i=e)}):i=d.publics,e(i)}else new a.net.xmlhttp({url:"http://webpager.renren.com/api/attentionAccounts?userId="+a.user.id+"&pageSize=100&curPage=1&serviceType=0",method:"get",onSuccess:function(i){var r=null,o=a.json.parse(i.responseText);0==o.code?(d.table||(d.table={}),d.publics=[],o.data.items.forEach(function(e){var i={};i.userId=e.id,i.userName=e.accountname,i.type=3,i.tiny=n.makeHeadTinyurl(e.head_pic_100),t&&t==e.id&&(r=i),d.table[e.id]=i,d.publics.push(i)}),null==r&&(r=d.publics),e&&e(r)):a.DO.showMessage("获取公共账号出错了，请稍后再试。")},onError:function(){a.DO.showMessage("获取公共账号出错了，请稍后再试。"),t||e&&e(d.publics)}})},getUserById:function(e){if(e==a.cookie.get("id")){var t={tiny:a.user.tinyPic,userId:e,userName:escape(a.user.name)};return t}if(d.table&&d.table[e])return d.table[e];var t={tiny:"",userId:e,userName:""};return t},getUser:function(e,t){d.table&&d.table[t]?e&&e(d.table[t]):new a.net.xmlhttp({url:"http://notify.renren.com/wpi/getuserinfo2.do",data:"uids="+t,method:"get",onSuccess:function(n){var i=a.json.parse(n.responseText);d.table||(d.table={}),d.table[t]=i[t],e&&e(i[t])}})},getUserGroups:function(e){d.UserGroups.length>0?e&&e(d.UserGroups):new a.net.xmlhttp({url:"http://webpager.renren.com/api/getFriendGroups",method:"get",onSuccess:function(t){var n=a.json.parse(t.responseText);"0"==n.code&&(d.UserGroups=n.data.groups),e&&e(d.UserGroups)}})},getUserGroup:function(e,t,n){var n=n||"0",i=50,r=0;r=i*n;var o=t+"-"+n;d.cats[o]?e&&e(d.cats[o]):new a.net.xmlhttp({url:"http://webpager.renren.com/api/getFriendsByGroup?groupId="+t+"&lt="+i+"&st="+r,method:"get",onSuccess:function(t){d.cats[o]=[];var n=a.json.parse(t.responseText);"0"==n.code&&n.data.items.forEach(function(e){var t={};t.userId=e.uid,t.userName=e.name,t.tiny=e.tiny_url,t.type=1,t.status=e.status,d.cats[o].push(t)}),e&&e(d.cats[o])}})},getStatus:function(e){var t=d.table[e];return t?t.status:0},getLocalFriend:function(e){if(!e)return null;var t=d.table[e];return!t||t.isStranger?null:t},getFriendsInfo:function(e){var t=this.getUserById(e),n={};return n[e]=t,n},getUserInfo:function(e,t){var n=this;new a.net.xmlhttp({url:"http://notify.renren.com/wpi/getuserinfo2.do",data:"uids="+e.join(),method:"get",onSuccess:function(e){var i,r=a.json.parse(e.responseText),o=d.table,s=[],l=n._pending;for(i in r)delete l[i],r[i].isStranger=1,o[i]=r[i],s.push(i);t&&t(r,s)}})},asyncSearch:function(e,t){var n=this,i=n._cache_search;return e=encodeURIComponent(e),i[e]&&t?void t(i[e]):void new a.net.xmlhttp({url:"http://friend.renren.com/friends/api/searchbywebpage?l=7&p="+e,method:"get",onSuccess:function(n){var a;try{a=JSON.parse(n.responseText)}catch(r){a={candidate:[]}}i[e]=a,t&&t(a)}})}}),c.init(),c}),object.define("webpager/service/messager","../lib/channel_api, ../lib/base, ../lib/tools",function(require){var e=(require("../lib/channel_api"),require("../lib/base")),t=require("../lib/tools"),n=t.QA,i=t.getLogger("messager"),a=(XN.user.id%10==0||XN.user.id%10==1||XN.user.id%10==2||XN.user.id%10==3||XN.user.id%10==4||"702403929"==XN.user.id||"236235312"==XN.user.id||"30314"==XN.user.id||"200484432"==XN.user.id||"245321166"==XN.user.id||"330480037"==XN.user.id||"299094607"==XN.user.id,new Class(function(){this.__mixins__=[e.events.Events],this.initialize=function(e){e.listenServerPush()},this.sendConv=function(e,t){t.data.icode?webpager.sendMessage(t.data,"spam"):webpager.sendMessage(t.data)},this.send=function(e,t){e.fireEvent("message",t)},this.listenServerPush=function(e){function t(e,t,n){var i=a(e);i&&webpager.fireEvent("notifySys",{roomid:e,msg:t}),n&&setTimeout(function(){i.model.getRoomInfo(!0)},1e3)}function a(e,t){return webpager.roomKeeper.findRoom(e,t)}window.webpager.addEvent("group_open",function(e){window.webpager.service.request("chat/group/start",e.from)}),window.webpager.addEvent("group_name",function(e){t(e.from,e.info),window.webpager.fireEvent("upAllGroupName",e)}),window.webpager.addEvent("group_inviteitem",function(e){t(e.roomid,e.info)}),window.webpager.addEvent("group_config",function(){}),window.webpager.addEvent("group_invite",function(e){var t=a(e.from);t.ui.nodes.header.innerHTML=t.ui.panels.chat.header.innerHTML,t.buildChatPanel()}),window.webpager.addEvent("group_quit",function(){}),window.webpager.addEvent("group_quititem",function(e){e.uid!=XN.user.id&&t(e.from,e.info)}),window.webpager.addEvent("superGroupTxt",function(e){t(e.from,e.info)}),window.webpager.addEvent("group_createitem",function(e){t(e.roomid,e.info)}),window.webpager.addEvent("group_sr",function(e){if(+e.msgkey){var t=a(e.to);t&&(t.ui.max_msg_id&&t.ui.max_msg_id!=e.last_msgkey&&setTimeout(function(){window.webpager.getChatLastestMsg(t.model.id,"g")},500),webpager.fireEvent("notifyClearInput",{roomid:e.to}),t.ui.max_msg_id=e.msgkey,t.ui.message(),t.model.inputText=null)}}),window.webpager.addEvent("group_message",function(e){var t=['<ack from="',XN.user.id,'" to="',e.groupid,'" msgkey="',e.msgkey,'" type="dr" chat_type="',e.type,'"/>\n\x00'].join("");webpager.sendMessage(t,"newProtocal");var n=a(e.groupid,!0);if(n){var i=0;"muc_self"==e.type&&(i=1),n.upMaxMsgKey(e.msgkey);var r={msgkey:e.msgkey,fromuin:e.groupid};n&&n.buildReport(r,i)}}),window.webpager.addEvent("chat_sr",function(e){if(+e.msgkey){var t=a(e.to);t&&(t.ui.max_msg_id&&t.ui.max_msg_id!=e.last_msgkey&&setTimeout(function(){window.webpager.getChatLastestMsg(t.model.id,"u")},500),webpager.fireEvent("notifyClearInput",{roomid:e.to}),t.ui.max_msg_id=e.msgkey,t.ui.message(),t.model.inputText=null)}}),window.webpager.addEvent("chat_message",function(e){var t=null,n=0;"chat_self"==e.type?(t=a(e.to),n=1):t=a(e.from);var i={id:e.from,msgkey:e.msgkey};if(t)t.buildReport(i,n);else{var r=['<ack from="',XN.user.id,'" to="',e.fromuin||e.id||e.uid,'" msgkey="',e.msgkey,'" type="dr" chat_type="',e.type,'"/>\n\x00'].join("");webpager.sendMessage(r,"newProtocal")}}),window.webpager.addEvent("realTime_got",function(t){var a=XN.json.parse(t.content);if(a&&(a.ugc_content||a.is_at)&&"true"!=a.isNewAddUgcType){if(n.log2(42),i.log1("new realTIme_got: ",t),n.log2(41),104==a.feed_stype)return e.headerNotify(a);var r={service:"ugc_chat",source:"renren.com",actor:"renren.com",action:"message",data:a};e.fireEvent("message",{sgl:r}),XN.net.sendStats("http://notifystat.renren.com/webpager?uid="+XN.user.id+"&json="+encodeURI(JSON.stringify(r.data)))}else"10000-1"==a.source?e.fireEvent("message",{service:"qun",source:"qun.renren.com",data:t}):a.bigtype&&webpager.isLocalConnect()&&(XN.net.sendStats("http://notifystat.renren.com/bubble?uid="+XN.user.id+"&json="+encodeURI(JSON.stringify(a))),e.headerNotify(a))}),webpager.addEvent("message_got",function(t){var n={service:"oto_chat",source:"wpi.renren.com",data:t};e.fireEvent("message",{sgl:n})}),webpager.addEvent("groupmsg_got",function(t){var n=t.roomid>=1e8?!0:!1,i=XN.json.parse(t.content);i.msgkey=t.msgkey;var a={service:n?"super_group_chat":"group_chat",source:"wpi.renren.com",data:i};i.attachment=t.attachment,i.localid=t.localid,i.msg_audiosrc=t.msg_audiosrc,i.msg_audiotime=t.msg_audiotime,i.msg_headsrc=t.msg_headsrc,i.msg_originalsrc=t.msg_originalsrc,i.fname=t.fname,i.timestamp=t.timestamp,i.chat_tag=t.chat_tag,e.fireEvent("message",{sgl:a})}),webpager.addEvent("spam_got",function(t){var n={service:"spam",source:"wpi.renren.com",data:t};e.fireEvent("message",{sgl:n})})},this.headerNotify=function(e,t){e.fireEvent("message",{service:"notify",source:"webpager",data:t})}}));return new a}),this.appendStytemInfo=function(e){var t=self.makeAttendee(e);self.frame.getElement("dl").appendChild(tools.getDom(t))},object.define("webpager/service/notify","../lib/base, ../lib/channel_api, ../lib/tools,../service/friendbook",function(require){function e(e,t){if(!e)return 0;var n=0,i=0,a=e.length;if(t){for(t=2*t;e[i];)if(e.charCodeAt(i)>255?n+=2:n++,i++,n>=t&&e[i])return!0;return!1}for(i=0;a>i;i++)e.charCodeAt(i)>255?n+=2:n++;return Math.ceil(n/2)}function t(e,t,n){var i=setTimeout(function(){if(e){g(e);try{n()}catch(t){}}},t);return i}function n(e,t,n,i,a,r,o){var s=new Date,d=a,l=r,c=e,u=i-n;!function(){var e=arguments.callee,i=new Date-s,a=i/d;a=a>=1?1:a,c.style[t]=n+Math.ceil(u*a)+"px",1!=a?setTimeout(e,l):o()}()}var i=require("../lib/base"),a=i.dom,r=(i.events,require("../lib/channel_api")),o=require("../lib/tools"),s=o.getLogger("notify"),d=require("../service/friendbook"),l=new i.events.Events;i.extend(l,{notify_list:[],tobe_valid:[],storage_tag:"webim_notify",i:0,count:0,_new_content:!1,init:function(){var e=this;s.log1("notify开始初始化 ",l);var t=new o.Cluster_Client("webpager_notify");e.cluster=t,t.addEvent("master",function(){e.load()}),e.bindEvent(),t.isMaster()&&e.load()},bindEvent:function(){var e=this;window.addEvent("unload",function(){s.log1("窗口unload,需要把桌面提醒都删除 ")}),o.focused.addEvent("focus",function(){s.log1("窗口被focus,取消新消息提示 "),e.newContent(-1)})},load:function(){var e=this;e.notify_list=[],e.count=0;var t=r.persistMgr.storageGet(e.storage_tag,1,1);t?(t=JSON.parse(t),t.t==o.User.t&&(e.tobe_valid=t.ntf,e.i=t.i)):e.i=0,s.log1("seervice/notify: 加载了LocalStorage的数据,准备提供服务 ",t),e.fireEvent("load",{data:t})},save:function(){var e={t:o.User.t,ntf:this.notify_list,i:this.i,c:this.count};r.persistMgr.storageSet(this.storage_tag,JSON.stringify(e),1,1),s.log1("service/notify: 保存到LocalStorage: ",e)},refresh:function(e){var t=this;s.log2("service/notify: 当前notify_list: ",t.notify_list),t.count!=t.notify_list.length&&(t.count=t.notify_list.length,t.fireEvent("count",{data:t.count,silent:e})),t.save()},newNotify:function(e){var t=this;if(s.log1("service/notify: 收到Notify请求: ",e),!e)return 0;for(var n,i=[].concat(e);n=i.shift();)n.id=++t.i,t.notify_list.push(n),n.content&&t.fireEvent("message",n);t.refresh()},newContent:function(e){this._new_content=e?!1:!0},delBySource:function(e){for(var t=this,n=t.notify_list,i=0,a=[];n[i];)if(n[i].source==e){var r=n.splice(i,1)[0];r.content&&(a=a.concat(r.content))}else i++;t.refresh(),a.length&&a.forEach(function(e){e.callback&&new XN.net.xmlhttp({url:e.callback})})},clear:function(){var e=this;e.notify_list=[],e.refresh(!0)},valid:function(e){for(var t=this,n=t.tobe_valid,i=!1,a=0;n[a];)e==n[a].source?(t.notify_list.push(n.splice(a,1)[0]),i=!0):a++;return i&&t.refresh(!0),i}});var c=function(){var e="【新消息】- ",t="【　　　】- ",n=function(){var n=document.title,i=n.indexOf(e);return-1==i&&(i=n.indexOf(t)),-1!=i?n.substring(i+7):n},i=new o.Bling({onStart:function(){-1==document.title.indexOf("【")&&(this.oldtitle=document.title)},fn1:function(){document.title=e+n()},fn0:function(){document.title=t+n()}});return i.addEvent("stop",function(){document.title=n()}),i}();l.addEvent("count",function(e){e.data?(s.log2("Notify count: "+e.data," 开启闪烁 "),c.start(),e.silent||r.playSound()):(s.log2("Notify count: "+e.data," 关闭闪烁 "),c.stop())}),window.webkitNotifications&&l.addEvent("message",function(e){if(l.cluster.isMaster()){var t=[].concat(e.content);t.forEach(function(t){t.id!=XN.user.id&&t.content&&"undefined"!=t.content&&(t.avatar&&t.name||d.getUser(function(n){if(""!=n.tiny&&""!=n.userName){var i=o.unescapeHTML(t.content);""==i&&t.contentsrc&&(i=t.contentsrc),window.webpager.notificationShow({head:n.tiny,name:n.userName,content:i,callback:e.callback})}},t.id))})}}),l.init();var u,p,f=null,h=[],m=function(e,i){if(u||(u=document.createElement("div"),u.id="seehere-box",a.getElement("#bottombar").appendChild(u)),f){if(f==e)return;if(h.some(function(t){return t==e}))return;return void h.push(e)}f=e;var r=u.style.height=u.offsetHeight;u.appendChild(e),setTimeout(function(){var t=r+e.offsetHeight;n(u,"height",r,t,400,20,function(){u.style.height=""})}),e.addEvent("mouseover",function(e){clearTimeout(p),e.cancelBubble=!0}),e.addEvent("mouseout",function(){clearTimeout(p),p=t(e,2e3)}),p=t(e,8e3,function(){i("auto-drop")}),i("bubble")},g=function(e){if(e==f)n(e,"left",0,200,200,20,function(){u.removeChild(e),e.style.left="",f=null,h.length&&m(h.shift())});else for(var t=0;t<h.length;t++)h[t]==e&&h.splice(t,1)},v=function(t,n){var r,o=document.createElement("div");o.className="seehere-message";var s=document.createElement("div");s.innerHTML=t.content,r=XN.browser.IE?e(s.innerText)>60:e(s.textContent)>60,s=null;var d="";t.actor&&(d=['<div class="actor"><figure>','	<a href="'+t.actor.link+'" click="head" title="'+t.actor.name+'" target="_blank">','	<img src="'+t.actor.image+'" click="head" width="32" alt="头像"></a>',"</figure></div>"].join(""));var l=['<header><a href="javascript:;" class="remove-btn" click="drop" title="忽略">&nbsp;</a></header>',d,'<div class="content"'+(r&&XN.browser.IE6?' style="height:78px;"':"")+">"+t.content+"</div>",t.overfollow?'<p style="margin-left:46px;">...</p>':"",'<div class="actions">'+(t.actions||"")+"</div>"].join("");o.appendChild(i.parseHTML(l)),a.wrap(o),o.addEvent("click",function(e){var t=e.target,i=t.getAttribute("click");if("string"!=typeof i&&(i=null),i)"drop"==i&&g(o),n(i);else{if("a"==t.tagName.toLowerCase())return;n("none")}}),this.frame=o,this.callback=n=n||function(){}};v.prototype={show:function(){m(this.frame,this.callback)},drop:function(){g(this.frame)}};var b=new i.events.Events;return i.extend(b,{add:function(){l.cluster.isMaster()&&l.newNotify.apply(l,arguments)},delBySource:function(){l.cluster.isMaster()&&l.delBySource.apply(l,arguments)},clear:function(){l.cluster.isMaster()&&l.clear()},valid:function(e){return l.cluster.isMaster()?l.valid(e):void 0},createTip:function(e,t){var n=new v(e,t);return n}}),l.addEvent("load",function(){s.log1("notify服务重新load"),b.fireEvent("load")}),b}),object.define("webpager/service/ubbparser","../lib/base, ../lib/tools",function(require){var e=require("../lib/base"),t=require("../lib/tools"),n=(t.QA,e.XN),i={_ubbMap:{},skey:"ubbList",init:function(){var e=this,t=webpager.getItem(e.skey,1);if(t){var n=t.slice(0,10)+"000";n=new Date(parseInt(n)),new Date-n<36e5?e.replaceUbb(t.slice(10)):this.getUbbList()}else this.getUbbList()},getUbbList:function(e){var t=this;new n.net.xmlhttp({url:"http://shell.renren.com/ubb/doingubb",method:"get",onSuccess:function(n){var i=n.responseText;if(i){t.replaceUbb(i);var a=parseInt(new Date/1e3);webpager.setItem(t.skey,a.toString()+i,1,1),e&&e(i)}}})},replaceUbb:function(e){var t=this;try{for(var n,e=JSON.parse(e).ubbList,i=0;i<e.length;i++)n=e[i],n.imgTag='<img src="http://a.xnimg.cn'+n.src+'" alt="'+n.alt+'">',t._ubbMap[n.ubb]=n;t.doReady()}catch(a){}},getUbbImg:function(e){var t=this._ubbMap[e];return t?t.imgTag:!1},mapMobileEmo:function(e){var t="http://a.xnimg.cn/webpager/res/emo/",n={"[象扑君--委屈]":"xiangpujun/weiqu","[象扑君--揉脸]":"xiangpujun/roulian","[象扑君--摇摆]":"xiangpujun/yaobai","[象扑君--摔]":"xiangpujun/suai","[象扑君--撒娇]":"xiangpujun/sajiao","[象扑君--纠结]":"xiangpujun/jiujie","[象扑君--舞]":"xiangpujun/wu","[象扑君--跑]":"xiangpujun/pao","[罗小黑--下雪了]":"luoxiaohei/xiaxuele","[罗小黑--哦也]":"luoxiaohei/ouye","[罗小黑--喵]":"luoxiaohei/miao","[罗小黑--奔跑]":"luoxiaohei/benpao","[罗小黑--得意]":"luoxiaohei/deyi","[罗小黑--扫灰]":"luoxiaohei/saohui","[罗小黑--拍地笑]":"luoxiaohei/paidixiao","[罗小黑--生气]":"luoxiaohei/shengqi","[罗小黑--舒服]":"luoxiaohei/shufu","[小幺鸡--不要呀]":"xiaoyaoji/buyaoy","[小幺鸡--寂寞呀]":"xiaoyaoji/jimoy","[小幺鸡--尿急]":"xiaoyaoji/niaoji","[小幺鸡--江南style]":"xiaoyaoji/jiangnan","[小幺鸡--泪奔]":"xiaoyaoji/leiben","[小幺鸡--滚筒]":"xiaoyaoji/guntong","[小幺鸡--猫女]":"xiaoyaoji/maonv","[小幺鸡--疯啦]":"xiaoyaoji/fengla","[小幺鸡--鸭子舞]":"xiaoyaoji/yaziwu","[小幺鸡--麦霸]":"xiaoyaoji/maiba","[阿狸--啊啊啊]":"Ali/1","[阿狸--吃饭]":"Ali/2","[阿狸--告状]":"Ali/3","[阿狸--好困啊]":"Ali/4","[阿狸--开心]":"Ali/5","[阿狸--渴望]":"Ali/6","[阿狸--抠鼻孔]":"Ali/7","[阿狸--赖皮]":"Ali/8","[阿狸--冷笑话]":"Ali/9","[阿狸--流鼻涕]":"Ali/10_1","[阿狸--挠]":"Ali/11","[阿狸--欠揍]":"Ali/12","[阿狸--蜷]":"Ali/13","[阿狸--吐白沫]":"Ali/14","[阿狸--捂脸跑掉]":"Ali/15","[小纯洁--得瑟]":"pure/1","[小纯洁--瞪眼]":"pure/2","[小纯洁--好棒]":"pure/3","[小纯洁--看看]":"pure/4","[小纯洁--考虑]":"pure/5","[小纯洁--卖萌]":"pure/6","[小纯洁--你懂的]":"pure/7","[小纯洁--抛媚眼]":"pure/8","[小纯洁--期待]":"pure/9","[小纯洁--看热闹]":"pure/10","[小纯洁--甩手]":"pure/11","[小纯洁--听音乐]":"pure/12","[小纯洁--挖鼻孔]":"pure/13","[小纯洁--运动]":"pure/14","[小纯洁--震惊哭]":"pure/15","[小纯洁--逢考必过]":"pure/16","[小纯洁--上课太耽误学习]":"pure/17","[小纯洁--上课太费流量]":"pure/18","[小纯洁--学长只能帮你到这了]":"pure/19","[熊猫--游泳]":"nonopanda/1","[熊猫--害羞]":"nonopanda/2","[熊猫--擦汗]":"nonopanda/3","[熊猫--吃]":"nonopanda/4","[熊猫--喊]":"nonopanda/5","[熊猫--掀桌子]":"nonopanda/6","[熊猫--幻想]":"nonopanda/7","[熊猫--赞]":"nonopanda/8","[熊猫--招手]":"nonopanda/9","[熊猫--贱笑]":"nonopanda/10","[熊猫--疑问]":"nonopanda/11","[熊猫--被打]":"nonopanda/12","[熊猫--龙爪手]":"nonopanda/13","[熊猫--酣睡]":"nonopanda/14","[熊猫--兴奋]":"nonopanda/15","[麦拉风--蹦垩]":"mailafeng/1","[麦拉风--冰冻]":"mailafeng/2","[麦拉风--打酱油]":"mailafeng/3","[麦拉风--点头]":"mailafeng/4","[麦拉风--发火]":"mailafeng/5","[麦拉风--感动]":"mailafeng/6","[麦拉风--感冒]":"mailafeng/7","[麦拉风--砍人]":"mailafeng/8","[麦拉风--冷场]":"mailafeng/9","[麦拉风--挠挠]":"mailafeng/10","[麦拉风--听歌]":"mailafeng/11","[麦拉风--痛哭]":"mailafeng/12","[麦拉风--委屈]":"mailafeng/13","[麦拉风--无语]":"mailafeng/14","[麦拉风--耶]":"mailafeng/15","[小白--吹泡泡]":"fool/1","[小白--呆]":"fool/2","[小白--鼓掌]":"fool/3","[小白--汗]":"fool/4","[小白--揉脸]":"fool/5","[小白--收声]":"fool/6","[小白--偷笑]":"fool/7","[小白--疑问]":"fool/8","[小白--无言]":"fool/9","[小白--心虚]":"fool/10","[小白--眼训]":"fool/11","[小白--怕怕]":"fool/12","[小白--大哭]":"fool/13","[小白--晕]":"fool/14","[小白--招手]":"fool/15","[阿狮马--上课了]":"ashima/shangkele","[阿狮马--扩胸运动]":"ashima/kuoxiongyundong","[阿狮马--冲锋枪]":"ashima/chongfengqiang","[阿狮马--压腿运动]":"ashima/yatuiyundong","[阿狮马--双枪]":"ashima/shuangqiang","[阿狮马--呸]":"ashima/pei","[阿狮马--得瑟]":"ashima/dese","[阿狮马--摇头]":"ashima/yaotou","[阿狮马--腿部运动]":"ashima/tuibuyundong","[阿狮马--顶牛右边]":"ashima/dingniuyoubian","[CC猫--拜拜]":"cat2/1","[CC猫--棒哦]":"cat2/2","[CC猫--蹦跶]":"cat2/3","[CC猫--吃]":"cat2/4","[CC猫--戳手指]":"cat2/5","[CC猫--各种求]":"cat2/6","[CC猫--苦逼思索]":"cat2/7","[CC猫--困]":"cat2/8","[CC猫--流汗]":"cat2/9","[CC猫--难过]":"cat2/10","[CC猫--爬过]":"cat2/11","[CC猫--叹气]":"cat2/12","[CC猫--体重爆表]":"cat2/13","[CC猫--小样儿]":"cat2/14","[CC猫--招财猫]":"cat2/15","[渣渣兔--no]":"downyrabbit/1","[渣渣兔--拜]":"downyrabbit/2","[渣渣兔--吃]":"downyrabbit/3","[渣渣兔--呆]":"downyrabbit/4","[渣渣兔--翻]":"downyrabbit/5","[渣渣兔--坟蛋]":"downyrabbit/6","[渣渣兔--汗]":"downyrabbit/7","[渣渣兔--冷]":"downyrabbit/8","[渣渣兔--毛]":"downyrabbit/9","[渣渣兔--萌]":"downyrabbit/10","[渣渣兔--求]":"downyrabbit/11","[渣渣兔--热]":"downyrabbit/12","[渣渣兔--伤]":"downyrabbit/13","[渣渣兔--甩]":"downyrabbit/14","[渣渣兔--吐]":"downyrabbit/15","[冷兔--板凳]":"rabbit/1","[冷兔--放屁]":"rabbit/2","[冷兔--给跪]":"rabbit/3","[冷兔--喝大了]":"rabbit/4","[冷兔--画圈圈]":"rabbit/5","[冷兔--奸笑]":"rabbit/6","[冷兔--累惨了]":"rabbit/7","[冷兔--挠屁股]":"rabbit/8","[冷兔--闹]":"rabbit/9","[冷兔--前排]":"rabbit/10","[冷兔--敲手鼓]":"rabbit/11","[冷兔--挖鼻屎]":"rabbit/12","[冷兔--吓尿了]":"rabbit/13","[冷兔--邪恶]":"rabbit/14","[冷兔--秀肌肉]":"rabbit/15","[炮炮兵--拜拜]":"soldier/1","[炮炮兵--打你]":"soldier/2","[炮炮兵--得意]":"soldier/3","[炮炮兵--恶心]":"soldier/4","[炮炮兵--尴尬]":"soldier/5","[炮炮兵--哈哈]":"soldier/6","[炮炮兵--惊吓]":"soldier/7","[炮炮兵--流口水]":"soldier/8","[炮炮兵--流泪]":"soldier/9","[炮炮兵--卖萌]":"soldier/10","[炮炮兵--难过]":"soldier/11","[炮炮兵--期待]":"soldier/12","[炮炮兵--傻笑]":"soldier/13","[炮炮兵--捂脸]":"soldier/14","[炮炮兵--早]":"soldier/15","[刀刀--拜拜]":"MrDog/1","[刀刀--快跑]":"MrDog/2","[刀刀--唉]":"MrDog/3","[刀刀--吃东西]":"MrDog/4","[刀刀--打酱油]":"MrDog/5","[刀刀--感冒]":"MrDog/6","[刀刀--唱歌]":"MrDog/7","[刀刀--鼓掌]":"MrDog/8","[刀刀--鬼脸]":"MrDog/9","[刀刀--哈哈]":"MrDog/10","[刀刀--困]":"MrDog/11","[刀刀--啦啦啦]":"MrDog/12","[刀刀--呕吐]":"MrDog/13","[刀刀--石化]":"MrDog/14","[刀刀--晕]":"MrDog/15","[圣诞快乐--CC猫]":"christmas/1","[圣诞快乐--小白]":"christmas/2","[圣诞快乐--部落虎]":"christmas/3","[圣诞快乐--想礼物]":"christmas/5","[圣诞快乐--炮炮兵]":"christmas/6","[圣诞快乐--阿哆]":"christmas/7","[圣诞快乐--阿哆喵]":"christmas/8","[圣诞快乐--八戒]":"christmas/9","[圣诞快乐--老沙]":"christmas/10","[圣诞快乐--麦麦]":"christmas/11","[圣诞快乐--阿狸]":"christmas/12","[圣诞快乐--蛛蛛]":"christmas/13","[圣诞快乐--渣渣兔]":"christmas/14","[圣诞快乐--张小盒]":"christmas/15","[张小盒--财源滚滚]":"box/1","[张小盒--点子]":"box/2","[张小盒--吊着]":"box/3","[张小盒--害羞]":"box/4","[张小盒--汗]":"box/5","[张小盒--哭]":"box/6","[张小盒--拍手]":"box/7","[张小盒--敲锣]":"box/8","[张小盒--翘屁股]":"box/9","[张小盒--扇风]":"box/10","[张小盒--逃命]":"box/11","[张小盒--听音乐]":"box	/12","[张小盒--玩屎]":"box/13","[张小盒--吸烟]":"box/14","[张小盒--兴奋]":"box/15","[蛛蛛--变脸]":"spider/1","[蛛蛛--哈球]":"spider/2","[蛛蛛--害羞]":"spider/3","[蛛蛛--汗]":"spider/4","[蛛蛛--挥别]":"spider/5","[蛛蛛--开餐]":"spider/6","[蛛蛛--开花]":"spider/7","[蛛蛛--哭]":"spider/8","[蛛蛛--骂]":"spider/9","[蛛蛛--拗头]":"spider/10","[蛛蛛--闪眼睛]":"spider/11","[蛛蛛--生气]":"spider/12","[蛛蛛--食零食]":"spider/13","[蛛蛛--咧嘴笑]":"spider/14","[蛛蛛--找打]":"spider/15","[打豆豆--变身]":"dadoudou/1","[打豆豆--打豆豆]":"dadoudou/2","[打豆豆--滚来滚去]":"dadoudou/3","[打豆豆--呼啦圈]":"dadoudou/4","[打豆豆--哭]":"dadoudou/5","[打豆豆--扔]":"dadoudou/6","[打豆豆--踢]":"dadoudou/7","[打豆豆--喂饭]":"dadoudou/8","[打豆豆--洗澡]":"dadoudou/9","[打豆豆--喜]":"dadoudou/10","[绿茶小桃--好基友]":"xiaotao/5","[绿茶小桃--萌]":"xiaotao/4","[绿茶小桃--好赞]":"xiaotao/1","[绿茶小桃--我晕]":"xiaotao/3","[绿茶小桃--干巴爹]":"xiaotao/2","[煎蛋锅--不是吧]":"egg/1","[煎蛋锅--擦汗]":"egg/2","[煎蛋锅--大哭]":"egg/3","[煎蛋锅--恶魔]":"egg/4","[煎蛋锅--发怒]":"egg/5","[煎蛋锅--翻滚]":"egg/6","[煎蛋锅--尴尬]":"egg/7","[煎蛋锅--哈哈]":"egg/8","[煎蛋锅--坏笑]":"egg/9","[煎蛋锅--可爱]":"egg/10","[煎蛋锅--悄悄]":"egg/11","[煎蛋锅--色眯眯]":"egg/12","[煎蛋锅--耍酷]":"egg/13","[煎蛋锅--调皮]":"egg/14","[煎蛋锅--偷笑]":"egg/15","[煎蛋锅--转圈]":"egg/16","[精选小萌牛--Aha]":"cow/1","[精选小萌牛--Yeah]":"cow/2","[精选小萌牛--Yummy]":"cow/3","[精选小萌牛--表酱紫]":"cow/4","[精选小萌牛--尴尬]":"cow/5","[精选小萌牛--么么哒]":"cow/6","[精选小萌牛--爽]":"cow/7","[精选小萌牛--委屈]":"cow/8","[小象--犯困]":"brothers/1","[小象--尴尬]":"brothers/2","[小象--害羞]":"brothers/3","[小象--坏笑]":"brothers/4","[小象--惊恐]":"brothers/5","[小象--潜水]":"brothers/6","[小象--郁闷]":"brothers/7","[小象--抓狂]":"brothers/8","[长颈鹿--不理你]":"brothers/9","[长颈鹿--呼啦圈]":"brothers/10","[长颈鹿--紧张]":"brothers/11","[长颈鹿--惊呆]":"brothers/12","[长颈鹿--疼]":"brothers/13","[长颈鹿--偷笑]":"brothers/14","[长颈鹿--洗澡]":"brothers/15","[长颈鹿--抓狂]":"brothers/16"};return n[e]?'<img class="emo-mobile" src="'+t+n[e]+'.gif" />':!1},hasUbb:function(e){var t=/(\(|\[)([^(\(|\[(\)|\]]+)(\)|\])/g;return t.test(e)},parseTxt:function(e){var t=/(\(|\[)([^(\(|\[(\)|\]]+)(\)|\])/g,n=e.match(t),i={"(":")","[":"]"};if(!n||!n.length)return e;for(var a,r=null,o=0;o<n.length;o++)a=n[o],r=this.getUbbImg(a)||this.mapMobileEmo(a),r&&(a="\\"+a.slice(0,a.length-1)+"\\"+i[a.slice(0,1)],e=e.replace(new RegExp(a),r));return e}};return e.readly(i),i.init(),i}),object.define("webpager/service/feed2talkparser","../lib/base, ../lib/tools",function(require){var e=require("../lib/base"),t=require("../lib/tools"),n=(t.QA,e.XN,{init:function(){},hasFeed2Talk:function(e){var t=/&lt\;feed_to_talk(.*)\/&gt\;/gim;return t.test(e)},hasBusinesscard:function(e){var t=/&lt\;businesscard(.*)\/&gt\;/gim;return t.test(e)},hasPoi:function(e){var t=/&lt\;poi(.*)\/&gt\;/gim;return t.test(e)},parseFeed2talk:function(e,t){for(var n=null,i=null,a=null,r=null,o=null,s=null,d=/&lt\;[^>]*?news_feed_type\s*=\s*['"](.*?)['"]/gi;null!=d.exec(e);)n=RegExp.$1;for(var l=/&lt\;[^>]*?news_feed_id\s*=\s*['"](.*?)['"]/gi;null!=l.exec(e);)i=RegExp.$1;for(var c=/&lt\;[^>]*?news_feed_user_id\s*=\s*['"](.*?)['"]/gi;null!=c.exec(e);)a=RegExp.$1;for(var u=/&lt\;[^>]*?news_feed_source_id\s*=\s*['"](.*?)['"]/gi;null!=u.exec(e);)r=RegExp.$1;for(var p=/&lt\;[^>]*?description\s*=\s*['"](.*?)['"]/gi;null!=p.exec(e);)o=RegExp.$1;for(var f=/&lt\;[^>]*?photo_id\s*=\s*['"](.*?)['"]/gi;null!=f.exec(e);)s=RegExp.$1;var h="";switch(n-=0){case 505:case 503:case 2008:case 502:h="状态";break;case 601:case 2012:case 102:case 2032:h="日志";break;case 701:case 2038:case 2036:case 103:h="照片";break;case 709:case 2013:case 2035:case 104:h="相册";break;case 2005:case 107:h="链接";break;case 2006:case 110:h="视频";break;default:h="状态"}var m="";switch(n){case 102:case 103:case 104:case 110:m="http://share.renren.com/share/"+a+"/"+r,_link_content="<a href='"+m+"' target='_blank'>"+m+"</a>";break;case 601:m="http://blog.renren.com/blog/"+a+"/"+r,_link_content="<a href='"+m+"' target='_blank'>"+m+"</a>";break;case 701:m="http://photo.renren.com/photo/"+a+"/photo-"+s,_link_content="<a href='"+m+"' target='_blank'>"+m+"</a>";break;case 709:m="http://photo.renren.com/photo/"+a+"/album-"+r,_link_content="<a href='"+m+"' target='_blank'>"+m+"</a>";break;case 502:case 505:_link_content=o;break;case 2038:m="http://page.renren.com/"+a+"/channel-photoshow-"+s,_link_content="<a href='"+m+"' target='_blank'>"+m+"</a>";break;case 2012:m="http://page.renren.com/"+a+"/channel-noteshow-"+r,_link_content="<a href='"+m+"' target='_blank'>"+m+"</a>";break;case 2013:m="http://page.renren.com/"+a+"/channel-albumshow-"+r,_link_content="<a href='"+m+"' target='_blank'>"+m+"</a>";break;default:_link_content="尚不支持此动态信息，可到<a href='http://mobile.renren.com' target='_blank'>mobile.renren.com</a>下载最新人人手机客户端"}var g='<div class="dlg_f2t_title">'+t+"分享的"+h+'</div><div class="dlg_f2t_link">'+_link_content+"</div>";return g}});return e.readly(n),n.init(),n}),object.define("xn/apps/status/tiper",function(){function e(e,t){var n="http://notify.renren.com/get2.feed?actor="+e.feed_actor+"&source="+e.feed_source+"&stype=502";new XN.net.xmlhttp({url:n,onSuccess:function(n){if(n.responseText){var i=JSON.parse(n.responseText);"{}"!=JSON.stringify(i)&&t(i,e)}},onError:function(e){console.log(e)}})}var t=parseInt(XN.user.id)||0,n=t%10,i=!1;2==n&&(i=!0);var a=function(e,t){var n={actor:{image:e.host_pic,name:e.host_name,link:"http://www.renren.com/profile.do?id="+e.host_id},content:'<a href="http://www.renren.com/profile.do?id='+e.host_id+'" target="_blank">'+e.host_name+"</a> : "+XN.string.unescapeHTML(e.content),actions:'<a click="reply" href="#nogo" title="打开小窗口快速回复">回复</a>&nbsp;&nbsp;<a href="#nogo" title="分享状态" click="share">分享</a>'},i=webpager.service.notify.createTip(n,function(n){switch(n){case"bubble":XN.net.sendStats("http://status.renren.com/statistics/littlebox/popup?doingId="+t.feed_source);break;case"drop":XN.net.sendStats("http://status.renren.com/statistics/littlebox/close");break;case"auto-drop":XN.net.sendStats("http://status.renren.com/statistics/littlebox/disappear");break;case"share":XN.loadFile("http://s.xnimg.cn/jspro/xn.app.status.js",function(){XN.net.sendStats("http://status.renren.com/statistics/littlebox/share");try{forwardDoing(t.feed_source,e.host_id,"webpager","1")}catch(n){XN.DO.showMsg("抱歉,暂时无法分享状态.")}});break;case"reply":case"none":"reply"==n&&XN.net.sendStats("http://status.renren.com/statistics/littlebox/reply"),"none"==n&&XN.net.sendStats("http://status.renren.com/statistics/littlebox/click"),setTimeout(function(){webpager.service.request("notify/view",{source:t.feed_source,actor:e.host_id,stype:"502"},!0)})}});i.show()};window.webpager.addEvent("other_got",function(t){try{var n=JSON.parse(t.content)}catch(t){return}!i&&"1"!=n.isfocus||"502"!=n.feed_stype||(XN.net.sendStats("http://status.renren.com/statistics/littlebox/push"),setTimeout(function(){e(n,a)},1e3))})}),object.define("webpager/im","./lib/uikit, ./lib/base, ./lib/tools, ./im/roomkeeper,./im/birthday, ./buddy, ./service, ./im/preferpanel,./ugc/radio",function(require){reportExpt=window.frames.imengine.WPC.reportExpt;var e=require("./lib/uikit"),t=require("./lib/base"),n=t.dom,i=require("./lib/tools"),a=i.getLogger("im"),r=require("./im/preferpanel"),o=require("./ugc/radio"),s=require("./service");window.webpager.service=s,window.webpager.messager=s.messager,window.fireEvent||n.wrap(window),window.fireEvent("webpagerReady",{webpager:window.webpager});var d=require("./im/roomkeeper"),l=require("./im/birthday"),c=require("./buddy"),u=n.getElement("#bottombar");u.style.zIndex="1999";var p=n.wrap(document.createElement("div"));p.id="webpager",p.addClass("webpager"),u.appendChild(p),p.addEvent("focus",function(e){e.cancelBubble=!0});try{var f=document.getElementById("webpager_css_loading");f&&(p.style.height="33px")}catch(h){}var m=new e.WebPager(p),g=new e.PagerCase;g.frame.style.right=0;var v=new e.WinSlider;v.setWidth(580);var b=new e.Window({no_xbtn:!0}),w=window.webpager.prefer_menu=new r.PreferMenu;b.nodes.bar.appendChild(w.frame),v.addEvent("foldAllPreferMenu",function(){w.pickup()});var y=function(){function e(){var e=l.get(r);if(!e||!/\d+\:\d+\:\d+/.test(e))return null;var t=e.split(":");o.zdate=t[0],o.ver=t[1],o.act=t[2],o.n=t[3]}function t(){var e=[o.zdate,o.ver,o.act,o.n].join(":");l.set(r,e,30)}if(webpager.imRunning||void 0==window.frames.imengine.AD_FOR_RRZM)return null;var a=window.frames.imengine.AD_FOR_RRZM,r="rrzm_ad",o={},s=new Date,d=s.getMonth().toString()+s.getDate().toString(),l=window.frames.imengine.WPC.cookie,c=['<div class="panelbarbutton" style="width: 97px;">','	<p class="wp-rrzm-ico">下载人人桌面</p>',"</div>"].join(""),u=n.wrap(document.createElement("div"));u.className="popupwindow",u.appendChild(n.getDom(c));var p={bar:n.getElement(".panelbarbutton",u),corner:n.getElement("span",u)},f=null,h={frame:u,_auto_hide_timer:0,init:function(){var e=this,t=0;p.bar.addEvent("mouseover",function(){t=setTimeout(function(){e.show()},500)}),p.bar.addEvent("mouseout",function(){clearTimeout(t),e.autoHide(2e3)}),p.bar.addEvent("click",function(){e._download&&"undefined"!=e._download&&window.open(e._download)})},show:function(){var e=this;return f?(f.show(),void e.autoHide()):void e.popup(a.standby)},hide:function(){f&&f.hide()},autoHide:function(e){var t=this;e=e||5e3,clearTimeout(t._auto_hide_timer),t._auto_hide_timer=setTimeout(function(){t.hide()},e)},shrink:function(){p.bar.style.width="17px",p.bar.style.fontSize="0",i.winFrame.fireEvent("resize")},stretch:function(){p.bar.style.width="97px",p.bar.style.fontSize=""},popup:function(e){var i=this,a=parseInt(e.length*Math.random()),r=e[a];i._download=r.download,f=n.wrap(document.createElement("div")),f.addClass("wp-rrzm-popup");var s=new Image;s.onload=function(){f.style.width=s.width+"px",f.style.height=s.height+"px",i.autoHide(3e4)},s.src=r.image,f.style.backgroundImage="url("+r.image+")";var d;d=['<a class="btn-close" href="javascript:;" title="关闭"></a>','<a class="jump-link" style="'+r.style+'" target="_blank" href="'+r.url+'"></a>'],f.addEvent("click",function(e){var n=e.target;"关闭"==n.title?(o.act=1,t(),i.close()):"a"!=n.tagName.toLowerCase()&&window.open(r.url)}),f.addEvent("mouseover",function(){clearTimeout(i._auto_hide_timer)}),f.addEvent("mouseout",function(){i.autoHide(2e3)}),f.innerHTML=d.join(""),i.frame.appendChild(f),i.autoHide(3e4)},close:function(){f.parentNode.removeChild(f),f=null}};return v.addEvent("append",function(){h.shrink()
}),v.addEvent("remove",function(e){0==e.rest&&h.stretch()}),v.addEvent("focus",function(){h.hide()}),h.init(),e(),setTimeout(function(){v._unfold_window||(a.ver!=o.ver&&(o.act=0,o.ver=a.ver),d!=o.zdate&&(o.zdate=d,o.n=0),1!=o.act&&o.n<3&&(h.popup(a.standby),o.n++),t())},2e3),h}(),_=n.wrap(document.createElement("div"));_.addClass("panel"),_.id="friends-panel",_.style.marginLeft="5px",null!=y&&_.appendChild(y.frame),_.appendChild(b.frame);try{g.frame.appendChild(_),c.init(b)}catch(h){reportExpt("buddy_init",h,"")}g.append(v),m.append(g),XN.browser.IE6||new l.birthdayRemind(b,w);var x=p;if($("container-for-pager")){var E=n.getElement("#navigation-for-pager"),k=n.getElement("#container-for-pager"),C={_layout:0,_close:!1,init:function(){var e=this,a=n.getElement("#dropmenuHolder");return t.addEvent(document,"click",function(t){var n=t.target;if(n&&n.tagName&&"a"!=n.tagName.toLowerCase()&&"object"!=n.tagName.toLowerCase()){var i=!0;do{if(n==a||n==x||null==n.parentNode){i=!1;break}n=n.parentNode}while(n&&n!=document.body);i&&(v.foldAll(),e._layout||b.fold())}}),!E||XN.browser.IE6||"apps.renren.com"==window.location.host?(i.winFrame.addEvent("resize",function(){e.updateWidth(),e.shading()}),void e.updateWidth()):(i.winFrame.addEvent("resize",function(){e.checkExpand()}),b.addEvent("unfocus",function(){e._layout&&(e._close=!0),setTimeout(function(){e.frameLayout(0),e.updateWidth()})}),b.addEvent("focus",function(){e._close=!1,setTimeout(function(){e.checkExpand()})}),void e.checkExpand())},checkExpand:function(){var e=this,t=i.getClientWidth();!e._close&&t>=1220?e.coexist():e.shading(t),e.updateWidth(t)},updateWidth:function(e){var t=this,e=e||i.getClientWidth(),n=160,a=241,r=980;if(t._layout)var o=0,s=(e-a-r)/2;else var s=(e-r)/2,o=5;var d=e-Math.ceil(s);_.style.marginRight=o+"px",v.setWidth(d-n-o-a)},shading:function(){var e=this;e._layout&&e.frameLayout(0);var t=i.getClientHeight();if(555>t){var n=t-128;b.setHeight(n)}else b.setHeight(420)},coexist:function(){var e=this;e._layout||e.frameLayout(1),b._fold&&b.unfold();var t=i.getClientHeight()-30;b.setHeight(t)},frameLayout:function(e){var t=this;t._layout=e,e?(E.addClass("fixWidthForPager"),k.addClass("fixWidthForPager")):(E.removeClass("fixWidthForPager"),k.removeClass("fixWidthForPager")),window.fireEvent("changeLayout",{layout:e})}};!function(){function e(e){XN.cookie.set(n,e?0:1,365,"/","renren.com")}function t(){var e="1"==XN.cookie.get(n)?0:1;0==parseInt(e)?b.unfold(!0):(b.fold(!0),C._close=!0)}var n="l4pager",r=new i.Cluster_Client("buddy");r.addEvent("message",function(e){a.log1("收到一条cluster:buddy广播: ",e),e.data?b.fold(!0):b.unfold(!0)}),b.addEvent("fold",function(t){r.broadcast(t.data),e(t.data)}),t()}(),C.init(),window.imengine.WPC.reportLogMsg("old_sb_buddy")}else!function(){function e(){var e=a.checkExpand();!b._fold&&e.full?s(e):o(e),d(e),r!=e.layout&&self.frameLayout(r),e.loading&&a.noLoading()}var a=XN.smartyBuddy,r=0,o=function(e){if(r&&(r=0),e.height<555){var t=e.height-128;b.setHeight(t)}else b.setHeight(420)},s=function(e){r||(r=1);var t=e.height-30-34;b.setHeight(t)},d=function(){var e=e||i.getClientWidth(),t=160,n=241,a=980;if(r)var o=0,s=(e-n-a)/2;else var s=(e-a)/2,o=5;var d=e-Math.ceil(s);_.style.marginRight=o+"px",v.setWidth(d-t-o-_.offsetWidth)};i.winFrame.addEvent("resize",e),b.addEvent("unfocus",e),b.addEvent("focus",e);var l=new i.Cluster_Client("buddy");l.addEvent("message",function(e){var t=e.data;if(t&&"sn"==t.type)return void(window.webpager.handleUnread&&window.webpager.handleUnread(t));if(t&&"upName"==t.type){window.webpager.fireEvent("updateGroupName",t);var n=window.webpager.roomKeeper.findRoom(t.from),i={name:t.name};return n.buildChatPanel(t.name),n.model.info.name=t.name,void n.ui.updateProfile(i)}return t&&"setStrange"==t.type?void window.webpager.fireEvent("setStrange"):t&&"getStrange"==t.type?void window.webpager.fireEvent("getStrange",t):t&&"groupListGot"==t.type?void window.webpager.fireEvent("groupListGot",t):t&&"groupItemGot"==t.type?void window.webpager.fireEvent("groupItemGot",t):void(t?b.fold(!0):b.unfold(!0))});var c=[];window.webpager.addEvent("chat_sn",function(e){c.push(e),setTimeout(function(){var e=c.length;if(e>1&&c[0].from)for(var t=0;e>t&&t!=e-1;t++)c[t].from==c[t+1].from&&(c.splice(t,1),t--,e=c.length);c.forEach(function(e,t){var n=e;n.type="sn",l.broadcast(n,1),c.splice(t,1)})},1500)}),window.webpager.addEvent("upAllGroupName",function(e){var t=e;e.type="upName",l.broadcast(t,1)}),window.webpager.addEvent("setStrangeInfo",function(e){var t=e;e.type="setStrange",l.broadcast(t,1)}),window.webpager.addEvent("getStrangeInfo",function(e){var t=e;e.type="getStrange",l.broadcast(t,1)}),window.webpager.addEvent("group_item",function(e){e.items;l.broadcast({type:"groupItemGot",data:e},1)}),window.webpager.addEvent("group_list",function(e){var t=e.items;l.broadcast({type:"groupListGot",list:t},1)}),b.addEvent("fold",function(e){l.broadcast(e.data),a.saveStat(!e.data)});var u=a.readStat();u?b.unfold(!0):b.fold(!0),e(),window.webpager.addEvent("hasNewNotify",function(){b._fold&&setTimeout(function(){a.saveStat(1)},1800)});var p=n.getElement("#dropmenuHolder");t.addEvent(document,"click",function(e){var t=n.wrap(e.target);if(t&&t.tagName&&(t.hasClass("start-groupchat")&&v.foldAll(),"a"!=t.tagName.toLowerCase()&&"object"!=t.tagName.toLowerCase())){var i=!0;do{if(t==p||t==x||null==t.parentNode){i=!1;break}t=t.parentNode}while(t&&t!=document.body);i&&(v.foldAll(),r||b.fold())}})}();if(setTimeout(function(){try{d.init(v)}catch(e){reportExpt("roomKeeper_init",e,"")}}),XN.disableMiniRadio===!0);else if("undefined"==typeof window.music_playSongBook){var T=["http://s.xnimg.cn/apps/radio/js/radio-main.js","http://s.xnimg.cn/apps/radio/css/radio-main-all-min.css"];o.radio.seedInit(T,"webpager-miniradio")}else XN.loadFiles(["http://s.xnimg.cn/apps/radio/js/radio-home.js","http://s.xnimg.cn/apps/radio/css/radio-home-v6.css"],function(){XN.radio.home.init("","webpager-miniradio")});if(XN&&XN.user){var N=parseInt(XN.user.id)||0,I=N%10,M=["462464478","200000032","200000521","136536176","254627805","193535156","243313519","303395580","248750157"].join("&");(2==I||3==I||M.indexOf(N)>-1)&&setTimeout(function(){object.execute("xn/apps/status/tiper")})}}),object.define("webpager/im/chatroom","../lib/base, ../lib/uikit, ../service, ../lib/tools, ../service/feed2talkparser, ../service/ubbparser, ../lib/voice,../FriendSelect",function(require,e){var t=require("../lib/base"),n=require("../lib/uikit"),i=require("../service"),a=require("../lib/tools"),r=require("../service/ubbparser"),o=require("../service/feed2talkparser"),s=(require("../lib/voice"),t.dom),d=(t.events,t.XN),l=(a.getLogger("chatroom"),new a.Cluster_Client("chatroom")),c=require("../FriendSelect"),u=new Class(n.Window,function(){this.__mixins__=[n.UIcomplex],this.initialize=function(e,t){this.parent(e,t);var n=e.nodes;n.title.innerHTML='<p class="header-title" style="height:19px"><a title="设置" class="chatroom-set" href="#nogo"  onclick="return false;"></a><span class="title-bg-l"><span class="title-bg-r"></span> </span></p> ',n.setbtn=s.getElement(".chatroom-set",n.title),n.title=s.getElement("span.title-bg-r",n.title),e.buildTalkflow(),e.buildInputer()},this.buildTalkflow=function(e){var t={};t.early_btn=!1;var i=new n.TalkFlow(t);e._assemble("talkflow",i),e.nodes.container.appendChild(i.frame),e.addEvent("focus",function(){setTimeout(function(){i.scrollBottom()})})},this.buildInputer=function(e){var t=new n.Inputer({emotion:!0,history:!0,uploader:!0,capture:!0,maxinput:{num:2e3,tip:"单聊每次最多发送2000个字符."}});e._assemble("inputer",t),e.nodes.container.appendChild(t.frame)},this.pushDialog=function(e,t,n){t.content=t.content.replace(/\r\n/g,"<br/>").replace(/\n/g,"<br/>").replace(/\s{2}/gim,"　　");var i=e.components.talkflow.pushDialog(t,n);return e._fold&&"self"!=t.chat_tag&&e.highLight(),i},this.dropdownLayer=function(e,t){if(e.dropdown_layer)return e.dropdown_layer;var t=t||{};t.block&&e.disable({color:"#FFF",opacity:1});var n=e.nodes.dropdown||(e.nodes.dropdown=document.createElement("div"));n.style.cssText="width:100%;position:absolute;padding-bottom:10px;overflow:hidden;",e.nodes.section.appendChild(n);var i={frame:n,destroy:function(){n.parentNode.removeChild(n),e.enable(),e.dropdown_layer=null}};return e.dropdown_layer=i,i}}),p=new Class(function(){this.__mixins__=[t.events.Events],this.service="oto_chat",this._status=0,this._dead=0,this._relatedUsers={},this.templaters=[],this.strangerList=[],this.initialize=function(e){e.prepare(),e.buildUI(),e.buildModel(),e.finish(),e.bindEvent(),e.model.loadHistory()},this.prepare=function(){},this.buildUI=function(e){var t=new u;e.ui=t},this.finish=function(e){e.model.isPublic&&(e.ui.nodes.setbtn.style.display="none")},this.getDialogTemplate=function(e,t){if(!e.templaters.length)return null;for(var n=null,i=0;i<e.templaters.length&&!(n=e.templaters[i](t));i++);return n},this.buildModel=function(e){var t=new v;e.model=t},this.buildSearchPanel=function(e){var t=e.ui;t.panels.status="search",e.hideAllPanels(),a.isEmptyObject(t.panels.search)?($extend(t.panels,{search:{header:{},section:{}}}),t.panels.search.header.innerHTML=e.buildPanelTitle("search","添加好友"),t.panels.search.section.innerHTML=['<div class="chat-panel search-panel">',"</div>"].join(""),jxn(t.nodes.section).append(t.panels.search.section.innerHTML),setTimeout(function(){e.loadFriendSection("search")},0)):e.loadFriendSection("search"),t.nodes.header.innerHTML=t.panels.search.header.innerHTML},this.buildChatPanel=function(e,t,n){var i=e.ui;if(i.panels.status="chat",i.panels.chat?i.nodes.header.innerHTML=i.panels.chat.header.innerHTML:($extend(i.panels,{chat:{search:{},header:{}}}),i.panels.chat.header.innerHTML=i.nodes.header.innerHTML),t){if(i.nodes.title=s.getElement("span.title-bg-r",i.body),n){i.nodes.title.innerHTML=t;var r=/<[^>]+>/g;i.saveTitle(t.replace(r,""))}else i.nodes.title.innerHTML=a.noMoreThan(t,16),i.nodes.title.title=t,i.saveTitle(t);i.panels.chat.header.innerHTML=i.nodes.header.innerHTML}e.hideAllPanels(),jxn(i.nodes.section).find(".dialog").show(),i.components.talkflow.scrollBottom()},this.loadFriendSection=function(e,t){var n,i=e.ui,a=s.id("wp-friend-select"),r=0;if("search"==t)n=s.getElement(".search-panel",i.nodes.section);else{if("im"!=t)return;n=s.getElement(".im-panel",i.nodes.section),r=10}a?(webpager.fs.maxSelect=r,webpager.fs.clear(),n.appendChild(a),n.style.display="block"):webpager.fs=new c.FriendSelect(n,{maxSelect:r}),webpager.fs.room=e,webpager.fs.room.addEvent("selected",function(t){if(webpager.fs.maxSelect&&webpager.fs.memberList.length==webpager.fs.maxSelect)return void d.Do.showMessage("最多可以添加"+webpager.fs.maxSelect+"成员");if(e.model.attmap){var n=t.data;if(n.id in e.model.attmap){var i=e.model.groupType?"群":"讨论组";return void d.Do.showMessage(n.name+"已在"+i+"中，不能再添加。")}}if(e.model.id){var n=t.data;if(n.id==e.model.id)return void d.Do.showMessage(n.name+"不能再添加了。")}webpager.fs.fireEvent("selectedItem",t)})},this.buildSetPanel=function(e){var t=e.ui;if(t.panels.status="set",e.hideAllPanels(),a.isEmptyObject(e.ui.panels.set)){var n=e.getUser(e.id);$extend(t.panels,{set:{header:{},section:{}}}),t.panels.set.header.innerHTML=e.buildPanelTitle("set","聊天设置"),t.panels.set.section.innerHTML=['<div class="chat-panel set-panel">','	<div class="f-area clearfix">','		<ul class="clearfix"><li>','			<a href="',a.makeProfileUrl(n.userId),'" target="_blank">','				<img src="',n.tiny,'">',"			</a>","			<em>",n.userName,"</em>","		</li>",'		<li class="chat-search">','			<a href="#nogo"  onclick="return false;">+</a>',"			<em>添加好友</em>","		</li></ul>","	</div>",'	<div class="wp-chat-set">',"	</div>","</div>"].join(""),jxn(t.nodes.section).append(t.panels.set.section.innerHTML)}else jxn(t.nodes.section).find(".set-panel").show();t.nodes.header.innerHTML=t.panels.set.header.innerHTML},this.buildHistoryMessagePanel=function(e){var t=e.ui;if(t.panels.status="hm",e.hideAllPanels(),a.isEmptyObject(e.ui.panels.hm)){$extend(t.panels,{hm:{header:{},section:{}}}),t.panels.hm.pageIndex=1,t.panels.hm.pageMaxIndex=9999,t.panels.hm.header.innerHTML=e.buildPanelTitle("hm","聊天记录"),t.panels.hm.section.innerHTML=['<div class="history-message">','	<div class="history-messages">',"	</div>",'	<p class="hm-ft clearfix"><a href="#nogo" title="上一页" class="prev">&lt;</a><a href="#nogo" title="下一页" class="disable next">&gt;</a></p>',"</div>"].join("");var n=jxn(t.nodes.section);n.append(t.panels.hm.section.innerHTML),t.panels.hm.btnPrev=jxn(".hm-ft .prev",n),t.panels.hm.btnNext=jxn(".hm-ft .next",n),e.bindPaginationEv(t)}else jxn(t.nodes.section).find(".history-message").show();t.nodes.header.innerHTML=t.panels.hm.header.innerHTML,e.getHistoryMessage(t)},this.resetHistoryMesagePanels=function(e,t){a.isEmptyObject(t.panels.hm)||(t.panels.hm.pageIndex=1,t.panels.hm.pageMaxIndex=9999,t.panels.hm.section.innerHTML="")},this.bindPaginationEv=function(e,t){jxn(".hm-ft a",jxn(t.nodes.section)).click(function(){var n=jxn(this).attr("class");if("prev"==n)t.panels.hm.pageIndex++;else{if("next"!=n)return;t.panels.hm.pageIndex--}e.getHistoryMessage(t)})},this.setPaginationBtnStatus=function(e,t,n){"enable"==n?(t.panels.hm.btnPrev.attr({"class":"prev",title:"上一页"}),t.panels.hm.btnNext.attr({"class":"next",title:"下一页"})):"disable"==n&&(t.panels.hm.btnPrev.attr({"class":"prev disable",title:""}),t.panels.hm.btnNext.attr({"class":"next disable",title:""}))},this.togglePaginationStatus=function(e,t){var n=t.panels.hm.pageIndex;e.setPaginationBtnStatus(t,"enable"),1>=n&&t.panels.hm.btnNext.attr({"class":"next disable",title:""}),n>=t.panels.hm.pageMaxIndex&&t.panels.hm.btnPrev.attr({"class":"prev disable",title:""})},this.getHistoryMessage=function(e,t,n){n||e.setPaginationBtnStatus(t,"disable");var i=n?1:t.panels&&t.panels.hm.pageIndex,a="sessionId="+e.model.id+"&isgroupchat="+(e.model.info?"1":"0")+"&page="+i;new d.net.xmlhttp({url:"http://chatlist.renren.com/message/get",method:"post",data:a,onSuccess:function(i){var a=d.json.parse(i.responseText);return n?void n(a):("0"==a.code?a.chatlist.length<20&&(t.panels.hm.pageMaxIndex=t.panels.hm.pageIndex):"1"==a.code&&(t.panels.hm.pageIndex=Math.max(1,--t.panels.hm.pageIndex),t.panels.hm.pageMaxIndex=t.panels.hm.pageIndex,jxn(".history-messages",jxn(t.nodes.section)).html('<p class="nomsgdata">没有历史聊天记录</p>')),e.togglePaginationStatus(t),void e.renderHistoryMessage(a.chatlist))},onError:function(){}})},this.renderHistoryMessage=function(e,t){if(!(t.length<=0)){e.ui.panels.hm.baseTime=null,e.ui.panels.hm.baseIndex=null;var n=jxn(".history-messages",jxn(e.ui.nodes.section));jxn("> section, .nomsgdata",n).each(function(){jxn(this).remove()});for(var i=0,s=t.length;s>i;i++){var l=d.json.parse(t[i].info),c=a.makeHeadTinyurl(l.head),u=t[i].name,p=t[i].time,f=t[i].messageid,h=d.json.parse(t[i].content),m="0"==h.contenttype?a.htmlFilter(h.content):h.content;n.append(e.renderTimestamp(e.ui,p,i));var g=h.type||"dialog";switch("appmsg"==h.bodyType&&(g=h.bodyType),g){case"dialog":var v=/img.*width|height/;v.test(m)&&(m=m.replace(/width=\"\d*\.{0,1}\d*\"/,""),m=m.replace(/height=\"\d*\.{0,1}\d*\"/,""));break;case"invitetogroup":case"bigemj":break;case"feed_to_talk":m=o.parseFeed2talk(m,t[i].name);break;case"location":var b=m,w=b.match(/poi.*address=[\"|'](\S*)[\"|']/);if(w&&(m=w[1]),w=b.match(/poi.*mapurl=[\"|'](\S*)[\"|']/)){var y=w[1];y=y.replace(/&amp;/gim,"&"),m+='<img width="180" src="'+y+'"/>'}break;case"secret":m="这是一张私密照片";break;case"readsecret":m="阅读了私密照片";break;case"voip":m="我用新版人人客户端给你打了一个免费电话，下载新版人人客户端就有机会获得各种好礼，你也来加入吧！<a href='http://mobile.renren.com' target='_blank'>http://mobile.renren.com</a>";break;case"appmsg":if("4"==h.appMsgType){var _,x=h.newsItems[0];x.title=""==x.title?"":x.title+"<br>",x.description=""==x.digest?"":x.digest+"<br>",-1!=x.title.indexOf("人人送手机流量包")?(_="http://test1.touch.renren.com/superRegister/activity",m=x.title+"<br>"+x.description+'<a target="_blank" href='+_+">点击查看</a>"):(_=x.url,m=x.title+"<br>"+x.description+'<a target="_blank" href='+_+">点击查看</a>")}else if("10"==h.appMsgType)m="网页版尚不支持此动态信息，可到<a href='http://mobile.renren.com' target='_blank'>mobile.renren.com</a>下载最新人人手机客户端查看";else{var E=""==h.title?"":h.title+"<br>",k=""==h.des?"":h.des+"<br>",C=""==h.appName?"":h.appName+"<br>";_=h.appUrl,m=C+E+k}break;default:m="网页版尚不支持此动态信息，可到<a href='http://mobile.renren.com' target='_blank'>mobile.renren.com</a>下载最新人人手机客户端查看"}m=a.replaceURLWithHTMLLinks(m),m=m.replace(/\r\n/g,"<br/>").replace(/\n/g,"<br/>"),r.hasUbb(m)&&(m=r.parseTxt(m));var T=/<img.*src=\"(.*?)\".*originalsrc=\"(.*?)\".*\/>/gim;if(T.test(m)){var N,I;m.replace(T,function(e,t,n){I=t,N=n}),d.browser.IE6&&(window.fixIE6Size=function(e){return e.width<100?void(e.style.height=e.height+"px"):(e.style.width="100px",void(e.style.height=100*e.height/e.width+"px"))});var M=d.browser.IE6?'onload="fixIE6Size(this);"':'width="100"';n.append(['<section class="wp-chatlist '+(f==d.user.id?"wp-chatlist-self":"")+'">','<figure class="avatar">','<a title="'+u+'" target="_blank" href="http://www.renren.com/profile.do?id='+f+'"><img width="35" height="35" src="'+c+'"></a>',"</figure>",'<section class="wp-chat-content">','<em class="wp-arrow"></em>','<em class="wp-arrow wp-arrow-inner"></em>',"<p>",'<img class="wp-mini-pic " originalsrc="'+N+'" src="'+I+'"'+M+" />","</p>","</section>","</section>"].join(""))}else n.append(['<section class="wp-chatlist '+(f==d.user.id?"wp-chatlist-self":"")+'">','<figure class="avatar">','<a title="'+u+'" target="_blank" href="http://www.renren.com/profile.do?id='+f+'"><img width="35" height="35" src="'+c+'"></a>',"</figure>",'<section class="wp-chat-content">','<em class="wp-arrow"></em>','<em class="wp-arrow wp-arrow-inner"></em>','<p class="tttt">'+m+"</p>","</section>","</section>"].join(""))}n.scrollTop(9999)}},this.getTimestamp=function(e,t,n,i){var a=864e5,r="";return r=t>=0?n:0>t&&t>=-a?"昨天 "+n:-a>t&&t>=2*-a?"前天 "+n:i,'<section class="sys-info">'+r+"</section>"},this.renderTimestamp=function(e,t,n,i){var a=n;n=n.split(" ");var r=n[0].split("-"),o=n[1].split(":"),s=parseInt(r[0]),d=parseInt(r[1])-1,l=parseInt(r[2]),c=parseInt(o[0]),u=parseInt(o[1]),p=new Date(s,d,l,c,u).getTime(),f=new Date,h=f.getFullYear(),m=f.getMonth(),g=f.getDate(),v=new Date(h,m,g).getTime(),b=p-v;return!e.ui.panels.hm.baseTime||p-e.ui.panels.hm.baseTime>3e5||i-e.ui.panels.hm.baseIndex>=10?(e.ui.panels.hm.baseTime=p,e.ui.panels.hm.baseIndex=i,e.getTimestamp(b,n[1],a)):""},this.hideAllPanels=function(e){var t=e.ui;jxn(t.nodes.section).children(":not(.topic-box)").forEach(function(e){jxn(e).hide()})},this.buildPanelTitle=function(e,t,n){var i=document.createElement("h4");i.innerHTML=[' 	<p class="header-title">','		<a class="chat-history"  href="#nogo"  onclick="return false;" title="返回" tag="',t,'">返回</a>',"		<span>",n,"</span>","	</p>"].join("");var a=i.outerHTML+'<menu><li title="最小化" label="最小化" class="minimize">最小化</li><li title="关闭" class="close">关闭</li></menu>';return e.ui.nodes.header.innerHTML=a,a},this.buildReport=function(e,t,n){if(e.ui._fold||n){if(e.model.info&&2==e.model.info.notify)return void e.buildRR(t,1);var i=e.model.attmap?"muc":"chat",a=['<ack from="',top.XN.user.id,'" to="',t.fromuin||t.id||t.uid,'" msgkey="',t.msgkey,'" type="dr" chat_type="',i,'"/>\n\x00'].join("");webpager.sendMessage(a,"newProtocal")}else e.buildRR(t,1)},this.buildRR=function(e,t,n){var i=e.model.attmap?"muc":"chat",a=['<ack from="',top.XN.user.id,'" to="',t.fromuin||t.id||t.uid,'" msgkey="',t.msgkey,'" type="rr" chat_type="',i,'" ext_flag="',n,'"/>\n\x00'].join("");webpager.sendMessage(a,"newProtocal")},this.upMaxMsgKey=function(e,t){e.ui.max_msg_id=t,e.ui.message()},this.isStranger=function(e,t,n){601621937!=e.id&&new d.net.xmlhttp({url:"http://friend.renren.com/friends/api/getrelation",method:"get",data:"gid="+e.id,onSuccess:function(e){var i=e.responseText;"false"==i&&t?t():n&&n()}})},this.popupCaptcha=function(e,t,n){return"muc"==e.model.chatType||e.ugc||e.checkStranger||e.model.isPublic?void n():"muc"==e.model.chatType||e.ugc||e.checkStranger?void n():void e.isStranger(function(){e.icode&&e.close_icode(),e.popupICode("101",t,n)},n)},this.popupICode=function(e,t,n,i){e.show_icode({content:n,attachment:"",story:e.model.sysmsgs[t].story},function(){new d.net.xmlhttp({url:"http://chatlist.renren.com/message/check",method:"post",data:"verifycode="+e.icode.nodes.input.value,onSuccess:function(t){e.close_icode();var a=d.json.parse(t.responseText);"4"==a.code?e.popupICode("102",n,i):(e.strangerList.push(e.id),i())}})},"gossip")},this.bindEvent=function(e){e.model.addEvent("message",function(t){var n=t.data;n.forEach(function(t,i){if(n[i]=e.extendMessage(t),t.isAt)delete n[i].content,e.ui.highLight();else{var a=((n[i].uid||n[i].id)!=top.XN.user.id,n[i].localid||+new Date);e.localid=a,e.msgkeyArray||(e.msgkeyArray=[]);for(var r=e.msgkeyArray.length-1;r>=0;r--)if(e.msgkeyArray[r]==a)return;e.msgkeyArray.push(a),e.msgkeyArray.length>10&&e.msgkeyArray.shift(),t.msgkey&&e.upMaxMsgKey(t.msgkey),e.model.info&&2==e.model.info.notify&&(n[i].ignore=!0),e.ui.pushDialog(n[i],e.getDialogTemplate(t))}}),"system"==n[0].tag||"self"==n[0].chat_tag||e.model.info&&2==e.model.info.notify||(e.ui.getStat().fold>0||e.ui._hidden?i.notify.add({source:e.id,content:n,callback:function(){e.ui.unfold(!0,!0)}}):n.forEach(function(e){e.callback&&new d.net.xmlhttp({url:e.callback,method:"post"})}))}),e.ui.addEvent("focus",function(t){i.notify.delBySource(e.id),t.focus&&setTimeout(function(){e.ui.components.inputer.focus()})}),e.ui.addEvent("fold",function(){if(void 0!=e.ui.max_msg_id&&!e.ui._fold&&e.ui._highlight){var t={id:e.model.id,msgkey:e.ui.max_msg_id};e.buildRR(t,0)}}),e.model.addEvent("historyReplace",function(t){for(var n=t.data,i=n.length,a=i-1;a>=0;a--)n[a].touin!=e.model.id&&n.splice(a,1);n.sort(function(e,t){if(e.msgkey){if(+e.msgkey>+t.msgkey)return 1;if(+e.msgkey<=+t.msgkey)return-1}else{if(e.replyTime>t.replyTime)return 1;if(e.replyTime<=t.replyTime)return-1}});var i=n.length;if(i>1&&n[0].msgkey)for(var a=0;i>a&&a!=i-1;a++)n[a].msgkey==n[a+1].msgkey&&(n.splice(a,1),a--,i=n.length);var r=[];n.forEach(function(t,n){r[n]=e.extendMessage(t)}),e.ui.components.talkflow.replaceContent(r,function(t){return e.getDialogTemplate(t)})});var t=e.ui;t.components.inputer.addEvent("send",function(t){e.ui.components.inputer.reset(!0),e.sendData=t.data,e.popupCaptcha(t.data.content,function(){var n=e.model.send(t.data);n&&e.fireEvent("signal",n),e.checkStranger||(e.checkStranger=!0)})}),e.ui.body.addEvent("click",function(t){t.cancelBubble=!0,t.defaultPrevented=!0;var n=s.wrap(t.target);if(n.hasClass("chat-history")){var i=n.getAttribute("tag");("set"==i||"hm"==i)&&(e.ui.nodes.header.innerHTML=e.ui.panels.chat.header.innerHTML,e.buildChatPanel()),"hm"==i&&e.resetHistoryMesagePanels(e.ui),("search"==i||"im"==i)&&(e.buildSetPanel(),window.webpager.fs.resetList()),("rm"==i||"ag"==i)&&e.buildSetPanel()}n.hasClass("chatroom-set")&&e.buildSetPanel(),n.hasClass("btn-shield"),n.hasClass("btn-reset"),window.webpager.emo&&window.webpager.emo.emotionsContainer.hide(),n.hasClass("wp-chat-history")&&e.buildHistoryMessagePanel();var a=n.getAttribute("originalsrc");a&&d.pasteUploader.showLayer({originalsrc:a,headsrc:n.getAttribute("src"),show:!0}),n.hasClass("checkbox-wrap")&&n.addClass("checkbox-checked"),n.hasClass("checkbox-checked")&&n.removeClass("checkbox-checked")}),e.ui.addEvent("focus",function(){var t=s.id("add-friend-box"),n=e.ui;t&&t.hide(),n.panels&&"search"==n.panels.status?e.buildSearchPanel():n.panels&&"im"==n.panels.status&&e.buildInviteMemberPanel()}),e.ui.addEvent("toChatPanel",function(){e.buildChatPanel()}),window.webpager.addEvent("check_online_status",function(t){var n=0==t?"show-chat-tips":"hide-chat-tips",i=e.ui.frame.getElements(".disconnect-tips");i.removeClass("hide-chat-tips"),i.removeClass("show-chat-tips"),i.addClass(n)}),window.webpager.addEvent("send_msg_faild",function(){var t=e.ui,n=new f({data:e.sendData,time:a.getTime((new Date).getTime()),submit:function(e){t.components.inputer.fireEvent("send",{data:e})}});t.pushDialog({},function(){return n.frame})})},this.extendMessage=function(e,t){return t.content=a.replaceURLWithHTMLLinks(t.content),o.hasFeed2Talk(t.content)&&(t.contentsrc=t.content,t.content=o.parseFeed2talk(t.content,t.name)),r.hasUbb(t.content)&&(t.contentsrc=t.content,t.content=r.parseTxt(t.content)),t},this.zombie=function(e){i.notify.delBySource(e.id),e._dead=new Date-0,e.ui.components.inputer.reset(),e.fireEvent("dead")},this.resume=function(e){e._dead=0,e.ui.show(),e.fireEvent("resume")},this.destroy=function(e){e.ui.destroy(),e.model.destroy()},this.getText=function(e,t,n){var i=e.textCollection[t];if(i){var a=i;for(var r in n)a=a.replace("%"+r+"%",n[r]);return a}return""},this.lookupHistory=function(e,t,n){n?n.location=t:window.open(t)}}),f=new Class(n.UIcommon,function(){this.id=0,this.initialize=function(e,t){e.submit=t.submit,e.param=t,e.buildFrame("section"),e.getUIRef(),e.bindEvent()},this.makeFrameHTML=function(e){var t=['<div class="failed-to-send"><p><span class="failed-to-send-time">'+e.param.time+"</span></p>",'<p class="failed-to-send-msg">可能由于网络原因，消息“'+(e.param.data.content||"")+'”发送失败。<a href="#nogo" class="resend">重新发送</a></p></div>'].join("");return t},this.getUIRef=function(e){var t=e.frame,n={resend:t.getElement("a.resend")};e.nodes=n},this.bindEvent=function(e){var t=e.nodes;t.resend.addEvent("click",function(){e.submit(e.param.data)})}}),h=new Class(n.UIcommon,function(){this.id=0,this._code_loaded=0,this.initialize=function(e,t){e.submit=t.submit,e.param=t,e.buildFrame("div","width:240px;position:relative;margin:auto;background:#EEE;padding:10px;box-shadow:0 0 7px #888"),e.getUIRef(),e.bindEvent()},this.makeFrameHTML=function(e){var t=["<p>"+e.param.tiptext+"<br/>请输入验证码：</p> ",'<p style="margin:9px 0"><a class="spam_geticode" title="看不清,换一个" href="#nogo"> -> 获取验证码</a></p>','<p><input type="text" style="width:50px"> <button>确定</button></p>'].join("");return t},this.getUIRef=function(e){var t=e.frame,n={btn_get:t.getElement("a.spam_geticode"),img:t.getElement("img"),input:t.getElement("input"),submit:t.getElement("button")};e.nodes=n},this.bindEvent=function(e){function t(){var t=n.input.value;return e._code_loaded?void(t&&e.submit(t)):void e.reloadCode()}var n=e.nodes;n.btn_get.addEvent("click",function(){e.reloadCode()}),n.submit.addEvent("click",t),n.input.addEvent("keyup",function(e){13==e.keyCode&&t()})},this.reloadCode=function(e){e._code_loaded=1,setTimeout(function(){e.nodes.btn_get.innerHTML='<img src="http://icode.renren.com/getcode.do?t='+(e.param.captcha?e.param.captcha:"privmessage")+"&rnd="+(new Date).getTime()+'" />'}),e.nodes.input.focus()}}),m=new Class(p,function(){this._status=0,this._dead=0,this.id,this.textCollection={title_online:'<a target="_blank" title="TA的主页" href="http://www.renren.com/%userId%/profile">%userName%</a><img alt="在线" title="在线" src="http://a.xnimg.cn/a.gif" class="wp-online" />',title_offline:'<a target="_blank" title="TA的主页" href="http://www.renren.com/%userId%/profile">%userName%</a>',title_busy:"%userName%",handler:"与%userName%聊天"},this._oto=1,this.initialize=function(e,t){e.id=t,this.parent(e),e.updateProfile(),setTimeout(function(){e.ui.max_msg_id=e.ui.getStat().max_msg_id},0)},this.showStrangeTip=function(e){e.getStrangeInfo(function(){var t=document.createElement("p"),n=e.ui.nodes.body;s.getElement("strange-tip")||(t.className="strange-tip",t.innerHTML='如果觉得打扰，<a href="#nogo" onclick="return false;" class="set">点击这里</a>屏蔽所有陌生人消息，<a href="#nogo" onclick="return false;" class="prevent">不再提醒</a>。',n.insertBefore(t,n.firstChild),setTimeout(function(){s.wrap(t).addEvent("click",function(n){var i=s.wrap(n.target);i.hasClass("set")&&window.webpager.prefer_menu.setStrangerState(1),i.hasClass("prevent")&&e.preventStrange(),jxn(t).remove()})},0),setTimeout(function(){t&&jxn(t).remove()},5e3))})},this.preventStrange=function(){new d.net.xmlhttp({url:"http://chatlist.renren.com/webpagger/page/setnotifyflag",method:"post",onSuccess:function(){}})},this.getStrangeInfo=function(e,t){new d.net.xmlhttp({url:"http://chatlist.renren.com/webpagger/page/getnotifyflag",method:"get",onSuccess:function(e){"true"==e.responseText&&t()}})},this.buildUI=function(e){var t=new u({icon:"wp-chat-ico"});t.rebuild_message={service:"oto_chat",data:{fromuin:e.id,touin:a.User.id}},t.id=e.id,window.talkflows?window.talkflows.push(t):window.talkflows=[t],e.ui=t},this.buildModel=function(e){var t=new v(e.id);e.model=t},this.bindEvent=function(e){this.parent(e),i.friendbook.addEvent("update",function(t){t.data.indexOf(e.id.toString())>=0&&(e._relatedUsers=i.friendbook.getFriendsInfo(e.id),e.updateProfile(),e.model.fireEvent("historyReplace",{data:e.model.msgs}))});e.ui.components.inputer;e.ui.addEvent("invite",function(t){var n=t.data;n.length&&(n.push(a.User.id),n.push(e.id),i.request("chat/group/create",n)&&t.close())}),e.ui.components.talkflow.addEvent("early",function(){e.loadEarlyMsg(10)}),l.addEvent("message",function(t){if(t.data.id==e.id)switch(t.data.msg){case"show_icode":e.show_icode(t.data.spam);break;case"close_icode":e.close_icode()}}),e.model.addEvent("need_icode",function(t){l.broadcast({id:e.id,msg:"show_icode",spam:t.data},1)}),e.ui.body.addEvent("click",function(t){t.cancelBubble=!0,t.defaultPrevented=!0;var n=s.wrap(t.target);if(n.hasClass("wp-friend-confirm")){if(n.hasClass("wp-friend-confirm-disable"))return;window.webpager.fs.disableBtn();var r=webpager.fs.memberList,o=webpager.fs.memberName;if(1==r.length&&r[0]==e.model.id)return void d.DO.showMessage("不能仅选择当前聊天的人创建讨论组。");if(!r.length>0)return void d.DO.showMessage("请至少选择一个好友。");r.push(a.User.id),o.push(a.User.name),r.push(e.model.id),o.push(e.getUser(e.model.id).userName),webpager.fs.clear(),e.buildChatPanel(),i.request("chat/group/create",r,o)}var l="chat-search";(n.hasClass(l)||s.wrap(n.parentNode).hasClass(l))&&e.buildSearchPanel()})},this.loadEarlyMsg=function(e,t,n){e.model.earlyMsg(t,function(t,i){var a=[];i.forEach(function(t){a.push(e.extendMessage(t))});var r=n?"replaceContent":"earlyContent";e.ui.components.talkflow[r](a,function(t){return e.getDialogTemplate(t)})})},this.show_icode=function(e,t,n,i){if(!e.icode){var a=e.ui.dropdownLayer({block:1}),r=new h({submit:n||function(n){e.model.send({content:t.content,attachment:t.attachment,icode:n}),e.close_icode(),l.broadcast({id:e.id,msg:"close_icode"})},tiptext:t.story,captcha:i});a.frame.appendChild(r.frame),a.frame.style.zoom=1,r.nodes.input.focus(),e.icode=r}},this.close_icode=function(e){e.icode.destroy(),e.icode=null,e.ui.dropdown_layer.destroy()},this.extendMessage=function(e,t){var n=t.fromuin,r=i.friendbook.getUserById(n),o={content:t.msg_content,avatar:r.tiny,name:r.userName,userName:r.userName,time:a.getTime(new Date(parseInt(t.timestamp)))||t.time,attachment:t.attachment,profile:"http://www.renren.com/profile.do?id="+n,id:n,msgkey:t.msgkey,msg_headsrc:t.msg_headsrc,msg_originalsrc:t.msg_originalsrc,msg_audiosrc:t.msg_audiosrc,msg_audiotime:t.msg_audiotime,localid:t.localid,chat_tag:t.chat_tag};return this.parent(e,o)},this.getUser=window.webpager.service.getUser=function(e,t){if(!e)return i.friendbook.getFriendsInfo(t)[t];var n=e._relatedUsers;if(!n[t]){var a=i.friendbook.getFriendsInfo(t);n[t]=a[t]}return n[t]},this.updateProfile=function(e){var t=e.ui,n="";e.id>=630000001&&e.id<=639999999?i.friendbook.getPublic(function(i){n=e.getText("title_busy",i),t.setTitle(n),e.buildChatPanel(n,!0),t.setHandler(i.userName)},e.id):i.friendbook.getUser(function(i){n=i.status?e.getText("title_online",i):e.getText("title_offline",i),t.setTitle(n),e.buildChatPanel(n,!0),t.setHandler(i.userName)},e.id)},this.finish=function(e){this.parent(e),e.ui.components.inputer.useFeature("attachment")}}),g=new Class(function(){this.__mixins__=[t.events.Events],this.msgs=[],this.id,this.initialize=function(e,t){e.id=t,e.id>=630000001&&e.id<=639999999&&(e.isPublic=!0)},this.send=function(){},this.loadHistory=function(e){e.attmap?window.webpager.getChatLastestMsg(e.id,"g"):window.webpager.getChatLastestMsg(e.id,"u")
},this.destroy=function(){}}),v=new Class(g,function(){this.sysmsgs={101:{msg:"need_icode",story:"对方不是好友!<br/>为证明你不是发广告的机器,"},102:{msg:"wrong_icode",story:"验证码输入错误!"}},this.send=function(e,t){var n=(t.attachment,t.icode);e.inputText=t.content;var i=t.pic,t=a.htmlFilter(t.content),r=+new Date;n&&(o.icode=n);var o={fromuin:a.User.id,fromname:a.User.name,touin:e.id,msg_content:t,attachment:"",localid:r},s="";e.isPublic&&(s=' subtype = "1000" ');var l="";l=i?['<message fname="',a.User.name,'" from="',a.User.id,'@talk.m.renren.com" to="',e.id,'@talk.m.renren.com" type="chat"',s,">\n",'<richbody type="dialog" localid="',r,'">\n','<img headsrc="',i.headsrc,'" originalsrc="',i.originalsrc,'" />\n',"</richbody>\n","</message>\n\x00"].join(""):['<message fname="',a.User.name,'" from="',a.User.id,'@talk.m.renren.com" to="',e.id,'@talk.m.renren.com" type="chat"',s,">\n",'<richbody type="dialog" localid="',r,'">\n',"<font>",t,"</font>\n","</richbody>\n","</message>\n\x00"].join("");var c=[{attachment:"",chat_tag:"self",fromname:a.User.name,fromuin:a.User.id,last_msgkey:"",localid:r,msg_audiosrc:"",msg_audiotime:"",msg_content:t,msg_headsrc:i?i.headsrc||"":"",msg_originalsrc:i?i.originalsrc||"":"",msgkey:"",timestamp:r,touin:e.id}],u=d.COOKIE.get("id");null!=u&&webpager.getConnState()&&(e.fireEvent("message",{data:c}),webpager.sendMessage(l,"newProtocal",o))},this.pushMessage=function(e,t){var n=[].concat(t),i=e.msgs.length;n.forEach(function(t){e.msgs.push(t)}),e.fireEvent("message",{data:e.msgs.slice(i)})},this.sysMessage=function(e,t){var n=e.sysmsgs[t.code],i={code:t.code,content:t.content,attachment:t.attachment,story:n.story};e.fireEvent("need_icode",{data:i})},this.earlyMsg=function(e,t,n){var i=e.msgs.length,r=["hostId="+a.User.id,"guestId="+e.id,"offset="+i,"limit="+t];new d.net.xmlhttp({url:"http://message.renren.com/message/getlistforwp?"+r.join("&"),method:"GET",onSuccess:function(t){try{var i=JSON.parse(t.responseText)}catch(r){return void n({msg:"服务器返回JSON解析失败!"})}if(!i.join)return void n({msg:"服务器返回数据格式不是列表"},i);for(var o,s=[];o=i.pop();)s.push({msg_content:o.content,time:a.getTime(o.time),fromname:o.memberinfo.name,fromuin:o.memberinfo.id,attachment:o.attach?o.attachment:void 0});e.msgs=s.concat(e.msgs),n(null,s)}})}});e.Chatroom=p,e.ConvChatroom=m,e.ChatroomModel=g,e.ConvChatroom_window=u,e.ConvChatroom_model=v}),object.define("webpager/im/groupchat","../lib/base, ./chatroom, ../service, ../lib/tools, ../lib/uikit",function(require,e){var n=require("../lib/base"),a=n.dom,r=require("./chatroom"),o=require("../service"),s=require("../lib/tools"),d=require("../lib/uikit"),l=s.getLogger("groupchat"),c=(s.QA,new s.Cluster_Client("groupchatroom"),new Class(r.Chatroom,function(){this.service="group_chat",this.initialize=function(e,t,n){e.id=t,e.info=n,this.parent(e);var i=function(){};(i=n.isSuper?o.friendbook.getGroup:o.friendbook.getTeams)(function(t){n.name=e.model.info.name=t.userName||"",e.ui.updateProfile(n),e.buildChatPanel(n.name),e.ui.tag="group",e.model.upTime=0},t)},this.buildUI=function(e){var t=new p({title:e.info.name,icon:e.info.isSuper?"wp-super-group-ico":"wp-group-ico",handler:e.info.name});t.id=e.id;var n=e.info.isSuper?"super_group_chat":"group_chat";t.rebuild_message={service:n,data:{info:{roomid:e.id,roomname:e.info.name},type:"groupchat"}},e.ui=t},this.buildModel=function(e){var t=new u(e.info);t.addEvent("attendee",function(){var n=t.attendee.slice(0);l.log1("成员列表有更新:  ",n),e.ui.components.attendee.setContent(n)}),t.addEvent("infoChange",function(t){e.ui.updateProfile(t.data);var n=e.model.info.name;e.ui.nodes.title=a.getElement("span.title-bg-r",e.ui.body),e.ui.nodes.title&&(e.ui.nodes.title.innerHTML=s.noMoreThan(n,16),e.ui.nodes.title.title=n)}),t.addEvent("exit",function(){if(e.id>1e8)jxn("#wp-supergroup-list dd[uid=g"+e.id+"]").remove(),jxn("#wp-list-recent dd[uid=g"+e.id+"]").remove(),o.friendbook.updateGroup(e.id),0==jxn("#wp-supergroup-list").find("dd").length&&jxn("#wp-supergroup-list").append('<dd uid="none" class="wp-group-nullResult"><a href="#nogo" onclick="return false;" class="wp-f-avatar-box"><img class="wp-f-avatar" src="http://a.xnimg.cn/webpager/res/group-null.png"></a><div class="wp-f-info"><span>还没有内容哦</span></div></dd>');else{jxn("#wp-group-list dd[uid=g"+e.id+"]").remove(),jxn("#wp-list-recent dd[uid=g"+e.id+"]").remove(),o.friendbook.updateTeams(e.id),0==jxn("#wp-group-list").find("dd").length&&jxn("#wp-group-list").append('<dd uid="none" class="wp-group-nullResult"><a href="#nogo" onclick="return false;" class="wp-f-avatar-box"><img class="wp-f-avatar" src="http://a.xnimg.cn/webpager/res/group-null.png"></a><div class="wp-f-info"><span>还没有内容哦</span></div></dd>');var t=['<iq id="123121" to="',e.id,'@muc.talk.renren.com" type="set">\n','	<query xmlns="http://muc.talk.renren.com/quit"/>\n',"</iq>\n\x00"].join("");webpager.sendMessage(t,"newProtocal")}e.ui.close()}),e.model=t},this.inviteFriends=function(e,t,n){t.length&&new XN.net.xmlhttp({url:"http://message.renren.com/session/join",data:"sessionid="+e.id+"&userid="+t.join(","),onSuccess:function(e){if(!e.responseText)return void XN.DO.showError("服务器返回异常. ");var i=JSON.parse(e.responseText);i.ids=t,n(i)}})},this.updateRoom=function(e,t){e.model.memberList=t.items,e.model.name=t.name,e.model.info={name:t.name},e.info.isSuper&&(e.model.info.summary=t.summary,e.model.info.time=t.create_time,e.model.info.male=t.male,e.model.info.female=t.female,e.model.info.member_count=t.member_count,e.model.info.max_member=t.max_member,e.model.info.admin=t.admin,e.model.info.notify=t.notify,e.model.info.isAdmin=t.isAdmin,e.model.info.number=t.number,e.model.info.head_url=t.head_url,e.model.info.poiName=t.poiName,e.model.info.type=t.type),n.setTimeout(function(){e.model.fireEvent("infoChange",{data:e.model.info})})},this.bindEvent=function(e){this.parent(e);e.ui.components.inputer;e.ui.addEvent("invite",function(t){e.inviteFriends(t.data,function(n){n.code?XN.DO.showError(n.msg):(t.close(),o.friendbook.getFriendsInfo(n.ids,function(t){var n=0;for(n in t)e.model.pushAttendee({id:t[n].userId,tiny:t[n].tiny,name:t[n].userName})}))})}),e.model.addEvent("getSuperGroupInfo",function(t){try{e.updateRoom(t.data);var n=jxn("#wp-supergroup-list").find("dd[uid=g"+e.model.id+"]");n.find("em").html(s.noMoreThan(t.data.name,9,!1,!1)),n.find("span")[0].title=t.data.name}catch(t){}}),e.ui.body.addEvent("click",function(t){t.cancelBubble=!0,t.defaultPrevented=!0;var n=a.wrap(t.target);if(n.hasClass("btn-set-name")){var i=a.getElement(".chat-name",n.getParent(".chat-panel"));if(""==i.value.trim())return XN.DO.showMessage("讨论组名称不能为空！"),void i.focus();if(i.value.trim()==e.model.info.name)return void XN.DO.showMessage("讨论组名称没有改变！");var r=['<iq id="create3" to="',e.id,'@muc.talk.renren.com" type="set">\n','	<query xmlns="http://muc.talk.renren.com/config">\n',"		<name>",s.htmlFilter(i.value),"</name>\n","	</query>\n","</iq>\n\x00"].join("");e.model.info.name=i.value.trim(),e.buildChatPanel(),e.ui.updateProfile({name:e.model.info.name}),webpager.sendMessage(r,"newProtocal")}if(n.hasClass("exitgroup")&&e.exitGroupProcess(),n.hasClass("wp-friend-confirm")){if(n.hasClass("wp-friend-confirm-disable"))return;window.webpager.fs.disableBtn();var o=webpager.fs.memberList,d=[];if(!o.length>0)return void XN.DO.showMessage("请至少选择一个好友。");var l=webpager.fs.room;if(l.model.id>1e8&&10==webpager.fs.maxSelect){{var o=webpager.fs.memberList;webpager.fs.memberName}return o.forEach(function(t,n){!function(n){setTimeout(function(){var n=['<message fname="',s.User.name,'" from="',s.User.id,'@talk.m.renren.com" to="',t,'@talk.m.renren.com" type="chat">\n','	<richbody type="invitetogroup" localid="0',(new Date).getTime(),'" >\n','  <groupinfo invite_desc="邀请你加入这个好玩的群" group_id="',e.model.id,'" group_type="100" group_title="',e.model.info.name,'" group_description="',e.model.info.summary,'" group_head_url="',e.model.info.head_url,'" />\n',"	</richbody>\n","</message>\n\x00"].join("");webpager.sendMessage(n,"newProtocal")},1e3*n)}(n)}),void e.buildChatPanel()}o.forEach(function(e){d.push("		<member>"+e+"</member>\n")});var r=['<iq id="121" to="',e.id,'@muc.talk.renren.com">\n','	<query xmlns="http://muc.talk.renren.com/invite">\n',d.join(""),"	</query>\n","</iq>\n\x00"].join("");webpager.sendMessage(r,"newProtocal")}if(n.hasClass("assign-group-btn")){var c=a.getElement(".item-checked",e.ui.nodes.body);if(!c)return void XN.Do.showMessage("请选择一个成员。");var u=c.getAttribute("uid");e.buildAssignHandel(u)}var p="chat-search";if((n.hasClass(p)||a.wrap(n.parentNode)&&a.wrap(n.parentNode).hasClass(p))&&e.buildSearchPanel(),n.hasClass("fbtn")&&e.fbtnSlide(n),n.hasClass("chat-tab")){var f=e.ui.body.getElement(".wp-chat-tab"),h=a.getElements(".chat-tab",f);return h.forEach(function(t,i){t.removeClass("on"),e.ui.panels.set.header.innerHTML=e.buildPanelTitle("set","聊天信息"),t==n&&(0==i?e.showMemberList():1==i?e.showGroupInfo():2==i&&e.setGroupInfo())}),void n.addClass("on")}if(n.hasClass("invite-member")&&e.buildInviteMemberPanel(),n.hasClass("remove-member")&&e.buildRemoveMemberPanel(),n.hasClass("remove-item")&&XN.Do.confirm({message:"您确定要移除该成员？",callback:function(t){t&&e.removeMemberHandel(n)}}),n.hasClass("modify-info")&&e.modifyGroupInfo(),n.hasClass("save-info")&&e.saveGroupInfo(),n.hasClass("close-info")&&e.showGroupInfo(),n.hasClass("prevent-message")&&e.setGroupNotify(n),n.hasClass("assign-group")&&e.buildAssignPanel(),n.hasClass("exit-superGroup")&&XN.Do.confirm({message:"您确定要退出群吗？",callback:function(t){t&&e.exitSuperGroup()}}),n.hasClass("item-checked"))return void n.removeClass("item-checked");if(n.hasClass("checkbox-item")){var m=a.getElements(".checkbox-item",e.ui.nodes.body);return m.forEach(function(e){e.removeClass("item-checked")}),void n.addClass("item-checked")}})},this.fbtnSlide=function(e,t){if(!t.hasClass("fbtn-disabled")){if(t.hasClass("fbtn-prev")){var n=parseInt(e.wpGroupchatWrap.css("margin-left"));return e.fbtnNext.removeClass("fbtn-disabled"),e.curPage>=e.maxPage-1?(e.wpGroupchatWrap.css("margin-left",0),e.curPage=e.maxPage,void t.addClass("fbtn-disabled")):(e.curPage++,void e.wpGroupchatWrap.css("margin-left",n+250+"px"))}if(t.hasClass("fbtn-next")){var n=parseInt(e.wpGroupchatWrap.css("margin-left")),i=jxn(".actived .wp-groupchat li").length;return e.fbtnPrev.removeClass("fbtn-disabled"),e.curPage<=e.minPage+1?(e.wpGroupchatWrap.css("margin-left",50*(-i+5)+"px"),e.curPage=e.minPage,void t.addClass("fbtn-disabled")):(e.curPage--,void e.wpGroupchatWrap.css("margin-left",n-250+"px"))}}},this.finish=function(e){this.parent(e),e.ui.components.inputer.useFeature("attachment")},this.exitGroupProcess=function(e){e.model.fireEvent("exit")},this.buildMemberList=function(e,t){for(var n=[],i=e.model.memberList||[],a="",r=0;r<i.length;r++)t&&"remove"==t?a='<a href="#nogo" onclick="return false;" class="remove-item" title="删除" uid="'+i[r].uid+'">&nbsp;</a>':t&&"assign"==t&&(a='<a href="#nogo" onclick="return false;" class="checkbox-item" uid="'+i[r].uid+'">&nbsp;</a>'),t&&i[r].uid==top.XN.user.id||n.push(["		<li>",'			<a title="TA的主页" href="http://www.renren.com/',i[r].uid,'/profile" target="_blank">','				<img src="',i[r].portrait,'">',"			</a>","			<em>",s.noMoreThan(i[r].name,4,!1,!0),"</em>",a,"		</li>"].join(""));return n.length||(n="assign"==t?['<li class="tip">该群还没有其他成员，无法转让。</li>']:['<li class="tip">该群还没有成员，赶快邀请好友加入吧。</li>']),n.join("")};this.buildSetPanel=function(e){var t=e.ui;return t.panels.status="set",e.hideAllPanels(),$extend(t.panels,{set:{header:{},section:{}}}),jxn(t.nodes.section).find(".set-panel").remove(),e.info.isSuper?void e.model.getGroupById(e.info.id,function(t){e.updateRoom(t),e.buildSgroupSetPanelHtml()}):void e.model.getForumById(function(t){e.updateRoom(t),e.buildSetPanelHtml()})},this.buildRemoveMemberPanel=function(e){var t=e.ui;if(t.panels.status="rm",e.hideAllPanels(),s.isEmptyObject(e.ui.panels.rm)){$extend(t.panels,{rm:{header:{},section:{}}}),t.panels.rm.header.innerHTML=e.buildPanelTitle("rm","移除成员"),t.panels.rm.section.innerHTML=['<div class="rm-panel">','<ul class="wp-remove-list">',e.buildMemberList("remove"),"</ul>","</div>"].join("");var n=jxn(t.nodes.section);n.append(t.panels.rm.section.innerHTML)}else jxn(t.nodes.section).find(".rm-panel").show();t.nodes.header.innerHTML=t.panels.rm.header.innerHTML},this.removeMemberHandel=function(e,t){var n=t.getAttribute("uid");new XN.net.xmlhttp({url:"http://lbsgroup.renren.com/admin/removeMember?",method:"post",data:"id="+e.model.id+"&uid="+n,onSuccess:function(i){var a=JSON.parse(i.responseText);a.status.code?(jxn(t.parentNode).remove(),e.model.removeMember(n)):XN.DO.showMessage(a.status.content)},onError:function(){XN.DO.showMessage("移除成员出错了，请稍后再试。")}})},this.inviteMemberHandel=function(e){new XN.net.xmlhttp({url:"http://lbsgroup.renren.com/admin/removeMember?",method:"post",data:"id="+e.model.id+"&uid="+uid,onSuccess:function(e){var n=JSON.parse(e.responseText);n.status.code?jxn(t.parentNode).remove():XN.DO.showMessage(n.status.content)},onError:function(){XN.DO.showMessage("移除成员出错了，请稍后再试。")}})},this.buildInviteMemberPanel=function(e){var t=e.ui;t.panels.status="im",e.hideAllPanels(),s.isEmptyObject(e.ui.panels.im)?($extend(t.panels,{im:{header:{},section:{}}}),t.panels.im.header.innerHTML=e.buildPanelTitle("im","邀请成员"),t.panels.im.section.innerHTML=['<div class="chat-panel im-panel">',"</div>"].join(""),jxn(t.nodes.section).append(t.panels.im.section.innerHTML),setTimeout(function(){e.loadFriendSection("im")},0)):e.loadFriendSection("im"),t.nodes.header.innerHTML=t.panels.im.header.innerHTML},this.showGroupInfo=function(e){var t=e.ui.body.getElement(".wp-super-content"),n=e.model.info.isAdmin?'<a href="#nogo" onclick="return false" class="modify-info sbtn">编辑资料</a>':"",i="1"==e.model.info.type?'	<p class="clearfix"><span class="p-l">位　　置：</span><span class="p-r">'+e.model.info.poiName+"</span></p>":'	<p class="clearfix"><span class="p-l">群　　号：</span><span class="p-r">'+e.model.info.number+"</span></p>";t.innerHTML=['<div class="wp-info-list">','	<p class="clearfix"><span class="p-l">名　　称：</span><span class="p-r">',e.model.info.name,"</span></p>",'	<p class="clearfix"><span class="p-l">群　　主：</span><span class="p-r">',e.model.info.admin,"</span></p>",i,"	<h3>&nbsp;</h3>",'	<p class="clearfix"><span class="p-l">创建时间：</span><span class="p-r">',e.model.info.time,"</span></p>",'	<p class="clearfix"><span class="p-l">群&nbsp;成&nbsp;员：</span><span class="p-r">',e.model.info.member_count,"/",e.model.info.max_member,"</span></p>",3!=e.model.info.type?'	<p class="clearfix"><span class="p-l">群&nbsp;介&nbsp;绍：</span><span class="p-r">'+e.model.info.summary+"</span></p>":"","</div>",'<p class="toolsp clearfix"><span class="tl-r">',n,"</span></p>"].join("")},this.modifyGroupInfo=function(e){var t=e.ui.body.getElement(".wp-super-content");if(t.innerHTML=['<div class="wp-info-list">','	<p class="clearfix"><span class="p-l">名称：</span><input type="text" maxlength="20" id="super-group-name" value="',e.model.info.name,'"></p>',3!=e.model.info.type?'	<p class="clearfix"><span class="p-l">群介绍:</span></p>	<p class="clearfix"><textarea id="super-group-summary" maxlength="100">'+e.model.info.summary+"</textarea></p>":"","</div>",'	<p class="toolsp clearfix">','		<span class="tl-r">','			<a href="#nogo" onclick="return false" class="save-info sbtn">保存</a>','			<a href="#nogo" onclick="return false" class="close-info sbtn gray">关闭</a>'," 		</span>","	</p>"].join(""),3!=e.model.info.type){var n=a.id("super-group-summary");e.ui.panels.set.textarea=new XN.form.help(n)}},this.setGroupInfo=function(e){var t=e.ui.body.getElement(".wp-super-content"),n=1==e.model.info.notify?"确定":"解除屏蔽",i=1==e.model.info.notify?"屏蔽此群消息":"此群消息已被屏蔽",a=e.model.info.isAdmin?"assign-group":"exit-superGroup";btnText=e.model.info.isAdmin?"转让群":"退出群",t.innerHTML=['<div class="wp-super-list">','	<p class="prevent-p">','		<span class="tl-l">',i,"</span>",'		<span class="tl-r"><a href="#nogo" onclick="return false" class="prevent-message sbtn gray" state="',e.model.info.notify,'">',n,"</a></span>","	</p>","</div>",'<p class="toolsp clearfix">','	<span class="tl-r">','		<a href="#nogo" onclick="return false" class="',a,' sbtn">',btnText,"</a>","	</span>","</p>","</p>"].join("")},this.exitSuperGroup=function(e){new XN.net.xmlhttp({url:"http://lbsgroup.renren.com/member/exitGroup?id="+e.model.id,method:"get",onSuccess:function(t){var n=JSON.parse(t.responseText);n.status.code?e.exitGroupProcess():XN.DO.showMessage(n.status.content)},onError:function(){XN.DO.showMessage("退出群出错了，请稍后再试。")}})},this.saveGroupInfo=function(e){var t=a.id("super-group-name").value,n=3==e.model.info.type,i=n?"私密群没有群介绍信息":a.id("super-group-summary").value;return t!=e.model.info.name||n||i!=e.model.info.summary?""==t.trim()||!n&&""==i.trim()?void XN.Do.showMessage("资料不能为空。"):t.trim().length<4?void XN.Do.showMessage("用户名称不能少于4个字符。"):!n&&i.trim().length<10?void XN.Do.showMessage("群简介不能少于10个字符。"):void new XN.net.xmlhttp({url:"http://lbsgroup.renren.com/group/editGroupInfo?id="+e.model.id+"&name="+encodeURIComponent(t)+"&summary="+encodeURIComponent(i),method:"get",onSuccess:function(n){var a=JSON.parse(n.responseText);if(a.status.code)e.model.info.summary=i,e.model.info.name=t,e.buildChatPanel(),e.ui.updateProfile({name:t});else{if(a.status.content)return void XN.DO.showMessage(a.status.content);XN.DO.showMessage(a.data)}},onError:function(){XN.DO.showMessage("保存编辑信息出错了，请稍后再试。")}}):void XN.Do.showMessage("你还没有更新群资料。")},this.setGroupNotify=function(e,t){var n=t.getAttribute("state"),i=1==n?2:1;new XN.net.xmlhttp({url:"http://lbsgroup.renren.com/group/setNotify?id="+e.model.id+"&state="+i,method:"get",onSuccess:function(i){var a=JSON.parse(i.responseText);a.status.code&&(1==n?(t.setAttribute("state",2),e.model.info.notify=2,t.innerHTML="解除屏蔽",jxn(t).parent().parent().find(".tl-l").html("此群消息已被屏蔽"),o.friendbook.updateGroupState(e.model.id,2)):(t.setAttribute("state",1),e.model.info.notify=1,t.innerHTML="确定",jxn(t).parent().parent().find(".tl-l").html("屏蔽此群消息"),o.friendbook.updateGroupState(e.model.id,1)))},onError:function(){XN.DO.showMessage("屏蔽消息设置出错了，请稍后再试。")}})},this.showMemberList=function(e){var t=e.ui.body.getElement(".wp-super-content"),n="";e.model.info.isAdmin&&(n+="0"==e.model.info.type?'<a href="#nogo" onclick="return false" class="invite-member sbtn">邀请成员</a>':"",n+='<a href="#nogo" onclick="return false;" class="remove-member sbtn gray">移除成员</a>'),t.innerHTML=['		<ul class="clearfix wp-super-list">',e.buildMemberList(),"		</ul>",'		<p class="toolsp clearfix">','			<span class="tl-l">成员(',e.model.memberList.length,")</span>",'			<span class="tl-r">',n,"</span>","		</p>"].join("")},this.buildSgroupSetPanelHtml=function(e){var t=e.ui;t.panels.set.header.innerHTML=e.buildPanelTitle("set","聊天信息"),t.panels.set.section.innerHTML=['<div class="chat-panel set-panel">','	<p class="wp-chat-tab clearfix">','		<span class="chat-tab first on">成员</span>','		<span class="chat-tab">资料</span>','		<span class="chat-tab">设置</span>',"	</p>",'	<div class="wp-super-content">',"	</div>","</div>"].join(""),jxn(t.nodes.section).append(t.panels.set.section.innerHTML),t.nodes.header.innerHTML=t.panels.set.header.innerHTML,e.showMemberList()},this.buildSetPanelHtml=function(e){var t=e.ui;t.panels.set.header.innerHTML=e.buildPanelTitle("set","聊天设置"),t.panels.set.section.innerHTML=['<div class="chat-panel set-panel">','	<div class="f-area clearfix">','		<a href="#nogo"  onclick="return false;" class="fbtn fbtn-prev fbtn-disabled"><</a>','		<a href="#nogo"  onclick="return false;" class="fbtn fbtn-next fbtn-disabled">></a>','		<div class="wp-groupchat"><ul class="clearfix">',e.buildMemberList(),'		<li class="chat-search">','			<a href="#nogo"  onclick="return false;">+</a>',"			<em>添加好友</em>","		</li></ul></div>","	</div>",'	<div class="wp-chat-set">',"		<h3>修改讨论组名称</h3>",'		<p><a href="#nogo"  onclick="return false;" class="btn btn-set-name">完成</a><input type="text" class="chat-name" maxlength="20" value="',e.model.info.name,'"></p>',"	</div>",'		<p class="exitgroup-wrap"><a href="#nogo"  onclick="return false;" class="exitgroup">退出讨论组</a></p>',"</div>"].join(""),jxn(t.nodes.section).append(t.panels.set.section.innerHTML),t.nodes.header.innerHTML=t.panels.set.header.innerHTML;var n=jxn(e.ui.body).find(".wp-groupchat ul"),i=n.find("li").length;n.css("width",50*i+"px"),e.maxPage=Math.floor(i/5),i%5!=0&&(e.maxPage+=1),e.minPage=1,e.curPage=e.minPage,e.wpGroupchatWrap=n,e.fbtnNext=jxn(e.ui.body).find(".fbtn-next"),e.fbtnPrev=jxn(e.ui.body).find(".fbtn-prev"),i>5&&(n.css("margin-left",50*-(i-5)+"px"),e.fbtnPrev.removeClass("fbtn-disabled"))},this.buildAssignHandel=function(e,t){new XN.net.xmlhttp({url:"http://lbsgroup.renren.com/admin/transferGroup?id="+e.model.id+"&uid="+t,method:"get",onSuccess:function(t){var n=JSON.parse(t.responseText);n.status.code?(XN.DO.showMessage("转让成功。"),e.buildChatPanel(),e.model.info.isAdmin=!1):XN.DO.showMessage(n.status.content)},onError:function(){XN.DO.showMessage("转让群出错了，请稍后再试。")}})},this.buildAssignPanel=function(e){var t=e.ui;t.panels.status="ag",e.hideAllPanels(),$extend(t.panels,{ag:{header:{},section:{}}}),t.panels.ag.header.innerHTML=e.buildPanelTitle("ag","聊天信息"),t.panels.ag.section.innerHTML=['<div class="chat-panel wp-assign-list">','	<ul class="clearfix">',e.buildMemberList("assign"),"	</ul>","</div>",'<p class="toolsp clearfix">','<span class="tl-r"><a href="#nogo" onclick="return false" class="assign-group-btn sbtn">确认转让</a></span>',"</p>"].join(""),jxn(t.nodes.section).append(t.panels.ag.section.innerHTML),t.nodes.header.innerHTML=t.panels.ag.header.innerHTML}})),u=new Class(r.ChatroomModel,function(){this.attendee=[],this.attmap={},this.info={},this.settings={notify:!0},this._history_att={},this.initialize=function(e,t){e.id=t.id,e.chatType="muc",e.info=t},this.removeMember=function(e,t){for(var n=e.memberList.length,i=0,a=0;n>a;a++)if(t==e.memberList[a].uid){i=a;break}e.memberList.splice(i,1)},this.addMember=function(e,t){var n=t.items;e.memberList&&(e.memberList=e.memberList.concat(n))},this.pushMessage=function(e,t){var n=t.info;switch(n.roomname&&e.info.name!=n.roomname&&(e.info.name=n.roomname,e.fireEvent("infoChange",{data:e.info})),t.type){case"groupchat":var i=t.uid||t.info.userid;o.friendbook.getUser(function(n){t.att=n;var i=e.extendMessage(t);i.attachment=t.attachment,e.fireEvent("message",{data:[i]})},i);break;case"entergroup":e.pushAttendee({id:n.userid,name:t.name,tiny:s.makeHeadTinyurl(t.tiny),status:t.status});break;case"leftgroup":e.pushAttendee({id:n.userid,name:t.name,tiny:s.makeHeadTinyurl(t.tiny),status:0});break;case"exitgroup":s.isMyself(n.userid)&&e.fireEvent("exit");break;case"settingchange":l.log1("没有处理的群消息: settingChange!!! ",t)}},this.extendMessage=function(e,t){{var n=t.att;t.timestamp||new Date}e.msgs.push({chat:t.chat,uid:n.userId});var i={avatar:n.tiny||s.resource.url.OFFLINE_IMG,profile:s.makeProfileUrl(n.userId),id:t.info.roomid,uid:n.userId,name:decodeURIComponent(n.userName||t.fname),time:s.getTime(new Date(parseInt(t.timestamp)))||t.time,content:t.chat,attachment:t.attachment,msgkey:t.msgkey,msg_headsrc:t.msg_headsrc,msg_originalsrc:t.msg_originalsrc,msg_audiosrc:t.msg_audiosrc,msg_audiotime:t.msg_audiotime,localid:t.localid,chat_tag:t.chat_tag};return i},this.send=function(e,t){var n=s.User,i=+new Date;e.inputText=t.content;var a=s.htmlFilter(t.content),r=t.pic,o=a.replace(/  /gim,"　"),d="";d=r?['<message fname="',n.name,'" from="',n.id,'@muc.talk.m.renren.com" to="',e.id,'@muc.talk.renren.com" type="muc">\n','<richbody type="dialog" localid="',i,'">','<img headsrc="',r.headsrc,'"  originalsrc="',r.originalsrc,'" />',"</richbody>\n","</message>\n\x00"].join(""):['<message fname="',n.name,'" from="',n.id,'@muc.talk.renren.com" to="',e.id,'@muc.talk.renren.com" type="muc">\n','	<richbody type="dialog" localid="',i,'"><font>',o,"</font></richbody>\n","</message>\n\x00"].join("");var o={from:e.id+"@group.talk.xiaonei.com/"+n.name+"(0)-"+n.id,roomid:e.id,to:n.id+"@talk.xiaonei.com/WTalkProxy6_0",content:'{type:"groupchat",info:{roomid:"'+e.id+'",userid:"'+n.id+'"}, chat:"'+o.replace(/\"/gim,'\\"').replace(/\\/gim,"\\\\")+'"}',attachment:t.attachment||"",msg_headsrc:r?r.headsrc||"":"",msg_originalsrc:r?r.originalsrc||"":"",msg_audiosrc:"",msg_audiotime:"",localid:i},l=[{attachment:t.attachment||"",avatar:XN.USER.tinyPic,chat_tag:"self",content:a,id:e.id,localid:i,msg_audiosrc:"",msg_audiotime:"",msg_headsrc:r?r.headsrc||"":"",msg_originalsrc:r?r.originalsrc||"":"",msgkey:"",name:n.name,profile:"http://www.renren.com/profile.do?id="+n.id,time:s.getTime(i),uid:n.id}],c=XN.COOKIE.get("id");null!=c&&webpager.getConnState()&&(e.fireEvent("message",{data:l}),webpager.sendMessage(d,"newProtocal"))},this.getRoomSetting=function(e){new XN.net.xmlhttp({url:"http://qun.renren.com/qun/"+e.id+"/chatFlag",method:"get",onSuccess:function(t){var n=JSON.parse(t.responseText);n&&0==n.code?(e.settings=n.chatFlag,e.fireEvent("setting")):l.log1("加载群聊roomSetting返回错误 ",n)}})},this.resetRoomIcon=function(e){var t=webpager.roomKeeper.findRoom(e.id).ui;jxn(t.nodes.bar).find("p").removeClass().addClass("wp-super-group-ico"),t.rebuild_message.service="super_group_chat",t.message()},this.getForumById=function(e,t){new XN.net.xmlhttp({url:"http://webpager.renren.com/api/getGroupInfo?gids="+e.id+"&type=1",method:"get",onSuccess:function(n){var i=XN.json.parse(n.responseText);if(0!=i.code)XN.DO.showMessage("获取群讨论组的信息出错了，"+i.msg);else{for(var a,r=i.data.groups[0],o={type:"result",name:r.name,from:e.id,items:[]},s=0;s<r.items.length;s++)a=r.items[s],o.items.push({name:a.name,portrait:a.tiny_url,uid:a.uid});t&&t(o)}},onError:function(){XN.DO.showMessage("获取讨论组列表出错了，请稍后再试。")}})},this.getforumInfo=function(e,t){if(!e.memberList||t){var n=['<iq id="',+new Date,'" to="',e.id,'@muc.talk.renren.com" type="get">\n','	<query xmlns="http://muc.talk.renren.com/items"/>\n',"</iq>\n\x00"].join("");webpager.sendMessage(n,"newProtocal")}},this.getGroupById=function(e,t,n){var t=t;new XN.net.xmlhttp({url:"http://lbsgroup.renren.com/group/getGroupProfile?id="+t,method:"get",onSuccess:function(e){var t=JSON.parse(e.responseText);t.status.code&&n&&n(t.data)},onError:function(){XN.DO.showMessage("获取群信息出错了，请稍后再试。")}})},this.getSuperGroupInfo=function(e){var t=e.id;new XN.net.xmlhttp({url:"http://lbsgroup.renren.com/group/getGroupProfile?id="+t,method:"get",onSuccess:function(t){var n=JSON.parse(t.responseText);n.status.code&&e.fireEvent("getSuperGroupInfo",{data:n.data})},onError:function(){XN.DO.showMessage("获取群信息出错了，请稍后再试。")}})},this.replaceAttendee=function(e,t){e.attendee=t;var n={},i=[];t.forEach(function(e){n[e.id||e.uid]=e,i.push(e.id)});var a={name:XN.user.name,uid:XN.user.id,tiny:XN.user.tinyPic};n[a.uid]=a,e.attmap=n},this.delAttendee=function(e,t){for(var n=t.id||t,i=e.attendee.length,a=0;i>a;a++)if(e.attendee[a].id==n){t=e.attendee[a],e.fireEvent("attendeeLeft",{data:e.attendee.splice(a,1)[0]});break}e.fireEvent("attendee",{data:t}),delete e.attmap[n]},this.pushAttendee=function(e,t){e.attmap[t.id]?n.extend(e.attmap[i],t,!0):(e.fireEvent("attendeeIn",{data:t}),e.attendee.push(t),e.attmap[t.id]=t),e.fireEvent("attendee",{data:t})}}),p=new Class(d.Window,function(){this.__mixins__=[d.UIcomplex],this.initialize=function(e,t){this.parent(e,t);var n=e.nodes;n.title.innerHTML='<p class="header-title" style="height:19px"><a title="设置" class="chatroom-set" href="#nogo" onclick="return false;"></a><span class="title-bg-l"><span class="title-bg-r"></span> </span></p> ',n.setbtn=a.getElement(".chatroom-set",n.title),n.title=a.getElement("span.title-bg-r",n.title);var i=new d.IFeature_invite;n.container.appendChild(i.frame),e.buildTalkflow(),e.buildInputer()},this.buildTalkflow=function(e){var t={};t.early_btn=!1;var n=new d.TalkFlow(t);e._assemble("talkflow",n),e.nodes.container.appendChild(n.frame),e.addEvent("focus",function(){setTimeout(function(){n.scrollBottom()},0)})},this.buildInputer=function(e){var t=new d.Inputer({emotion:!0,uploader:!0,capture:!0,history:!0});e._assemble("inputer",t),e.nodes.container.appendChild(t.frame)},this.pushDialog=function(e,t,n){t.content=t.content.replace(/\r\n/g,"<br/>").replace(/\n/g,"<br/>").replace(/\s{2}/gim,"　　");var i=e.components.talkflow.pushDialog(t,n);return e._fold&&"system"!=t.tag&&"self"!=t.chat_tag&&!t.ignore&&e.highLight(),i},this.updateProfile=function(e,t){setTimeout(function(){var n=jxn(".title-bg-r",e.nodes.header);n.html(s.noMoreThan(t.name,16)),n[0]&&(n[0].title=t.name,e.panels.chat.header.innerHTML=e.nodes.header.innerHTML)},0),e.setHandler(s.noMoreThan(t.name,6))},this.appendAttendee=function(e,t){e.components.attendee.appendAttendee(t)}});e.GroupChatroom=c}),object.define("webpager/im/roomkeeper","../lib/base, ../lib/tools, ../lib/channel_api, ../service, ../lib/uikit, ./chatroom, ./groupchat, ../ugc, ../ugc/gift",function(require,e){var t=(require("../lib/base"),require("../lib/tools")),n=require("../lib/channel_api"),i=t.getLogger("roomkeeper"),a=t.QA,r=require("../service"),o=r.preferences,s=(require("../lib/uikit"),require("./chatroom")),d=require("./groupchat"),l=require("../ugc"),c=require("../ugc/gift"),u=new t.Cluster_Client("chat"),p=function(e){if(e)switch(e.service){case"oto_chat":roomKeeper.throwToChatRoom(e);break;case"group_chat":roomKeeper.throwToGroupChatRoom(e);break;case"super_group_chat":roomKeeper.throwToGroupChatRoom(e,1);break;case"ugc_chat":if(!e.target){var t=e.data,n=t.feed_actor+"_"+t.feed_source+"_"+t.feed_stype;e.target=n}roomKeeper.dispatch(e);break;case"spam":roomKeeper.processSpam(e)}};e.init=function(t){webpager.imRunning?o.set("im_disabled",!0):(o.get("im_disabled")&&(window.frames.imengine.WPC.reportLogMsg("bug_imDisabled"),e.nlog_once=!0),o.set("im_disabled",!1)),window.webpager.addEvent("group_inviteuser",function(e){var t=e;t.tag="addOneGroup",u.broadcast(t,1)}),window.webpager.addEvent("group_open",function(e){var t=e;t.roomName=e.name,t.tag="addOneGroup",u.broadcast(t,1)}),window.webpager.addEvent("group_createitem",function(e){var t=e;t.roomName=e.roomname,t.from=e.roomid,t.tag="addOneGroup",u.broadcast(t,1)}),u.addEvent("message",function(e){if(e.data&&"notifySys"==e.data.tag){var t=roomKeeper.findRoom(e.data.roomid);return void(t&&(t.model.fireEvent("message",{data:[{content:e.data.msg,tag:"system"}]}),t.buildChatPanel()))}if(e.data&&"clearInput"==e.data.tag){var t=roomKeeper.findRoom(e.data.roomid);return void(t&&t.ui.fireEvent("room_input_reset",{}))}if(e.data&&"addOneGroup"==e.data.tag)return void window.webpager.fireEvent("insertGroup",e.data);if(e.data&&"error"==e.data.tag){var t=roomKeeper.findRoom(e.data.id);return void(t&&XN.Do.showMessage(e.data.msg))}if(e.data&&"sr_error"==e.data.tag){var t=roomKeeper.findRoom(e.data.id);return void(t&&(t.ui.components.inputer.nodes.text.value=t.model.inputText))}if(e.data&&"addMember"==e.data.tag){var t=roomKeeper.findRoom(e.data.roomid);return void(t&&t.model.addMember(e.data))}if(e.data&&"removeMember"==e.data.tag){var t=roomKeeper.findRoom(e.data.from);return void(t&&t.model.removeMember(e.data.uid))}if(e.data&&"getGroupType"==e.data.tag){var t=roomKeeper.findRoom(e.data.roomid,!0);return void(t&&100==e.data.grouptype&&(t.model.groupType=100,t.model.resetRoomIcon()))}i.log1("收到一条cluster广播: ",e),e.data.posted=1,p(e.data)}),webpager.addEvent("notifyClearInput",function(e){var t={tag:"clearInput",roomid:e.roomid};u.broadcast(t,1)}),window.webpager.addEvent("get_group_type",function(e){var t={tag:"getGroupType",roomid:e.from,grouptype:e.grouptype};u.broadcast(t,1)}),window.webpager.addEvent("chat_error",function(e){var t;t="sr"==e.type?{tag:"sr_error",id:e.to}:{tag:"error",msg:e.info,id:e.from},u.broadcast(t,1)}),window.webpager.addEvent("group_info",function(e){var t={tag:"error",msg:e.description,id:e.groupid};u.broadcast(t,1)}),window.webpager.addEvent("group_inviteitem",function(e){var t=e;t.tag="addMember",u.broadcast(t,1)}),window.webpager.addEvent("group_quititem",function(e){var t=e;t.tag="removeMember",u.broadcast(t,1)
}),webpager.addEvent("notifySys",function(e){var t={tag:"notifySys",msg:e.msg,roomid:e.roomid};u.broadcast(t,1)}),r.messager.addEvent("message",function(e){p(e.sgl)}),roomKeeper.init(),f.init(t),t.addEvent("remove",function(e){var t=roomKeeper.findRoom(e.data);t&&t.zombie()})},roomKeeper={rooms:{},_rooms_pending:{},_rooms_dead:{},init:function(){var e=this;t.pagerTimer.addEvent("timeout",function(t){var n=e._rooms_dead;for(var i in n)t.timestamp-n[i]._dead>6e5&&(n[i].destroy(),delete n[i])}),r.notify.addEvent("load",function(){e.validNotify()})},dispatch:function(e){i.log1("messager发布的signal",e);var t=this,n=e.target,a=t.findRoom(n);if("create"==e.action||!a){if(a)return;if(t._rooms_pending[n]=[],t.buildRTChatroom(e,function(i,a){if(i)return void(t._rooms_pending[n]="dead");if(a){var r=t._rooms_pending[n];t.addRoom(a,n),a.signal(r)}e.posted||u.broadcast(e),e.callback&&e.callback(i)}),"create"==e.action)return}if(a&&a.signal)a.signal(e),e.posted||u.broadcast(e);else{if(!(t._rooms_pending[n]instanceof Array))throw new Error("findRoom的结果不是新概念UGC聊天室,pendding列表中没有该roomId对应的信号队列");t._rooms_pending[n].push(e)}},throwToChatRoom:function(n){try{e.nlog_once&&(window.frames.imengine.WPC.reportLogMsg("bug_missed_msg"),e.nlog_once=!1)}catch(d){}o.get("im_disabled")&&("user"!=n.source||(o.set("im_disabled",!1),o.set("quiet_mode",!1))),i.log1("收到新单聊消息",n);var l=this,c=n.data,u=t.isMyself(c.fromuin)?c.touin:c.fromuin;if(o.get("ban_stranger")&&"webpager"!=n.source&&"user"!=n.source){var p=this.findRoom(u,!0);!p&&!r.friendbook.getLocalFriend(u),p=this.findRoom(u)}else var p=this.findRoom(u);if(!p)try{p=new s.ConvChatroom(u),l.addRoom(p,u)}catch(d){i.err(d),a.reportExpt("creatOTOChatroom",d,u)}switch(n.source){case"user":p.ui.unfold(!0,!0);break;case"webpager":break;default:if(p.lostedMsgId)return;p.model.pushMessage(c)}},throwToGroupChatRoom:function(e,t){i.log1("收到新群聊天消息",e);var n=this;try{var r=e.data,o=r.type,s=r.info,l=n.findRoom(s.roomid,!0);if(!l&&("user"==e.source||"webpager"==e.source)){if("groupchat"!=o&&"settingchange"!=o)return;var c={id:s.roomid,memberList:s.memberList,name:s.roomname,isSuper:t||0};l=new d.GroupChatroom(s.roomid,c),n.addRoom(l,s.roomid)}}catch(u){i.log1(u.stack),a.reportExpt("createGroupChatroom",u,JSON.stringify(e.data))}switch(e.source){case"user":l&&l.ui.unfold(!0,!0);break;case"webpager":break;default:if(l){if(l.lostedMsgId)return;l.model.pushMessage(r)}}},buildRTChatroom:function(e,t){if(e.data.rt_topic)return void new c.GiftChatroom(e.target,e.data,function(e,n){t&&t(e,n)});try{l.makeRoom(e.target,e.data,function(e,n){e&&(n.destroy(),i.log1("该实时化类型业务逻辑决定不展示这一次实时化: "+e)),t&&t(e,n)})}catch(n){t&&t(n,null),i.err(n),a.reportExpt("createUgcChatroom",n,JSON.stringify(e.data))}},processSpam:function(e){var t=e.data,n=t.to,i=this.findRoom(n,1);i&&i.model.sysMessage(t)},findRoom:function(e,t){var n=this.rooms[e]||this._rooms_pending[e];return n?n:t?null:(n=this._rooms_dead[e],n?(n.resume(),this.addRoom(n,e,!0),delete this._rooms_dead[e],n):null)},addRoom:function(e,t,n){var i=this;f.addWindow(e.ui,t,n),this.rooms[t]=e,i._rooms_pending[t]&&delete i._rooms_pending[t],i.validNotify(e,t),e.addEvent("dead",function(){delete i.rooms[t],i._rooms_dead[t]=e,e.removeEvent("dead",arguments.callee)}),e.addEvent("signal",function(t){var n={actor:t.actor,action:t.action,data:t.data,service:e.service,target:e.id};u.broadcast(n,!!t.forall)})},validNotify:function(e,t){var n=this;if(e&&t)r.notify.valid(t)&&e.ui.highLight();else{var i,a=n.rooms;for(i in a)r.notify.valid(a[i].id)&&a[i].ui.highLight()}},sendUserAgent:function(e){var t=window.navigator.userAgent.toLowerCase(),n=/(opr)[\/]([\w.]+)/.exec(t)||/(chrome)[ \/]([\w.]+)/.exec(t)||/(version)[ \/]([\w.]+).*(safari)[ \/]([\w.]+)/.exec(t)||/(webkit)[ \/]([\w.]+)/.exec(t)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(t)||/(msie) ([\w.]+)/.exec(t)||t.indexOf("trident")>=0&&/(rv)(?::| )([\w.]+)/.exec(t)||t.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(t)||[],i=/(ipad)/.exec(t)||/(iphone)/.exec(t)||/(android)/.exec(t)||/(windows phone)/.exec(t)||/(win)/.exec(t)||/(mac)/.exec(t)||/(linux)/.exec(t)||[],a=n[3]||n[1]||"",r=n[2]||"0",o=i[0]||"";xml="<xml>	                <ToUser><![CDATA["+e+"]]></ToUser>	                <FromUser><![CDATA["+XN.user.id+"]]></FromUser>	                <CreateTime> "+(new Date).getTime()+" </CreateTime>	                <MsgType><![CDATA[command]]></MsgType>	                <Action><![CDATA[enterdialog]]></Action>	                <Content><![CDATA[web;"+r+";"+a+";"+o+';""]]></Content>	                <MsgId>![CDATA[""]]</MsgId>	            </xml>',url="http://admin.renren.com/webservice/customerservice/send",sha1param={token:"dswndvck",timestamp:"1397701482061",nonce:"2iue0",signature:"EA804FF03F11AFFE13104DFA90E203B73BE401C4"},token="dswndvck",timestamp=sha1param.timestamp,nonce=sha1param.nonce,signature=sha1param.signature,new XN.net.xmlhttp({url:url,method:"post",data:"token="+token+"&timestamp="+timestamp+"&nonce="+nonce+"&signature="+signature+"&message="+xml,dataType:"json",onSuccess:function(e){console.log(e)},onError:function(){}})}};var f={winSlider:null,_timestamp:0,skey:"winslider_layout",winInfo:{},init:function(e){var n=this;n.slider=e,n.cluster=new t.Cluster_Client("winslider_layout"),n.slider.addEvent("changed",function(e){e.data&&(i.log2("窗口布局有改变",e.data),n.cluster.broadcast(e.data)),n.save()}),n.cluster.addEvent("message",function(e){var t=e.data,i=n.slider;i.applyChange(t),n.save()});try{n.load()}catch(a){window.frames.imengine.WPC.reportExpt("roomKeeper_layout_load",a,"")}},load:function(){var e=this,t=n.persistMgr.storageGet(this.skey,1);if(t){if(t=JSON.parse(t),t.t!=XN.cookie.get("t"))return;var a=t.stats;i.log1("总共有"+t.order.length+"个窗口需要重建"),t.order.forEach(function(t){var n=a[t].rebuild;if(n){e.slider.addPlaceholder(a[t]),n.source||(n.source="webpager");try{n.action="create",p(n)}catch(i){console.error(i)}}})}},addWindow:function(e,t,n){this.slider.appendWindow(e,t,n)},isInStack:function(e){return this.isInStack(e)},save:function(){var e=this;if(e.cluster.isMaster()){var t=this.slider.getOrder(),a=e.slider.getStats(),r={t:XN.cookie.get("t"),order:t,stats:a};n.persistMgr.storageSet(e.skey,JSON.stringify(r),1,1),i.log2("保存了布局: ",JSON.stringify(r))}}},h=function(e,n){"630000001"===e&&roomKeeper.sendUserAgent(e),i.log1("通过消息打开一个单聊窗口");var a={service:"oto_chat",data:{fromuin:e,touin:t.User.id},source:"user"};n&&(a.data.unread=n),u.broadcast(a,1)},m=function(e,t){if(!e||!e.length)return!1;for(var n=[],i=0;i<e.length;i++)n.push("			<member>",e[i],"</member>\n");if(e.length>100)return XN.DO.showError("一个群最多100个成员。"),!1;var a=['<iq id="1" type="set">\n','	<query xmlns="http://muc.talk.renren.com/create">\n','		<item name="',t.join(","),'" >\n',n.join(""),"		</item>\n","	</query>\n","</iq>\n\x00"].join("");return webpager.sendMessage(a,"newProtocal"),!0},g=function(e){var t={info:{roomid:e},type:"groupchat"},n={service:"group_chat",data:t,source:"user"};u.broadcast(n,1)},v=function(e){var t={info:{roomid:e},type:"groupchat"},n={service:"super_group_chat",data:t,source:"user"};u.broadcast(n,1)},b={18:"701",16:"502",14:"chat"};r.regService("notify/view",function(e,t,n,i){var a=!1;if("string"==typeof e){e=e.split("-");var r=b[e[0]];e=e[1];var s=t.match(/&uid=(\d+)/)[1]}else{if("object"!=typeof e)return;var d=e,s=d.actor,r=d.stype;e=d.source,a=t}if(a||o.get("notify_viewer")&&r){var l={feed_actor:s,feed_source:e,feed_stype:r},c={service:"ugc_chat",action:"create",source:"notify/view",actor:"user",data:l,callback:function(e){if(e){var t=['<p style="background:url(http://a.xnimg.cn/imgpro/icons/error.png) no-repeat;padding-left:70px;margin:15px" >',"获取消息失败,请点击下面的链接到终端页查看<br/>",'<a href="'+i+'" target="_blank">点这里</a>',"</p>"].join(""),n=new XN.ui.dialog({title:"消息提醒",noFooter:!0,showCloseButton:!0,message:t});n.body.addEvent("click",function(e){"a"==e.target.tagName.toLowerCase()&&n.remove()})}}},u={service:"ugc_chat",action:"focus",actor:"user",source:"notify/view",data:l};return p(c),p(u),1}return 0}),r.regService("chat/group/create",m),r.regService("chat/group/start",g),r.regService("chat/supergroup/start",v),r.regService("chat/conv/open",h),webpager.roomKeeper=roomKeeper,window.talkto=function(e){r.request("chat/conv/open",e)},window.wpInviteUser=function(e,n,i){var a=['<message fname="',t.User.name,'" from="',t.User.id,'@talk.m.renren.com" to="',e,'@talk.m.renren.com" type="chat">\n','	<richbody type="invitetogroup" localid="0',(new Date).getTime(),'" >\n','  <groupinfo invite_desc="邀请你加入这个好玩的群" group_id="',n,'" group_type="100" group_title="',i,'" group_description="" group_head_url="" />\n',"	</richbody>\n","</message>\n\x00"].join("");webpager.sendMessage(a,"newProtocal")}}),object.define("webpager/im/preferpanel","../lib/base, ../service, ../lib/tools, ../lib/uikit, ../lib/channel_api",function(require,e){var t=require("../lib/base"),n=t.dom,i=require("../service"),a=require("../lib/tools"),r=require("../lib/uikit"),o=i.preferences,s=new Class(r.UIcommon,function(){this._dropdown=!1,this.initialize=function(e){e.buildFrame();e.showBirthday=parseInt(XN.user.id)%10==8||parseInt(XN.user.id)%10==7||parseInt(XN.user.id)%10==1||229528266==parseInt(XN.user.id)&&!XN.browser.IE6,e.getUIRef(),e.bindEvent(),e.getStrangerState()},this.getStrangerState=function(e){var t=['<iq id="',+new Date,'"  type="get">\n','	<query xmlns="http://blockstranger.talk.renren.com/blockstranger" />\n',"</iq>\n\x00"].join("");webpager.sendMessage(t,"newProtocal"),window.webpager.addEvent("setStrange",function(){var t=jxn(e.frame).find("dd[key='ban_stranger']");o.get("ban_stranger")?(t.removeClass("pref-on"),o.set("ban_stranger",!1)):(t.addClass("pref-on"),o.set("ban_stranger",!0))}),window.webpager.addEvent("getStrange",function(e){var t=+e.blockvalue?!0:!1;o.set("ban_stranger",t)})},this.setStrangerState=function(e,t){var n=(jxn(e.frame).find("dd[key='ban_stranger']"),['<iq id="',+new Date,'"  type="set">\n','<query xmlns="http://blockstranger.talk.renren.com/blockstranger">\n',"<blockvalue>",t,"</blockvalue>\n","</query>\n","</iq>\n\x00"].join(""));webpager.sendMessage(n,"newProtocal")},this.makeFrameHTML=function(){var e=['<div class="wp-preferences">','	<a class="pref-btn">O</a>','	<dl class="pref-menu" style="display:none">',"	</dl>","</div>"].join("");return e},this.makeListHTML=function(e){var t="";e.showBirthday&&(t="<dd "+(o.get("quiet_birthday")?'class="pref-on"':"")+' key="quiet_birthday"><a>屏蔽生日提醒</a></dd>');var n=["<dd "+(o.get("ban_stranger")?'class="pref-on"':"")+' key="ban_stranger"><a>屏蔽陌生人消息</a></dd>',"<dd "+(o.get("quiet_mode")?'class="pref-on"':"")+' key="quiet_mode"><a>关闭声音提醒</a></dd>',t];return a.whiteList.checkSpread()&&(o.isSet("notify_viewer")||o.set("notify_viewer",!0),n.push("<dd "+(o.get("notify_viewer")?'class="pref-on"':"")+' key="notify_viewer"><a>小窗查看提醒</a></dd>')),n.join("")},this.getUIRef=function(e){var t=e.frame,i={btn_gear:n.getElement("a.pref-btn",t),list:n.getElement("dl.pref-menu",t)};e.nodes=i},this.bindEvent=function(e){var t=e.nodes;e.frame.addEvent("click",function(e){e.cancelBubble=!0}),t.btn_gear.addEvent("click",function(){e._dropdown?e.pickup():e.dropdown()}),t.list.addEvent("click",function(t){var n=t.target;"a"==n.tagName.toLowerCase()&&(n=n.parentNode),e.onClick(n)})},this.dropdown=function(e){e.nodes.list.innerHTML="",e.nodes.list.appendChild(a.parseHTML(e.makeListHTML())),e.nodes.list.show(),e._dropdown=!0;var t=n.getElement(".birthday-box",n.getElement("#webpager"));t&&"inline-block"==t.getStyle("display")&&(t.style.display="none")},this.pickup=function(e){e.nodes.list.hide(),e._dropdown=!1},this.onClick=function(e,t){var i=t.getAttribute("key");if(i){var a=n.getElement(".birthday-remind",n.getElement("#webpager"));if(t.className.indexOf("pref-on")<0){if("ban_stranger"==i)return void e.setStrangerState(1);t.className="pref-on",o.set(i,!0),a&&"quiet_birthday"==i&&(a.style.display="none")}else{if("ban_stranger"==i)return void e.setStrangerState(0);if(t.className="",o.set(i,!1),a&&"quiet_birthday"==i){a.style.display="block";var r=n.getElement(".birthday-box",n.getElement("#webpager"));r&&"block"==r.getStyle("display")&&(r.style.display="none")}}}}});e.PreferMenu=s}),object.define("webpager/im/birthday","../lib/base,../service",function(require,e){var t=require("../lib/base"),n=t.dom,i=require("../service"),a=i.preferences;e.birthdayRemind=new Class(function(){this.cookie=window.frames.imengine.WPC.cookie,this.userid=XN.user.id,this.initialize=function(e,t,n){function i(){new XN.net.xmlhttp({url:"http://gift.renren.com/api/mainpage/birthdaystatus",data:"id="+e.userid,method:"POST",onSuccess:function(n){return"false"==n.responseText?void jxn.storage.set("webpager_showBirthday",1):(jxn.storage.set("webpager_showBirthday",2),void e.getBirthdayData(t))},onError:function(){jxn.storage.set("webpager_showBirthday",0)}})}this.prefer_menu=n,e.newDay=!1;var a=new Date;if(jxn.storage.get("webpager_birthdayNewDate")?jxn.storage.get("webpager_birthdayNewDate")!=a.getDate()&&(jxn.storage.set("webpager_birthdayNewDate",a.getDate()),e.newDay=!0):jxn.storage.set("webpager_birthdayNewDate",a.getDate()),jxn.storage.get("webpager_showBirthday")||jxn.storage.set("webpager_showBirthday",0),e.newDay)i();else if(0==jxn.storage.get("webpager_showBirthday"))i();else{if(1==jxn.storage.get("webpager_showBirthday"))return;2==jxn.storage.get("webpager_showBirthday")&&e.getBirthdayData(t)}},this.getBirthdayData=function(e,t){var i=document.createElement("div"),r=['<div class="birthday-box">','<div class="header">',"   <h4>今日寿星</h4>",'   <a id="birthdayminimize" class="minimize" label="最小化" title="最小化"></a>','   <a id="birthdayclose" class="close" title="关闭"></a>',"</div>",'<div class="bir-content"><ul>',"</ul>","</div>","</div>",'<div class="panelbarbutton" style="width:33px;padding:0;"><a class="birthday-btn" href="#nogo"  onclick="return false;"></a></div>'].join("");i.className="popupwindow birthday-remind",i.appendChild(n.getDom(r)),this.frame=i;var o=n.getElement("#webpager #friends-panel");o.insertBefore(i,o.lastChild);var s=new Date,d="bt_re";if(!e.cookie.get(d)||e.cookie.get(d)==s){e.cookie.set(d,s.getDate()+1,365);var l=n.getElement(".panelbarbutton",this.frame);l.addClass("birthday-btn-hovered")}var c=a.get("quiet_birthday");c&&jxn("#webpager .birthday-remind").hide(),jxn(".birthday-remind .panelbarbutton").bind("click",function(){jxn(".birthday-remind .panelbarbutton").unbind("click",arguments.callee);n.getElement(".birthday-box",this.frame),n.getElement(".panelbarbutton",this.frame);new XN.net.xmlhttp({url:"http://gift.renren.com/api/mainpage/birthdaydates",data:"id="+e.userid,method:"POST",onSuccess:function(n){var i=JSON.parse(n.responseText);e.renderFrame(i,t),jxn(".birthday-box").show()},onError:function(){}})})},this.renderFrame=function(e,t,n){e.buildFrame(t,n),e.bindEvent(n)},this.buildFrame=function(e,t,n){for(var i="",a=(document.createElement("div"),0);a<t.length;a++){var r=t[a].receiveGiftNum+"人已祝福";t[a].receiveGiftNum<1&&(r="抢先送祝福");var o=["<li>",'   <a target="_blank" class="head"  href="http://www.renren.com/',t[a].id,'/profile"> <img src="',t[a].head_url,'" width="35" height="35" title="',t[a].name,'" class="imgclick" /></a>','   <div class="info">','       <a target="_blank" class="giftheadurl" href="http://www.renren.com/',t[a].id,'/profile">',t[a].name.substring(0,5),'<img src="http://a.xnimg.cn/webpager/cssimg/birthday2.gif" /></a>',"       <p>",r,"</p>","   </div>",'   <a class="gift" href="#nogo" onclick="return false;" dataid="',t[a].id,'" href="',t[a].head_url,'">祝福TA</a>',"</li>"].join("");i+=o}jxn(".bir-content ul").empty().append(jxn(i)),n.fold()},this.bindEvent=function(e,t){var i=this,a=n.getElement(".panelbarbutton",this.frame),r=n.getElement(".birthday-box",this.frame),o=n.getElement(".bir-content",this.frame),s=n.id("birthdayminimize"),d=n.id("birthdayclose"),l=n.getElement("#webpager .birthday-remind");o.addEvent("click",function(e){var t=n.wrap(e.target);if(t.hasClass("giftheadurl")&&new XN.net.xmlhttp({url:"http://gift.renren.com/api/mainpage/usemainpagename",data:"",method:"POST",onSuccess:function(){}}),t.hasClass("imgclick")&&new XN.net.xmlhttp({url:"http://gift.renren.com/api/mainpage/usemainpageimage",data:"",method:"POST",onSuccess:function(){}}),t.hasClass("gift")){var i=t.getAttribute("dataid");XN.loadFiles(["http://a.xnimg.cn/xnapp/giftpro/home/birthdayTip/css/birth.15856.css?t=1","http://a.xnimg.cn/xnapp/giftpro/home/birthdayTip/js/birth.15711.js","http://a.xnimg.cn/xnapp/giftpro/js/xn.alertChange.15343.js","http://s.xnimg.cn/a13589/jspro/xn.ui.pager.js","http://s.xnimg.cn/xnapp/common/js/swfobjectv2.2.1558.js"],function(){object.use("xn/birthGiftFlow",function(e){new e.birthGiftFlow(i)})})}}),a.addEvent("click",function(){var e=n.getElement("#webpager .pref-menu");a.removeClass("birthday-btn-hovered"),"none"==r.getStyle("display")?(r.show(),t.fold(),"block"==e.getStyle("display")&&i.prefer_menu.pickup()):r.hide()}),s.addEvent("click",function(){r.style.display="none",a.removeClass("birthday-btn-hovered")}),d.addEvent("click",function(){l.style.display="none",a.removeClass("birthday-btn-hovered")}),t.nodes.bar.addEvent("click",function(){t._fold||(r.style.display="none")})}})}),object.define("webpager/buddy","ua, ./lib/uikit, ./lib/base, ./service/friendbook, ./service/feed2talkparser, ./service/ubbparser,./service, ./lib/tools, ./buddy/buddywin, ./lib/channel_api",function(require,e){var t=require("./lib/base"),n=require("./service/friendbook"),i=require("./service"),a=require("./lib/tools"),r=require("./buddy/buddywin"),o=(require("./lib/channel_api"),require("./service/ubbparser")),s=(require("./lib/uikit"),require("./service/feed2talkparser")),d=t.dom,l=(require("ua"),t.events,null),c=null;window.webpager.sn={};var u=[],p={nodes:{},init:function(e){var t=this;e.nodes.handler.addClass("wp-friend-ico"),this.nodes.domBtn=e.nodes.handler,this.nodes.frame=e.nodes.frame,e.addEvent("unfocus",function(){t.foldMode(!0)}),e.addEvent("focus",function(){t.foldMode(!1)}),t.foldMode(e._fold)},foldMode:function(e){if(e){this.nodes.domBtn.title="展开列表";var t='聊天<span class="wp-frid-num"></span>';"true"==jxn(this.nodes.domBtn).data("hasNew")?t="你有新消息<span class='wp-newmsg-arr'></span>":jxn(this.nodes.domBtn).parent().removeClass("panelbarnew")}else{this.nodes.domBtn.title="收起";var t=""}this.nodes.domBtn.innerHTML=t}},f={showBubble:function(){var e=webpager.getItem("wp_sn_list");if(e){e=JSON.parse(e);for(var t in e){var n=webpager.roomKeeper.findRoom(t,!0);n?setTimeout(function(){var e="muc"==n.model.chatType?"g":"u";f.clearBubble(t,e)},500):f.appendBubble(JSON.parse(e[t]))}}},appendBubble:function(e){var t,i,o,s=e.chat_type,d=e.from,l=parseInt(e.count),c=0,u=e.count,p=function(n,i){var o=jxn("#wp-sn-list");o.length>0&&(c=parseInt(r.ddFindDtNum(o)));var s=['<dd uid="',t,e.from,'">','	<a href="#nogo" class="wp-f-avatar-box">','		<var data-count="'+u+'">',u>99?"99+":u,'</var><img class="wp-f-avatar" src="',i,'" alt="头像">',"	</a>",'	<div class="wp-f-info">','<span title="',n,'"><em>',a.noMoreThan(n,9,!1,!1),"		</em></span>","	</div>","</dd>"].join("");if(0==o.length){var d=['<dl class="wp-list-close" id="wp-sn-list"><dt title="点击收起" data-count="'+l+'">未读消息<var class="wp-sn-bell" style="display:none;">'+(l>99?"99+":l)+"</var></dt>","</dl>"].join("");jxn(".wp-frid-list:first").find("dl:first").before(jxn(d));var p=jxn(o).find("dd[uid="+t+e.from+"]");p.length||o.append(s),o=jxn("#wp-sn-list")}var f=o.find("dt"),h=f.find("var"),p=o.find("dd[uid="+t+e.from+"]");if(0==p.length)return jxn(o).append(s),l=+c+l,h[0].innerHTML=l>99?"99+":l,void f.attr("data-count",l);var m=parseInt(p.find("var").attr("data-count"));p.find("var").html(e.count>99?"99+":e.count),p.find("var").attr("data-count",e.count),p.find("em").html(a.noMoreThan(n,9,!1,!1)),p.find(".wp-f-avatar").attr("src",i);var g=parseInt(c)-m+parseInt(e.count);return h[0].innerHTML=g>99?"99+":g,void f.attr("data-count",g)};if("muc"==s){t="g";var f=n.getTeams;d>=1e8&&(f=n.getGroup),f(function(e){if(null!=e){if(i=e.userName,o=e.tiny||"http://a.xnimg.cn/webpager/res/group-avatar-new2.png",!i)return;if(1==e.type&&2==e.state)return;p(i,o)}},d)}else{t="u";var f=n.getUser;d>=630000001&&639999999>=d&&(f=n.getPublic),f(function(e){i=e.userName,o=e.tiny,p(i,o)},d)}},clearBubble:function(e,t){var n="wp_sn_list",i=webpager.getItem(n)||"{}";i="null"==i?"{}":i,i=JSON.parse(i);try{delete i[e]}catch(a){}delete window.webpager.sn[e],webpager.setItem(n,JSON.stringify(i));var o=jxn("#wp-sn-list"),s=o.find("dd[uid="+t+e+"]");if(s.length>0){var d=parseInt(r.ddFindDtNum(o)),l=parseInt(s.find("var").text());o.find("dt").attr("data-count",d-l),o.find("dt .wp-sn-bell").text(String(d-l)),s.remove(),0==o.find("dd").length&&o.remove()}var l=parseInt(r.ddFindDtNum(o));i&&"{}"!=JSON.stringify(i)||f.renderNewStyle(!1)},renderNewStyle:function(e){var t=jxn("#friends-panel").find(".panelbarbutton:last");if(e){if(t.addClass("panelbarnew"),t.find(".wp-friend-ico").data("hasNew","true"),"收起"==t.find(".wp-friend-ico").attr("title"))return;t.find(".wp-friend-ico").html("你有新消息<span class='wp-newmsg-arr'></span>")}else t.removeClass("panelbarnew"),t.find(".wp-friend-ico").data("hasNew","false"),c._fold&&t.find(".wp-friend-ico").html("聊天<span class='wp-frid-num'></span>")},setNewStyle:function(e){var t=0;for(v in e)t++;t>0&&f.renderNewStyle(!0)}};window.webpager.handleUnread=function(e){var t=(parseInt(e.from),window.webpager.roomKeeper.findRoom(e.from,!0));if(!(e.from in window.webpager.sn&&e.count==window.webpager.sn[e.from].count)){if(window.webpager.sn[e.from]={count:a},t&&0==e.count&&t.ui._highlight)t.ui.highLight(-1),t.ui.fireEvent("focus",{focus:!1}),t.ui.message();else{if(t&&e.count>0&&t.ui._highlight){var i="chat"==e.chat_type?"u":"g";return void f.clearBubble(e.from,i)}t&&(e.count=0)}var a=e.count,r="wp_sn_list",o=webpager.getItem(r)||"{}",o=JSON.parse(o),s=function(t){if(!t||2!=t.state){u.push(e);var n=u.length;u.forEach(function(e,t){o[e.from]=JSON.stringify(e),t==n-1&&(webpager.setItem(r,JSON.stringify(o)),u=[],f.setNewStyle(o))}),c._fold||f.appendBubble(e)}};if(e.count>0)"muc"==e.chat_type&&e.from>=1e8?n.getGroup(s,e.from):s();else{var i="chat"==e.chat_type?"u":"g";f.clearBubble(e.from,i)}}};var h=function(){function e(e){if(e.inviterid==XN.user.id){var t=d.id("wp-supergroup-list"),n=arguments.callee;if(!t){var i=d.id("wp-supergroup-list");if(!i){var r='<dl class="wp-list-open" id="wp-supergroup-list"><dt title="点击展开"><span class="group_text_align_left">群</span><span class="group_number_align_right">0</span></dt></dl>',o=jxn(".wp-frid-list:first");d.id("wp-supergroup-list")?o.find("#wp-supergroup-list").before(jxn(r)):d.id("wp-list-recent")?o.find("#wp-list-recent").before(jxn(r)):o.find("dl:first").before(jxn(r))}n(e)}var s=u(e.from,t),l=jxn(t);s||(window.webpager.groupListInfo&&window.webpager.groupListInfo.push({head:"http://a.xnimg.cn/webpager/res/group-avatar-new2.png",id:e.from,name:e.roomName,state:1,type:1}),s=['<dd uid="g',e.from,'">','<a href="#nogo" class="wp-f-avatar-box"><img class="wp-f-avatar" src="http://a.xnimg.cn/webpager/res/group-avatar-new2.png"',"></a>",'<div class="wp-f-info"><span title="',e.roomName,'"><em>',a.noMoreThan(e.roomName,9,!1,!1),"</em>","</span></div></dd>"].join(""),l.find("dd:first")[0]?l.find("dd:first").before(s):l.append(s),l.find("dt")[0].innerHTML=l.find("dt").html().replace(/(\d{1,})/,function(e,t){return+t+1}))}}function t(e){if(i.friendbook.updateTeams(e.roomid,e.roomName),!(jxn("#wp-group-list dd[uid=g"+e.from+"]").length>0)){jxn("#wp-group-list dd[uid=none]").length>0&&jxn("#wp-group-list dd[uid=none]").remove();var t=d.id("wp-group-list"),n=jxn(t),r=['<dd uid="g',e.from,'">','<a href="#nogo" class="wp-f-avatar-box"><img class="wp-f-avatar" src="http://a.xnimg.cn/webpager/res/group-avatar-new2.png"',"></a>",'<div class="wp-f-info"><span title="',e.roomName,'"><em>',a.noMoreThan(e.roomName,9,!1,!1),"</em>","</span></div></dd>"].join("");n.find("dd:first")[0]?n.find("dd:first").before(r):n.append(r),n.find("dt")[0].innerHTML=n.find("dt").html().replace(/(\d{1,})/,function(e,t){return+t+1})}}function l(e){setTimeout(function(){var t=webpager.roomKeeper.findRoom(e);t&&(t.ui.components.talkflow.replaceContent([],function(){}),t.getHistoryMessage(t.ui,function(e){t.ui.components.talkflow.replaceContent([],function(){});for(var n=e.chatlist,i=n.length,r=0;i>r;r++){var d=XN.json.parse(n[r].info);if(d){var l=XN.json.parse(n[r].content);if(l){if(!l.bodyType){var c="0"==l.contenttype?a.htmlFilter(l.content):l.content;if(!c)continue}var u=l.type||"dialog";switch("appmsg"==l.bodyType&&(u=l.bodyType),u){case"dialog":var p=/img.*width|height/;p.test(c)&&(c=c.replace(/width=\"\d*\.{0,1}\d*\"/,""),c=c.replace(/height=\"\d*\.{0,1}\d*\"/,""));break;case"invitetogroup":case"bigemj":break;case"feed_to_talk":c=s.parseFeed2talk(c,n[r].name);break;case"location":var f=c,h=f.match(/poi.*address=[\"|'](\S*)[\"|']/);if(h&&(c=h[1]),h=f.match(/poi.*mapurl=[\"|'](\S*)[\"|']/)){var m=h[1];m=m.replace(/&amp;/gim,"&"),c+='<img width="180" src="'+m+'"/>'}break;case"secret":c="这是一张私密照片";break;case"readsecret":c="阅读了私密照片";break;case"voip":c="我用新版人人客户端给你打了一个免费电话，下载新版人人客户端就有机会获得各种好礼，你也来加入吧！<a href='http://mobile.renren.com' target='_blank'>http://mobile.renren.com</a>";break;case"appmsg":if("4"==l.appMsgType){var g=l.newsItems[0],v=g.title,b=g.digest,w=g.url,y=g.cover,_=v.length>10?v.substring(0,10)+"...":v;b=-1!=b.indexOf("恭喜你获得人人网页新版限量体验资格")?"童鞋，恭喜你获得人人网新版限量体验资格！全新界面设计，沟通更便捷！使用过程中有任何不爽请直接回复此消息，人人程序猿欢迎您的吐槽！":b;var x=b.length>20?b.substring(0,20)+"...":b,E=""==y?"display:none;":"",k=""==y?"width:auto;":"float:right;width:80px;",x=""!=y?x:b,C='<div class="dlg_f2t_title">'+_+'</div><div class="dlg_f2t_link" style="padding-top:10px;"><a style="'+k+'" title="'+b+'" href="'+w+'" target="_blank">'+x+'</a><a style="float:left;width:80px;height:80px;margin-right:5px;display:inline-block;'+E+'" title="'+v+'" href="'+w+'" target="_blank"><img width="100%" height="100%" src="'+y+'" title="'+v+'"></a></div>';c=-1!=v.indexOf("邀请好友")?'邀请身边好友注册人人，一起拿流量包，<a href="http://test1.touch.renren.com/superRegister/activity" target="_blank">查看更多</a>':-1!=v.indexOf("0M")?v+"，快登陆手机客户端，领取奖励吧":C}else if("10"==l.appMsgType)c="网页版尚不支持此动态信息，可到<a href='http://mobile.renren.com' target='_blank'>mobile.renren.com</a>下载最新人人手机客户端查看";else{var T=l.title,b=l.des,y=l.resLowUrl,v=l.appName,w=l.appUrl,x=b.length>20?b.substring(0,20)+"...":b,_=T.length>10?T.substring(0,10)+"...":T,E=""==y?"display:none;":"",k=""==y?"width:auto;":"width:100px;",x=""!=y?x:b,C='<div class="dlg_f2t_title">'+_+'</div><div class="dlg_f2t_link" style="padding-top:10px;"><a style="float:left;'+E+'" href="'+w+'" target="_blank"><img width="50" height="50" src="'+y+'" title="'+T+'"></a><a style="float:left;padding-left:10px;" title="'+v+'" href="'+w+'" target="_blank">'+v+'</a><u style="float:left;'+k+'padding-left:10px;text-decoration:none;display:block;" title="'+b+'">'+x+"</u></div>";c=C}break;default:c="网页版尚不支持此动态信息，可到<a href='http://mobile.renren.com' target='_blank'>mobile.renren.com</a>下载最新人人手机客户端查看"}c=a.replaceURLWithHTMLLinks(c),o.hasUbb(c)&&(c=o.parseTxt(c)),c=c.replace(/\r\n/g,"<br/>").replace(/\n/g,"<br/>");var N={avatar:a.makeHeadTinyurl(d.head),name:n[r].name,time:a.getTime(new Date(n[r].time).getTime()),id:d.id,content:c,profile:a.makeProfileUrl(d.id)};t.ui.components.talkflow.pushDialog(N,t.getDialogTemplate(N))}}}var I=n[n.length-1].sessionId;if(I){t.upMaxMsgKey(I);var M={msgkey:I,uid:t.model.id};t.ui._highlight||t.buildRR(M,1)}}))},0)}function u(e,t){var t=t||d.id("wp-sn-list"),n=d.getElements("dd",t),i=n.length,a=null;if(t){for(var r=0;i>r;r++){var o=n[r].getAttribute("uid"),s=o.substr(1);if(s==e){a=n[r];break}}return a}}c.enable(),p.init(c),window.webpager.addEvent("insertGroup",function(n){return n.type&&1==n.type||n.from>1e8?void e(n):void t(n)}),window.webpager.addEvent("updateGroupName",function(e){i.friendbook.updateTeams(e.from,e.name);var t=jxn("#wp-group-list dd[uid=g"+e.from+"]");t.find(".wp-f-info span").text(a.noMoreThan(e.name,9,!1,!1))}),window.webpager.addEvent("chat_msg_losted",function(e){var t=webpager.roomKeeper.findRoom(e.id);t&&(t.lostedMsgId=e.msgid)}),window.webpager.addEvent("chat_load_lastestmsg",function(e){var t=webpager.roomKeeper.findRoom(e);if(t){var n=window.imengine.WPC.PersistMgr.getItemFrom("m_u"+e,"webpager_msg"+XN.user.id),i=n&&""!=n?XN.json.parse(n):[];i.forEach(function(e){if(t.lostedMsgId&&t.lostedMsgId>=e.msgkey)return!0;var n=t.extendMessage(e);t.ui.components.talkflow.pushDialog(n,t.getDialogTemplate(e))}),t.lostedMsgId=!1}}),window.webpager.addEvent("group_msg_losted",function(e){var t=webpager.roomKeeper.findRoom(e.id);t&&(t.lostedMsgId=e.msgid)}),window.webpager.addEvent("group_load_lastestmsg",function(e){var t=webpager.roomKeeper.findRoom(e);if(t){var n=window.imengine.WPC.PersistMgr.getItemFrom("m_g"+e,"webpager_msg"+XN.user.id),i=n&&""!=n?XN.json.parse(n):[];i.forEach(function(e){if(t.lostedMsgId&&t.lostedMsgId>=e.msgkey)return!0;var n=XN.json.parse(e.content);n.msgkey=e.msgkey,n.attachment=e.attachment,n.localid=e.localid,n.msg_audiosrc=e.msg_audiosrc,n.msg_audiotime=e.msg_audiotime,n.msg_headsrc=e.msg_headsrc,n.msg_originalsrc=e.msg_originalsrc,n.fname=e.fname,n.timestamp=e.timestamp,n.chat_tag=e.chat_tag;var i=t.model.extendMessage(n);t.ui.components.talkflow.pushDialog(i,t.getDialogTemplate(n))}),t.lostedMsgId=!1}}),window.webpager.getChatLastestMsg=l,c._fold?c.addEvent("focus",function(){r.init(c),setTimeout(function(){f.showBubble()}),c.removeEvent("focus",arguments.callee),c.addEvent("focus",function(){setTimeout(function(){f.showBubble()})})}):(r.init(c),setTimeout(function(){f.showBubble()}),c.addEvent("focus",function(){clearTimeout(panelBarTimer)})),r.addEvent("search_change",function(e){var t=e.data;return t?void n.asyncSearch(t,function(e){if(e.candidate.length){for(var n=0;n<e.candidate.length;n++)e.candidate[n].userId=e.candidate[n].id,e.candidate[n].userName=e.candidate[n].name,e.candidate[n].tiny=e.candidate[n].head;r.renderSearchResult(e.candidate),r.upDownSlcting(!1)}else r.renderNoResult(t)}):void r.showBuddyList()}),r.addEvent("selected",function(e){XN.net.sendStats("http://message.renren.com/statistics/wp/friend");var t=e.data,n=t.charAt(0);switch(t=t.substr(1),n){case"g":t>1e8?i.request("chat/supergroup/start",t):i.request("chat/group/start",t);break;case"u":i.request("chat/conv/open",t)}f.clearBubble(t,n)})},m=function(){XN.browser.IE6&&jxn(".winslider").delegate(".panelbarbutton","mouseover",function(){$(this).addClass("panelbarbutton_hover")}).delegate(".panelbarbutton","mouseout",function(){$(this).removeClass("panelbarbutton_hover")});XN.cookie.get("id"),document.createElement("div"),d.getElement("#webpager")};e.init=function(e){l=e.nodes,c=e,e.nodes.body.addClass("friends-window"),e.nodes.container.addClass("wp-frid-box"),e.nodes.handler.addEvent("click",function(){XN.net.sendStats("http://message.renren.com/statistics/wp/list")}),e.addEvent("focus",function(e){r.ready(function(){e.focus&&r.searchFocus()})}),e.addEvent("resize",function(e){e.height&&(r.container_height=e.height,r.setPanelHeight())});c.disable({color:"#f5f6f9",opacity:1},'<p style="position:relative;width:90px;margin:auto;top:50%">好友加载中&nbsp;<img src="http://a.xnimg.cn/n/core/res/loading.gif"></img></p>'),c.nodes.handler.innerHTML="",h(),setTimeout(function(){m(c)})}}),object.define("webpager/buddy/buddywin","../lib/jqtpl, ../lib/base, ../lib/tools,../FriendSelect,../lib/uikit, ua,../service/friendbook",function(require){function e(e){var t=jxn(e).find("dt").html(),n=/(\d+)/,i=n.exec(t);return null!=i&&i.length>0?n.exec(t)[0]:0}var t=require("../lib/jqtpl"),n=require("../lib/base"),i=require("../lib/tools"),a=require("../FriendSelect"),r=(require("../lib/uikit"),require("ua")),o=require("../service/friendbook"),s='<article><section class="wp-frid-list">    <dl class="wp-list-open" title="群" id="wp-supergroup-list"><dt title="点击展开"><span class="group_text_align_left">群</span><span class="group_number_align_right"></span></dt></dd></dl>    <dl class="wp-list-open" title="讨论组" id="wp-group-list"><dt title="点击展开"><span class="group_text_align_left">讨论组</span><span class="group_number_align_right"></span></dt></dd></dl>    <dl class="wp-list-open" title="最近联系" id="wp-list-recent"><dt title="点击展开"><span class="group_text_align_left">最近联系</span><span class="group_number_align_right"></span></dt></dd></dl>    <dl class="wp-list-open" title="在线好友" id="wp-list-online" ><dt title="点击展开"><span class="group_text_align_left">在线好友</span><span class="group_number_align_right"></span></dt></dd></dl>    <dl class="wp-list-open" title="全部好友" id="wp-list-offline" ><dt title="点击展开"><span class="group_text_align_left">全部好友</span><span class="group_number_align_right"></span></dt></dd></dl>    <dl class="wp-list-open" title="公共账号" id="wp-public-list"><dt title="点击展开"><span class="group_text_align_left">公共账号</span><span class="group_number_align_right"></span></dt></dd></dl>    <dl class="wp-list-open" title="站内信" id="wp-site-msg"><dt class="site_msg">站内信</dt></dl>    </section>    <section class="wp-frid-list wp-frid-search" style="display:none;"></section>    <footer><div style="display:none;" class="wp-searchbox"><form method="post" action="#" style="display:none;" onsubmit="return false;"></form></div><div class="buddy-clent-ad" style="display:none;"><p><a href="http://im.renren.com/desktop/rrsetup-54.exe?wp01" target="_blank"><img src="http://a.xnimg.cn/webpager/cssimg/download-icon.png"><var>隐身登录，悄悄在线-人人桌面</var></a></p></div></footer>    </article>',d='{{each(i, cat) cats}}<dl class="wp-list-open" title="${name}" id="user_group_${id}"><dt title="点击展开"><span class="group_text_align_left">${name}</span></dt></dd></dl>{{/each}}',l='{{each(i, group) buddies}}{{if !group.title}}<dl class="wp-list-close">{{else}}<dl class="wp-list-open">{{/if}}</dl>{{/each}}',c='{{if type==2}}<dd uid="g${userId}" title="${title}">    {{else}}<dd uid="u${userId}" title="${title}">{{/if}}    {{if isRecent}}<a href="javascript:;" class="wp-remove-contact" title="从最近联系人中删除" tag="remove">&nbsp;&nbsp;</a>{{/if}}    {{if (type!=2&&type!=3)}}    <a href="${profile}" title="TA的主页" target="_blank" class="wp-profile">个人主页</a>    {{/if}}    <a href="#nogo" onclick="return false;" class="wp-f-avatar-box">    {{if (type!=2&&type!=3)}}	    {{if status == 0 }}	    <img src="http://a.xnimg.cn/a.gif" title="不在线" class="wp-status wp-offline" />	    {{else}}	    <img src="http://a.xnimg.cn/a.gif" title="在线" class="wp-status wp-online" />	    {{/if}}	{{/if}}    <img class="wp-f-avatar" src="${tiny}" title="${title}" alt="头像" /></a>    <div class="wp-f-info"><span>${shortName}</span>{{if (status&2) == 2}} {{else}}{{if (status&4) == 4}} <img src="http://a.xnimg.cn/a.gif" title="人人桌面在线" class="wp-device wp-client" /> {{else}}{{if (status&8) == 8}}<img src="http://a.xnimg.cn/a.gif" title="手机在线" class="wp-device wp-phone" />{{/if}}	    {{/if}}{{/if}}    </div></dd>',u="{{each(i, buddy) buddies}}{{html getAbuddyTpl(buddy)}}{{/each}}",p='<p style="padding: 20px;">您的好友中没有<strong>${name}</strong></p>',f=n.$extend,h=(n.Sizzle,n.events,n.readly),m=n.dom,g=n.XN,v=i.getLogger("buddywin");
t.template("buddy_win",s),t.template("buddy_win_nodes",d),t.template("buddy_groups",l),t.template("aBuddy",c),t.template("noResult",p),t.template("buddyLis",u);var b=new n.events.Events;return b.ddFindDtNum=e,f(b,{ui:{},buddies:[],curQuery:"",cats:null,isHtmlMade:{},search_tobeused:0,_ad_height:30,init:function(e){try{f(this.ui,e.nodes),this.win=e,this.initData(),this.initUI(),this.getUIRef(),this.prepareUI(),this.bindEvent(),this.doReady();var n=this;g.browser.IE6||o.getUserGroups(function(e){var i=t.tmpl("buddy_win_nodes",{cats:e});if(""!==i){jxn("#wp-list-offline").before(jxn(i));for(var a=0;a<e.length;a++)n.ui[e[a].id]=m.id("user_group_"+e[a].id)}g.browser.IE7||setTimeout(function(){o.getRecentNew(0,function(e){e.length>0&&jxn(".wp-frid-list").trigger("click")})})})}catch(i){}},initData:function(){return 0},initUI:function(){return this.win.nodes.header.innerHTML='<a href="#nogo" title="创建讨论组" onclick="return false;" class="start-groupchat">讨论组</a><div class="wp-searchbox"><form method="post" action="#" onsubmit="return false;"><input type="text" onsubmit="return false;" id="webpager_friend_search" /><a href="javascript:;" id="wp-searchbox-clear"></a></form></div>',this.renderBuddyWin(this.cats),0},prepareUI:function(){var e=this;return e._searchHelper=g.form.help(e.ui.searchInput),e._defaultValue="发起聊天",e.ui.searchInput.value=e._defaultValue,e.ui.searchInput.style.color="#888",0},getUIRef:function(){f(this.ui,{gspList:m.getElement("section.wp-frid-list",this.ui.container),searchInput:m.getElement("#webpager_friend_search",this.win.nodes.header),searchInputClear:m.getElement("#wp-searchbox-clear",this.win.nodes.header),searchPanel:m.getElement("section.wp-frid-search",this.ui.container),btnStartGroup:m.getElement(".start-groupchat",this.ui.body)});for(var e=m.getElements("dl",this.ui.gspList),t=0;t<e.length;t++)this.ui[e[t].title]=e[t];return 0},getUI:function(e){return this.ui[e]},removeRecent:function(e){{var t=e.parentNode.getAttribute("uid"),n=t.charAt(0),t=t.substr(1);jxn("#wp-list-recent").find("dt")[0]}switch(n){case"g":n=2;break;case"u":n=1}new g.net.xmlhttp({url:"http://webpager.renren.com/api/deleteRecent",data:"ownerId="+g.user.id+"&targetId="+t+"&chatType="+n,method:"get",onSuccess:function(){m.wrap(e.parentNode),e.parentNode.dispose(),0==jxn("#wp-list-recent").find("dd").length&&jxn("#wp-list-recent").append('<dd uid="none" class="wp-group-nullResult"><a href="#nogo" onclick="return false;" class="wp-f-avatar-box"><img class="wp-f-avatar" src="http://a.xnimg.cn/webpager/res/group-null.png"></a><div class="wp-f-info"><span>还没有内容哦</span></div></dd>')}})},setBuddyClentAd:function(){if(webpager.imRunning||void 0==window.frames.imengine.AD_FOR_RRZM)return m.getElement(".buddy-clent-ad",this.win.frame).hide(),m.getElement(".wp-searchbox",this.win.frame).style.border="none",void(this._ad_height=0);var e=window.frames.imengine.AD_FOR_RRZM,t=e.buddybar,t=t[Math.floor(Math.random()*t.length)],n=t.text,i=t.link,a=m.getElement(".buddy-clent-ad",this.win.frame);if(a){var r=m.getElement("var",a),o=m.getElement("a",a);r.innerHTML=n,o.href=i}},rendGroupPanel:function(){},bindEvent:function(){function e(e){if("_blank"!=e.getAttribute("target")){if(e.getAttribute("tag")&&"remove"==e.getAttribute("tag"))return void l.removeRecent(e);for(var t;e&&"section"!=e.tagName.toLowerCase()&&(t=e.getAttribute("uid"),"dd"==e.tagName.toLowerCase()&&t&&l.fireEvent("selected",{data:t}),e.parentNode);)e=e.parentNode}}function t(){var e=jxn(".wp-sn-bell").html();if(c)jxn(".unread-alert").removeClass("unread-alert-hidden").addClass("unread-alert-show");else{var t=m.getDom('<div class="unread-alert unread-alert-show"><span class="unread-bell"></span>你有<span class="unread-number">'+e+"</span>条未读消息</div>");jxn(".wp-frid-box").append(t),jxn(".unread-alert").bind("click",function(){jxn(".wp-frid-list").scrollTop(0),jxn("#wp-sn-list").removeClass("wp-list-open").addClass("wp-list-close"),jxn(".wp-sn-bell").css({display:"none"})})}var n=jxn("#wp-sn-list").outerWidth();0!=n&&jxn(".unread-alert").css({width:n+"px"}),c=!0}function s(){jxn(".unread-number").text(jxn(".wp-sn-bell").html()),"webkit"==r.ua.core}function d(){u=0,m.id("wp-sn-list")&&jxn(".wp-frid-list").scrollTop()>jxn("#wp-sn-list")[0].offsetHeight&&(t(),jxn(".unread-number").text(jxn(".wp-sn-bell").html())),m.id("wp-sn-list")&&jxn(".wp-frid-list").scrollTop()<=jxn("#wp-sn-list")[0].offsetHeight&&jxn(".unread-alert").removeClass("unread-alert-show").addClass("unread-alert-hidden")}var l=this;n.addEvent(this.ui.gspList,"click",function(t){var n=t.target;"wp-frid-list"==t.target.className&&(n=document.getElementById("wp-list-recent").childNodes[0]);var i=n.tagName.toLowerCase(),a=t.target.parentNode;if("dt"==a.tagName.toLowerCase()&&(n=a,i=a.tagName.toLowerCase()),"dt"!=i){if("more"==n.getAttribute("uid")){if("span"==i&&(n=n.parentNode),"wp-list-offline"==n.parentNode.id){var r=parseInt(n.getAttribute("page"))+1;o.getAll(function(e){l.showCat("全部好友-"+r,e)},r)}else{var s=n.parentNode.id.replace("user_group_",""),r=parseInt(n.getAttribute("page"))+1;o.getUserGroup(function(e){l.showCat(s+"-"+r,e)},s,r)}n.remove()}e(n)}else{if("wp-list-close"==n.parentNode.className)return n.parentNode.className="wp-list-open",void(n.title="点击展开");if("wp-site-msg"!=n.parentNode.id){if(n.parentNode.className="wp-list-close",n.title="点击收起","1"==n.getAttribute("data-loaded"))return;n.setAttribute("data-loaded","1")}var d=n.parentNode.id,c="";switch(-1!=d.indexOf("user_group_")&&(c=d.replace("user_group_",""),d="user_group_"),d){case"wp-supergroup-list":o.getGroup(function(e){jxn("#wp-supergroup-list dd").remove(),l.showCat("群",e)});break;case"wp-group-list":o.getTeams(function(e){jxn("#wp-group-list dd").remove(),l.showCat("讨论组",e)});break;case"wp-public-list":o.getPublic(function(e){l.showCat("公共账号",e)});break;case"wp-list-recent":o.getRecentNew(0,function(e){l.showCat("最近联系",e)});break;case"wp-list-online":o.getRecentNew(1,function(e){l.showCat("在线好友",e)});break;case"wp-list-offline":o.getAll(function(e){l.showCat("全部好友-0",e)});break;case"user_group_":o.getUserGroup(function(e){l.showCat(c+"-0",e)},c);break;case"wp-site-msg":return void window.open("http://msg.renren.com/msg/getMessageList")}}});var c=!1,u=0,p=300;n.addEvent(this.ui.gspList,"scroll",function(){"ie"==r.ua.core?(u&&(clearTimeout(u),u=0),u=setTimeout(d,p)):(m.id("wp-sn-list")&&jxn(".wp-frid-list").scrollTop()>jxn("#wp-sn-list")[0].offsetHeight&&(t(),s()),m.id("wp-sn-list")&&jxn(".wp-frid-list").scrollTop()<=jxn("#wp-sn-list")[0].offsetHeight&&jxn(".unread-alert").removeClass("unread-alert-show").addClass("unread-alert-hidden"))}),i.winFrame.addEvent("resize",function(){s()}),n.addEvent(this.ui.searchPanel,"click",function(t){var n=t.target;e(n)}),n.addEvent(this.ui.searchInputClear,"click",function(){jxn("#webpager_friend_search").val("").focus()}),n.addEvent(this.ui.searchInput,"input",function(){m.getElement("#wp-searchbox-clear").style.display=m.getElement("#webpager_friend_search").value?"block":"none"}),n.addEvent(this.ui.searchInput,"propertychange",function(){m.getElement("#wp-searchbox-clear").style.display=m.getElement("#webpager_friend_search").value&&m.getElement("#webpager_friend_search").value!=l._defaultValue?"block":"none"}),n.addEvent(this.ui.searchInput,"focus",function(){this.value==l._defaultValue&&(this.value="",this.style.color="#333"),clearInterval(l.searchTimer),l.searchTimer=setInterval(function(){l._searchHelper.getRealValue()!=l.curQuery&&(l.curQuery=l._searchHelper.getRealValue(),l.fireEvent("search_change",{data:l.curQuery}),0==l.search_tobeused&&(g.net.sendStats("http://message.renren.com/statistics/wp/search"),l.search_tobeused=-1))},500)}),n.addEvent(this.ui.searchInput,"blur",function(){""==this.value&&(l.search_tobeused=0,this.value=l._defaultValue,this.style.color="#888"),clearInterval(l.searchTimer),m.getElement("#webpager_friend_search").value==l._defaultValue&&m.getElement("#wp-searchbox-clear")&&(m.getElement("#wp-searchbox-clear").style.display="none")}),n.addEvent(this.ui.searchInput,"keydown",function(e){if("search"==l.mode)if(v.log2(e.keyCode),38==e.keyCode)l.upDownSlcting(!0);else if(40==e.keyCode)l.upDownSlcting(!1);else if(13==e.keyCode){var t=l.getSelecting();t?l.fireEvent("selected",{data:t.getAttribute("uid")}):(m.getElement("#navSearchInput").value=l._searchHelper.getRealValue(),m.getElement("#globalSearchForm").submit()),l.clearSlcting(),l.commonMode()}}),n.addEvent(this.ui.btnStartGroup,"click",function(){function e(){r?(jxn(d).append(r),webpager.fs.clear()):(webpager.fs=new a.FriendSelect(d),setTimeout(function(){r=m.id("wp-friend-select"),webpager.fs.clear()},0)),webpager.fs.room=null}function t(){webpager.fs.addEvent("selected",function(e){webpager.fs.fireEvent("selectedItem",e)}),n.addEvent(u,"click",function(e){var t=m.wrap(e.target);if(t.hasClass("sf-close")&&(u.style.display="none"),t.hasClass("sitem")&&(m.getElements(".sitem",u).forEach(function(e){m.wrap(e).removeClass("in")}),jxn(u).find(".sw").children().forEach(function(e){m.wrap(e).style.display="none"}),t.addClass("in"),t.hasClass("sf")&&(s&&(s.style.display="none"),d.style.display="block",d.appendChild(r),webpager.fs.clear()),t.hasClass("sg")))if(d.style.display="none",s)s.style.display="block";else{var n=document.createElement("div");n.id="wp-group-select",o.getTeams(function(e){for(var t=e.length,a="",r=0;t>r;r++)e[r].type&&1==e[r].type||(a+=['<dd uid="',e[r].userId,'" title="',e[r].userName,'">','<img src="http://a.xnimg.cn/webpager/res/group-avatar-new2.png" alt="头像">','<span class="wp-group-name">',i.noMoreThan(e[r].userName,16),"</span></dd>"].join(""));var o=['<dl class="wp-group-buddy">',a,"</dl>"].join("");jxn(n).append(o),l.appendChild(n),jxn("#wp-group-select dd").click(function(){var e=jxn(this).attr("uid");webpager.service.request("chat/group/start",e)}),setTimeout(function(){s=m.id("wp-group-select")},0)})}if(t.hasClass("wp-friend-confirm")){if(t.hasClass("wp-friend-confirm-disable"))return;window.webpager.fs.disableBtn();var a=webpager.fs.memberList,c=webpager.fs.memberName;if(!a.length>0)return void g.DO.showMessage("请至少选择一个好友。");a.length>1?(webpager.service.request("chat/group/create",a,c),webpager.service.request("chat/group/start",a,c)):webpager.service.request("chat/conv/open",a[0]),window.webpager.fs.clear()}})}var r=m.id("wp-friend-select"),s=m.id("wp-group-select"),d=m.id("wp-friend-sg"),l=m.getElement(".sw",u),c=m.id("add-friend-box");if(c)c.style.display="block",e();else{var u=document.createElement("div");u.id="add-friend-box",u.innerHTML=['<h3>选择讨论组<a href="#nogo" onclick="return false;" class="sf-close">关闭</a></h3>','<p class="smenu clearfix">','	<span class="sitem sf in">选择好友</span><span class="sitem sg">选择讨论组</span></p>',"<p>",'<div class="sw">','	<div id="wp-friend-sg"></div>',"</div>"].join(""),c=u,m.id("webpager").appendChild(c),setTimeout(function(){l=m.getElement(".sw",c),d=m.id("wp-friend-sg"),e(),t()},0)}})},searchMode:function(){this.mode="search",this.ui.searchPanel.show(),this.ui.gspList.hide()},commonMode:function(){this.mode="common",this.ui.searchPanel.hide(),this.ui.gspList.show(),this.searchReset()},getSelecting:function(){return m.getElement("dd.selecting",this.ui.searchPanel)},makeBuddyList:function(e){return t.tmpl("buddyListInner",{buddies:e,getAbuddyTpl:function(e){return t.tmpl("aBuddy",e)},aBuddyTpl:c.html})},makeBuddyWin:function(e){return t.tmpl("buddy_win",{cats:e})},makeABuddy:function(e){return t.tmpl("aBuddy",e)},makeNoResult:function(e){return t.tmpl("noResult",{name:e})},makeBuddyLis:function(e,n){return t.tmpl("buddyLis",{buddies:e,getAbuddyTpl:function(e){return e.isRecent=n?!0:!1,e.status=e.status,e.title=e.userName,""==e.head&&(e.type=2,e.tiny="http://a.xnimg.cn/webpager/res/group-avatar-new2.png"),e.shortName=i.noMoreThan(e.userName,9,!1,!1),e.profile=2==e.type?"":"http://www.renren.com/profile.do?id="+e.userId,t.tmpl("aBuddy",e)}})},renderBuddyList:function(e){this.ui.gspList.removeClass("wp-frid-search");var t=this.makeBuddyList(e);return this.ui.gspList.innerHTML=t,0},renderBuddyLis:function(e,t,n,i){if(e){var a="";a="最近联系"===n?this.makeBuddyLis(t,!0):this.makeBuddyLis(t);var r=jxn(e);""==a&&0==r.find("dd").length&&(a='<dd uid="none" class="wp-group-nullResult"><a href="#nogo" onclick="return false;" class="wp-f-avatar-box"><img class="wp-f-avatar" src="http://a.xnimg.cn/webpager/res/group-null.png"></a><div class="wp-f-info"><span>还没有内容哦</span></div></dd>'),r.find("[uid=more]").remove(),i&&(a+='<dd uid="more" page="'+i+'" class="wp-group-moreResult"><span uid="more">加载更多</span></dd>'),r.append(a)}},renderBuddyWin:function(e){return this.ui.container.innerHTML="",this.ui.container.appendChild(i.parseHTML(this.makeBuddyWin(e))),0},renderSearchResult:function(e){return this.searchMode(),this.ui.searchPanel.innerHTML="<dl>"+this.makeBuddyLis(e)+"</dl>",0},renderNoResult:function(e){return this.searchMode(),this.ui.searchPanel.innerHTML=this.makeNoResult(e),0},showBuddyList:function(){this.commonMode()},showCat:function(e,t){if(!this.isHtmlMade[e]){var n=e,i=void 0;-1!=e.indexOf("-")&&(n=e.substr(0,e.indexOf("-")),t.length>=50&&(i=e.substr(e.indexOf("-")+1))),this.renderBuddyLis(this.ui[n],t,e,i),this.isHtmlMade[e]=!0}},clearSlcting:function(){var e=m.getElement("dd.selecting",this.ui.searchPanel);e&&e.removeClass("selecting")},upDownSlcting:function(e){v.log2("upDownSlcting");var t,n=m.getElement("dd.selecting",this.ui.searchPanel);if(n)if(n.removeClass("selecting"),t=e?function(){var e=n.previousSibling;return e?8==e.nodeType?8==e.previousSibling.nodeType?null:e.previousSibling:e:void 0}():function(){var e=n.nextSibling;return e?8!=e.nodeType?e:e.nextSibling:void 0}())t=m.wrap(t),t.addClass("selecting");else{var i=m.getElements("dd",this.ui.searchPanel);t=e?i[i.length-1]:i[0],t&&t.addClass("selecting")}else{var i=m.getElements("dd",this.ui.searchPanel);t=e?i[i.length-1]:i[0],t&&t.addClass("selecting")}},searchReset:function(){this.ui.searchInput.value=""},searchFocus:function(){this._searchHelper.focus()},setPanelHeight:function(e){var t=e||this.container_height;t-=this._ad_height,this.ui.gspList&&(this.ui.container.style.height=t+"px",this.ui.gspList.style.height=t-23+"px",this.ui.container.style.zoom=1.1,this.ui.container.style.zoom=1)}}),h(b),b}),object.define("webpager/ugc","./lib/base, ./lib/tools",function(require,e){function t(t){i[t].inited=1;var n=i[t].q;n.forEach(function(t){e.makeRoom(t.roomId,t.ugc,t.callback)})}var n=(require("./lib/base"),require("./lib/tools")),i=(n.QA,{common:{inited:-1,q:[]},photo:{inited:-1,q:[]},video:{inited:-1,q:[]},group:{inited:-1,q:[]},blog:{inited:-1,q:[]}});e.makeRoom=function(e,n,a){var r=parseInt(n.feed_stype);switch(r){case 505:case 503:case 502:var o="common";if(i[o].inited<=0){i[o].q.push({roomId:e,ugc:n,callback:a}),i[o].inited&&(i[o].inited=0,require.async("webpager/ugc/common",function(){t(o)}));break}require.async("webpager/ugc/common",function(t){new t.UgcChatroom(e,n,a)});break;case 701:case 708:case 709:var o="photo";if(i[o].inited<=0){i[o].q.push({roomId:e,ugc:n,callback:a}),i[o].inited&&(i[o].inited=0,require.async("webpager/ugc/photo",function(){t(o)}));break}require.async("webpager/ugc/photo",function(t){new t.PhotoChatroom(e,n,a)});break;case 5030:case 110:var o="video";if(i[o].inited<=0){i[o].q.push({roomId:e,ugc:n,callback:a}),i[o].inited&&(i[o].inited=0,require.async("webpager/ugc/video",function(){t(o)}));break}require.async("webpager/ugc/video",function(t){new t.VideoChatroom(e,n,a)});break;case 103:var o="photo";if(i[o].inited<=0){i[o].q.push({roomId:e,ugc:n,callback:a}),i[o].inited&&(i[o].inited=0,require.async("webpager/ugc/photo",function(){t(o)}));break}require.async("webpager/ugc/photo",function(t){new t.SharePhotoChatroom(e,n,a)});break;case 209:var o="group";if(i[o].inited<=0){i[o].q.push({roomId:e,ugc:n,callback:a}),i[o].inited&&(i[o].inited=0,require.async("webpager/ugc/group",function(){t(o)}));break}require.async("webpager/ugc/group",function(t){new t.GroupChatroom(e,n,a)});break;case 601:var o="blog";if(i[o].inited<=0){i[o].q.push({roomId:e,ugc:n,callback:a}),i[o].inited&&(i[o].inited=0,require.async("webpager/ugc/blog",function(){t(o)}));break}require.async("webpager/ugc/blog",function(t){new t.BlogChatroom(e,n,a)});break;case 102:var o="blog";if(i[o].inited<=0){i[o].q.push({roomId:e,ugc:n,callback:a}),i[o].inited&&(i[o].inited=0,require.async("webpager/ugc/blog",function(){t(o)}));break}require.async("webpager/ugc/blog",function(t){new t.ShareBlogChatroom(e,n,a)})}}}),object.define("webpager/ugc/common","../lib/base, ../lib/uikit, ../im/chatroom,../service ,../lib/tools,../service/feed2talkparser",function(require,e){var t=require("../lib/base"),n=t.dom,i=require("../lib/uikit"),a=require("../im/chatroom"),r=require("../lib/tools"),o=(require("../service"),r.getLogger("ugc/common")),s=r.QA,d=require("../service/feed2talkparser"),l={502:{n:3,tag:"status",text:"状态"},503:{n:3,tag:"status",text:"被动with"},505:{n:3,tag:"status",text:"分享状态"},701:{n:1,tag:"photo",text:"照片"},708:{n:1,tag:"photo",text:"照片"},709:{n:1,tag:"photo",text:"照片"},110:{n:4,tag:"share",text:"分享"},103:{n:4,tag:"share",text:"分享"},5030:{n:4,tag:"share",text:"分享"},209:{n:25,tag:"group",text:"小组"},601:{n:0,tag:"blog",text:"日志"},102:{n:4,tag:"share",text:"分享"},801:{n:17,tag:"gift",text:"礼物回复",ico:"wp-gift-ico"},8301:{n:20,tag:"gift",text:"礼物"},8302:{n:21,tag:"gift",text:"礼物"},807:{n:17,tag:"gift",text:"礼物"},808:{n:17,tag:"gift",text:"礼物"}},c=new Class(a.Chatroom,function(){this.service="ugc_chat",this.textCollection={title:'<p class="wp-status-ico">状态回复</p>',handler:"状态回复"},this.initialize=function(e,t,n,i){if(!i)throw Error("创建Ugc聊天室必须提供ondone这个参数");e.id=t,e.ugc=n,e._ondone=i,this.parent(e)},this.buildUI=function(e){var t=e.ugc,n=new f({title:e.getText("title"),handler:e.getText("handler"),ugc:t});n.rebuild_message={service:"ugc_chat",target:e.id,data:{feed_actor:t.feed_actor,feed_source:t.feed_source,feed_stype:t.feed_stype}},n.id=e.id,e.ui=n;var i=e.buildTopic();i.addEvent("load",function(t){e._ondone(t.err,e),t.err||e.loadHistory(t.data)}),i.load()},this.loadHistory=function(e){e.model.loadHistory("from_ugc_chatroom")},this.buildTopic=function(e){var t=e.ui,n=e.ugc;t.setIcon("wp-status-ico");var i=new h(n);return t._assemble("topic",i),t.nodes.drawer.appendChild(i.frame),i.addEvent("resize",function(e){t.nodes.body.style.width=322+e.data.width+"px",t.nodes.drawer.style.width=e.data.width+"px"}),i},this.buildModel=function(e){var t=new u(e.ugc);e.model=t},this.bindEvent=function(e){this.parent(e),e.ui.addEvent("exit",function(){e.model.leave(function(){e.ui.close()})}),e.model.addEvent("broadcast_error",function(e){var t="";t=1031==e.ret.code?"抱歉，您发送消息太快了，请休息一会儿再试试吧。":1030==e.ret.code?"抱歉，您发送的信息中包含违禁词，发送不成功。":e.ret.msg||"可能含有不适合发布的词汇",XN.DO.showError('消息"'+e.gsp.content+'"未发送成功: '+t)})},this.extendMessage=function(e,t){var n={content:t.replyContent,avatar:t.replyer_tinyurl,name:t.ubname,time:t.replyTime,callback:t.callback,isAt:t.isAt,profile:"http://www.renren.com/profile.do?id="+t.ubid};if(r.isMyself(t.ubid)||(n.reply_btn=!0,n.rid=t.id,n.uid=t.ubid,n.whisper=t.whisper),t.vocal_url){if(!XN.vocalPlayer){arguments.callee}XN.loadFiles(["http://s.xnimg.cn/a52454/n/apps/status/module/vocal/player-all-min.css","http://s.xnimg.cn/a53841/n/apps/status/module/vocal/player.js"]),n.content=n.content.replace("这是一条语音评论。","<a class=\"vocal-player vocal-player-tiny\" 				 data-vocal=\"{'url': '"+t.vocal_url+"', 'time': "+t.vocal_length+",'ownerId':"+t.ownerId+",'voiceId':"+t.id+", 'sourceOwner':"+t.sourceOwner+", 'sourceId':"+t.sourceId+', \'ugcType\':4}" href     ="javascript:;">				   <span class="btn"></span>				   <span class="time"><span class="num">'+t.vocal_length+"</span>秒</span>				 </a>")}return d.hasFeed2Talk(t.content)&&(n.contentsrc=t.content,n.content=d.parseFeed2talk(t.content,t.name)),n=this.parent(e,n)},this.signal=function(e,t){function n(t){switch(t.action){case"focus":e.ui.unfold(0,1);break;case"message":e.model.pushMessage(t.data)}}if(t instanceof Array){var i=[],a=[];t.forEach(function(e){"message"==e.action?i.push(e.data):a.push(e)}),e.model.pushMessage(i);for(var r;r=a.shift();)n(r)}else n(t)}}),u=new Class(function(){this.__mixins__=[t.events.Events],this.msgs=[],this.chatWordNum=140,this.initialize=function(e,t){e.ugc=t},this.pushMessage=function(e,t){var n=[].concat(t);if(n.length){var i=e.msgs.length;n.forEach(function(t){return t.ugc_content?!t.source||502!=t.feed_stype&&505!=t.feed_stype||0!=t.source.indexOf("541-")?void e.msgs.push(e.dataAdapt(t)):void(t.rmessagecallback&&XN.net.sendStats(r.unescapeHTML(t.rmessagecallback))):void 0});var a=e.msgs.slice(i);a.length&&e.fireEvent("message",{data:a})}},this.send=function(e,t){t.content&&t.content.length>e.chatWordNum&&(t.content=XN.string.trim(t.content),t.content=t.content.substring(0,e.chatWordNum-3)+"..."),t.content=r.htmlFilter(t.content),e.broadcastGsp(t);var n=r.User,i=e.ugc,a={from_id:n.id,from_name:n.name,from_pic:n.head,time:(new Date-0)/1e3,is_whisper:t.isWhisper,ugc_content:e.atFilter(t.content),feed_actor:i.feed_actor,feed_source:i.feed_source,feed_stype:i.feed_stype,pass:!0};return e.pushMessage(a),{action:"message",data:a,forall:0}},this.dataAdapt=function(e,t){e.ugc;try{if(/这是一条语音评论。$/.test(t.ugc_content)){var n=r.unescapeHTML(t.content).match(/(http:[^"]*)/g);n&&n.length&&(n=n[n.length-1],t.ugc_content=t.ugc_content.replace("这是一条语音评论。",'<a href="'+n+'" title="到终端页收听" target="_blank">这是一条语音评论</a>'))}}catch(i){}var a={id:t.ugc_id,replyContent:e.atFilter(t.ugc_content),replyer_tinyurl:r.makeHeadTinyurl(t.from_pic),replyTime:r.getDateTime(1e3*t.time),ubname:t.from_name,ubid:t.from_id,whisper:parseInt(t.is_whisper)};if(t.rmessagecallback){var n=r.unescapeHTML(t.rmessagecallback);n=n.replace(/\/remove\?/,"/process?"),a.callback=n}return t.is_at&&(a.isAt=t.is_at),a},this.atFilter=function(e,t){var n=/@([^\(\)@]+)\((\d+)\)/gim,i=t.replace(n,function(e,t,n){return 19==n.toString().length?'@<img src="http://a.xnimg.cn/imgpro/icons/mention-friend-group3.png">'+t+"&nbsp;":'<a target="_blank" href="http://www.renren.com/profile.do?id='+n+'">@'+t+"</a>"});return i},this.loadHistory=function(e,t,n){if("from_ugc_chatroom"==t){var n=n||e.ugc,i={doingId:n.feed_source,owner:n.feed_actor,source:n.feed_source,t:l[n.feed_stype].n};s.log2("22&source="+n.feed_source+"&stype="+n.feed_stype+"&actor="+n.feed_actor+"&empty=5"),o.log2(">>>>>>>>>> UGC  loadHistory"),new XN.net.xmlhttp({url:"http://status.renren.com/feedcommentretrieve.do",data:XN.array.toQueryString(i),onSuccess:function(t){try{o.log2("<<<<<<<<<<<<<<<<< UGC loaded",t.responseText);var i=XN.json.parse(t.responseText);i.replyList?e.replaceHistory(i.replyList):s.log2("23&source="+n.feed_source+"&stype="+n.feed_stype+"&actor="+n.feed_actor+"&empty=2")}catch(a){s.log2("24&source="+n.feed_source+"&stype="+n.feed_stype+"&actor="+n.feed_actor+"&empty=3")}},onError:function(){s.log2("25&source="+n.feed_source+"&stype="+n.feed_stype+"&actor="+n.feed_actor+"&empty=4")}})}},this.replaceHistory=function(e,t){e.msgs.forEach(function(e){e.whisper&&t.push(e)}),t.sort(function(e,t){return e.replyTime>t.replyTime?1:-1}),e.msgs=t,e.fireEvent("historyReplace",{data:t})},this.broadcastGsp=function(e,t){var n=e.ugc,i=n.feed_stype,a={c:t.content,t:l[i].n,source:n.feed_source,owner:n.super_feed_actor||n.feed_actor,replyName:t.replyName||"",replyTo:t.replyTo||"",secondaryReplyId:t.replyId||"",isWhisper:t.isWhisper||!1},o=502==i?"&nfrom=0101011010000":"";a.replyTo||3!=a.t||s.log2("status_nobody"),3==a.t&&s.log2("a1"),new XN.net.xmlhttp({url:"http://status.renren.com/feedcommentreply.do?from=wp&fromu="+r.User.id+"&tou="+a.replyTo+"&source="+a.source+"&fowner="+a.owner+"&t="+a.t+"&stype="+e.ugc.feed_stype+o,data:XN.array.toQueryString(a),onSuccess:function(n){var i=n.responseText;if(i&&"empty"!=i){var a=XN.json.parse(n.responseText);a&&a.code&&e.fireEvent("broadcast_error",{ret:a,gsp:t})}},onComplete:function(){e.replyName="",e.replyTo="",e.isWhisper=!1}})},this.leave=function(e,t){e.x=!0;var n=e.ugc;new XN.net.xmlhttp({url:"http://notify.renren.com/quitchat.notify?groups="+n.feed_source+"-"+n.feed_stype+"-"+n.feed_actor,onSuccess:function(){t&&t()},onError:function(){XN.DO.showError("网络不稳定,请重试.")}})},this.destroy=function(){}}),p=new Class(i.TalkFlow,function(){this.initialize=function(e){e._ugc_talkflow=!0,this.parent(e),e.bindEvent()},this.bindEvent=function(e){var t=e.frame;t.addEvent("click",function(t){var n=t.target;if("span"==n.tagName.toLowerCase()&&"reply"==n.getAttribute("click")){var i={name:n.getAttribute("wname"),id:n.getAttribute("wid"),rid:n.getAttribute("rid")};"1"==n.getAttribute("whisper")&&(i.whisper=!0),e.fireEvent("replyTo",{data:i}),XN.net.sendStats("http://message.renren.com/statistics/win/reply")}})},this.buildDialog=function(e,t){if(t.reply_btn)var n='<span click="reply" style="cursor:pointer" class="wp-chat-reply" whisper="'+(t.whisper?1:0)+'" wname="'+t.name+'" wid="'+t.uid+'" rid="'+t.rid+'" href="javascript:void(0)">回复</span>';var i="wp-chatlist-ugc",a=['<section class="',i,'">','	<figure class="avatar">','		<a href="'+t.profile+'" target="_blank" title="'+t.name+'"><img width="35" height="35" src="'+t.avatar+'" /></a>','		<p class="wp-name-tip" style="display:none">'+t.name+'<span class="wp-arrow"></span></p>',"	</figure>",'	<section class="wp-chat-content">','		<p><a href="'+t.profile+'" target="_blank">'+t.name+"</a>："+t.content+(t.whisper?'&nbsp;<img title="悄悄话" src="http://a.xnimg.cn/img/lock_red_new.png" />':"")+"</p>","	</section>","	<footer>"+(n||"")+'<span class="wp-chat-time">'+t.time+"</span></footer>","</section>"].join(""),o=r.parseHTML(a);return o}}),f=new Class(i.WindowWithDrawer,function(){this.initialize=function(e,t){this.parent(e,t),e.buildTalkflow(),e.buildInputer(t.ugc),e.nodes.body.style.width="500px",e.addExitBtn()},this.buildTalkflow=function(e){var t={};t.early_btn=!1;var n=new p(t);e._assemble("talkflow",n),e.nodes.container.appendChild(n.frame),e.addEvent("fold",function(e){e.data||n.scrollBottom()}),n.addEvent("replyTo",function(t){var n=t.data;e.components.inputer.replyTo(n)})},this.buildInputer=function(e,t){var n={ugcId:t.feed_source,ugcType:l[t.feed_stype].tag,ownerId:t.feed_actor},a=new i.Inputer({emotion:!0,mention:n,maxinput:{num:140,tip:"每次回复最多140个字符."}});e._assemble("inputer",a),e.nodes.container.appendChild(a.frame)},this.pushDialog=function(e,t){e.components.talkflow.pushDialog(t),e._fold&&e.highLight()}}),h=new Class(i.UIcommon,function(){this.initialize=function(e,t){e.ugc=t;e.buildFrame()},this.getUIRef=function(){},this.bindEvent=function(){},this.buildContent=function(e,t){e.fireEvent("resize",{data:{width:228}});var n=['<section class="topic wp-status-topic" style="max-width:208px;">',"<figure>",'	<a href="http://www.renren.com/profile.do?id='+t.host_id+'"><img width="30" height="30" src="'+t.host_pic+'" /></a>',"</figure>",'<div class="wp-status-main">','	<a href="http://www.renren.com/profile.do?id='+t.host_id+'">'+t.host_name+"</a>："+r.unescapeHTML(t.content),'	<p class="wp-topic-time">'+r.getDate(t.timestamp)+"</p>","</div>","</section>"].join("");return n},this.render=function(e,t){var n=e.buildContent(t);e.frame.innerHTML="",e.frame.appendChild(r.parseHTML(n)),e.getUIRef(),e.bindEvent()},this.load=function(e){var t=e.ugc,i=e.frame;i.innerHTML=" loading... ";var a="http://notify.renren.com/get2.feed?actor="+t.feed_actor+"&source="+t.feed_source+"&stype="+t.feed_stype;new XN.net.xmlhttp({url:a,useCache:!0,onSuccess:function(t){var n=XN.json.parse(t.responseText);if(!t.responseText||"{}"==JSON.stringify(n))return n=null,void e.fireEvent("load",{err:t.responseText});try{e.topic=n,e.render(n)}catch(i){s.reportExpt("ugc_renderTopic",i,""),r("渲染过程出错:"+i.stack)}e.fireEvent("load",{data:n})},onError:function(){o.err("网络错误, ugc Topic 加载失败!"),s.log2("34&source="+t.feed_source+"&stype="+t.feed_stype+"&actor="+t.feed_actor+"&empty=1"),e.fireEvent("loadFaild"),r("网络错误")}});var r=function(t){i.innerHTML="";var a=n.getDom('<p style="width:120px;margin-top:35px;">抱歉,主题加载失败(也可能已经被主人删除),请点击<a class="retry" href="#nogo" onclick="return false;">重试</a></p><span style="display:none;">'+t+"</span>");i.appendChild(a);var r=n.getElement("a.retry",i);r.addEvent("click",function(){e.load()})}}});e.UgcChatroom=c,e.UgcChatroom_window=f,e.UgcTopic=h,e.UgcChatroom_model=u,e.stypeMap=l}),object.define("webpager/ugc/gift","../lib/base, ../lib/tools, ../lib/uikit, ./common",function(require,e){var t=require("../lib/base"),n=t.dom,i=require("../lib/tools"),a=require("../lib/uikit"),r=i.QA,o=require("./common"),s=o.stypeMap,d=new Class(o.UgcChatroom,function(){this.buildUI=function(e){var t=e.ugc,n=new l({title:'<p class="'+s[t.rt_type].ico+'">'+s[t.rt_type].text+"</p>",handler:s[t.rt_type].text,ugc:t});n.rebuild_message={service:"ugc_chat",target:e.id,data:{feed_actor:t.feed_actor,feed_source:t.feed_source,feed_stype:t.feed_stype,feed_ntype:t.feed_ntype,rt_topic:t.rt_topic,rt_comments:t.rt_comments||"",rt_reply:t.rt_reply||"",rt_type:t.rt_type}},n.id=e.id,e.ui=n;var i=e.buildTopic();i.addEvent("load",function(t){e._ondone(t.err,e),t.err||e.loadHistory(t.data)}),i.load()},this.buildModel=function(e){var t=new c(e.ugc);e.model=t},this.buildTopic=function(e){var t=e.ui,n=e.ugc;t.setIcon(s[n.rt_type].ico);var i=new u(n);return t._assemble("topic",i),t.nodes.drawer.appendChild(i.frame),i.addEvent("resize",function(e){t.nodes.body.style.width=322+e.data.width+"px",t.nodes.drawer.style.width=e.data.width+"px"}),i}}),l=new Class(o.UgcChatroom_window,function(){this.buildInputer=function(e,t){var n={ugcId:t.feed_source,ugcType:s[t.rt_type].tag,ownerId:t.feed_actor},i=new a.Inputer({emotion:!0,mention:n,maxinput:{num:140,tip:"每次回复最多140个字符."}});e._assemble("inputer",i),e.nodes.container.appendChild(i.frame)}}),c=new Class(o.UgcChatroom_model,function(){this.loadHistory=function(e,t,n){if(!e.ugc.rt_comments)return void this.parent(e,t,n);var n=n||e.ugc;if("from_ugc_chatroom"==t){var i={doingId:n.feed_source,owner:n.feed_actor,source:n.feed_source,t:n.feed_ntype};new XN.net.xmlhttp({url:e.ugc.rt_comments,data:XN.array.toQueryString(i),onSuccess:function(t){try{var n=XN.json.parse(t.responseText);n.replyList&&e.replaceHistory(n.replyList)}catch(i){}},onError:function(){}})}},this.broadcastGsp=function(e,t){if(!e.ugc.rt_reply)return void this.parent(e,t);var n=e.ugc,a={c:t.content,t:n.feed_ntype,source:n.feed_source,owner:n.feed_actor,replyName:t.replyName||"",replyTo:t.replyTo||"",secondaryReplyId:t.replyId||"",isWhisper:t.isWhisper||!1};a.replyTo||3!=a.t||r.log2("status_nobody"),3==a.t&&r.log2("a1"),new XN.net.xmlhttp({url:e.ugc.rt_reply+"?from=wp&fromu="+i.User.id+"&tou="+a.replyTo+"&source="+a.source+"&fowner="+a.owner+"&t="+a.t+"&stype="+e.ugc.feed_stype,data:XN.array.toQueryString(a),onSuccess:function(n){var i=n.responseText;if(i&&"empty"!=i){var a=XN.json.parse(n.responseText);a&&a.code&&e.fireEvent("broadcast_error",{ret:a,gsp:t})}},onComplete:function(){e.replyName="",e.replyTo="",e.isWhisper=!1}})}}),u=new Class(o.UgcTopic,function(){this.buildContent=function(e,t){return e.fireEvent("resize",{data:{width:228}}),e.frame.innerHTML="",e.frame.appendChild(i.parseHTML(t)),t},this.buildTopicHtml=function(e,t){var n,a,o;t.replace(/\[Data\]([\w\W]*?)\[\/Data\]/gim,function(e,t){return n=t,e}).replace(/\[HTML\]([\w\W]*?)\[\/HTML\]/gim,function(e,t){return a=t,e});try{if(!n)return void e.fireEvent("load",{err:t});if(!a)return void e.fireEvent("load",{err:t});n=JSON.parse(n)}catch(s){e.fireEvent("load",{err:t})}n.topic.timestamp=i.getDate(n.topic.timestamp);try{o=i.renderTpl(a,n)}catch(s){r.reportExpt("ugc_renderTpl",s,"")}return o},this.load=function(e){var t=e.ugc,a=e.frame,o=t.rt_topic,s="topic_"+t.feed_actor+"_"+t.feed_source+"_"+t.feed_stype,d=webpager.getItem(s);if(d)return void setTimeout(function(){e.buildContent(d),e.fireEvent("load",{data:{}})},0);a.innerHTML=" loading... ",new XN.net.xmlhttp({url:i.unescapeHTML(o),useCache:!0,onSuccess:function(t){var n=e.buildTopicHtml(t.responseText.replace(/[\n\r]/gm,""));
webpager.setItem(s,n);try{e.buildContent(n)}catch(i){r.reportExpt("ugc_renderTopic",i,""),l("渲染过程出错:"+i.stack)}e.fireEvent("load",{data:{}})},onError:function(){l("网络错误")}});var l=function(t){a.innerHTML="";var i=n.getDom('<p style="width:120px;margin-top:35px;">抱歉,主题加载失败(也可能已经被主人删除),请点击<a class="retry" href="#nogo" onclick="return false;">重试</a></p><span style="display:none;">'+t+"</span>");a.appendChild(i);var r=n.getElement("a.retry",a);r.addEvent("click",function(){e.load()})}}});e.GiftChatroom=d}),object.define("webpager/ugc/radio","",function(require,e){var t,n=window.$,i=function(e){var t=n(e);return window.asyncHTMLManager&&(t.addEvent=function(e,n,i){window.asyncHTMLManager.dom.Element.prototype.addEvent.call(t,e,n,i)}),t},a=function(){if(navigator.plugins&&navigator.plugins.length&&navigator.plugins["Shockwave Flash"])return!0;if(navigator.mimeTypes&&navigator.mimeTypes.length){var e=navigator.mimeTypes["application/x-shockwave-flash"];return e&&e.enabledPlugin}try{return new ActiveXObject("ShockwaveFlash.ShockwaveFlash"),!0}catch(t){}return!1}(),r=!1;"undefined"==typeof console||0==r?t=XN.func.empty:(t=console.log,XN.browser.WebKit&&(t=function(){console.log.apply(console,Array.prototype.slice.call(arguments,0))}),setTimeout(function(){window.radio=XN.radio.home},100)),XN.namespace("XN.radio.home"),$extend(XN.radio.home,{seedInit:function(e,t){a&&(this.radioFileList=e,i(t).innerHTML=this.seedInitHTML(),this.seedAddEvents(),this.seedIfHasNotice(),this.seedInited=!0)},seedIfHasNotice:function(){XN.radio.home.noticeContent&&this.seedLoad()},seedMainLoading:!1,seedInitHTML:function(){return'<div id="radio-home-con">	<div class="radio-display"  id="radio-home-panel" style="display:none;"></div>	<div id="home-radio-bar">   	<div id="home-radio-btns">			<div class="home-radio-playOrPause"><a id="home-radio-play" href="#nogo" onclick="return false;" hidefocus="true" title="播放" class="playPause"><span></span></a></div>			<div class="home-radio-next"><a id="home-radio-next" href="#nogo" onclick="return false;" hidefocus="true"  title="播放音乐时可用" class="nextDisable"><span></span></a></div>			<div class="home-radio-fav"><a id="home-radio-fav" href="#nogo" onclick="return false;" hidefocus="true" title="播放音乐时可用" class="favDisable"><span></span></a></div>    	</div>		<div  class="listNormal"><a id="home-radio-listbar" href="#nogo"  onclick="return false;"  title="电台列表" hidefocus="true"></a></div>	</div><div id="radio-home-favPanel" style="display:none;"><span class="heart"></span><span class="addHeartSucc">加心成功！</div><div id="radio-home-songInfoPanel"  style="display:none;"></div></div>	<div id="radio_home_flashcon"></div>'},seedAddEvents:function(){var e=this,t=!1,n=i("home-radio-listbar");n.addEvent("mouseover",function(){n.delEvent("mouseover",arguments.callee),t||e.seedMainLoaded||(t=!0,e.seedLoad("list"))});var a=i("home-radio-play");a.addEvent("click",function(){a.delEvent("click",arguments.callee),t||e.seedMainLoaded||(t=!0,e.seedLoad("play"))})},playFeedSong:function(e,t,n,i){var a=this;a.seedMainLoading||(a.seedMainLoaded?a.mainPlayFeedSong(e,t,n,i):a.seedLoad(function(){a.mainPlayFeedSong(e,t,n,i)}))},seedLoad:function(e){this.seedMainLoading=!0,/^apps?\./.test(window.location.hostname)||XN.loadFiles(this.radioFileList,function(){object.use("xn/radio",function(){e&&(i("radio-home-panel").style.display="block"),XN.radio.home.init(e)})})}}),XN.event.enableCustomEvent(XN.radio.home),e.radio=XN.radio.home}),object.define("webpager/ugc/photo","../lib/base, ../lib/tools, ./common",function(require,e){var t=require("../lib/base"),n=(t.dom,require("../lib/tools")),i=(n.QA,require("./common")),a=new Class(i.UgcChatroom,function(){this.textCollection={title:'<p class="wp-photo-ico">照片回复</p>',handler:"照片回复"},this.buildTopic=function(e){var t=e.ui,n=e.ugc;t.setIcon("wp-photo-ico");var i=new r(n);return t._assemble("topic",i),t.nodes.drawer.appendChild(i.frame),i.addEvent("resize",function(e){t.nodes.body.style.width=322+e.data.width+"px"}),i}}),r=new Class(i.UgcTopic,function(){this.buildContent=function(e,t){e.fireEvent("resize",{data:{width:228}});var i=t.photos[0],a=i.voice,r=i.url;r+=/\?/.test(r)?"&psource=6":"?psource=6";var o={ptype:"photo",large:i.big_image,param:"?psource=6",owner:t.host_id,id:i.id};o=' data-photo="'+JSON.stringify(o).replace(/"/g,"'")+'"';var s=a?['<div style="position:absolute;bottom:68px;right:0px;">','	<a href="javascript:;" class="vocal-player float-left" data-vocal="'+JSON.stringify({url:a.voiceUrl,time:a.voiceLength,ownerId:t.host_id,voiceId:a.id,photoId:i.id}).replace(/"/g,"'")+'" style="width:100px">','		<div class="progress"></div>','		<span class="btn"></span>','		<span class="time"><span class="num">3</span>秒</span>',"	</a>","</div>"].join(""):"",d=['<section class="topic wp-photo-topic" style="max-width:208px;position:relative;display:block;">','	<a target="_blank" href="'+r+'">','			<img width="210" src="'+(i.big_image||i.image)+'" '+o+" />","	</a>",s,'	<p class="wp-photo-dec">'+n.unescapeHTML(i.desc)+"</p>","	<footer>",'		<a href="http://www.renren.com/profile.do?id='+t.host_id+'">'+t.host_name+'</a><span class="wp-topic-time"></span>',"	</footer>","</section>"].join("");return d}}),o=new Class(i.UgcChatroom,function(){this.textCollection={title:'<p class="wp-share-ico">分享照片回复</p>',handler:"分享照片回复"},this.buildTopic=function(e){var t=e.ui,n=e.ugc;t.setIcon("wp-share-ico");var i=new s(n);return t._assemble("topic",i),t.nodes.drawer.appendChild(i.frame),i.addEvent("resize",function(e){t.nodes.body.style.width=322+e.data.width+"px"}),i}}),s=new Class(i.UgcTopic,function(){this.buildContent=function(e,t){var n=t.photos[0];e.fireEvent("resize",{data:{width:228}});var i=e.ugc,a="http://share.renren.com/share/"+i.feed_actor+"/"+i.feed_source+"?ref=webpager_realTime",r=['<section class="topic wp-photo-topic" style="max-width:208px;">','	<a target="_blank" href="'+a+'">','		<div href="#" style="display:block;max-width:208px;overflow:hidden;">','			<img width="210" src="'+(n.big_image||n.image)+'" />',"		</div>","	</a>",'	<p class="wp-photo-dec">'+n.desc+"</p>","	<footer>",'		<a href="http://www.renren.com/profile.do?id='+t.host_id+'">'+t.host_name+'</a>分享的照片<span class="wp-topic-time"></span>',"	</footer>","</section>"].join("");return r},this.bindEvent=function(e){var t=e.topic,n=t.photos[0].url;/\?$/.test(n)&&(n=n.substr(0,n.length-1));var i=n+"/ajax?untrack=true";new XN.net.xmlhttp({url:i,onSuccess:function(t){var n=t.responseText;if(n){var i=XN.json.parse(n);if(e.topic_data=i,i.photos){var a=i.photos[0];e.frame.getElement("section>a>div>img").src=a.large}}}})}});e.PhotoChatroom=a,e.SharePhotoChatroom=o}),object.define("webpager/ugc/video","../lib/base, ../lib/tools, ./common",function(require,e){var t=require("../lib/base"),n=(t.dom,require("../lib/tools")),i=(n.QA,require("./common")),a=new Class(i.UgcChatroom,function(){this.textCollection={title:'<p class="wp-share-ico">分享视频回复</p>',handler:"分享视频回复"},this.buildTopic=function(e){var t=e.ui,n=e.ugc;t.setIcon("wp-share-ico");var i=new r(n);return t._assemble("topic",i),t.nodes.drawer.appendChild(i.frame),i.addEvent("resize",function(e){t.nodes.body.style.width=322+e.data.width+"px",t.nodes.drawer.style.width=e.data.width+"px"}),t.addEvent("unfocus",function(){i.hidePlayer()}),i}}),r=new Class(i.UgcTopic,function(){this.buildContent=function(e,t){var n="http://www.renren.com/profile.do?id="+t.host_id,i=("http://share.renren.com/share/"+t.host_id+"/"+t.share_id,['<section class="topic wp-share-topic">','	<div class="wp-video-img" style="width:128px;height:96px;background-repeat:no-repeat;background-image:url('+t.image+')" class="video"><a class="wp-video-play" href="#nogo" onclick="return false;">播放</a></div>','	<div class="player"></div>','	<div class="operation" style="display:none;"><a href="javascript:;" onclick="return false;"><span style="font-family:宋体;">&gt;&gt;&nbsp;</span>收起视频</a></div>','	<a href="'+t.fullurl+'" target="_blank" class="wp-share-name">'+t.headtitle+"</a>","	<footer>",'		<a href="'+n+'">'+t.host_name+"</a>","	</footer>","</section>"].join(""));return i},this.getUIRef=function(e){var t=e.frame,n={section:t.getElement("section"),thumb:t.getElement("div.wp-video-img"),player:t.getElement("div.player"),pbtn:t.getElement("a.wp-video-play"),cbtn:t.getElement("div.operation>a"),operation:t.getElement("div.operation")};e.nodes=n},this.bindEvent=function(e){var t=e.nodes;t.pbtn.addEvent("click",function(){e.showPlayer()}),t.cbtn.addEvent("click",function(){e.hidePlayer()}),e.hidePlayer()},this.showPlayer=function(e){var t=e.nodes,n=e.topic.url;t.thumb.hide(),t.operation.show(),t.player.innerHTML='<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"><embed src="'+n+'" style="width:100%;height:100%" allowscriptaccess="sameDomain" allownetworking="all" wmode="transparent" allowfullscreen="true" type="application/x-shockwave-flash"></object>',t.player.style.width="300px",t.player.style.height="265px",t.player.show(),e.fireEvent("resize",{data:{width:320}})},this.hidePlayer=function(e){var t=e.nodes;t.thumb.show(),t.player.hide(),t.operation.hide(),t.player.innerHTML="",e.fireEvent("resize",{data:{width:170}})}});e.VideoChatroom=a}),object.define("webpager/ugc/group","../lib/base, ../lib/tools, ./common",function(require,e){var t=require("../lib/base"),n=(t.dom,require("../lib/tools")),i=(n.QA,require("./common")),a=new Class(i.UgcChatroom,function(){this.textCollection={title:'<p class="wp-xiaozu-ico">小组回复</p>',handler:"小组回复"},this.buildTopic=function(e){var t=e.ui,n=e.ugc;t.setIcon("wp-xiaozu-ico");var i=new r(n);return t._assemble("topic",i),t.nodes.drawer.appendChild(i.frame),i.addEvent("resize",function(e){t.nodes.body.style.width=322+e.data.width+"px"}),webpager.getItem("group_ugc_"+n.feed_source)||webpager.setItem("group_ugc_"+n.feed_source,JSON.stringify(n)),i},this.loadHistory=function(e,t){var n=e.ugc,i={feed_stype:n.feed_stype,feed_actor:t.group_id,feed_source:n.feed_source};n.super_feed_actor=t.group_id,e.model.loadHistory("from_ugc_chatroom",i)}}),r=new Class(i.UgcTopic,function(){this.load=function(e){var t=e.ugc;t=t.group_id?t:JSON.parse(webpager.getItem("group_ugc_"+t.feed_source)),e.topic=t,e.render(t),setTimeout(function(){e.fireEvent("load",{data:t})},0)},this.buildContent=function(e,t){e.fireEvent("resize",{data:{width:228}});var i=e.getTopicContent(t),a=n.makeHeadTinyurl(t.host_pic),r=n.makeProfileUrl(t.host_id),o=['<section class="topic wp-group-topic" style="max-width:208px;">','<p><a target="_blank" href="',r,'">','<img src="',a,'" width="30" height="30">',"</a>",'<a  class="host_name" target="_blank" href="',r,'">',t.host_name,"</a></p>",'<p>在<a href="http://xiaozu.renren.com/xiaozu/',t.group_id,'" target="_blank">',t.group_name,"</a>小组发表的贴子</p>",'<p><a href="',t.title_url,'" target="_blank"><b>',t.title,"</b></a></p>","<div>",i,"</div>","	<footer>",'<span class="wp-topic-time">',n.getDate(t.timestamp),"</span>","</footer>","</section>"].join("");return o},this.getTopicContent=function(e,t){var n=t.scontent,i="";switch(parseInt(t.stype,10)){case 0:i=n;break;case 1:i=['<a href="',t.title_url,'" target="_blank" class="wp-group-pic"><img src="',t.imgsrc,'" width="100"></a><p>',n,"</p>"].join("");break;case 2:i=['<div class="wp-video-img" style="width:128px;height:96px;background-repeat:no-repeat;background-image:url('+t.imgsrc+')" class="video"><a class="wp-video-play" target="_blank" href="',t.title_url,'" >播放</a></div><p>',n,"</p>"].join("")}return i}});e.GroupChatroom=a}),object.define("webpager/ugc/blog","../lib/base, ../lib/tools, ./common",function(require,e){var t=require("../lib/base"),n=(t.dom,require("../lib/tools")),i=(n.QA,require("./common")),a=new Class(i.UgcChatroom,function(){this.textCollection={title:'<p class="wp-blog-ico">日志回复</p>',handler:"日志回复"},this.buildTopic=function(e){var t=e.ui,n=e.ugc;t.setIcon("wp-blog-ico");var i=new r(n);return t._assemble("topic",i),t.nodes.drawer.appendChild(i.frame),i.addEvent("resize",function(e){t.nodes.body.style.width=322+e.data.width+"px"}),i}}),r=new Class(i.UgcTopic,function(){this.buildContent=function(e,t){e.fireEvent("resize",{data:{width:228}});var i=n.unescapeHTML(t.title);i=i.length>25?i.substring(0,25)+"…":i;var a="http://blog.renren.com/blog/"+t.host_id+"/"+t.blog_id,r=e.getTopicDesc(t,a),o=(n.makeHeadTinyurl(t.host_pic),n.makeProfileUrl(t.host_id)),s=['<section class="topic wp-blog-topic" style="max-width:208px;">','<p><a href="',a,'" target="_blank"><b>',i,"</b></a></p>",'<p><a href="',o,'" target="_blank">',t.host_name,"</a>",'<span style="color:#999; margin-left:10px;">',n.getDate(t.timestamp),"</span></p>","<div>",r,"</div>",'<footer><a href="',a,'" target="_blank">查看全部&gt;&gt;</footer>',"</section>"].join("");return s},this.getTopicDesc=function(e,t,i){var a=n.unescapeHTML(t.content);return t.orgImage?['<a href="',i,'" target="_blank" class="wp-group-pic">','<img src="',t.orgImage,'" width="194"></a><p>',a,"</p>"].join(""):t.videoImage?['<div class="wp-video-img" style="width:128px;height:96px;background-repeat:no-repeat;background-image:url('+t.videoImage+')" class="video"><a class="wp-video-play" target="_blank" href="',i,'" >播放</a></div><p>',a,"</p>"].join(""):a}}),o=new Class(i.UgcChatroom,function(){this.textCollection={title:'<p class="wp-blog-ico">日志分享回复</p>',handler:"日志分享回复"},this.buildTopic=function(e){var t=e.ui,n=e.ugc;t.setIcon("wp-blog-ico");var i=new s(n);return t._assemble("topic",i),t.nodes.drawer.appendChild(i.frame),i.addEvent("resize",function(e){t.nodes.body.style.width=322+e.data.width+"px"}),i}}),s=new Class(i.UgcTopic,function(){this.buildContent=function(e,t){e.fireEvent("resize",{data:{width:228}});var i=n.unescapeHTML(t.title);i=i.length>25?i.substring(0,25)+"…":i;var a="http://blog.renren.com/share/"+t.host_id+"/"+t.shareId,r=e.getTopicDesc(t,a),o=(n.makeHeadTinyurl(t.host_pic),n.makeProfileUrl(t.host_id)),s=n.makeProfileUrl(t.resourceUserId),d=['<section class="topic wp-blog-topic" style="max-width:208px;">','<p><a href="',a,'" target="_blank"><b>',i,"</b></a></p>",'<p><a href="',o,'" target="_blank">',t.host_name,'</a><span style="color:#999; margin-left:10px;">',n.getDate(t.timestamp),'</span><span style="color:#999; margin-left:10px;">分享</span></p>',"<div>",r,"</div>",'<footer><a href="',a,'" target="_blank" style="float:left;">查看全部&gt;&gt;</a>','<span style="float:right; color:#666;">来自：<a href="',s,'" target="_blank">',t.resourceUserName,"</a></span></footer>","</section>"].join("");return d},this.getTopicDesc=function(e,t,i){var a=n.unescapeHTML(t.content);return t.orgImage?['<a href="',i,'" target="_blank" class="wp-group-pic">','<img src="',t.orgImage,'" width="194"></a><p>',a,"</p>"].join(""):t.videoImage?['<div class="wp-video-img" style="width:128px;height:96px;background-repeat:no-repeat;background-image:url('+t.videoImage+')" class="video"><a class="wp-video-play" target="_blank" href="',i,'" >播放</a></div><p>',a,"</p>"].join(""):a}});e.BlogChatroom=a,e.ShareBlogChatroom=o});