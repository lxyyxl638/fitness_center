object.define("xn/photo/recommend","events, dom, net",function(require,e){var t=require("dom"),n=require("events"),r=require("net");e.PhotoRecommend=new Class(function(){Class.mixin(this,n.Events);var e={hiddenAlbum:null,initialize:function(e,n){e.option={container:t.getElement("#stage .photo-content-box"),flowContainer:$("photoLayer"),recommendContainerId:"r-layer",hideLayerClass:"r-hide",recommendContentClass:"r-canvas",listContainerClass:"r-body",otherPics:0,hotPics:0,headTemplate:['<div style="width:100%;background:#3c3c3c;float:left;">','<div class="r-head">','<span class="r-note">您已经浏览到相册的最后一张</span>','<a class="r-close" href="javascript:;" title="关闭"></a>','<a class="r-restart" href="javascript:;"></a>',"</div>","</div>"].join(""),itemTemplate:['<div class="r-all">','<div data-type="{{type}}" class="r-item">','<a class="r-image recommentLayerLink" data-type="{{type}}" href="{{url}}" target="_blank" style="width:200px;height:200px;" data-index="{{index}}" album-id="{{id}}" owner-id="{{owner}}">','<img data-src="{{cover}}"/>',"</a>",'<div class="r-note">','<div class="description">','<a href="{{url}}" title="{{name}}" target="_blank" class="recommentLayerLink" data-index="{{index}}" album-id="{{id}}" owner-id="{{owner}}">{{name2}}</a>','<span class="pics_logo"></span>','<span class="pics_num">{{photoCount}}张</span>',"</div>","</div>","</div>",'<div class="r-footer">来自: <a target="_blank" href="http://www.renren.com/{{owner}}">{{description}}</a></div>',"</div>"].join("")},e.ajaxContent=null,$extend(e.option,n)},dealData:function(e,t,n){var r=new Object;return n.name.length>10?n.name2=n.name.substring(0,9)+"...":n.name2=n.name,n.width||(n.width=360),n.height||(n.height=360),n.description=n.userName,$extend(r,n),r},createItemHTML:function(e,t,n){var r=e.dealData(t,n);return r.index=t+1,Mustache.to_html(e.option.itemTemplate,r)},getHotAlbumsHTML:function(e,t){var n=['<div class="albums-title" style="margin-left:-6px;"><div class="albums-title-point">大家都在看</div></div>'];e.option.hotPics=0;for(var r=0;r<t.length&&e.option.hotPics<6-e.option.otherPics;r++)t[r].type===1&&(n.push(e.createItemHTML(r,t[r])),e.option.hotPics++);return e.option.hotPics?n.join(""):""},getOtherAlbumsHTML:function(e,t){var n="";e.option.otherPics=0,bInit=!1;for(var r=0;r<t.length&&e.option.otherPics<3;r++)if(t[r].type===2){if(!bInit){var i=t[r].userName;n=['<div class="albums-title"><div class="albums-title-point">ta的其它相册</div></div>'],bInit=!0}n.push(e.createItemHTML(r,t[r])),e.option.otherPics++}return e.option.otherPics?n.join(""):""},getListHTML:function(e,t){var n=['<div class="',e.option.listContainerClass,'">'];return n.push('<div id="recommendDiv_left">'),n.push(e.getOtherAlbumsHTML(t)),n.push('</div><div id="recommendDiv_right">'),n.push(e.getHotAlbumsHTML(t)),n.push("</div>"),n.push("</div>"),n.join("")},getRecommendNode:function(e,n){var r=t.wrap($element("DIV"));r.className=e.option.recommendContentClass;var i=[];return i.push(e.option.headTemplate),i.push(e.getListHTML(n)),r.innerHTML=i.join(""),r},getRecommendAlbums:function(e,t,n,i,s,o){s=s||XN.func.empty;if(!o&&e.ajaxContent){i(e.ajaxContent.albumList);return}new XN.net.xmlhttp({url:"http://photo.renren.com/photo/suggest/suggestAlbumNew?ownerId="+n+"&station="+t+"&albumId="+e.option.albumId+"&ref="+(e.isPopLayer()?0:1),method:"get",onSuccess:function(t){var o;try{o=XN.JSON.parse(t.responseText)}catch(u){o=null,e.isPopLayer()||e.fireEvent("skipRecommend")}if(o===null||o.code!=0||o.albumList==null||o.albumList.length==0){s();return}e.ajaxContent=o,i(o.albumList),jxn("body").delegate(".recommentLayerLink","click",function(){var t=this.getAttribute("data-index"),i=this.getAttribute("album-id"),s=this.getAttribute("owner-id"),o="http://photo.renren.com/photo/suggest/addLog/click?albumId="+e.option.albumId+"&ownerId="+n+"&clickAlbumId="+i+"&clickOwnerId="+s+"&position="+t;r.ping(o)})},onError:s})},init:function(e){e.getRecommendAlbums("1",e.option.ownerId,function(n){e.isPopLayer()?e.sendLog(1):e.sendLog(2),e.recommendContainer=t.wrap($element("DIV")),e.recommendContainer.id=e.option.recommendContainerId,e.recommendNode=e.getRecommendNode(n),e.hideLayer=t.wrap($element("DIV")),e.hideLayer.className=e.option.hideLayerClass,e.recommendContainer.appendChild(e.hideLayer),e.recommendContainer.appendChild(e.recommendNode),document.getElementsByTagName("body")[0].appendChild(e.recommendContainer),e.bindEvents(),e.fireEvent("initReady"),XN.browser.IE||e.resize(),e.adjustPicSize(),XN.bSRecommendAlbums=!0,setTimeout(function(){var n=$("r-layer"),r=t.getElement(".r-body",n),i=XN.browser.IE?"":"-webkit-transition-duration: 500ms;-moz-transition-duration: 500ms;-o-transition-duration: 500ms;transition-duration: 500ms;";i!=""&&(r.style.cssText=r.style.cssText?r.style.cssText+i:i),r&&(r.style.height="224px"),XN.browser.IE&&e.resize()},1),e.bindRecAlbumsEvent()},function(){e.fireEvent("recommendRestart")})},bindEvents:function(e){function r(){var n=$("r-layer"),r=this,i=t.getElement(".r-body",n);XN.browser.IE?(e.close(r),o()):(i&&(i.style.height="0px"),setTimeout(function(){e.close(r),o()},500));var s=e.isPopLayer()?11:12;e.sendLog(s)}function i(e){var e=e||window.event,t=e.srcElement||e.target;e.type=="keydown"&&e.keyCode==27&&XN.bSRecommendAlbums===!0&&(r(),setTimeout(function(){XN.bSRecommendAlbums=!1},1))}function s(){var n=$("r-layer"),r=this,i=t.getElement(".r-body",n);XN.browser.IE?(e.restart(r),o()):(i&&(i.style.height="0px"),setTimeout(function(){e.restart(r),o()},500))}function o(){n.undelegate(".r-close","click",r),n.undelegate(".r-restart","click",s),n.undelegate(".r-hide","click",r),XN.event.clearEvents(document,"keydown",i)}var n=e.recommendContainer;n.delegate(".r-close","click",r),n.delegate(".r-hide","click",r),n.delegate(".r-restart","click",s),XN.event.addEvent(document,"keydown",i)},bindRecAlbumsEvent:function(e){var t=$("r-layer"),n=Sizzle(".r-body a",t),r=this;XN.Array.each(n,function(t,n){XN.event.addEvent(n,"click",function(t){return function(){e.sendRecommendLog(t)}}(n.getAttribute("data-type")))})},sendLog:function(e,t){var n="http://photo.renren.com/photo/suggest/suggestAlbumData?source="+t;object.use("net",function(e){e.ping(n)})},sendRecommendLog:function(e,t){var n="http://photo.renren.com/photo/suggest/suggestAlbumDataLog?type="+t;object.use("net",function(e){e.ping(n)})},isPopLayer:function(e){return e.option.popLayer||XN.photo.photoViewer},close:function(e,n){var r=t.wrap(e.option.container);e.recommendContainer&&e.recommendContainer.remove(),n.className!="r-close"&&n.className!="r-restart"&&(log=e.isPopLayer()?14:15,e.sendLog(log)),XN.bSRecommendAlbums=!1,e.fireEvent("recommendClose")},restart:function(e,t){e.close(t);var n=e.isPopLayer()?9:10;e.sendLog(n),e.fireEvent("recommendRestart")},resize:function(e){function u(e,n,r){var i=Sizzle("#recommendDiv_left .r-all"),s=Sizzle("#recommendDiv_right .r-all"),o=!!e.option.otherPics,u=o?75:35,a=parseInt((n-r-u)/208),f=t.getElement(".r-head",$("r-layer")),l=t.getElement(".r-body",$("r-layer")),c=0,h=0;if(!e.option.otherPics&&!e.option.hotPics)return;if(o)for(var p=0;p<i.length;p++)i[p].style.display="none";for(var p=0;p<s.length;p++)s[p].style.display="none";a<2&&(a=2),i&&(c=i.length),s&&(h=s.length);if(o)for(var p=0;p<parseInt(a/2)+a%2&&p<c;p++)i[p].style.display="";for(var p=0;p<(o?parseInt(a/2):a)&&p<h;p++)s[p].style.display="";a>c+h&&(a=c+h),l.style.width=a*208+u+"px",f.style.width=a*208+u-8+"px"}var n=$("r-layer"),r=document.body.clientWidth||document.documentElement.clientWidth,i=t.getElement(".r-head",n),s=t.getElement(".r-body",n),o=s?s.children:null;if(!n)return;u(e,r,10)},adjustPicSize:function(){var e=$("r-layer"),t=0,n=0,r=Sizzle(".r-body img",e);if(r&&r.length>0)for(var i=0;i<r.length;i++)r[i].onload=function(){t=this.width,n=this.height,t>n?(this.style.height="200px",this.style.marginLeft=100*(1-t/n)+"px"):(this.style.width="200px",this.style.marginTop=50*(1-n/t)+"px")},r[i].getAttribute("data-src")&&(r[i].src=r[i].getAttribute("data-src"))}},i=this;Object.keys(e).forEach(function(t){i[t]=e[t]})})}),function($){var CONTAINER_MIN_WIDTH=960,CONTAINER_MIN_HEIGHT=500,CONTAINER_MAX_WIDTH=1404,SIDEBAR_WIDTH=360,MAIN_MIN_WIDTH=CONTAINER_MIN_WIDTH-SIDEBAR_WIDTH,TOOLBAR_HEIGHT=45,MAIN_MIN_HEIGHT=CONTAINER_MIN_HEIGHT-TOOLBAR_HEIGHT,MAIN_MAX_WIDTH=CONTAINER_MAX_WIDTH-SIDEBAR_WIDTH,PHOTO_ROOT_URL="http://photo.renren.com/photo",boxSize,albumData,currentPhoto,photosList=[],coolCache={},photoRelatedDataCatch={},PRELOAD_COUNT=3,pSource=XN.pageId=="home"?"1":XN.pageId=="profile"?"2":location.href.indexOf("http://photo")===0?"3":0,photoViewerIsLock=!1,circling=!1,circleType,dragInstance=null,recommentPhotoIsShow=!1,fullScreening=!1,isIE=$.browser.ie,isIE7=isIE&&$.browser.version=="7",layerScrollTimer=null,layerScrollTop=0,winWidth=$(window).width(),winHeight=$(window).height(),resizeTimer=null,hashCopy=location.hash,unfoldAlways=!1,placeholderSupport="placeholder"in document.createElement("input"),EventProxy={_cache:{},_guid:0,clear:function(){this._guid=0,this._cache={}},assign:function(){var e=Array.prototype.slice.call(arguments,0),t=e.length;if(!t&&t<2)return;var n=e[t-1],r=e.slice(0,-1).join("");this._cache[r+this._guid++]=[r,n]},trigger:function(e){var t=this._cache;for(var n in t){var r=t[n][0].replace(e,"");r===""?(typeof t[n][1]=="function"&&t[n][1](),delete t[n]):t[n][0]=r}}},num2uinitZH=function(e){return typeof e=="number"&&e>=1e4?(e/1e4).toFixed(1)+"万":e},log=function(e){$.get("http://photo.renren.com/photo/log/"+XN.user.id+"/action?sourceId="+currentPhoto.id+"&psource="+e)},template={layout:'<div class="photoViewer" id="photoViewer">					<div class="photoViewerLayer" style="height:<%= layerHeight %>px" id="photoViewerLayer" layer-cmd="close">						<div class="photoViewerLayerCenter" style="width:<%= containerWidth %>px;" id="photoViewerLayerWrapper">							<div class="photoViewerContent pv-clear"  style="width:<%= containerWidth %>px;" id="photoViewerLayerContainer">								<div class="photoViewerMain" style="width:<%= mainWidth %>px;" id="photoViewerMain">									<div class="photoViewerImgContainer" style="height:<%= imgContainerHeight %>px;" id="photoViewerImgContainer" layer-cmd="navagator">										<div class="photoTopRightPos" id="photoTopRightPos">											<span class="circleThePhoto" id="circleThePhoto" layer-cmd="circleComment">圈亮点</span>											<div class="WHInfo" id="WHInfo"><div class="WHInfoBg"></div><span class="WHInfoContent" layer-cmd="fullScreen">高清图</span></div>										</div>										<div class="pViewerMainCool photoViewerCool" id="pViewerMainCool" layer-cmd="cool"><i class="pViewerCoolIco photoViewerCool" id="pViewerCoolIco" layer-cmd="cool"></i><span class="pViewerMainCoolCount photoViewerCool" id="photoViewCoolCount" layer-cmd="cool"></span></div>										<img id="photoViewerImg" class="photoViewerImg" style="width:<%= imgWidth %>px;height:<%= imgHeight %>px;" src="<%= src %>" layer-cmd="navagator"><span class="imgVerticalMiddleHelp"></span>										<span class="photoViewerPrev" id="photoViewerPrev" title="上一张" layer-cmd="prev"></span>										<span class="photoViewerNext" id="photoViewerNext" title="下一张" layer-cmd="next"></span>										<div class="photoViewerLoading" id="photoViewerLoading"><img src="http://a.xnimg.cn/n/apps/photo/cssimg/photo-layer/loading.gif"/></div>										<div class="photoViewerVoice" id="photoViewerVoice"></div>									</div>									<div class="photoViewerActionBar pv-clear" id="photoViewerToolbar"></div>								</div>								<div class="photoViewerAside" id="photoViewerAside" style="min-height:<%= sidebarMinHeight %>px;">									<div class="photoViewerSideHeader"><span class="photoViewerClose" layer-cmd="close" title="点击两边的空白处也可以关闭"></span>										<div class="photoViewerSidebarShadow"></div>									</div>									<div style="min-height:250px">										<div class="photoViewerInfo" id="photoViewerSidebarTop"></div>										<div class="photoViewerCommentBox pv-clear" id="photoViewerCommentBox"></div>									</div>									<div class="photoViewerAD" id="photoViewerAD">										<div class="Widget"><div id="adla100000000072"></div></div>									</div>								</div>							</div>						</div>					</div>				</div>',toolbar:'<% if (showTitle) { %>					<h3 class="photoViewerAlbumName" id="photoViewerAlbumName" title="<%= title %>">【<a class="photoViewerAlbumNameLink" href="http://photo.renren.com/photo/<%= ownerId %>/album-<%= albumId %>" target="_blank"><%= name %></a>】</h3>				 <% } else { %>				 	<h3 class="photoViewerAlbumName" id="photoViewerAlbumName">【<a class="photoViewerAlbumNameLink" href="http://photo.renren.com/photo/<%= ownerId %>/album-<%= albumId %>" target="_blank"><%= name %></a>】</h3>				 <% } %>					<p class="photoViewerIndex">第<span id="photoViewerIndex"><%= index %></span>张，共<span id="photoViewerTotal"><%= count %></span>张</p>					<div class="photoViewerActMenu" id="photoViewerActMenu">						<div class="photoViewerMoreAct"><span>更多操作</span><span class="photoViewerMoreActTrig"></span></div>						<ul class="photoViewerActDropMenu" id="photoViewerActDropMenu">							<li class="photoViewerActItem" layer-cmd="fullScreen"><i class="photoViewerIcoFull" layer-cmd="fullScreen"></i>全屏查看</li>							<li class="photoViewerActItem" layer-cmd="left"><i class="photoViewerIcoTurnLeft" layer-cmd="left"></i>向左转</li>							<li class="photoViewerActItem" layer-cmd="right"><i class="photoViewerIcoTurnRight" layer-cmd="right"></i>向右转</li>							<% if(XN.user.id == ownerId) { %>							<li class="photoViewerActItem" layer-cmd="transform"><i class="photoViewerIcoTransform" layer-cmd="transform"></i>转移</li>							<% if(type !== 1) { %>							<li class="photoViewerActItem" layer-cmd="cover"><i class="photoViewerIcoCover" layer-cmd="cover"></i>设为封面</li>							<% } %>							<li class="photoViewerActItem" id="photoViewerActAvatar" layer-cmd="avatar"><i class="photoViewerIcoAvatar" layer-cmd="avatar"></i>设为头像</li>							<li class="photoViewerActItem" id="photoViewerActDelete" layer-cmd="delete"><i class="photoViewerIcoDel" layer-cmd="delete"></i>删除</li>							<% } %>							<li class="photoViewerActItem photoViewerExif" id="photoViewerExif"><i class="photoViewerIcoExif"></i>相机信息<div id="photoViewerExifWrapper" class="photoViewerExifWrapper"></div></li>						</ul>					</div>					<div class="photoViewerActBtn pv-clear">						<a href="javascript:" class="pViewerComment" layer-cmd="loadOnceComment">评论<span class="pViewerBottomNum layer-cmd="loadOnceComment" id="photoViewCommentCount"></span></a>						<a href="javascript:" class="pViewerShare photoViewShare share_new" layer-cmd="share">分享<span class="pViewerBottomNum photoViewShare share_new" layer-cmd="share" id="photoViewShareCount"><%= shareCount %></span></a>						<a href="javascript:" class="pViewerCircle" id="pViewerCircle" layer-cmd="circleFace">圈人<span class="pViewerBottomNum layer-cmd="circleFace" id="photoViewCircleCount"></span></a>					</div>',photoViewerInfo:'<div class="photoViewerAuthor pv-clear">							<a href="http://www.renren.com/profile.do?id=<%= owner.userName.id %>" class="photoViewAuthorAvatar" target="_blank"><img src="<%= owner_tinyFullUrl %>" alt=""></a>							<div class="photoViewerAuthorInfo">                                <a class="photoViewerUserName" href="http://www.renren.com/profile.do?id=<%= owner.userName.id %>" target="_blank"><%= owner.userName.name %></a>                                <p class="photoViewerPrivacy" id="photoViewerPrivacy"></p>                                <p class="photoViewerDate">上传于&nbsp;<span id="photoUploadDate"><%= currentPhoto.date %></span></p>                            </div>						</div>						<div class="photoViewerDescWithTag pv-clear" id="photoViewerDescWithTag">							<% if(owner.userName.id !== guest.userName.id) { %>								<p class="photoViewerDesc" id="photoViewerDesc"><%= currentPhoto.title %></p>							<% } else { %>								<% if(XN.string.trim(currentPhoto.title)) { %>								<p class="photoViewerDescEdit" id="photoViewerDescEditWraper"><span class="photoViewerEditSpan" id="photoViewerDesc"><%= currentPhoto.title %></span></p>								<% } else { %>								<p class="photoViewerDescEdit" id="photoViewerDescEditWraper"><span class="photoViewerEditSpan" id="photoViewerDesc">单击此处添加描述</span></p>								<% } %>								<div class="photoViewerDescEditarea" id="photoViewerDescEditarea">									<textarea class="photoViewerDescTextarea" id="photoViewerDescTextarea"></textarea>									<span class="photoViewerBtn" layer-cmd="editDescOk">确定</span>									<span class="photoViewerBtnDisable" layer-cmd="editDescCancel">取消</span>								</div>							<% } %>							<div class="photoViewerWith" id="photoViewerWith"></div>						</div>						<div id="photoViewerLocation" class="photoViewerLocation"></div>						<ul id="subjectInfoList"></ul>						<ul class="photoViewerSideAct pv-clear">							<li class="PVSideBtnWrap"><a href="javascript:" class="pViewerSideActBtn pViewerCoolBtn photoViewerCool" id="pViewerSideCool" layer-cmd="cool"></a></li>							<% if(currentPhoto.photoControl == 99 && currentPhoto.albumControl == 99) { %>							<li class="PVSideBtnWrap"><a href="javascript:" class="pViewerSideActBtn pViewerShareBtn photoViewShare share_new" layer-cmd="share"></a></li>							<% }else { %>							<li class="PVSideBtnWrap"><a href="javascript:" class="pViewerSideActBtn pViewerShareBtn photoViewShareAble" title="当前照片已设置隐私，无法被分享" layer-cmd="share"></a></li>							<% } %>							<li class="PVSideBtnWrap"><a href="javascript:" class="pViewerSideActBtn pViewerCommentBtn" layer-cmd="commentFocus"></a></li>							<li class="PVSideViewCountwrap">浏览<span class="photoViewCount" id="photoViewCount"><%= currentPhoto.viewCount %></span></li>						</ul>						<div class="photoViewerComments" id="photoViewerComments"></div>',commentBox:'<textarea placeholder="我也说两句..." class="photoViewCommentEnterTextarea" id="photoViewCommentEnterTextarea"></textarea>					<div class="photoViewerCommentEnterAct pv-clear" id="photoViewerCommentEnterAct">						<a href="javascript:" class="photoViewerCommentAt" id="photoViewerCommentAt"></a>						<a href="javascript:" class="photoViewerCommentEmotion" id="photoViewerCommentEmotion"></a>						<div class="photoViewerCommentSecret">							<label class="photoViewerCircleCheckboxLabel">								<input  class="photoViewerCircleCheckbox" id="whisperForTheatre" type="checkbox" name="only_to_me" value="true">悄悄话							</label>						</div>						<span href="javascript:" class="photoViewerBtn" id="photoViewerCommentBtn" layer-cmd="comment">回复</span>					</div>',comments:'<% if(comments.length) { %>					<div class="photoViewCommentContent">						<% if(commentCount > 5) { %>						<div class="photoViewerMoreCommentWrapper" id="photoViewerMoreCommentWrapper">							<a href="javascript:" class="photoViewerCommentsLoadMore" id="photoViewerCommentsLoadMore" layer-cmd="moreComments">显示较早的<span id="remainCommentCount" layer-cmd="moreComments"><%= (commentCount - 5) %></span>条评论</a>						</div>						<% } %>						<ul class="photoViewerCommentsList" id="photoViewerCommentsList">							<% for(var i = comments.length - 1; i >= 0; i--) { %>							<% if(comments[i].tagComment !== undefined) { %>							<li class="photoViewerComment CC pv-clear" id="photoViewerComment-<%= comments[i].id %>" circle-id=<%= comments[i].id %>>							<% } else { %>							<li class="photoViewerComment pv-clear" id="photoViewerComment-<%= comments[i].id %>">							<% } %>								<a href="http://www.renren.com/profile.do?id=<%= comments[i].author %>" class="photoViewerCommentAvatar" target="_blank">									<img src="<%= comments[i].headUrl %>" alt="" width="30">								</a>								<div class="photoViewerCommentContent">									<a href="http://www.renren.com/profile.do?id=<%= comments[i].author %>" class="photoViewerCommentName" target="_blank"><%= comments[i].name %></a>									<% if(comments[i].isVip) { %>										<a href="http://i.renren.com/index.action?wc=290000" target="_blank"><img src="<%= comments[i].vipIconUrl %>"/></a>									<% } %>：									<% if(comments[i].state === 1) { %>										<a class="vocal-player vocal-player-tiny" style="margin-left:10px;" data-vocal=\'{"url": "<%= comments[i].url %>","time":<%= comments[i].length %>,ownerId:<%= comments[i].owner %>,"voiceId":<%= comments[i].id %>,"sourceOwner":<%= comments[i].owner %>,"sourceId":<%= comments[i].photoId %>, "ugcType":3}\' href="javascript:">											<span class="btn"></span>											<span class="time"><span class="num"><%= comments[i].length %></span>秒</span>										</a>									<% } else { %>										<%= comments[i].body %>									<% } %>									<% if(comments[i].tagComment !== undefined) { %>										<span class="circleCommentIcon" data-id="<%= comments[i].id %>"></span>									<% } %>									<div class="photoViewerCommentInfo">										<span class="photoViewerCommentDate"><%= comments[i].time %></span>										<% if(comments[i].whisper) { %>										<i class="photoViewerWhisperIcon" title="悄悄话"></i>										<% } %>										<div class="photoViewerCommentAct">											<% if(comments[i].author == XN.user.id || XN.user.id == comments[i].owner) { %>											<% if(comments[i].tagComment !== undefined) { %>											<a href="javascript:" class="photoViewerCommentDel" layer-cmd="deleteComment" data-id="<%= comments[i].id %>" data-type="circleComment">删除</a>											<% } else { %>											<a href="javascript:" class="photoViewerCommentDel" layer-cmd="deleteComment" data-id="<%= comments[i].id %>">删除</a>											<% } %>											<% } %>											<% if(comments[i].author != XN.user.id) { %>											<a target="_blank" href="http://support.renren.com/admin/newuserreport.do?type=24&owner=<%= comments[i].owner %>&contentId=<%= comments[i].id %>&userId=<%= comments[i].author %>&pid=<%= comments[i].photoId %>" class="photoViewerCommentReport">举报</a>											<% } %>											<% if(comments[i].like == 0 || typeof comments[i].like === "undefined") { %>											<a href="javascript:" class="photoViewerCommentCool" layer-cmd="commentCool" data-cooled="0" data-id="<%= comments[i].id %>" data-name="<%= comments[i].name %>" data-owner="<%= comments[i].owner %>">赞</a>											<% } else { %>											<a href="javascript:" class="photoViewerCommentCool" layer-cmd="commentCool" data-cooled="1" data-id="<%= comments[i].id %>" data-name="<%= comments[i].name %>" data-owner="<%= comments[i].owner %>">取消赞</a>											<% } %>											<% if(comments[i].author != XN.user.id) { %>												<% if(comments[i].whisper) { %>													<a href="javascript:" class="photoViewerCommentReply" layer-cmd="reply" data-author="<%= comments[i].author %>" data-id="<%= comments[i].id %>" data-name="<%= comments[i].name %>" data-whisper="true">回复</a>												<% } else { %>													<a href="javascript:" class="photoViewerCommentReply" layer-cmd="reply" data-author="<%= comments[i].author %>" data-id="<%= comments[i].id %>" data-name="<%= comments[i].name %>">回复</a>												<% } %>											<% } %>										</div>									</div>								</div>							</li>							<% } %>						</ul>					</div>					<% } %>',moreComments:'<% for(var i = comments.length - 1; i >= 0; i--) { %>							<% if(comments[i].tagComment !== undefined) { %>							<li class="photoViewerComment CC pv-clear" id="photoViewerComment-<%= comments[i].id %>" circle-id=<%= comments[i].id %>>							<% } else { %>							<li class="photoViewerComment pv-clear" id="photoViewerComment-<%= comments[i].id %>">							<% } %>							<a href="http://www.renren.com/profile.do?id=<%= comments[i].author %>" class="photoViewerCommentAvatar" target="_blank">								<img src="<%= comments[i].headUrl %>" alt="" width="30">							</a>							<div class="photoViewerCommentContent">								<a href="http://www.renren.com/profile.do?id=<%= comments[i].author %>" class="photoViewerCommentName" target="_blank"><%= comments[i].name %></a>								<% if(comments[i].isVip) { %>									<a href="http://i.renren.com/index.action?wc=290000" target="_blank"><img src="<%= comments[i].vipIconUrl %>"/></a>								<% } %>：								<% if(comments[i].state === 1) { %>									<a class="vocal-player vocal-player-tiny" style="margin-left:10px;" data-vocal=\'{"url": "<%= comments[i].url %>","time":<%= comments[i].length %>,ownerId:<%= comments[i].owner %>,"voiceId":<%= comments[i].id %>,"sourceOwner":<%= comments[i].owner %>,"sourceId":<%= comments[i].photoId %>, "ugcType":3}\' href="javascript:">										<span class="btn"></span>										<span class="time"><span class="num"><%= comments[i].length %></span>秒</span>									</a>								<% } else { %>									<%= comments[i].body %>								<% } %>								<% if(comments[i].tagComment !== undefined) { %>									<span class="circleCommentIcon" data-id="<%= comments[i].id %>"></span>								<% } %>								<div class="photoViewerCommentInfo">									<span class="photoViewerCommentDate"><%= comments[i].time %></span>									<% if(comments[i].whisper) { %>									<i class="photoViewerWhisperIcon" title="悄悄话"></i>									<% } %>									<div class="photoViewerCommentAct">										<% if(comments[i].author == XN.user.id || XN.user.id == comments[i].owner) { %>										<% if(comments[i].tagComment !== undefined) { %>										<a href="javascript:" class="photoViewerCommentDel" layer-cmd="deleteComment" data-id="<%= comments[i].id %>" data-type="circleComment">删除</a>										<% } else { %>										<a href="javascript:" class="photoViewerCommentDel" layer-cmd="deleteComment" data-id="<%= comments[i].id %>">删除</a>										<% } %>										<% } %>										<% if(comments[i].author != XN.user.id) { %>										<a target="_blank" href="http://support.renren.com/admin/newuserreport.do?type=24&owner=<%= comments[i].owner %>&contentId=<%= comments[i].id %>&userId=<%= comments[i].author %>&pid=<%= comments[i].photoId %>" class="photoViewerCommentReport">举报</a>										<% } %>										<% if(comments[i].like == 0 || typeof comments[i].like === "undefined") { %>										<a href="javascript:" class="photoViewerCommentCool" layer-cmd="commentCool" data-cooled="0" data-id="<%= comments[i].id %>" data-name="<%= comments[i].name %>" data-owner="<%= comments[i].owner %>">赞</a>										<% } else { %>										<a href="javascript:" class="photoViewerCommentCool" layer-cmd="commentCool" data-cooled="1" data-id="<%= comments[i].id %>" data-name="<%= comments[i].name %>" data-owner="<%= comments[i].owner %>">取消赞</a>										<% } %>										<% if(comments[i].author != XN.user.id) { %>											<% if(comments[i].whisper) { %>												<a href="javascript:" class="photoViewerCommentReply" layer-cmd="reply" data-id="<%= comments[i].id %>" data-author="<%= comments[i].author %>" data-name="<%= comments[i].name %>" data-whisper="true">回复</a>											<% } else { %>												<a href="javascript:" class="photoViewerCommentReply" layer-cmd="reply" data-id="<%= comments[i].id %>" data-author="<%= comments[i].author %>" data-name="<%= comments[i].name %>">回复</a>											<% } %>										<% } %>									</div>								</div>							</div>						</li>						<% } %>',exif:'<div class="photoViewerExifContent">					<span class="photoViewerExifTrig"></span>					{{--exifContent--}}				</div>',location:'<div class="photoViewerLoc"><i class="photoViewerLocIco"></i><a href="<%= url %>" target="_blank"><%= name %></a></div>',fullScreen:'<div class="photoViewerFull" id="photoViewerFull"><img class="photoViewerFullImg" id="photoViewerFullImg" src="http://a.xnimg.cn/n/apps/photo/cssimg/photo-layer/loading.gif"/><span class="imgVerticalMiddleHelp"></span></div>',circle:'<div class="photoViewerCircle" id="photoViewerCircle" style="width:<%= width %>px;height:<%= height %>px;top:<%= top %>px;left:<%= left %>px;" dir-cmd="reset">					<% if(type === "face") { %>					<div class="photoViewerCircleCancel" layer-cmd="circleCancel">取消圈人</div>					<% } else if(type === "comment") { %>					<div class="photoViewerCircleCancel" layer-cmd="circleCancel">退出圈亮点</div>					<% } %>					<div class="photoViewerCircleDrag" id="photoViewerCircleDrag" style="width:<%= circleWidth %>px;height:<%= circleHeight %>px;left:<%= circleLeft %>px;top:<%= circleTop %>px;">						<div class="resizableContent">							<% if(type === "comment") { %>							<img src="<%= src %>" width="<%= width %>" height="<%= height %>" class="circleInnerImg" id="circleInnerImg" style="left:-<%= circleLeft %>px;top:-<%= circleTop %>px;">							<% } %>							<div class="resizableBorderTop"></div>							<div class="resizableBorderRight"></div>							<div class="resizableBorderBottom"></div>							<div class="resizableBorderLeft"></div>						</div>						<div class="resizableHandle" id="resizableHandle" dir-cmd="move">							<span class="circleCancel" layer-cmd="circleCancel"></span>							<div class="RSH resizable-handle-t" dir-cmd="n"></div>							<div class="RSH resizable-handle-r" dir-cmd="e"></div>							<div class="RSH resizable-handle-b" dir-cmd="s"></div>							<div class="RSH resizable-handle-l" dir-cmd="w"></div>							<div class="RSH RSH-block resizable-handle-lt" dir-cmd="nw"></div>							<div class="RSH RSH-block resizable-handle-rt" dir-cmd="ne"></div>							<div class="RSH RSH-block resizable-handle-lb" dir-cmd="sw"></div>							<div class="RSH RSH-block resizable-handle-rb" dir-cmd="se"></div>						</div>					</div>					<% if(type === "face") { %>					<div class="photoViewerCircleEnter" id="photoViewerCircleEnter" style="top:<%= circleTop + circleHeight + 10 %>px;left:<%= circleLeft - (145 - circleWidth) / 2 %>px;">						<span class="photoViewerCircleTrig"></span>						<input type="text" class="photoViewerCircleInput" placeholder="请输入名字或标签" id="photoViewerCircleInput"/>						<ul class="circleFriendsList" id="circleFriendsList"></ul>					</div>					<% } else if(type === "comment") { %>					<div class="photoViewerCircleEnter photoViewerCircleCommentEnter" id="photoViewerCircleEnter" style="top:<%= circleTop + circleHeight + 10 %>px;left:<%= circleLeft - (240 - circleWidth) / 2 %>px;">						<span class="photoViewerCircleTrig"></span>						<div class="rdagCircleComment">							<textarea class="circleCommentTextarea" id="circleCommentTextarea" placeholder="移动至亮点区域并评论~"></textarea>							<div class="circleCommentBottom pv-clear">								<a href="javascript:" class="photoViewerCommentAt" id="circleCommentAt"></a>								<span class="photoViewerBtn" layer-cmd="submitCircleComment">回复</span>								<span class="circleCommentwordsCount" id="circleCommentwordsCount">0/50</span>							</div>						</div>					</div>					<% } %>				</div>',circleFriendsSuggest:'<% for(var i = 0, len = candidate.length; i < len; i++) { %>								<% if(i === 0) { %>								<li data-id="<%= candidate[i].id %>" class="circleFriendsSugI circleFriendsSugActive">								<% } else { %>								<li class="circleFriendsSugI" data-id="<%= candidate[i].id %>">								<% } %>									<img class="circleFriendsSugAvatar" src="<%= candidate[i].head %>"/>									<span class="circleSugName"><%= candidate[i].name %></span>								</li>								<% } %>',circleView:{who:'<div class="PVCI PVCIWho" id="circle<%= id %>" data-id="<%= id %>" layer-cmd="circleUnsignedFace" style="top:<%= top %>px;left:<%= left %>px;width:<%= width %>px;height:<%= height %>px;">						<div class="photoViewerCircleTips circleWhoTips" style="left:<%= tipLeft %>px;">							<span class="photoViewerCircleTrig"></span>							<div class="photoViewerCircleTipsContent PVCWhoCotent">圈出Ta</div>						</div>					</div>',face:'<div class="PVCI PVCIFace" id="circle<%= id %>" style="top:-10000px;left:-10000px;width:<%= width %>px;height:<%= height %>px;">						<div class="photoViewerCircleTips circleFaceTips">							<span class="photoViewerCircleTrig"></span>							<div class="photoViewerCircleTipsContent PVCFaceCotent"><i class="circleFaceIcon"></i><%= targetName %></div>						</div>					</div>',comment:'<div class="PVCCI" id="circle<%= id %>" style="top:-10000px;left:-10000px;;width:<%= width %>px;height:<%= height %>px;">						<div class="photoViewerCircleTips circleCommentTips">							<span class="photoViewerCircleTrig"></span>							<div class="photoViewerCircleTipsContent PVCCommentCotent"><span class="circleCommentName"><%= name %></span>：<%= body %></div>						</div>					</div>'},withs:'<span><% if(hasDesc) { %>——<% } %>和</span>				<% for(var i = 0, len = withs.length; i < len; i++) { %>				<a class="withItem" id="withTag<%= withs[i].id %>" href="http://www.renren.com/profile.do?id=<%= withs[i].userId %>" target="_blank" data-id="<%= withs[i].id %>">					<%= withs[i].userName %>					<% if(ownerId == XN.user.id || withs[i].userId == XN.user.id) { %>						<i class="withDeleteIco" data-id="<%= withs[i].id %>" layer-cmd="deleteWiths" title="删除"></i>					<% } %>				</a>				<% if(i !== len - 1 || tags.length > 0) { %><span>、</span><% } %>				<% } %>				<% for(var i = 0, len = tags.length; i < len; i++) { %>				<% if(tags[i].targetId != 0) { %>					<a class="withItem" id="withTag<%= tags[i].id %>" href="http://www.renren.com/profile.do?id=<%= tags[i].targetId %>" target="_blank" data-id="<%= tags[i].id %>" data-type="circle">						<%= tags[i].targetName %>						<% if(ownerId == XN.user.id || tags[i].taggerId == XN.user.id || tags[i].targetId == XN.user.id) { %>							<i class="withDeleteIco" data-id="<%= tags[i].id %>" layer-cmd="deleteCircle" title="删除"></i>						<% } %>					</a>					<% if(i !== len - 1) { %><span>、</span><% } %>				<% } else { %>					<span class="withItem" id="withTag<%= tags[i].id %>" data-id="<%= tags[i].id %>" data-type="circle">						<%= tags[i].targetName %>						<% if(ownerId == XN.user.id || tags[i].taggerId == XN.user.id || tags[i].targetId == XN.user.id) { %>							<i class="withDeleteIco" data-id="<%= tags[i].id %>" layer-cmd="deleteCircle" title="删除"></i>						<% } %>					</span>					<% if(i !== len - 1) { %><span>、</span><% } %>				<% } %>				<% } %>				<span>一起</span>'
,voice:'<a href="javascript:;" class="vocal-player" data-vocal="{url:&quot;<%=voiceUrl%>&quot;,ownerId:&quot;<%=ownerId%>&quot;,photoId:&quot;<%=photoId%>&quot;,voiceId:&quot;<%=id%>&quot;,time:&quot;<%=voiceLength%>&quot;, psource:&quot;10005&quot;}">	                <div class="progress"></div>	                <span class="btn"></span>	                <span class="time"><span class="num"><%=voiceLength%></span>秒</span>	            </a>',circleCommentHoverView:'<div class="circleCommentHoverShow" id="circleCommentHoverShow" data-id=<%= id %> style="width:<%= width %>px;height:<%= height %>px;top:<%= top %>px;left:<%= left %>px;">		    						<div class="circleCommentHoverShowImgWrap" style="width:<%= width %>px;height:<%= height %>px;">										<img class="circleCommentHoverShowImg" src="<%= src %>" width="<%= imgWidth %>" height="<%= imgHeight %>" style="top:-<%= imgTop %>px;left:-<%= imgLeft %>px;"/>		    						</div>									<div class="photoViewerCircleTips circleCommentTips" style="left:<%= tipsLeft %>px; top: <%= tipsTop %>px; width: <%= tipsWidth %>px; white-space: normal;">										<% if(tipsTop > 0) { %>										<span class="photoViewerCircleTrig"></span>										<% } else { %>										<span class="photoViewerCircleTrigB"></span>										<% } %>										<div class="photoViewerCircleTipsContent PVCCommentCotent">											<span class="circleCommentName"><%= name %></span>：<%= body %>										</div>									</div>	    						</div>',cooledList:'<% for(var i = 0, len = likeList.length; i < len; i++) { %>    					<li class="cooledListItem" id="cooler-<%= likeList[i].id %>"><a href="http://www.renren.com/profile.do?id=<%= likeList[i].id %>" title="<%= likeList[i].name %>" target="_blank"><%= likeList[i].name %></a></li>    				<% } %>    				<% if(likeCount > 8) { %>						<li class="cooledListItem"><span>其他<%= (likeCount - 8) %>人</span></li>					<% } %>'},tmpl=function(e,t){var n={},r=function(e,t){var r=/\W/.test(e)?new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+e.replace(/[\r\t\n]/g," ").split("<%").join("	").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("	").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');"):n[e]=n[e]||tmpl(document.getElementById(e).innerHTML);return t?r(t):r};return r(e,t)},disableNamecard=function(e){for(var t=0,n=e.length;t<n;t++)e[t].body=e[t].body.replace(/\s+namecard\s?=\s?[\'\"]\d+[\'\"]/g,"")},fetchAlbumData=function(e,t,n,r){var i=PHOTO_ROOT_URL+"/"+e+"/photo-"+t+"/layer";r?i+=r+"&psource="+n:i+="?psource="+n,i+="&isGuide=1",$.get(i,function(e){e=JSON.parse(e);if(e.code==0){albumData=e;var t=albumData.list,n=albumData.photoNum;albumData.listA&&(t=t.concat(albumData.listA)),albumData.listB&&(t=t.concat(albumData.listB));for(var r=0,i=t.length;r<i;r++)photosList[n-t[r].position]=t[r];currentPhoto=photosList[n-e.currentPhoto.position],EventProxy.trigger("fetchAlbumData"),$.get("http://photo.renren.com/photo/pv/addPv?photo="+currentPhoto.id+"&owner="+albumData.album.owner+"&album="+albumData.album.id+"&type=48")}else e.code==402?setTimeout(function(){window.location.href=e.redirectUrl},500):(close(),XN.DO.showMessage("对不起，您点击的图片无法显示，可能的原因导致：<br/>内容过期、内容不存在，或者您没有权限查看该内容。"))})},fetchMorePhotoList=function(e,t,n,r,i){var s=PHOTO_ROOT_URL+"/"+e+"/photo-"+t+"/bypage/ajax?pos="+n+"&toward="+r;$.get(s,function(e){e=JSON.parse(e);if(e.code==0){var t=e.list;for(var n=0,r=t.length;n<r;n++)photosList[albumData.photoNum-t[n].position]=t[n];i&&i()}else XN.DO.showMessage("数据获取出错了，请稍后重试")})},fetchPhotoData=function(e,t,n){if(photoRelatedDataCatch[t]){n&&n(),EventProxy.trigger("fetchPhotoData");return}var r=PHOTO_ROOT_URL+"/"+e+"/photo-"+t+"/ajaxmsy";$.post(r,{psource:pSource,limit:5,newLayer:!0},function(e){e=JSON.parse(e.responseText),e.code==0&&(disableNamecard(e.comments),photoRelatedDataCatch[t]=e,n&&n(),EventProxy.trigger("fetchPhotoData"))})},calculateBoxSize=function(e,t){var n=winWidth-17-80,r=winHeight,i=r,s=n>=CONTAINER_MAX_WIDTH?CONTAINER_MAX_WIDTH:n>=CONTAINER_MIN_WIDTH?n:CONTAINER_MIN_WIDTH,o=r>=CONTAINER_MIN_HEIGHT?r:CONTAINER_MIN_HEIGHT,u=caculateImgWH(s,o-TOOLBAR_HEIGHT-15,e,t),a=u.width,f=u.height,l=a<=MAIN_MIN_WIDTH?MAIN_MIN_WIDTH:a,c=f<=o-15?o-15:f,h=l+SIDEBAR_WIDTH,p=c-TOOLBAR_HEIGHT,d=c,v=a/e;return{layerHeight:i,containerWidth:h,mainWidth:l,mainHeight:c,imgWidth:a,imgHeight:f,imgContainerHeight:p,sidebarMinHeight:d,scale:v,circleScale:(e>720?e/720:1)*v}},caculateImgWH=function(e,t,n,r){var i,s;return e-=SIDEBAR_WIDTH,e>=n?t>=r?(i=n,s=r):(s=t,i=s/r*n):t>=r?(i=e,s=i/n*r):(i=e/n>=t/r?t/r*n:e,s=i/n*r),{width:Math.round(i),height:Math.round(s)}},photoViewerClickHandler=function(e){var e=window.event||e,t=e.srcElement||e.target,n=t.getAttribute("layer-cmd");if(n)switch(n){case"close":close();break;case"prev":flip("prev");break;case"next":flip("next");break;case"left":rotate.start("left");break;case"right":rotate.start("right");break;case"comment":submitComment();break;case"moreComments":loadMoreComments();break;case"deleteComment":var r=t.getAttribute("data-id"),i=t.getAttribute("data-type");deleteComment(r,i);break;case"commentCool":commentCool(t);break;case"fullScreen":fullScreen();break;case"navagator":photoViewerIsLock||imgContainerNavigator(e);break;case"cover":setCover();break;case"avatar":setAvatar();break;case"delete":deletePhoto();break;case"transform":transform();break;case"cool":cool(t);break;case"editDescOk":editPhotoDescOk();break;case"editDescCancel":editPhotoDescCancel();break;case"circleComment":$("#photoViewerLoading").css("display")==="none"?circleComment(t):XN.Do.showMessage("图片加载完成之前不能圈亮点额~"),circleCommentGuidClose();break;case"reply":commentReply(t);break;case"circleUnsignedFace":$(t).hide();var r=t.getAttribute("data-id");circleUnsignedFace(r);break;case"circleFace":circleFace(),log("1008");break;case"circleCancel":destroyCircle();break;case"submitCircleComment":submitCircleComment();break;case"deleteWiths":var r=t.getAttribute("data-id");deleteWiths(r),XN.event.stop(e);break;case"deleteCircle":var r=t.getAttribute("data-id");deleteCircle(r),XN.event.stop(e);break;case"share":$(t).hasClass("photoViewerShareBtn")?log("1011"):log("1012");break;case"closeCircleGuid":circleCommentGuidClose();break;case"commentFocus":$("#photoViewCommentEnterTextarea").focus();break;case"loadOnceComment":loadMoreComments.beginPos===5&&loadMoreComments(),$("#photoViewCommentEnterTextarea").focus()}},layerScrollEventHandler=function(){var e=this;layerScrollTimer&&clearTimeout(layerScrollTimer),layerScrollTimer=setTimeout(function(){layerScrollTop=$(e).scrollTop()},100)},imgContainerMouserLeaveHandler=function(){mouseMoveCircleShowTimer&&clearTimeout(mouseMoveCircleShowTimer),circleType!=="face"&&$(".PVCI, .PVCCI").hide()},baseFrameViewInit=function(e,t,n){$("html").addClass("photoLayerActive");var r=boxSize=calculateBoxSize(t,n);r.src=e,$("body").append(tmpl(template.layout,r)),loadMoreComments.beginPos=5,boxSize.imgWidth<110||boxSize.imgHeight<150?$("#photoTopRightPos").css({right:"5px",top:"5px"}):$("#photoTopRightPos").css({right:(boxSize.mainWidth-boxSize.imgWidth)/2+5+"px",top:(boxSize.imgContainerHeight-boxSize.imgHeight)/2+5+"px"}),$("#pViewerMainCool").css("top",(boxSize.imgContainerHeight-boxSize.imgHeight)/2+boxSize.imgHeight-40+"px"),boxSize.scale<=.5&&$("#WHInfo").show(),$("#photoViewer").bind("click",photoViewerClickHandler),$(document).bind("keyup",keyupHandler),circleSuggestClickEventInit(),isIE||$(window).bind("resize",resizeHandler),$("#photoViewerImgContainer").bind("mouseleave",imgContainerMouserLeaveHandler),$("#photoViewerLayer").bind("scroll",layerScrollEventHandler),EventProxy.trigger("baseFrameViewInit")},openViewerLayer=function(e,t,n){if(!arguments.length)var r=currentPhoto,e=r.large,t=r.largeWidth,n=r.largeHeight;t===0||n===0||t>1024?loadImg(e,function(t){baseFrameViewInit(e,t.width,t.height)}):baseFrameViewInit(e,t,n)},keyupHandler=function(e){var t=(e||window.event).keyCode||e.which;if(t===27)circling?destroyCircle():fullScreening||close(),fullScreening&&(fullScreening=!1);else if(t===37){e=window.event||e;var n=e.srcElement||e.target,r=n.tagName.toLowerCase();!photoViewerIsLock&&!fullScreening&&r!=="textarea"&&r!=="input"&&($("#photoViewerImg").removeClass("photoHalfOpacity"),$("#photoViewCommentEnterTextarea").blur(),flip("prev"))}else if(t===39){e=window.event||e;var n=e.srcElement||e.target,r=n.tagName.toLowerCase();!photoViewerIsLock&&!fullScreening&&r!=="textarea"&&r!=="input"&&($("#photoViewerImg").removeClass("photoHalfOpacity"),$("#photoViewCommentEnterTextarea").blur(),flip("next"))}},jebeViewInit=function(){try{var e=new XN.jebe.Container;XN.jebe.dispatcher({createId:XN.string.getQuery("js_url"),container:e,adInitLocation:"http://photo.renren.com/photo/"+albumData.album.owner+"/photonew-"+currentPhoto.id,noNeedPageType:!0,layerPrefix:"la"})}catch(t){}},close=function(){photosList=[],coolCache={},photoRelatedDataCatch={},recommentPhotoIsShow=!1,circling&&destroyCircle();if(typeof currentPhoto.photoVoice=="object"){var e=$("#photoViewer .vocal-player")[0].player;e&&e.reset()}$("#photoViewerLayer").unbind("scroll",layerScrollEventHandler),$("#photoViewerImgContainer").unbind("mouseleave",imgContainerMouserLeaveHandler).unbind("mousemove",mouseMoveOnPhotoContainerHandler),$("#photoViewer").unbind("click",photoViewerClickHandler).remove(),$("html").removeClass("photoLayerActive"),$(document).unbind("keyup",keyupHandler),isIE||$(window).unbind("resize",resizeHandler)},imgContainerNavigator=function(e){if(albumData.list.length>1){var e=window.event||e,t=e.pageX||e.clientX,n=$("#photoViewerImgContainer").offset().left;t-n>=boxSize.mainWidth/2?flip("next"):flip("prev")}},mouseMoveEventInit=function(){$("#photoViewerImgContainer").bind("mousemove",mouseMoveOnPhotoContainerHandler)},preloadImg=function(){var e=albumData.photoNum,t=e-currentPhoto.position;for(var n=1;n<=PRELOAD_COUNT;n++){var r=photosList[t+n];r&&loadImg(r.large)}for(var n=-1;n>=-PRELOAD_COUNT;n--){var r=photosList[t+n];r&&loadImg(r.large)}},loadImg=function(e,t){var n=document.createElement("img");n.src=e;if(t){loadImg.srcCache.push(e);if(n.complete&&e===loadImg.srcCache[loadImg.srcCache.length-1]){loadingTimer&&clearTimeout(loadingTimer),$("#photoViewerLoading").hide(),t(n);return}n.onload=function(){n.onload=null,this.src===loadImg.srcCache[loadImg.srcCache.length-1]&&(loadingTimer&&clearTimeout(loadingTimer),$("#photoViewerLoading").hide(),t(this))}}n.onerror=function(){this.src===loadImg.srcCache[loadImg.srcCache.length-1]&&(loadingTimer&&clearTimeout(loadingTimer),$("#photoViewerLoading").hide(),$("#photoViewerImg").attr({src:"http://a.xnimg.cn/img/no-image.png"}).css({width:"550px",height:"300px"})),n.onerror=null}};loadImg.srcCache=[];var coolAreaLeaved=!1,sidebarTopViewInit=function(){var e=albumData.currentPhoto,t={guest:albumData.guest,owner:albumData.owner,owner_tinyFullUrl:albumData.owner_tinyFullUrl,currentPhoto:{date:e.date,title:e.title.replace(/\s+namecard\s?=\s?[\'\"]\d+[\'\"]/g,""),viewCount:num2uinitZH(e.viewCount),shareCount:e.shareCount,photoControl:e.photoControl,albumControl:e.albumControl}},n=$("#photoViewerSidebarTop");n.html(tmpl(template.photoViewerInfo,t));var r=$("#photoViewerDescTextarea");r.length&&window.Mention.init([{obj:r[0],scrollable:!0,ownerId:albumData.album.owner,ugcId:currentPhoto.id,ugcType:"photo",limit:5,recentLimit:5}]),$("#photoViewerDescEditWraper #photoViewerDesc").click(function(e){editPhotoDesc(),XN.event.stop(e)}),updateShare(),jebeViewInit(),EventProxy.trigger("sidebarTopViewInit")},toolbarViewInit=function(){var e=currentPhoto,t=albumData.album.name;$("#photoViewerToolbar").append(tmpl(template.toolbar,{index:albumData.photoNum-e.position+1,name:t.length>15?t.slice(0,12)+"...":t,showTitle:t.length>15?!0:!1,title:t,count:albumData.photoNum,ownerId:albumData.album.owner,canTag:albumData.canTag,albumId:albumData.album.id,type:albumData.album.type,shareCount:e.shareCount})),albumData.album.type===1&&avatarAlbumPermission(),$("#photoViewerActMenu").hover(function(){(!exifViewInit.pid||exifViewInit.pid!==currentPhoto.id)&&exifViewInit(),circling||($("#photoViewerActDropMenu").show(),isIE&&$("#photoViewerToolbar").css("z-index","3"))},function(){circling||($("#photoViewerActDropMenu").hide(),isIE&&$("#photoViewerToolbar").css("z-index",""))}),$("#pViewerCircle").mouseenter(function(){if(circling)return;isIE&&$("#photoViewerToolbar").css("z-index","3"),$(".circleWhoTips").hide(),$(".PVCI").show()}),$("#pViewerCircle").mouseleave(function(){isIE&&$("#photoViewerToolbar").css("z-index","");if(circling)return;$(".PVCI").hide()}),updateCoolCountView(),updateShare(),e.photoVoice&&updateVoiceView(),albumData.photoNum===1&&$("#photoViewerImgContainer").addClass("photoOnly"),EventProxy.trigger("toolbarViewInit")},exifViewInit=function(){var e=currentPhoto.id,t=photoRelatedDataCatch[e].exif;if(t)$("#photoViewerExifWrapper").html(template.exif.replace("{{--exifContent--}}",t)),exifViewInit.pid===e;else{var n="http://photo.renren.com/photo/"+albumData.album.owner+"/photo-"+currentPhoto.id+"/exif";$.get(n,function(t){photoRelatedDataCatch[e].exif=t,exifViewInit.pid===e,$("#photoViewerExifWrapper").html(template.exif.replace("{{--exifContent--}}",t))})}},commentsListViewInit=function(){var e=photoRelatedDataCatch[currentPhoto.id],t=e.comments,n=e.commentCount;$("#photoViewerCommentCount").text(n+""),n>0?($("#photoViewerCommentBox").removeClass("PVCommentUnfold"),unfoldAlways=!1):($("#photoViewerCommentBox").addClass("PVCommentUnfold"),unfoldAlways=!0),$("#photoViewerComments").html(tmpl(template.comments,{comments:t,commentCount:n}));var r=$("#photoViewerSidebarTop"),i=r[0].scrollHeight;r[0].style.cssText=(i>=450?"overflow-y:scroll;":"")+"visibility:visible;",r[0].scrollTop=0,EventProxy.trigger("commentsListViewInit")},commentBoxViewInit=function(){var e=placeholderSupport?"":"我也说两句...";$("#photoViewerCommentBox").append(tmpl(template.commentBox,{guest_tinyFullUrl:albumData.guest_tinyFullUrl})),XN.ui.emoticons?XN.ui.emoticons({input:$("#photoViewCommentEnterTextarea")[0],button:$("#photoViewerCommentEmotion")[0],keepShow:!1,btnAlignType:"4-1",atBtn:$("#photoViewerCommentAt")[0],onShowEmoPop:function(){var e=$(this.emotionsContainer.frame),t=$("#photoViewCommentEnterTextarea").offset().top,n=Math.max(document.body.scrollTop,document.documentElement.scrollTop);t-n>boxSize.sidebarMinHeight-200?e.css("top",t-200+"px"):e.css("top",t+40+"px")}},!0):XN.loadFiles(["http://s.xnimg.cn/jspro/xn.ui.emoticons.js","http://s.xnimg.cn/csspro/module/minieditor.css"],function(){XN.ui.emoticons({input:$("#photoViewCommentEnterTextarea")[0],button:$("#photoViewerCommentEmotion")[0],keepShow:!1,btnAlignType:"4-1",atBtn:$("#photoViewerCommentAt")[0],onShowEmoPop:function(){var e=$(this.emotionsContainer.frame),t=$("#photoViewCommentEnterTextarea").offset().top;t-$("body").scrollTop()<boxSize.sidebarMinHeight-200?e.css("top",t-200+"px"):e.css("top",t+40+"px")}},!0)}),$("#photoViewCommentEnterTextarea").focus(function(){$("#photoViewerCommentBox").addClass("PVCommentUnfold")}),object.use("xn/mentionMain",function(e){e.Mention.init({obj:$("#photoViewCommentEnterTextarea")[0],button:$("#photoViewerCommentAt")[0],scrollable:!0,ownerId:albumData.album.owner,ugcId:currentPhoto.id,ugcType:"photo",limit:5,recentLimit:5})}),$("#photoViewerComments").delegate(".CC","mouseenter",function(){if(circling)return;var e=$(this).attr("circle-id");if($("#circleCommentHoverShow").attr("data-id")===e)$("#photoViewerImgContainer").css("z-index","3"),$("#circleCommentHoverShow").show();else{$("#photoViewerImgContainer").css("z-index",""),$("#circleCommentHoverShow").remove();var t=getCircleById(e),n=(boxSize.mainWidth-boxSize.imgWidth)/2,r=(boxSize.imgContainerHeight-boxSize.imgHeight)/2,i=boxSize.circleScale,s=Math.round(t.frameWidth*i),o=Math.round(t.frameHeight*i),u=Math.round(t.leftToPhoto*i),a=t.topToPhoto*i,f=$(tmpl(template.circleCommentHoverView,{width:s-4,height:o-4,left:n+u,top:r+a,id:t.id,src:currentPhoto.large,imgWidth:boxSize.imgWidth,imgHeight:boxSize.imgHeight,imgLeft:u,imgTop:a,tipsLeft:t.tips.left,tipsTop:t.tips.top,tipsWidth:t.tips.width,body:t.body,name:t.name})).appendTo($("#photoViewerImgContainer")).show()}$("#photoViewerImg").addClass("photoHalfOpacity")}),$("#photoViewerComments").delegate(".CC","mouseleave",function(){if(circling)return;$("#photoViewerImgContainer").css("z-index",""),$("#circleCommentHoverShow").hide(),$("#photoViewerImg").removeClass("photoHalfOpacity")}),$("#photoViewerWith").delegate(".withItem","mouseenter",function(){if(circling)return;$("#circle"+$(this).attr("data-id")).show()}),$("#photoViewerWith").delegate(".withItem","mouseleave",function(){if(circling)return;$("#circle"+$(this).attr("data-id")).hide()}),placeholderSupport||$("#photoViewCommentEnterTextarea").click(function(e){this.value==="我也说两句..."&&(this.value=""),XN.event.stop(e)}),EventProxy.trigger("commentBoxViewInit")},foldCommentBox=function(){var e=placeholderSupport?"":"我也说两句...",t=$("#photoViewCommentEnterTextarea");if(!t.length)return;var n=t.val().replace(/^\s+|\s+$/g,"");n===e&&unfoldAlways!==!0&&$("#photoViewerCommentBox").removeClass("PVCommentUnfold")},getCircleById=function(e){var t=photoRelatedDataCatch[currentPhoto.id].commentTags;for(var n=0,r=t.length;n<r;n++)if(t[n].id==e)return t[n]},updateWithsView=function(){var e=photoRelatedDataCatch[currentPhoto.id],t=e.tags,n=e.withs;if(t.length||n.length){var r=$("#photoViewerDesc"),i=r.length&&r.text()!==""?!0:!1;$("#photoViewerWith").html(tmpl(template.withs,{tags:t,withs:n,ownerId:albumData.album.owner,hasDesc:i}))}else $("#photoViewerWith").html("")},commentReply=function(e){var t=$("#photoViewCommentEnterTextarea"),n=t.val(),r=e.getAttribute("data-author"),i=e.getAttribute("data-name"),s="回复"+i+"：";n!==""&&n!=="我也说两句..."&&((new RegExp("^"+s)).test(n)||(n=n.replace(/.+?：/,""),s+=n)),$(e).attr("data-whisper")==="true"?($("#whisperForTheatre").attr("checked",!0),t.attr("data-whisper","true")):($("#whisperForTheatre").attr("checked",!1),t.attr("data-whisper","false")),t.val(s),t.attr("to-id",r),t=t[0];if(t.createTextRange){var o=t.createTextRange();o.text=t.value,o.select(),o.collapse(!1)}else window.getSelection?(t.select(),window.getSelection().collapseToEnd()):t.focus()},clearCommentData=function(){$("#photoViewCommentEnterTextarea").val("").attr("to-id","")},submitComment=function(){var e=XN.string.trim($("#photoViewCommentEnterTextarea").val()).replace(/[\r\t\n]/g,""),t=placeholderSupport?"":"我也说两句...";if(e.length>500)XN.DO.showError("回复字数不能超过500字","提示");else if(e!==t&&e!==""){var n=albumData.album.id,r=albumData.album.owner,i=currentPhoto.id,s=albumData.guest.userName.name,o=PHOTO_ROOT_URL+"/"+r+"/photo-"+i+"/commentmsy",u={body:e+" ",to:$("#photoViewCommentEnterTextarea").attr("to-id")||0,id:i,newLayer:!0,owner:r,feedComment:!0,psource:3,state:0,guestName:s,realWhisper:""};if($("#whisperForTheatre").attr("checked")||$("#photoViewCommentEnterTextarea").attr("data-whisper")==="true")u.only_to_me=!0;$.post(o,u,function(e){var n=e.responseText;if(/^af:/.test(n)){XN.DO.showError(n.substring(3));return}$("#photoViewCommentEnterTextarea").attr("to-id",""),e=JSON.parse(n);if(e.code===0){$("#whisperForTheatre").attr("checked",!1);var r=photoRelatedDataCatch[currentPhoto.id];r.comments=[e].concat(r.comments),r.commentCount+=1,e.body=e.body.replace(/\s+namecard\s?=\s?[\'\"]\d+[\'\"]/g,""),$("#photoViewCommentEnterTextarea").val(t);var i=$("#photoViewerCommentsList");if(i.length){i.append(tmpl(template.moreComments,{comments:[e]}));var s=$("#photoViewerCommentCount"),o=parseInt(s.text(),10);o+=1,s.text(""+o)}else $("#photoViewerComments").html(tmpl(template.comments,{comments:[e],commentCount:1})),$("#photoViewerCommentCount").text("1");var u=$("#photoViewerSidebarTop");height=u[0].scrollHeight,height>450&&(u.css({"overflow-y":"scroll"}),u[0].scrollTop=height-u.height())}})}else $("#photoViewCommentEnterTextarea").focus()},submitCircleComment=function(){var e=XN.string.trim($("#circleCommentTextarea").val()).replace(/[\r\t\n]/g,""),t=placeholderSupport?"":"移动至亮点区域并评论~";if(e.length>50)XN.DO.showError("圈亮点字数不能超过50字","提示");else if(e!==""&&e!==t){var n=dragInstance.dragData,r=(boxSize.mainWidth-boxSize.imgWidth)/2,i=(boxSize.imgContainerHeight-boxSize.imgHeight)/2,s=4,o=albumData.album.id,u=albumData.album.owner,a=currentPhoto.id,f=albumData.guest.userName.name,l=PHOTO_ROOT_URL+"/"+u+"/photo-"+a+"/commentmsy",c={body:e+" ",to:$("#photoViewCommentEnterTextarea").attr("to-id")||0,id:a,owner:u,feedComment:!0,guestName:f,realWhisper:""},h=boxSize.circleScale;c["commentTag.topDis"]=Math.round(n.top/h),c["commentTag.leftDis"]=Math.round(n.left/h),c["commentTag.frameWidth"]=Math.round(n.width/h),c["commentTag.frameHeight"]=Math.round(n.height/h),$.post(l,c,function(e){var t=e.responseText;if(/^af:/.test(t)){XN.DO.showError(t.substring(3));return}e=JSON.parse(t);if(e.code===0){var o=photoRelatedDataCatch[currentPhoto.id];o.comments=[e].concat(o.comments),o.commentCount+=1,e.body=e.body.replace(/\s+namecard\s?=\s?[\'\"]\d+[\'\"]/g,""),$("#circleCommentTextarea").val(""),$("#circleThePhoto").data("state","init");var u=n.width,a=n.height,f=r+n.left,l=i+n.top,c=$(tmpl(template.circleView.comment,{id:e.id,width:u-s,height:a-s,body:e.body,name:e.name})).appendTo($("#photoViewerImgContainer")),h=c.find(".circleCommentTips"),p=h.width(),p=p>240?240:p<80?80:p;h.css({width:p+"px","white-space":"normal"});var d=h.height(),v=(u-p)/2;c.hide().css({left:f+"px",top:l+"px"});if(l+a+d+10>boxSize.mainHeight){var m=-(d+10);h.find(".photoViewerCircleTrig").removeClass("photoViewerCircleTrig").addClass("photoViewerCircleTrigB")}else var m=a+10;h.css({left:v+"px",top:m+"px"});var g={frameHeight:a/boxSize.circleScale,frameWidth:u/boxSize.circleScale,id:e.id,body:e.body,name:e.name,leftToPhoto:n.left/boxSize.circleScale,topToPhoto:n.top/boxSize.circleScale,tips:{left:v,top:m,width:p}};o.commentTags=o.commentTags||[],o.commentTags.push(g),e.tagComment=!0;var y=$("#photoViewerCommentsList");if(y.length){y.append(tmpl(template.moreComments,{comments:[e]}));var b=$("#photoViewerCommentCount"),w=parseInt(b.text(),10);w+=1,b.text(""+w)}else $("#photoViewerComments").html(tmpl(template.comments,{comments:[e],commentCount:1})),$("#photoViewerCommentCount").text("1");var E=$("#photoViewerSidebarTop"),a=E[0].scrollHeight;a>450&&$("#photoViewerSidebarTop").css({"overflow-y":"scroll"})}}),destroyCircle()}},deleteComment=function(e,t){var n=albumData.album.id,r=albumData.album.owner,i=currentPhoto.id,s=PHOTO_ROOT_URL+"/"+r+"/photo-"+i+"/comment/"+e+"/delete";XN.DO.confirm({title:"删除评论",msg:"确定删除这条评论吗？",callBack:function(n){n&&$.post(s,function(n){n=JSON.parse(n.responseText);if(n.code==0){$("#photoViewerCommentsList li").length===1?$("#photoViewerComments").html(""):$("#photoViewerComment-"+e).remove(),deleteCommentCache(e),t==="circleComment"&&($("#circle"+e).remove(),deleteCommentCircleCache(e));var r=$("#photoViewerCommentCount"),i=parseInt(r.text(),10);i-=1,r.text(""+i)}else XN.Do.showError(n.msg)})}})},deleteCommentCache=function(e){var t=photoRelatedDataCatch[currentPhoto.id],n=t.comments;for(var r=0,i=n.length;r<i;r++)if(n[r].id==e){n.splice(r,1),t.commentCount-=1;return}},deleteCommentCircleCache=function(e){var t=photoRelatedDataCatch[currentPhoto.id],n=t.commentTags;for(var r=0,i=n.length;r<i;r++)if(n[r].id==e){n.splice(r,1);return}},loadMoreComments=function(){if(photoRelatedDataCatch[currentPhoto.id].commentCount<=5)return;var e="http://photo.renren.com/photo/"+albumData.album.owner+"/photo-"+currentPhoto.id+"/comment/offset?begin="+loadMoreComments.beginPos;loadMoreComments.beginPos+=30,$.get(e,function(e){e=JSON.parse(e);if(e.code==0){$("#photoViewerAD").hide(),$("#photoViewerCommentBox").addClass("PVCommentUnfold"),unfoldAlways=!0,disableNamecard(e.comments),$(tmpl(template.moreComments,e)).insertBefore($("#photoViewerCommentsList li")[0]);var t=$("#photoViewerSidebarTop"),n=t[0].scrollHeight;n>boxSize.mainHeight-110?$("#photoViewerSidebarTop").css({"max-height":boxSize.mainHeight-106+"px","overflow-y":"scroll"}):$("#photoViewerSidebarTop").css({"max-height":n-6+"px",overflow:"hidden"}),e.hasMore?$("#remainCommentCount").text(photoRelatedDataCatch[currentPhoto.id].commentCount-loadMoreComments.beginPos+""):$("#photoViewerMoreCommentWrapper").remove();var r=$("#photoViewCommentEnterTextarea")[0].mention;r&&(r.selector.menu.menu.alignType="4-4",r.selector.menu.menu.offsetY=-20)}else XN.Do.showError(e.msg)})};loadMoreComments.beginPos=5;var commentCool=function(obj){var commentId=obj.getAttribute("data-id"),name=obj.getAttribute("data-name"),commentOwner=obj.getAttribute("data-owner"),isCooled=obj.getAttribute("data-cooled");if(isCooled=="0")var url="http://like.renren.com/comment/addlike?resource="+currentPhoto.id+"&uid="+XN.user.id+"&owner="+commentOwner+"&resourceownerid="+albumData.album.owner+"&type=8&name="+name+"&gid=photocomment_"+commentId;else if(isCooled=="1")var url="http://like.renren.com/comment/removelike?resource="+currentPhoto.id+"&uid="+XN.user.id+"&owner="+commentOwner+"&resourceownerid="+albumData.album.owner+"&type=8&name="+name+"&gid=photocomment_"+commentId;$.get(url,function(ret){ret=eval("("+ret+")"),ret.code==0?ret.ownerLike?(obj.innerHTML="取消赞",obj.setAttribute("data-cooled","1")):(obj.innerHTML="赞",obj.setAttribute("data-cooled","0")):XN.Do.showError(ret.msg)}),obj.id==="photoViewerCoolBtn"?log("1009"):log("1013")},updateVoiceView=function(){if(boxSize.imgWidth>=210)var e=(boxSize.mainWidth-boxSize.imgWidth)/2,t=(boxSize.imgContainerHeight-boxSize.imgHeight)/2;else var e=5,t=5;$("#photoViewerVoice").html(tmpl(template.voice,currentPhoto.photoVoice)).css({right:e+"px",bottom:t+"px"})},loadingTimer=null,updatePhotoView=function(e){rotate.reset(),loadingTimer=setTimeout(function(){$("#photoViewerLoading").show()},200);var t=e.largeWidth,n=e.largeHeight;if(t===0||n===0||t>1024)loadImg(e.large,function(n){var r=calculateBoxSize(n.width,n.height);r.containerWidth>boxSize.containerWidth&&($("#photoViewerLayerWrapper").width(r.containerWidth),$("#photoViewerLayerContainer").width(r.containerWidth),$("#photoViewerMain").width(r.mainWidth),boxSize.containerWidth=r.containerWidth,boxSize.mainWidth=r.mainWidth),$("#photoViewerImg").attr({src:e.large}),$("#photoViewerImg").width(r.imgWidth).height(r.imgHeight),currentPhoto.largeHeight=n.height,currentPhoto.largeWidth=n.width,boxSize.imgWidth=r.imgWidth,boxSize.imgHeight=r.imgHeight,boxSize.scale=r.imgWidth/n.width,boxSize.circleScale=(t>720?t/720:1)*boxSize.scale,boxSize.scale<=.5&&$("#WHInfo").show(),boxSize.imgWidth<110?$("#photoTopRightPos").css({right:"5px",top:"5px"}):$("#photoTopRightPos").css({right:(boxSize.mainWidth-boxSize.imgWidth)/2+5+"px",top:(boxSize.imgContainerHeight-boxSize.imgHeight)/2+5+"px"}),$("#pViewerMainCool").css("top",(boxSize.imgContainerHeight-boxSize.imgHeight)/2+boxSize.imgHeight-40+"px")});else{var r=calculateBoxSize(t,n);r.containerWidth>boxSize.containerWidth&&($("#photoViewerLayerWrapper").width(r.containerWidth),$("#photoViewerLayerContainer").width(r.containerWidth),$("#photoViewerMain").width(r.mainWidth),boxSize.containerWidth=r.containerWidth,boxSize.mainWidth=r.mainWidth),boxSize.imgWidth=r.imgWidth,boxSize.imgHeight=r.imgHeight,boxSize.scale=r.imgWidth/t,boxSize.circleScale=(t>720?t/720:1)*boxSize.scale,loadImg(e.large,function(){$("#photoViewerImg").attr({src:e.large}),$("#photoViewerImg").width(r.imgWidth).height(r.imgHeight),boxSize.imgWidth<110?$("#photoTopRightPos").css({right:"5px",top:"5px"}):$("#photoTopRightPos").css({right:(boxSize.mainWidth-boxSize.imgWidth)/2+5+"px",top:(boxSize.imgContainerHeight-boxSize.imgHeight)/2+5+"px"}),$("#pViewerMainCool").css("top",(boxSize.imgContainerHeight-boxSize.imgHeight)/2+boxSize.imgHeight-40+"px")}),boxSize.scale<=.5&&$("#WHInfo").show()}e.photoVoice&&updateVoiceView(),$("#photoViewerAD").show(),currentPhoto.coolListViewIsInit=!1,$.get("http://photo.renren.com/photo/pv/addPv?photo="+currentPhoto.id+"&owner="+albumData.album.owner+"&album="+albumData.album.id+"&type=48")},updatePhotoIndexView=function(e){$("#photoViewerIndex").html(e+1)},updatePhotoDate=function(){$("#photoUploadDate").text(currentPhoto.date)},updatePhotoDesc=function(){var e=XN.string.trim(currentPhoto.title.replace(/\s+namecard\s?=\s?[\'\"]\d+[\'\"]/g,""));e===""&&XN.user.id==albumData.album.owner&&(e="单击此处添加描述"),$("#photoViewerDesc").html(e)},updateLocView=function(){var e=photoRelatedDataCatch[currentPhoto.id].lbs;e.name?$("#photoViewerLocation").html(tmpl(template.location,e)):$("#photoViewerLocation").html("")},updateSidebarTopView=function(){$("#cooledList").html(""),updatePhotoDesc(),updatePhotoDate(),fetchPhotoData(albumData.album.owner,currentPhoto.id,function(){updateWithsView(),imgSubjectMessages(),updateLocView(),commentsListViewInit(),circleViewInit(),updateToolbarActionView()})},updateHash=function(){},updateView=function(){loadMoreComments.beginPos=5,unfoldAlways=!1,editPhotoDesc.instance&&editPhotoDescCancel();if(unfoldAlways){var e=$("#photoViewCommentEnterTextarea")[0].mention;e&&(e.selector.menu.menu.alignType="4-1",e.selector.menu.menu.offsetY=0)}$("#WHInfo").hide(),albumData.album.type===1&&avatarAlbumPermission(),updatePhotoView(currentPhoto),updateHash(),updatePhotoIndexView(albumData.photoNum-currentPhoto.position),updateSidebarTopView(),updateCoolCountView(),updateViewCount(),updateShare()},flip=function(e){if(!photoViewerIsLock&&albumData.photoNum>1){var t=e==="prev"?prev:e==="next"?next:function(){},n=$("#photoViewCommentEnterTextarea"),r=XN.string.trim(n.val()).replace(/[\r\t\n]/g,""),i=placeholderSupport?"":"我也说两句...";albumData.is_new_layer===0&&circleCommentGuidClose();if(r!==i&&r!==""){XN.Do.confirm("是否放弃本次评论","提示",function(e){if(e){n.val(i);if(currentPhoto.photoVoice){var r=$("#photoViewer .vocal-player")[0].player;r&&r.reset()}t()}});return}if(currentPhoto.photoVoice){var s=$("#photoViewer .vocal-player")[0].player;s&&s.reset()}t()}},next=function(){var e=albumData.photoNum,t=e-currentPhoto.position+1,t=t>=e?0:t;if(t===0&&XN.user.id!=albumData.album.owner&&!recommentPhotoIsShow){showRecommendPhoto();return}e-t>PRELOAD_COUNT&&photosList[t+PRELOAD_COUNT+1]&&loadImg(photosList[t+PRELOAD_COUNT+1].large),photosList[t]?(e>60&&!photosList[t+PRELOAD_COUNT]&&fetchMorePhotoList(albumData.album.owner,currentPhoto.id,t,1),currentPhoto=photosList[t],updateView()):fetchMorePhotoList(albumData.album.owner,currentPhoto.id,t,1,function(){currentPhoto=photosList[t],updateView()})},prev=function(){var e=albumData.photoNum,t=e-currentPhoto.position-1,t=t<0?e-1:t;t>PRELOAD_COUNT&&photosList[t-PRELOAD_COUNT-1]&&loadImg(photosList[t-PRELOAD_COUNT-1].large),photosList[t]?(e>60&&!photosList[t-PRELOAD_COUNT]&&fetchMorePhotoList(albumData.album.owner,currentPhoto.id,t,-1),currentPhoto=photosList[t],updateView()):fetchMorePhotoList(albumData.album.owner,currentPhoto.id,t,-1,function(){currentPhoto=photosList[t],updateView()})},rotate={degree:0,support:function(){var e=document.createElement("div"),t=e.style,n="filter",r=["transform","MozTransform","webkitTransform","OTransform","filters"];for(var i=0,s=r.length;i<s;i++)if(r[i]in t)return r[i];if("filters"in e)return n}(),start:function(e){var t=e=="left"?-90:90;XN.user.id==albumData.album.owner?this.severRotate(t):this.clientRotate(t)},clientRotate:function(e){this.degree+=e;if(this.degree>=0)var t=Math.PI*this.degree/180;else var t=Math.PI*(360+this.degree)/180;if(this.degree%90===0&&this.degree%180!==0){var n=boxSize.mainWidth/boxSize.imgHeight;n=n>1?1:n}else n=1;var r=this.support;if(r==="filter"){var i=Math.cos(t)*n,s=-1*Math.sin(t)*n,o=-s*n,u=i;$("#photoViewerImg")[0].style.filter="progid:DXImageTransform.Microsoft.Matrix(M11="+i+",M12="+s+",M21="+o+",M22="+u+',SizingMethod="auto expand")'}else{var a=Math.round(Math.cos(t)*1e3)/1e3*n,f=Math.round(Math.sin(t)*1e3)/1e3*n,l=[a.toFixed(20),f.toFixed(20),-f.toFixed(20),a.toFixed(20)].join(",");$("#photoViewerImg")[0].style[r]="matrix("+l+", 0, 0)"}},severRotate:function(e){var t="http://photo.renren.com/photo/"+albumData.album.owner+"/photo-"+currentPhoto.id+"/rotate";$.post(t,{angle:e,psource:13},function(e){e=JSON.parse(e.responseText);if(e.code==0){var t=e.files[0].images;t=t[t.length-1];var n=photosList[albumData.photoNum-currentPhoto.position];n.large=t.url,n.largeWidth=t.width,n.largeHeight=t.height,updatePhotoView(n),currentPhoto=n}else XN.Do.showError(e.msg)})},reset:function(){rotate.degree!==0&&(this.degree=0,$("#photoViewerImg")[0].style[this.support]="")}},setCover=function(){XN.Do.confirm({title:"设为封面",msg:"设置此照片为相册封面？",modal:!0,callback:function(e){if(e){var t=albumData.album.owner,n=currentPhoto.id,r="http://photo.renren.com/photo/"+t+"/photo-"+
n+"/setcover";$.post(r,{photo:n},function(e){e=JSON.parse(e.responseText),e.code!=0&&XN.Do.showError("设为封面出了点小问题，稍后再来试试哦~")})}this.remove()},yes:"是",no:"取消"})},setAvatar=function(){XN.Do.confirm({title:"请您上传真实的照片",msg:"人人网是一个真实的网络，请使用您本人的照片，其他图片请不要设为头像。确认是您本人照片吗？",width:465,callback:function(e){if(e){if(albumData.album.type===1){window.location="http://www.renren.com/setphotoprofile.do?id="+currentPhoto.id;return}$.get("http://head.upload.renren.com/profile/AjaxCertificate.do",function(e){e=JSON.parse(e),$.post("http://head2.upload.renren.com/head2/Photo2Head.do",{url:currentPhoto.large,hostid:e.hostid,tsc:e.tsc},function(e){e=JSON.parse(e.responseText),XN.Do.showMessage(e.msg)})})}else this.remove()}})},avatarAlbumPermission=function(){currentPhoto.headUrl2===albumData.album.headurl?($("#photoViewerActAvatar").hide(),$("#photoViewerActDelete").hide()):($("#photoViewerActAvatar").show(),$("#photoViewerActDelete").show())},deletePhoto=function(){var e=albumData.album.owner,t=currentPhoto.id,n="http://photo.renren.com/photo/"+e+"/photo-"+t+"/delete";$.get(n,{photo:t},function(e){var t=e,r=(new XN.ui.dialog({title:"删除？",body:t,modal:!0})).addButton({text:"确定",onclick:function(){this.preventHide(),doDeletePhoto(n,r)}}).addButton({text:"取消",onclick:function(){r.remove(),r=null}});$("#pvDelPhotoForm").append('<input style="display:none;">');var i=$("#photoInfoCode");i.focus(),i[0].onkeydown=function(e){var e=e||window.event;e.keyCode==13&&doDeletePhoto(n,r)}})},doDeletePhoto=function(e,t){$.post(e,{photoInfoCode:$("#photoInfoCode").val()},function(e){e=JSON.parse(e.responseText),e.code==0?(updateDeletePhoto(),XN.Do.showMessage("删除成功"),t.remove(),t=null):(XN.Do.showError(e.msg),$("#photoVerifyPic")[0].src+=new Date)})},updateDeletePhoto=function(){var e=albumData.photoNum;albumData.photoNum-=1;if(albumData.photoNum==0){close();return}albumData.photoNum==1&&$("#photoViewerImgContainer").addClass("photoOnly");var t=e-currentPhoto.position;photosList.splice(t,1);for(var n=0,r=t;n<r;n++)typeof photosList[n]!="undefined"&&(photosList[n].position=photosList[n].position-1);flip("next"),$("#photoViewerTotal").html(albumData.photoNum)},updateShare=function(){var e={stype:"create_share_feed",id:currentPhoto.id,owner:currentPhoto.owner,type:"photo",mainurl:currentPhoto.mainUrl},t=document.documentMode;if(currentPhoto.albumControl==99&&currentPhoto.photoControl==99)t==7||isIE7?($(".pViewerShareBtn").attr({className:"pViewerSideActBtn pViewerShareBtn photoViewShare share_new",title:""}),$(".pViewerShare").attr({className:"pViewerShare photoViewShare share_new",title:""}),$(".pViewerBottomNum").attr({className:"pViewerBottomNum photoViewShare share_new"})):($(".pViewerShareBtn").attr({"class":"pViewerSideActBtn pViewerShareBtn photoViewShare share_new",title:""}),$(".pViewerShare").attr({"class":"pViewerShare photoViewShare share_new",title:""}),$(".pViewerBottomNum").attr({"class":"pViewerBottomNum photoViewShare share_new"}));else if(currentPhoto.albumControl!=99||currentPhoto.photoControl!=99)t==7||isIE7?($(".pViewerShareBtn").attr({title:"当前照片已设置隐私，无法被分享",className:"pViewerSideActBtn pViewerShareBtn photoViewShareAble"}),$(".pViewerShare").attr({title:"当前照片已设置隐私，无法被分享",className:"pViewerShare"}),$(".pViewerBottomNum").attr({className:"pViewerBottomNum"})):($(".pViewerShareBtn").attr({title:"当前照片已设置隐私，无法被分享","class":"pViewerSideActBtn pViewerShareBtn photoViewShareAble"}),$(".pViewerShare").attr({title:"当前照片已设置隐私，无法被分享","class":"pViewerShare"}),$(".pViewerBottomNum").attr({"class":"pViewerBottomNum"}));$(".photoViewShare").attr("data-share",XN.json.build(e)),$("#photoViewShareCount").text(""+num2uinitZH(currentPhoto.shareCount))},updateViewCount=function(){$("#photoViewCount").text(""+num2uinitZH(currentPhoto.viewCount))},transform=function(){var e="http://photo.renren.com/photo/"+albumData.album.owner+"/album/common/ajax";$.get(e,function(e){e=JSON.parse(e);if(e.code==0){var t=e.list,n=[],r='<p>转移至相册:</p><select class="photo-move-opts" id="photo-change-album">{{options}}</select>';for(var i=0,s=t.length;i<s;i++){var o=t[i];o.id!=currentPhoto.albumId&&n.push('<option title="'+o.name+'" value="'+o.id+'"'+">"+o.name+"("+o.photoCount+")</option>")}XN.Do.confirm({title:"照片转移",msg:r.replace("{{options}}",n.join("")),modal:!0,callback:function(e){if(e){var t="http://photo.renren.com/photo/"+albumData.album.owner+"/photo-"+currentPhoto.id+"/transfer";$.post(t,{toId:$("#photo-change-album").val(),sendFeed:1},function(e){e=JSON.parse(e.responseText),e.code==0?(XN.Do.showMessage("照片转移成功"),updateDeletePhoto()):XN.Do.showError(e.msg)})}this.remove()}})}else XN.Do.showError(e.msg)})},cool=function(obj){var isCooled=obj.getAttribute("data-cool");if(isCooled=="0")var url="http://like.renren.com/addlike?gid=photo_"+currentPhoto.id+"&uid="+XN.user.id+"&owner="+albumData.album.owner+"&type=2&name="+XN.user.name;else if(isCooled=="1")var url="http://like.renren.com/removelike?gid=photo_"+currentPhoto.id+"&uid="+XN.user.id+"&owner="+albumData.album.owner+"&type=2&name="+XN.user.name;url+="&t="+Math.random(),$.get(url,function(ret){ret=eval("("+ret+")");if(ret.code==0){if(isCooled=="0"){$("#pViewerSideCool").addClass("pViewerCooledBtn");var coolIco=$("#pViewerCoolIco");coolIco.addClass("pViewerCoolActive").addClass("photo-view-anim-bounceIn"),setTimeout(function(){coolIco.removeClass("photo-view-anim-bounceIn")},1e3),$(".photoViewerCool").attr("data-cool","1")}else if(isCooled=="1"){$("#pViewerSideCool").removeClass("pViewerCooledBtn"),$("#pViewerCoolIco").removeClass("pViewerCoolActive"),$(".photoViewerCool").attr("data-cool","0");var coolWrap=$("#pViewerMainCool"),value="-62px",times=0,clearId=setInterval(function(){times++,coolWrap.css("margin-left",value),value=="-62px"?value="-58px":value="-62px",times==10&&(coolWrap.css("margin-left","-60px"),clearInterval(clearId))},50)}$("#photoViewCoolCount").html(ret.likeCount),coolCache[currentPhoto.id]=ret}else XN.Do.showError(ret.msg)}),obj.id==="pViewerSideCool"?log("1009"):log("1013")},updateCoolCountView=function(){var coolData=coolCache[currentPhoto.id];if(coolData){coolData.ownerLike?($("#pViewerSideCool").addClass("pViewerCooledBtn"),$("#pViewerCoolIco").addClass("pViewerCoolActive"),$(".photoViewerCool").attr("data-cool","1")):($("#pViewerSideCool").removeClass("pViewerCooledBtn"),$("#pViewerCoolIco").removeClass("pViewerCoolActive"),$(".photoViewerCool").attr("data-cool","0")),$("#photoViewCoolCount").html(coolData.likeCount);return}var url="http://like.renren.com/showlike?gid=photo_"+currentPhoto.id+"&uid="+XN.user.id;$.get(url,function(ret){ret=eval("("+ret+")"),ret.code==0?(ret.ownerLike?($("#pViewerSideCool").addClass("pViewerCooledBtn"),$("#pViewerCoolIco").addClass("pViewerCoolActive"),$(".photoViewerCool").attr("data-cool",1)):($("#pViewerSideCool").removeClass("pViewerCooledBtn"),$("#pViewerCoolIco").removeClass("pViewerCoolActive"),$(".photoViewerCool").attr("data-cool",0)),$("#photoViewCoolCount").html(ret.likeCount),coolCache[currentPhoto.id]=ret):XN.Do.showError(ret.msg)})},editPhotoDesc=function(){var e=$("#photoViewerDescTextarea"),t=currentPhoto.originTitle;e.val(t==="单击此处添加描述"?"":t),$("#photoViewerDescEditWraper").hide(),$("#photoViewerDescEditarea").show(),editPhotoDesc.instance=!0,e=e[0];if(e.createTextRange){var n=e.createTextRange();n.text=e.value,n.select(),n.collapse(!1)}else e.focus()};editPhotoDesc.instance=!1;var editPhotoDescOk=function(){var e="http://photo.renren.com/photo/"+albumData.album.owner+"/photo-"+currentPhoto.id+"/description";$.post(e,{description:$("#photoViewerDescTextarea").val()},function(e){e=JSON.parse(e.responseText),e.code==0?($("#photoViewerDesc").html(XN.string.trim(e.titleWithAtAndLink.replace(/\s+namecard\s?=\s?[\'\"]\d+[\'\"]/g,""))||"单击此处添加描述"),$("#photoViewerDescEditarea").hide(),$("#photoViewerDescEditWraper").show(),editPhotoDesc.instance=!1,currentPhoto.title=e.titleWithAtAndLink,currentPhoto.originTitle=e.title):XN.Do.showError(e.msg)})},editPhotoDescCancel=function(){$("#photoViewerDescTextarea").val(""),$("#photoViewerDescEditarea").hide(),editPhotoDesc.instance=!1,$("#photoViewerDescEditWraper").show()},supportsFullScreen=function(){if(typeof document.cancelFullScreen!="undefined")return!0;var e=["webkit","o","ms","khtml"];for(var t=0,n=e.length;t<n;t++)if(typeof document[e[t]+"CancelFullScreen"]!="undefined")return e[t];return!1}(),fullScreen=function(){if(fullScreening)return;isIE||$(window).unbind("resize",resizeHandler);var e=window.screen.height;fullScreening=!0;var t="http://photo.renren.com/photo/"+albumData.album.owner+"/photo-"+currentPhoto.id+"/xlarge";$.get(t,function(e){e=JSON.parse(e);if(e.code==0)loadImg(e.xlargeurl,function(){$("#photoViewerFullImg").attr("src",e.xlargeurl)});else{if(e.msg==="no xlarge url"){loadImg(currentPhoto.large,function(){$("#photoViewerFullImg").attr("src",currentPhoto.large)});return}cancelFullScreen(),XN.Do.showError(e.msg)}}),$("body").append(tmpl(template.fullScreen,{height:e}));var n=$("#photoViewerFull");supportsFullScreen===!0?n[0].requestFullScreen():supportsFullScreen===!1?n.show():n[0][supportsFullScreen+"RequestFullScreen"](),n.click(function(){cancelFullScreen()})},cancelFullScreen=function(){fullScreening=!1,supportsFullScreen===!0?document.cancelFullScreen():typeof supportsFullScreen=="string"&&document[supportsFullScreen+"CancelFullScreen"](),$("#photoViewerFull").remove(),setTimeout(function(){isIE||$(window).bind("resize",resizeHandler)},500)},lockPhotoViewer=function(){photoViewerIsLock=!0},unlockPhotoViewer=function(){photoViewerIsLock=!1},updateToolbarActionView=function(){var e=photoRelatedDataCatch[currentPhoto.id];$("#photoViewCommentCount").text(e.commentCount+""),$("#photoViewCircleCount").text(e.tags.length+"")},loadCooledList=function(){var url="http://like.renren.com/showlikedetail?gid=photo_"+currentPhoto.id+"&uid="+XN.user.id,likeList=currentPhoto.coolList;if(currentPhoto.coolListLoaded&&likeList.length){var likeCount=coolCache[currentPhoto.id].likeCount;$("#cooledList").html(tmpl(template.cooledList,{likeList:currentPhoto.coolList,likeCount:likeCount})),coolAreaLeaved||$("#coolListArea").show(),currentPhoto.coolListViewIsInit=!0;return}$.get(url,function(ret){ret=eval("("+ret+")"),ret.code==0&&(currentPhoto.coolListLoaded=!0,currentPhoto.coolList=ret.likeList,ret.likeList.length&&($("#cooledList").html(tmpl(template.cooledList,{likeList:ret.likeList,likeCount:ret.likeCount})),coolAreaLeaved||$("#coolListArea").show(),currentPhoto.coolListViewIsInit=!0))})},circleFace=function(){if(circling||!albumData.canTag)return;circleType="face",$(".PVCI").hide(),$(".PVCCI").hide();var e=photoRelatedDataCatch[currentPhoto.id],t=e.untags,n=boxSize.circleScale,r=t[0];if(r){var i=Math.round(r.topToPhoto*n),s=Math.round(r.leftToPhoto*n),o=Math.round(r.frameWidth*n),u=Math.round(r.frameHeight*n);doCircle("face",s,i,o,u),$("#photoViewerCircleInput").attr({"circle-id":r.id,"circle-index":0}),$(".PVCIWho").show(),$(".PVCIWho .circleWhoTips").hide(),$("#circle"+r.id).hide()}else{var o=boxSize.imgWidth>60?60:boxSize.imgWidth,u=boxSize.imgHeight>60?60:boxSize.imgHeight,s=(boxSize.imgWidth-o)/2,i=(boxSize.imgHeight-u)/2;doCircle("face",s,i,o,u),$("#photoViewerCircleInput").removeAttr("circle-id").removeAttr("circle-index")}},circleUnsignedFace=function(e,t){$(".PVCIFace").hide();var n=findUntagsPositionByTagId(e),r=photoRelatedDataCatch[currentPhoto.id],i=r.untags,s=boxSize.circleScale,o=i[n],u=o.topToPhoto*s,a=o.leftToPhoto*s,f=o.frameWidth*s,l=o.frameHeight*s;if(circleType!=="face"){if(circling)return;circleType="unsignedFace",doCircle("face",a,u,f,l)}else circleUnsignedFace.prevCircleId=circleUnsignedFace.prevCircleId||i[0].id,t||$("#circle"+circleUnsignedFace.prevCircleId).show(),$("#circle"+e).hide(),$("#circleFriendsList").html("").hide(),dragInstance.set(a,u,f,l);circleUnsignedFace.prevCircleId=e,$("#photoViewerCircleInput").attr({"circle-id":o.id,"circle-index":n})},circleComment=function(e){if(!(circleType!=="face"&&circleType!=="unsignedFace"||!circling))return;if($("#photoViewerImg").attr("src")==="http://a.xnimg.cn/img/no-image.png"){XN.Do.showMessage("图片读取失败，不能圈亮点额~");return}var t=$(e).data("state")||"init";if(t==="init"){circleType="comment";var n=boxSize.imgWidth>120?120:boxSize.imgWidth,r=boxSize.imgHeight>120?120:boxSize.imgHeight,i=(boxSize.imgWidth-n)/2,s=(boxSize.imgHeight-r)/2;$("#photoViewerImg").addClass("photoHalfOpacity"),doCircle("comment",i,s,n,r),$(e).data("state","cancel")}else t==="cancel"&&($(e).show(),destroyCircle(),$(e).data("state","init"))},circleViewInit=function(){$(".PVCI").remove(),$(".PVCCI").remove();var e=Math.round((boxSize.mainWidth-boxSize.imgWidth)/2),t=Math.round((boxSize.imgContainerHeight-boxSize.imgHeight)/2),n=boxSize.circleScale,r=4,i=photoRelatedDataCatch[currentPhoto.id],s=i.tags,o=s.length;if(o>0)for(var u=0;u<o;u++){var a=s[u],f=e+Math.round(a.leftToPhoto*n),l=t+Math.round(a.topToPhoto*n),c=Math.round(a.frameWidth*n-r),h=Math.round(a.frameHeight*n-r),p=$(tmpl(template.circleView.face,{width:c,height:h,targetName:a.targetName.length>5?a.targetName.slice(0,5)+"...":a.targetName,id:a.id})).appendTo($("#photoViewerImgContainer")),d=p.find(".circleFaceTips"),v=d.width(),m=(c-v)/2;p.hide().css({left:f+"px",top:l+"px"}),d.css("left",m+"px")}var g=i.untags,y=g.length;if(y>0&&albumData.canTag){var b="";for(var u=0;u<y;u++){var a=g[u],f=Math.round(e+a.leftToPhoto*n),l=Math.round(t+a.topToPhoto*n),c=Math.round(a.frameWidth*n-r),h=Math.round(a.frameHeight*n-r),w=(c-70)/2;b+=tmpl(template.circleView.who,{width:c,height:h,top:l,left:f,tipLeft:w,index:u,id:a.id})}$("#photoViewerImgContainer").append(b)}var E=i.commentTags,y=E&&E.length;if(E&&y)for(var u=0;u<y;u++){var a=E[u],f=Math.round(e+a.leftToPhoto*n),l=Math.round(t+a.topToPhoto*n),c=Math.round(a.frameWidth*n-r),h=Math.round(a.frameHeight*n-r),S=a.body,x=$(tmpl(template.circleView.comment,{width:c,height:h,body:S,id:a.id,name:a.name})).appendTo($("#photoViewerImgContainer")),d=x.find(".circleCommentTips"),v=d.width(),v=v>240?240:v<80?80:v;d.css({width:v+"px","white-space":"normal"});var T=d.height(),m=(c-v)/2;x.hide().css({left:f+"px",top:l+"px"}),l+h+T+10>boxSize.mainHeight?(tipsTop=-(T+10),d.find(".photoViewerCircleTrig").removeClass("photoViewerCircleTrig").addClass("photoViewerCircleTrigB")):tipsTop=h+10,d.css({left:m+"px",top:tipsTop+"px"}),a.tips={left:m,top:tipsTop,width:v}}},doCircle=function(e,t,n,r,i){rotate.reset(),lockPhotoViewer(),$("#photoTopRightPos").hide(),$("#photoViewerPrev").hide(),$("#photoViewerNext").hide(),$("#pViewerMainCool").hide();var s=(boxSize.imgContainerHeight-boxSize.imgHeight)/2,o=(boxSize.mainWidth-boxSize.imgWidth)/2;$("#photoViewerImgContainer").append(tmpl(template.circle,{width:boxSize.imgWidth,height:boxSize.imgHeight,top:s,left:o,circleLeft:t,circleTop:n,circleWidth:r,circleHeight:i,src:currentPhoto.large,type:e}));if(e==="face")circleFriendSuggestInit($("#photoViewerCircleInput"),$("#circleFriendsList"));else if(e==="comment"){var u=$("#circleCommentTextarea");u.keyup(function(e){e=e||event;var t=e.keyCode||e.which;if(t===13){submitCircleComment();return}var n=XN.string.trim($(this).val()).replace(/[\r\t\n]/g,""),r=placeholderSupport?"":"移动至亮点区域并评论~",i=n===r?0:n.length,s=$("#circleCommentwordsCount");i>50?s.addClass("circleCommentwordsCountError"):s.removeClass("circleCommentwordsCountError"),s.text(""+i+"/50")}),u.focus(function(){var e=XN.string.trim($(this).val()).replace(/[\r\t\n]/g,""),t=placeholderSupport?"":"移动至亮点区域并评论~",n=e===t?0:e.length,r=$("#circleCommentwordsCount");n>50?r.addClass("circleCommentwordsCountError"):r.removeClass("circleCommentwordsCountError"),r.text(""+n+"/50")}),window.Mention.init([{obj:$("#circleCommentTextarea")[0],button:$("#circleCommentAt")[0],scrollable:!0,ownerId:albumData.album.owner,ugcId:currentPhoto.id,ugcType:"photo",limit:5,recentLimit:5}])}dragInstance=new Drag({node:$("#photoViewerCircleDrag"),parent:$("#photoViewerCircle"),width:r,height:i,left:t,top:n,type:e});var a=null,f=$("#photoViewerLayer");f.unbind("scroll"),f.bind("scroll",function(e){a&&clearTimeout(a),a=setTimeout(function(){dragInstance.offset=$("#photoViewerCircle").offset()})}),circling=!0},destroyCircle=function(){circling=!1,unlockPhotoViewer(),circleType==="comment"&&($("#photoViewerImg").removeClass("photoHalfOpacity"),$("#circleThePhoto").data("state","init")),$("#photoTopRightPos").css("display",""),$("#photoViewerPrev").css("display",""),$("#photoViewerNext").css("display",""),$("#pViewerMainCool").css("display",""),circleType="",circleUnsignedFace.prevCircleId=null,$("#photoViewerCircle").remove(),$("#photoViewerLayer").unbind("scroll")},Drag=function(e){var t=this;this.offset={top:15+(boxSize.imgContainerHeight-boxSize.imgHeight)/2,left:e.parent.offset().left},this.type=e.type,this.containerWidth=e.parent.width(),this.containerHeight=e.parent.height(),this.node=e.node,this.isMoved=!1,this.dragData={width:e.width,height:e.height,left:e.left,top:e.top},e.parent.mousedown(function(e){e=e||window.event;var n=e.srcElement||e.target;t.direct=n.getAttribute("dir-cmd"),t.direct&&(t.isMoved=!1,$("#photoViewerCircle").css("cursor",t.direct==="move"?"move":"default"),$("#resizableHandle").css("cursor",t.direct==="move"?"move":"default"),t.start(e))}),$(document).mousemove(function(e){t.isStartDrag&&(t.isMoved=!0,t.move(e))}),$(document).mouseup(function(e){t.isStartDrag&&t.stop(e)})};Drag.prototype={set:function(e,t,n,r){this.dragData={width:n,height:r,left:e,top:t},$("#photoViewerCircleDrag").css({left:e+"px",top:t+"px",width:n+"px",height:r+"px"}),$("#photoViewerCircleEnter").css({left:e-(145-n)/2+"px",top:t+r+10+"px"}),$("#circleInnerImg").css({left:-e+"px",top:-t+"px"})},start:function(e){e=e||window.event;var t=e.srcElement||e.target;window.getSelection?window.getSelection().removeAllRanges():document.selection.empty(),document.onselectstart=function(){return!1},this.isStartDrag=!0,$("#photoViewerCircleEnter").hide(),this.nodeWidth=this.node.width(),this.nodeHeight=this.node.height(),this.left=parseInt(this.node.css("left")),this.top=parseInt(this.node.css("top")),this.bottom=this.top+this.nodeHeight,this.right=this.left+this.nodeWidth,this.dragInnerImg=$("#circleInnerImg"),this.lastX=e.clientX-this.offset.left,this.lastY=e.clientY-this.offset.top,this.clickX=e.clientX-this.left-this.offset.left,this.clickY=e.clientY-this.top-this.offset.top;var n=this;this.dragData={width:n.nodeWidth,height:n.nodeHeight,left:n.left,top:n.top},this.node[0].setCapture?this.node[0].setCapture():window.captureEvents&&window.captureEvents(Event.MOUSEMOVE|Event.MOUSEUP)},move:function(e){e=e||window.event;var t=e.clientX-this.offset.left,n=e.clientY-this.offset.top,r=t-this.lastX,i=n-this.lastY;this.direct.length===2&&"nwneswse".indexOf(this.direct)!==-1?(this.doMove(this.direct.charAt(0),t,n,r,i),this.doMove(this.direct.charAt(1),t,n,r,i)):this.doMove(this.direct,t,n,r,i)},doMove:function(e,t,n,r,i){switch(e){case"reset":var s=i,o=r;this.left=this.right=this.lastX,this.top=this.bottom=this.lastY;if(s<=0){var u=this.bottom+i,u=u<=0?0:u;s=-s>this.top?this.top:-s,this.node.css({top:u+"px",height:s+"px"}),this.dragInnerImg.css({top:-u+"px"}),this.dragData.top=u,this.dragData.height=s}else s=s>this.containerHeight-this.lastY?this.containerHeight-this.lastY:s,this.node.css({top:this.lastY+"px",height:s+"px"}),this.dragInnerImg.css({top:-this.lastY+"px"}),this.dragData.top=this.lastY,this.dragData.height=s;if(o<=0){var a=this.right+r,a=a<=0?0:a,o=-o>this.left?this.left:-o;this.node.css({left:a+"px",width:o+"px"}),this.dragInnerImg.css({left:-a+"px"}),this.dragData.left=a,this.dragData.width=o}else o=o>this.containerWidth-this.lastX?this.containerWidth-this.lastX:o,this.node.css({left:this.lastX+"px",width:o+"px"}),this.dragInnerImg.css({left:-this.lastX+"px"}),this.dragData.left=this.lastX,this.dragData.width=o;break;case"move":a=t-this.clickX,u=n-this.clickY,a=a<0?0:a>this.containerWidth-this.nodeWidth?this.containerWidth-this.nodeWidth:a,u=u<0?0:u>this.containerHeight-this.nodeHeight?this.containerHeight-this.nodeHeight:u,this.node.css({top:u+"px",left:a+"px"}),this.dragInnerImg.css({left:-a+"px",top:-u+"px"}),this.dragData.left=a,this.dragData.top=u;break;case"n":var u=this.top+i,s=this.nodeHeight-i;s<=0?(s=-s>=this.containerHeight-this.bottom?this.containerHeight-this.bottom:-s,this.node.css({top:this.bottom+"px",height:s+"px"}),this.dragInnerImg.css({top:-this.bottom+"px"}),this.dragData.height=s,this.dragData.top=this.bottom):(u=u<=0?0:u>this.bottom?this.bottom:u,s=s>this.bottom?this.bottom:s,this.node.css({top:u+"px",height:s+"px"}),this.dragInnerImg.css({top:-u+"px"}),this.dragData.height=s,this.dragData.top=u);break;case"e":var o=this.nodeWidth+r;if(o<=0){var a=this.right+r,a=a<=0?0:a,o=-o>this.left?this.left:-o;this.node.css({left:a+"px",width:o+"px"}),this.dragInnerImg.css({left:-a+"px"}),this.dragData.left=a,this.dragData.width=o}else o=o>this.containerWidth-this.left?this.containerWidth-this.left:o,this.node.css({left:this.left+"px",width:o+"px"}),this.dragInnerImg.css({left:-this.left+"px"}),this.dragData.left=this.left,this.dragData.width=o;break;case"s":var s=this.nodeHeight+i;if(s<=0){var u=this.bottom+i,u=u<=0?0:u;s=-s>this.top?this.top:-s,this.node.css({top:u+"px",height:s+"px"}),this.dragInnerImg.css({top:-u+"px"}),this.dragData.top=u,this.dragData.height=s}else s=s>this.containerHeight-this.top?this.containerHeight-this.top:s,this.node.css({top:this.top+"px",height:s+"px"}),this.dragInnerImg.css({top:-this.top+"px"}),this.dragData.top=this.top,this.dragData.height=s;break;case"w":var a=this.left+r,o=this.nodeWidth-r;o<=0?(o=-o>this.containerWidth-this.right?this.containerWidth-this.right:-o,this.node.css({left:this.right+"px",width:o+"px"}),this.dragInnerImg.css({left:-this.right+"px"}),this.dragData.left=this.right,this.dragData.width=o):(a=a<=0?0:a>this.right?this.right:a,o=o>this.right?this.right:o,this.node.css({left:a+"px",width:o+"px"}),this.dragInnerImg.css({left:-a+"px"}),this.dragData.left=a,this.dragData.width=o)}},stop:function(e){if(!this.isMoved&&this.direct==="reset"){var t=boxSize.imgWidth,n=boxSize.imgHeight;this.type==="comment"?(t=t<120?boxSize.imgWidth:120,n=n<120?boxSize.imgHeight:120):(t=boxSize.imgWidth<60?boxSize.imgWidth:60,n=boxSize.imgHeight<60?boxSize.imgHeight:60);var r=this.lastX-t/2<0?0:this.lastX+t/2>boxSize.imgWidth?boxSize.imgWidth-t:this.lastX-t/2,i=this.lastY-n/2<0?0:this.lastY+n/2>boxSize.imgHeight?boxSize.imgHeight-n:this.lastY-n/2;this.node.css({width:t+"px",height:n+"px",left:r+"px",top:i+"px"}),this.dragInnerImg.css({left:-r+"px",top:-i+"px"}),this.dragData={width:t,height:n,left:r,top:i}}else{var s=this.dragData,t=s.width,n=s.height,r=s.left,i=s.top;t<16&&(t=16,r=t+s.left>boxSize.imgWidth?boxSize.imgWidth-t:s.left),n<16&&(n=16,i=n+s.top>boxSize.imgHeight?boxSize.imgHeight-n:s.top),this.node.css({width:t+"px",height:n+"px",left:r+"px",top:i+"px"}),this.dragInnerImg.css({left:-r+"px",top:-i+"px"}),this.dragData={width:t,height:n,left:r,top:i}}this.node[0].releaseCapture?this.node[0].releaseCapture():window.captureEvents&&window.captureEvents(Event.MOUSEMOVE|Event.MOUSEUP),document.onselectstart=function(){return!0};var o=this,u=$("#circleFriendsList li").length,a=u*40;u&&(o.dragData.top+o.dragData.height+40+a>boxSize.mainHeight?$("#circleFriendsList").css("top",-a+7+"px").show():$("#circleFriendsList").css("top","29px").show());if(this.type==="face")var f=o.dragData.left-(145-o.dragData.width)/2,l=o.dragData.top+o.dragData.height+10;else if(this.type==="comment"){var f=o.dragData.left-(240-o.dragData.width)/2;boxSize.mainHeight-o.dragData.top-o.dragData.height>90?(l=o.dragData.top+o.dragData.height+10,$(".photoViewerCircleTrigB").removeClass("photoViewerCircleTrigB").addClass("photoViewerCircleTrig")):(l=o.dragData.top-75-10,$(".photoViewerCircleTrig").removeClass("photoViewerCircleTrig").addClass("photoViewerCircleTrigB"))}$("#photoViewerCircleEnter").css({left:f+"px",top:l+"px"}).show(),$("#photoViewerCircle").css("cursor","crosshair"),$("#resizableHandle").css("cursor","move"),this.isStartDrag=!1}};var getCoodsRelativeToPhoto=function(e,t){var n=(winWidth-boxSize.containerWidth)/2+(boxSize.mainWidth-boxSize.imgWidth)/2,r=15-layerScrollTop+(boxSize.imgContainerHeight-boxSize.imgHeight)/2;return{x:e-n,y:t-r}},mouseMoveCircleShowTimer=null,mouseMoveOnPhotoContainerHandler=function(e){if(circling)return;var e=e||window.event,t=getCoodsRelativeToPhoto(e.clientX,e.clientY),n=t.x,r=t.y,i=n+(boxSize.mainWidth-boxSize.imgWidth)/2,s=$(this);albumData.photoNum>1&&(i<=boxSize.mainWidth/2?(s.hasClass("cursorNext")&&s.removeClass("cursorNext"),s.addClass("cursorPrev")):(s.hasClass("cursorPrev")&&s.removeClass("cursorPrev"),s.addClass("cursorNext"))),mouseMoveCircleShowTimer&&clearTimeout(mouseMoveCircleShowTimer),mouseMoveCircleShowTimer=setTimeout(function(){var e=photoRelatedDataCatch[currentPhoto.id];if(!e)return;var t=e.tags,i=e.untags,s=e.commentTags,o=[],u=boxSize.circleScale;t.length&&(o=o.concat(t)),i.length&&(o=o.concat(i)),s&&s.length&&(o=o.concat(s));for(var a=0,f=o.length;a<f;a++){var l=o[a],c=l.topToPhoto*u,h=l.leftToPhoto*u,p=l.frameWidth*u,d=l.frameHeight*u,v=$("#circle"+l.id);n>=h&&r>=c&&n<=h+p&&r<=c+d?v.length&&(v.show(),v.find(".circleWhoTips").show()):v.length&&v.hide()}},15)},findUntagsPositionByTagId=function(e){var t=photoRelatedDataCatch[currentPhoto.id].untags;for(var n=0,r=t.length;n<r;n++)if(t[n].id==e)return n;return-1},circleFriendSuggestInit=function(e,t){e.keyup(function(e){e=e||event;var n=e.keyCode||e.which;if(n===38){var r=$(".circleFriendsSugActive"),i=r.prev();i.length&&(r.removeClass("circleFriendsSugActive"),i.addClass("circleFriendsSugActive"));return}if(n===40){var r=$(".circleFriendsSugActive"),s=r.next();s.length&&(r.removeClass("circleFriendsSugActive"),s.addClass("circleFriendsSugActive"));return}if(n===13){var o=$(".circleFriendsSugActive");if(o.length)var u=o.attr("data-id"),a=o.find(".circleSugName").text();else var u=0,a=$("#photoViewerCircleInput").val();var f=$("#photoViewerCircleInput").attr("circle-id");circleCommit(u,a,f);return}var l=encodeURIComponent($(this).val());circleFriendSuggestInit.prevKeywords!==l&&(t.html(""),l?$.get("http://sg.renren.com/s/m?q="+l+"&l=4",function(e){e=JSON.parse(e);if(e.candidate.length){var n=dragInstance.dragData;n.top+n.height+40+e.candidate.length*40+(boxSize.imgContainerHeight-boxSize.imgHeight)/2>boxSize.mainHeight?$("#circleFriendsList").css("top",-e.candidate.length*40+7+"px").show():$("#circleFriendsList").css("top","29px").show(),t.html(tmpl(template.circleFriendsSuggest,e))}else $("#circleFriendsList").hide()}):$("#circleFriendsList").hide()),circleFriendSuggestInit.prevKeywords=l}),e.keydown(function(e){var e=e||window.event;if(e.keyCode==38||e.keyCode==40)e.preventDefault?e.preventDefault(!0):e.returnValue=!1})},circleSuggestClickEventInit=function(){$("#photoViewer").undelegate(".circleFriendsSugI","click"),$("#photoViewer").delegate(".circleFriendsSugI","click",function(){var e=$(this).attr("data-id"),t=$(this).find(".circleSugName").text(),n=$("#photoViewerCircleInput").attr("circle-id");circleCommit(e,t,n)})},circleCommit=function(e,t,n){if(t==="")return;var r=albumData.album.owner,i=currentPhoto.id,s="http://photo.renren.com/photo/"+r+"/photo-"+i+"/tag",o=dragInstance.dragData,u=boxSize.circleScale,a={photoId:i,ownerId:r,leftToPhoto:parseInt(o.left/u),topToPhoto:parseInt(o.top/u),frameWidth:parseInt(o.width/u),frameHeight:parseInt(o.height/u),photoWidth:currentPhoto.largeWidth,photoHeight:currentPhoto.largeHeight,targetId:e,targetName:t,psource:pSource,t:(new Date).getTime()};typeof n!==undefined&&(a.tagId=n),$.post(s,a,function(e){e=JSON.parse(e.responseText);if(e.code!==0&&e.code!==4){XN.Do.showError(e.msg);return}var n=(boxSize.mainWidth-boxSize.imgWidth)/2,r=(boxSize.imgContainerHeight-boxSize.imgHeight)/2,i=boxSize.circleScale,s=4,u=n+o.left,f=r+o.top,l=o.width-s,c=o.height-s,h=photoRelatedDataCatch[currentPhoto.id];if(a.tagId){if(h.untags.length){var p=findUntagsPositionByTagId(a.tagId);h.untags.splice(p,1)}$("#circle"+a.tagId).remove();var d=$("#photoViewerUncircleCount"),v=parseInt(d.text(),10);v--,v===0?(d.hide(),$("#photoViewerCircleBtnTipsContent").html("点击开始圈人")):(d.text(""+v),$("#uncircleTipCount").text(""+v))}var m=$(tmpl(template.circleView.face,{width:l,height:c,targetName:t.slice(0,5),id:e.tagId})).appendTo($("#photoViewerImgContainer")),g=m.find(".circleFaceTips"),y=g.width(),b=(l-y)/2;m.hide().css({left:u+"px",top:f+"px"}),g.css("left",b+"px");var w={frameHeight:o.height/boxSize.circleScale,frameWidth:o.width/boxSize.circleScale,id:e.tagId,leftToPhoto:o.left/boxSize.circleScale,ownerId:e.ownerId,taggerId:XN.user.id,taggerName:decodeURI(XN.user.name),targetId:e.targetId,targetName:e.targetName,topToPhoto:o.top/boxSize.circleScale};h.tags.push(w);var E=$(".withItem");if(E.length>0){var S=E.last();if(e.targetId==0)var x='<span class="withItem" id="withTag'+e.tagId+'" data-id="'+e.tagId+'" data-type="circle">'+e.targetName+'<i class="withDeleteIco" data-id="'+e.tagId+'" layer-cmd="deleteCircle" title="删除"></i></span>';else var x='<a class="withItem" id="withTag'+e.tagId+'" href="http://www.renren.com/profile.do?id='+e.targetId+'" target="_blank" data-id="'+e.tagId+'" data-type="circle">'+e.targetName+'<i class="withDeleteIco" data-id="'+e.tagId+'" layer-cmd="deleteCircle" title="删除"></i></a>';S.after("<span>、</span>").next().after(x)}else{var T=$("#photoViewerDesc"),N=T.length&&T.text()!==""?!0:!1;$("#photoViewerWith").html(tmpl(template.withs,{tags:h.tags,withs:[],ownerId:albumData.album.owner,hasDesc:N}))}if(circleType==="face"&&h.untags.length){var C=h.untags[0],f=C.topToPhoto*i,u=C.leftToPhoto*i,l=C.frameWidth*i,c=C.frameHeight*i;dragInstance.set(u,f,l,c),$("#photoViewerCircleInput").val(""),circleUnsignedFace(C.id,!0)}else destroyCircle()})},resizeHandler=function(e){resizeTimer&&clearTimeout(resizeTimer),resizeTimer=setTimeout(function(){winWidth=$(window).width(),winHeight=$(window).height(),boxSize=calculateBoxSize(currentPhoto.largeWidth,currentPhoto.largeHeight),$("#photoViewerLayer").height(boxSize.layerHeight),$("#photoViewerLayerWrapper").width(boxSize.containerWidth),$("#photoViewerAside").css("min-height",boxSize.mainHeight+"px"),$("#photoViewerLayerContainer").width(boxSize.containerWidth),$("#photoViewerMain").width(boxSize.mainWidth),$("#photoViewerImgContainer").height(boxSize.imgContainerHeight),$("#photoViewerImg").width(boxSize.imgWidth).height(boxSize.imgHeight),$("#photoViewerSidebarTop").css({"max-height":boxSize.layerHeight-106+"px",overflow:"visible"}),$("#photoTopRightPos").css({right:(boxSize.mainWidth-boxSize.imgWidth)/2+5+"px",top:(boxSize.imgContainerHeight-boxSize.imgHeight)/2+5+"px"})},100)},updatePrivacy=function(e){var t={},n=this;t.ugcGlobalId=e.photoGlobalId,t.sourceControl=e.photoControl,t.groupId=e.photoGroupId,t.groupType=e.photoGroupType,t.readOnly=!1,t.readOnlyTips="非公开相册中的照片不能单独设置隐私",e.albumControl!="99"?t.readOnly=!0:XN.user.id!=albumData.album.owner?t.readOnly=!0:albumData.album.type!=0&&albumData.album.type!=3&&albumData.album.type!=5&&albumData.album.type!=18?(t.readOnly=!0,t.readOnlyTips="此相册中的照片无法设置隐私"):e.withs&&e.withs.length>0&&(t.readOnly=!0,t.readOnlyTips="暂不支持对带和谁信息的内容设置隐私");if(XN.user.id!=albumData.album.owner&&t.sourceControl=="7")t.groupName="部分好友可见",t.icon="custom";else switch(t.sourceControl){case"99":t.groupName="公开",t.icon="public";break;case"4":t.groupName="密码保护",t.icon="password";break;case"0":t.groupName="好友可见",t.icon="friend";break;case"-1":t.groupName="仅自己可见",t.icon="private";break;default:XN.user.id==albumData.album.owner?(t.groupName=e.photoGroupName,t.icon=e.photoGroupType):(t.groupName="仅对部分好友可见",t.icon="custom")}object.use("dom",function(n){var r=$("#photoViewerPrivacy");r.html(Mustache.to_html('<a class="privacy-trigger {{#readOnly}}privacy-trigger-disabled {{/readOnly}}" id="privacy_create_status" data-toggle="privacy" data-option={"sourceControl":{{sourceControl}},"ugcGlobalIds":["{{ugcGlobalId}}"],"privacyGroupId":"{{groupId}}","privacyGroupType":"{{groupType}}","ugcType":"photo","alignType":"1-4"} href="#" >            <i class="privacy-icon picon-{{icon}}"></i>            <span>{{groupName}}</span>            {{^readOnly}}<i class="privacy-icon picon-arrow-down"></i>{{/readOnly}}            </a>{{#readOnly}}<div class="btn-tip" style="display: none;"><div class="btn-tip-arrow"></div><p>{{readOnlyTips}}</p></div>{{/readOnly}}',t)),n.wrap(r.find("a")[0]).addEvent("privacyinited",function(t){t.privacy.addEvent("settingsuccessed",function(){var n=JSON.parse(t.privacy.sendJson);e.photoControl=n.sourceControl+"",e.photoGroupId=n.privacyGroupId,e.photoGroupName=n.privacyGroupName})}),r.find("a").hover(function(e){XN.user.id==albumData.album.owner&&r.find(".btn-tip"
).show()},function(e){r.find(".btn-tip").hide()})})},deleteWiths=function(e){var t="http://photo.renren.com/photo/with/delete/"+e;$.post(t,{},function(t){var t=JSON.parse(t.responseText);t.code!=0&&XN.Do.showError(t.msg);var n=$("#withTag"+e),r=n.next(),i=n.prev();r.text()==="、"?r.remove():i.text()==="、"&&i.remove(),$(".withItem").length===1?$("#photoViewerWith").html(""):n.remove(),$("#circle"+e).remove();var s=photoRelatedDataCatch[currentPhoto.id].withs;for(var o=0,u=s.length;o<u;o++){var a=s[o].id;if(e==a){s.splice(o,1);return}}})},deleteCircle=function(e){var t="http://photo.renren.com/photo/"+albumData.album.owner+"/tag-"+e+"/delete";$.post(t,{photoId:currentPhoto.id,targetId:e},function(t){t=JSON.parse(t.responseText);if(t.code!=0){XN.Do.showError(t.msg);return}var n=$("#withTag"+e),r=n.next(),i=n.prev();r.text()==="、"?r.remove():i.text()==="、"&&i.remove(),$(".withItem").length===1?$("#photoViewerWith").html(""):n.remove(),$("#circle"+e).remove();var s=photoRelatedDataCatch[currentPhoto.id].tags;for(var o=0,u=s.length;o<u;o++)if(s[o].id==e){s.splice(o,1);return}})},showRecommendPhoto=function(){object.use("xn/photo/recommend",function(e){var t=new e.PhotoRecommend({photoId:currentPhoto.id,albumId:albumData.album.id,ownerId:albumData.album.owner,popLayer:!0});lockPhotoViewer(),t.addEvent("recommendClose",function(){unlockPhotoViewer(),t.removeEvent("recommendClose")}),t.addEvent("recommendRestart",function(){unlockPhotoViewer(),flip("next")}),t.init(),recommentPhotoIsShow=!0})};XN.namespace("XN.app"),XN.event.enableCustomEvent(XN.app),XN.app.addEvent("bridgeSharePostSuccess",function(e){if($(e).hasClass("photoViewShare")){var t=$("#photoViewShareCount");t.text(parseInt(t.text(),10)+1+""),currentPhoto.shareCount+=1}});var circleCommentGuidViewInit=function(){albumData.is_new_layer===0&&$("#photoTopRightPos").append('<div class="circleCommentGuid" id="circleCommentGuid"><a href="javascript:" class="circleCommentGuidClose" layer-cmd="closeCircleGuid"></a></div>').addClass("guidShow")},circleCommentGuidClose=function(){var e=$("#circleCommentGuid");e.length&&($("#circleCommentGuid").remove(),$("#photoTopRightPos").removeClass("guidShow"),circleCommentGuidClose=function(){})};this.photoViewer={init:function(data){EventProxy.clear(),EventProxy.assign("fetchAlbumData","baseFrameViewInit",toolbarViewInit),EventProxy.assign("fetchAlbumData","baseFrameViewInit",sidebarTopViewInit),EventProxy.assign("fetchPhotoData","sidebarTopViewInit",commentsListViewInit),EventProxy.assign("fetchAlbumData","fetchPhotoData","sidebarTopViewInit",updateLocView),EventProxy.assign("fetchAlbumData","fetchPhotoData","sidebarTopViewInit",updateWithsView),EventProxy.assign("fetchAlbumData","fetchPhotoData","sidebarTopViewInit",imgSubjectMessages),EventProxy.assign("commentsListViewInit",commentBoxViewInit),EventProxy.assign("fetchAlbumData","fetchPhotoData","baseFrameViewInit",circleViewInit),EventProxy.assign("fetchAlbumData","fetchPhotoData","baseFrameViewInit",mouseMoveEventInit),EventProxy.assign("fetchPhotoData","toolbarViewInit",updateToolbarActionView),EventProxy.assign("fetchAlbumData","baseFrameViewInit",circleCommentGuidViewInit),EventProxy.assign("fetchAlbumData","baseFrameViewInit",preloadImg),hashCopy=location.hash,typeof data=="string"&&(data=eval("("+data+")"));var src,width,height;data.xLarge&&data.xLarge!==""?(src=data.xLarge,width=data.xWidth,height=data.xHeight):data.xUrl&&data.xUrl!==""?(src=data.large.replace(/\/(large_.+_)/,"/original_"+data.xUrl+"_"),width=data.xWidth,height=data.xHeight):(src=data.large,width=data.lWidth,height=data.lHeight);var pSource=data.psource||pSource,ownerId=data.owner,photoId=data.id,param=data.param;currentPhoto=data,/\.[jpg|JPG|jepg|JEPG|png|PNG|gif|GIF]$/.test(src)&&loadImg(src),width&&height&&width!=0&&height!=0?openViewerLayer(src,width,height):EventProxy.assign("fetchAlbumData",openViewerLayer),fetchAlbumData(ownerId,photoId,pSource,param),fetchPhotoData(ownerId,photoId)}};var imgSubjectMessages=function(){function i(){var e=[],i=0;for(;i<n;i++){var u=t[i],f="",l=a(u.subjectName),c=15.7;l<10&&(c-=10-l),u.relatedAlbumsCount>1?f=s(u,c):f=o(u,c),e.push(f)}r.append(e.join(""))}function s(e,t){var n=0,r=[],i=e.userarray.length,s="";for(;n<i;n++)r.push(e.userarray[n].userName);i>3?(r=r.slice(0,3),s=r.join("、")+"等"+i+"人"):s=r.join("、");var o=s+"关联了"+e.relatedAlbumsCount+"组照片到该主题，现在就去欣赏吧";return['<li><label>主题：</label><a href="',e.subjectUrl,'" target="_blank">',e.subjectName,"（",e.relatedAlbumsCount,'组照片）</a><span class="details-icon"><span class="details-qtip-triangle hidden"></span><span class="details-qtip hidden" style="left: -',t,'em;">',o,"</span>?</span></li>"].join("")}function o(e,t){var n="还在苦恼聚会or旅行的照片四处散落的你，快来关联照片让它们团聚吧";return['<li><label>主题：</label><a href="',e.subjectUrl,'" target="_blank">',e.subjectName,'（前往关联）</a><span class="details-icon"><span class="details-qtip-triangle hidden"></span><span class="details-qtip hidden" style="left: -',t,'em;">',n,"</span>?</span></li>"].join("")}function u(){jxn("#subjectInfoList .details-icon").each(function(){var e=jxn(this),t={},n=e.find("span");n.bind({mouseenter:function(){clearTimeout(t)},mouseleave:function(){t=setTimeout(function(){n.addClass("hidden")},100)}}),e.bind({mouseenter:function(){clearTimeout(t);var e=jxn(this).find("span");e.removeClass("hidden")},mouseleave:function(){t=setTimeout(function(){n.addClass("hidden")},100)}})})}function a(e){var t=/[^\x00-\xff]/g;return e=e||"",e.replace(t,"**").length}var e=photoRelatedDataCatch[currentPhoto.id],t=e.subjects,n,r=jxn("#subjectInfoList");if(!t||!t.length)return;n=t.length,n=n>3?3:n,r.empty();if(n==0)return;i(),u()}}(jxn);