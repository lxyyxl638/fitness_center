/**  
  用法 ： 
	var manage =  CommentManage.getInstance(config) 获取一个管理器实例
	manage.showComment(response) 显示留言
	manage.Init({sourceId : "id" }) 更改处理对象的ID,如相册和图片的ID
	manage.sendSave(param,obj) //外部发送一个留言
	 //param : 要发送的请求参数
	 //obj : {
				 onsuccess: sucFun, //请求成功
				 onerror : errFun	//请求失败			
			} 
//config对象参数列表
//以下为必须参数
type:'photo',
parentEl: XN.dom.getElementsByClassName('replies','content','div')[0], //留言容器
userId: _PCI.curUserId,    //登录用户的ID
ownerId: _PCI.albumOwner, //查看对象的ID
sourceId: _PCI.currentPhotoId, //PHOTO ALBUM等的ID
getDelUrl: function(id){return 'http://photo.' +  XN.env.domain + '/photo/' + this.ownerId + '/photo-' + this.sourceId +  '/comment/' + id + '/delete'},
getDelParam : function(id){return "id=" + id + "&photoid=" + this.sourceId + "&owner=" + this.ownerId},
getLoadUrl: function(){return 'http://photo.' +  XN.env.domain + '/photo/' + this.ownerId + '/photo-' + this.sourceId +  '/comment'},
getReportUrl: function(){return 'http://admin.renren.com/admin/newuserreport.do?type=24owner =?&contentId=?userId=?origURL=?'},
getLoadParam: function(){return "commentId=" + this.lastEndId + "&photo=" + this.sourceId + "&owner=" + this.ownerId},
getSaveUrl: function(){return this.getLoadUrl();},
getSaveParam: function(){return XN.form.serialize(this.comEditorFormID)}

		//以下参数有默认值
		isCache: true,
		isAdmin:false, //登录用户是否管理员
		isVip: false, //是否VIP
		cmtBodyID: 'cmtbody', //留言编辑框
		editorBtnID: 'editorFormBtn', //提交评论BUTTON ID
		errorMsgID: 'ajax_msgerror', //错误提示ID
		commContainerID: 'commContainer',//留言的容器ID
		showMoreID: 'showMore', //显示更多
		showMoreCommentsID : 'showMoreComments',
		comEditorFormID: 'commentEditorForm', //留言FORM的ID
		whisperID: 'whisper', //悄悄话
		feedCommentID: 'feedComment', //是否发送FEED消息ID
		miniEditorID:'miniEditor',
		miniEditorActionID:'miniEditorAction',
		//emoBtnID : 'emoBtn', //表情按钮			
		toidID:'cmttoid',    //留言回复给谁的input
		sourceidID:'sourceid', //回复的目标的input，eg :photoid
		tempLoadingID :'tempLoading'  //加载留言时显示loading的ID		
				
		urlProfile : 'http://' + XN.env.domain + '/profile.do',
		urlVipIcon : 'http://s.xnimg.cn/imgpro/icons/vip_f.gif',
		urlVipActionUrl : 'http://i.'+ XN.env.domain + '/index.action?wc=290000',
		urlMobile : 'http://mobile.' + XN.env.domain,
		urlMobileIcon : 'http://s.xnimg.cn/img/mobile-intro/tinymobile.gif',
        likeText: '赞', // 喜欢的文案, 用于测试 "喜欢" 和 "赞"
		delErrMsg : '',
		saveErrMsg : '非常抱歉，发送回复失败，请稍后重试',
		loadErrMsg : '非常抱歉，评论加载失败，请尝试刷新！',		
 *//**
 * @author dimu.feng@opi-corp.com
 * @modify by bo.hu@opi-corp.com 
 * @date 2010.04.12  增加举报
 * @date 2011.06.27  修改为模板渲染，准备统一评论
 */(function(){function Extend(e,t,n){var n=n||function(e){return e};for(var r in t)e[r]=n(t[r]);return e}var Class={create:function(){return function(){this.initialize.apply(this,arguments)}}},DataCache=Class.create();DataCache.prototype={initialize:function(e){this.key=e,this._cache={},this._delCache={}},get:function(e){var e=e||"first";return this._cache[e]},add:function(e,t){var e=e||"first",t=t||{};this._cache[e]=t},del:function(e){this._delCache[e]=1},isDel:function(e){return!!this._delCache[e]}},DataCache.obj={},DataCache.getInstance=function(e){return DataCache.obj[e]||(DataCache.obj[e]=new DataCache(e)),DataCache.obj[e]};var SuperComment=Class.create();SuperComment.prototype={urlProfile:"http://www."+XN.env.domain+"/profile.do",urlVipIcon:"http://s.xnimg.cn/imgpro/icons/vip_f.gif",urlVipActionUrl:"http://i."+XN.env.domain+"/index.action?wc=290000",urlMobile:"http://mobile."+XN.env.domain,urlMobileIcon:"http://s.xnimg.cn/img/mobile-intro/tinymobile.gif",likeText:"赞",delErrMsg:"",saveErrMsg:"非常抱歉，发送回复失败，请稍后重试",loadErrMsg:"非常抱歉，评论加载失败，请尝试刷新！",defInnerHTML:"",initialize:function(e){this.isCache=!0,this.isAdmin=!1,this.isVip=!1,Extend(this,e);if(!$(this.parentEl))return;this.allCount=0,this.nowCount=0,this._initContainer(),this._init(),this._bindEvents(),this.imgLazyload=new HeadLazyload},Init:function(e){this.sourceId=e.sourceId,this.ownerId=e.ownerId||this.ownerId,$("ownerId")&&($("ownerId").value=e.ownerId||this.ownerId),this.allCount=0,this.nowCount=0,this._init()},_init:function(){this._nameCache={},this.lastEndId=null,this.currentPage=0,$(this.commContainerID).hide(),$(this.commContainerID).innerHTML=this.defInnerHTML,this._cache=DataCache.getInstance(this.sourceId),this._initEditor(),this._hideError(),this._setBtnEnable(!0)},_initContainer:function(){var e="";e+='<dl class="replies">',this.cmtMode?e+='<dt style="display:none;" class="show-all" id="'+this.showMoreID+'"><a target="_blank" style="width:108px;" id="'+this.showMoreCommentsID+'" href="http://photo.renren.com/photo/'+this.ownerId+"/photo-"+this.sourceId+'">显示剩余<span id="'+this.lastedCommentCount+'"></span>条评论</a>':e+='<dt style="display:none;" class="show-all" id="'+this.showMoreID+'"><a style="width:108px;" id="'+this.showMoreCommentsID+'" href="javascript:;">显示较早之前的评论</a>',e+='<span style="visibility:hidden;" id="'+this.tempLoadingID+'">加载中&nbsp;<img src="'+XN.env.staticRoot+'imgpro/bg/indicator_blue_small.gif" /></span>',e+="</dt></dl>",e+='<div id="'+this.commContainerID+'"></div>',$(this.parentEl).innerHTML=e},_bindEvents:function(){var e=this;$(this.commContainerID).onclick=function(t){e._commClickProxy(t)},$(this.comEditorFormID).onkeydown=function(t){var t=t||window.event;!t.shiftKey&&!t.altKey&&t.keyCode==13&&t.ctrlKey&&e.saveComment()},$(this.editorBtnID).onclick=function(t){e.saveComment()},$(this.showMoreCommentsID).onclick=function(t){if(e.cmtMode){if(e.allCount<=30){var n=t||window.event;XN.Event.stop(n),e._loadCommentMore()}}else e.showComment()}},_showError:function(e){$(this.errorMsgID).innerHTML=e,$(this.errorMsgID).show(),this.fireEvent("showError",e)},_hideError:function(){$(this.errorMsgID).hide(),$(this.errorMsgID).innerHTML=""},_addCache:function(e){var t=this._cache.get(null);if(!t)return;var n=t.comments||[];n.splice(0,0,e),t.comments||(t.comments=n)},firstLoad:function(){this.currentPage=-1,this.showComment()},showComment:function(e){e&&this._cache.add(this.lastEndId,e);var e=this._cache.get(this.lastEndId);e?(this._updateCount(e),this._drawComment(e),this.fireEvent("showComment")):(this.currentPage++,this._loadComment())},_updateCount:function(e){this.allCount=e.commentCount,this.nowCount+=e.comments.length,this.cmtMode&&($(this.lastedCommentCount).innerHTML=this.allCount-this.nowCount)},_drawComment:function(e){if(!e)return;this._updateHasMore(e),this._updateOldComId(e.comments),this._updateComment(e.comments),this._updateCommentsWiki(e)},_updateCommentsWiki:function(e){if(e.wikiWordsMap){var t=JSON.parse(e.wikiWordsMap);for(proid in t)$("talk"+proid+" .reply").setAttribute("data-wiki",t[proid])}window.wikiHighlight&&window.wikiHighlight()},_updateHasMore:function(e){this.hasMore=e&&e.hasMore,this.hasMore?$(this.showMoreID).show():$(this.showMoreID).hide(),$(this.tempLoadingID).style.visibility="hidden"},_updateOldComId:function(e){this.lastEndId=null;if(!e||e.length==0)return;this.lastEndId=e[e.length-1].id},_updateComment:function(e){var t=$element("dl");t.className="replies";var n=this._getComHTML(e);if(!n)return;t.innerHTML=n;var r=$(this.commContainerID);r.show();if(this.cmtMode)r.innerHTML="",r.appendChild(t);else{var i=r.childNodes[0];i?r.insertBefore(t,i):r.appendChild(t)}r=i=null;var s=this;setTimeout(function(){s.imgLazyload.addContainer(t),s.onRenderList&&s.onRenderList()},100)},_getComHTML:function(e){var e=e||[],t=[];for(var n=e.length-1;n>=0;n--){var r=e[n];if(r&&!this._cache.isDel(r.id)){var i="";e[n].tagComment&&(i='onmouseover="showCircleCommentView('+r.id+')" onmouseout="hideCircleCommentView('+r.id+')"'),t.push('<dd id="talk'+r.id+'" '+i+">"+this._getOneComHTML(r,this.globalNotLazy)+"</dd>")}}return t.join("")},_getOneComHTML:function(e,t){this._nameCache[e.author]=e.name;if(!e.wrapped){this.userId!==e.author&&this.userId!==this.ownerId&&!this.isAdmin&&(e.reportURL=this.getReportUrl(e.id,e.author)),e.liveUserClass=e.keepUse?" lively-user":"",e.liveUserTitle=e.keepUse?"连续登录7天, 即可获得橙名特权":e.name,e.urlProfile=this.urlProfile+"?id="+e.author;if(e.url){var n='<a class="vocal-player vocal-player-tiny" style="margin-left:10px;"                         data-vocal="{\'url\': \''+e.url+"', 'time': "+e.length+",'ownerId':"+e.author+",'voiceId':"+e.id+", 'sourceOwner':"+e.owner+", 'sourceId':"+e.photoId+', \'ugcType\':3}" href="javascript:;">                          <span class="btn"></span>                          <span class="time"><span class="num">'+e.length+"</span>秒</span>                        </a>",r=/^回复[^>]+>?[:：]/,i=r.test(e.body)?e.body.match(r)[0]:"";e.commentBody=i+n,e.isVoice=!0}else e.commentBody=e.body.replace(/\n/g,"<br />").replace("<xiaonei_wap/>",'<a href="'+this.urlMobile+'"><img class="mb-message" src="'+this.urlMobileIcon+'" alt="通过手机发布" title="通过手机发布"/></a>'),e.commentBody=e.commentBody.replace(/((%[0-9A-F]{2}){3})/g,function(e){try{return decodeURIComponent(e)}catch(t){return e}}),e.lightInteract=e.lightInteract||!1,e.lightInteract&&(e.commentBody='<span class="like-comment-style">'+e.commentBody+"</span>"),e.isVoice=!1;e.srcAttr=(t?"":"lazyload-")+"src",e.urlVipIcon=e.vipIconUrl,e.urlVipIcon?e.isVip=!0:e.isVip=!1,e.urlVipActionUrl=this.urlVipActionUrl,e.isShowReply=this.userId!=e.author,e.likecount_str=e.likecount||"",e.like_text=this.likeText,e.state=typeof e.state=="undefined"?0:e.state,e.wrapped=!0}return Mustache.to_html(this.oneCmtTPL,e)},_loadComment:function(){this._showLoad();var e=this,t=this.sourceId,n=this.cmtMode?this.getLoadCmtUrl():this.getLoadUrl()+"?"+this.getLoadParam();new XN.NET.xmlhttp({url:n,method:"GET",onSuccess:function(n){e._hideLoad();if(t!=e.sourceId)return;try{var r=XN.JSON.parse(n.responseText);r.code==0&&e.showComment(r)}catch(i){}},onError:function(){if(t!=e.sourceId)return;e._hideLoad()}})},_loadCommentMore:function(){this._showLoad();var e=this,t=this.sourceId;new XN.NET.xmlhttp({url:this.getLoadUrl()+"?"+this.getLoadParam(),method:"GET",onSuccess:function(n){e._hideLoad();if(t!=e.sourceId)return;try{var r=XN.JSON.parse(n.responseText);r.code==0&&e.showComment(r)}catch(i){}},onError:function(){if(t!=e.sourceId)return;e._hideLoad()}})},_showLoad:function(){$(this.tempLoadingID).style.visibility=""},_hideLoad:function(){$(this.tempLoadingID).style.visibility="hidden"},_commClickProxy:function(e){var t=e||window.event,n=XN.event.element(t),r=n.getAttribute("comorder");try{r=XN.JSON.parse(r);if(!r)return}catch(t){return}if(r.type=="del")this.delComment(r.id,r.owner);else if(r.type=="reply"){var i=this._nameCache[r.id];this.replyComment(r.id,i,r.whisper,r.cmtid,r.lightInteract,r.state)}else r.type=="like"&&this.likeComment(r.uid,r.name,r.ownerid,r.cmtid,n)},delComment:function(e){var t=this;XN.DO.confirm({title:"删除评论",msg:"确定删除这条评论吗？",callBack:function(n){n&&t._sendDel(e)}})},_sendDel:function(e){$("talk"+e)&&$("talk"+e).hide(),this.fireEvent("delComment"),this._cache.del(e);var t=this;new XN.NET.xmlhttp({url:this.getDelUrl(e),data:this.getDelParam(e),onSuccess:function(){t.fireEvent("delCommentSuccess")}}),$(XN.vocalPlayer.flashId)&&($(XN.vocalPlayer.flashId).remove(),XN.vocalPlayer.flashReady=!1)},saveComment:function(){var e=XN.STRING.trim($(this.cmtBodyID).value),t=$(this.cmtBodyID).value;if(!this._checkEditor(e))return;if(e.split("").length>500){XN.DO.showError("回复字数不能超过500字","提示");return}var n=this;this._setBtnEnable(!1);var r=function(e){n._hideError(),n._initEditor(),n._setBtnEnable(!0),n.commentState=undefined;if(!e)return;if(e.code==1)return;n._appendOneComment(e),n.fireEvent("saveCommentSuccess"),!!$("doShare")&&$("doShare").checked&&n.shareThis(t)},i=function(e){var t=e&&e.msg?e.msg:n.saveErrMsg;n._showError(t),n._setBtnEnable(!0)};this.sendSave(null,{onsuccess:r,onerror:i})},addLikeComment:function(){var e=XN.array.toQueryString({body:""+Math.random(),feedComment:!0,realWhisper:!1,to:0,replyCommentId:0,owner:this.ownerId,guestName:XN.user.name,lightInteract:1}),t=this;this.sendSave(e,{onsuccess:function(e){if(!e||e.code==1)return;t._appendOneComment(e)}})},sendSave:function(param,obj){var obj=obj||{},param=param||this.getSaveParam();$(this.toidID)&&$(this.toidID).value!="0"&&this.lightInteract&&(param+="&lightInteract=2"),this.commentState!==undefined&&(param+="&state="+this.commentState),new XN.net.xmlhttp({url:this.getSaveUrl(),data:param,onSuccess:function(response){var str=response.responseText;if(/^af:/.test(str)){isFunction(obj.onerror)&&obj.onerror({msg:str.substring(3)});return}try{var result=eval("("+str+")");isFunction(obj.onsuccess)&&obj.onsuccess(result)}catch(e){isFunction(obj.onerror)&&obj.onerror()}},onError:function(){isFunction(obj.onerror)&&obj.onerror()}})},_checkEditor:function(e){return XN.string.isBlank(e)?(this._showError("请填写评论"),!1):(new String(e)).length>this.maxEditorLenth?(this._showError("评论不能多于"+this.maxEditorLenth+"个字符"),!1):!0},_appendOneComment:function(e){this._addCache(e);var t=$element("dd");t.id="talk"+e.id,t.innerHTML=this._getOneComHTML(e,!0);var n=$(this.commContainerID);n.childNodes.length==0&&(n.show(),n.innerHTML='<dl class="replies"></dl>');var r=n.childNodes[n.childNodes.length-1];r&&r.appendChild(t),this.fireEvent("appendComment",t)},shareThis:function(e){var t={};t.link=encodeURIComponent($("link").value),t.action="add",t.auth=99,t.type=$("type").value,t.title=encodeURIComponent(XN.string.ltrim($("title").value.replace(/\n|\r|\t/g,""))),t.pic=encodeURIComponent($("pic").value),t.fromno=$("fromno").value,t.fromname=$("fromname").value,t.fromuniv=$("fromuniv").value,t.albumid=$("albumid").value,t.summary=encodeURIComponent($("summary").value.replace(/\n|\r|\t/g,"")),t.largeurl=$("largeurl").value,t.fromShareId="0",t.fromShareOwner="0",t.currenUserTinyurl=XN.user.tinyPic,t.forwardComment=encodeURIComponent(XN.string.ltrim(e.replace(/\n|\r|\t/g,""))),t.body=encodeURIComponent(XN.string.ltrim(e.replace(/\n|\r|\t/g,""))),new XN.NET.xmlhttp({url:"http://share.renren.com/share/popupSubmit/internal",data:"post="+XN.json.build(t),onSuccess:function(e){},onError:function(){}})},replyComment:function(e,t,n,r,i,s){this._initEditor(e,t,n,r,i,s),this.fireEvent("replayComment");var o=this;setTimeout(function(){(new XN.FORM.inputHelper($(o.cmtBodyID))).focus()},0)},sendLikeComment:function(e){var t={resource:this.sourceId,uid:XN.user.id,owner:e.uid,resourceownerid:e.ownerid,type:8,name:e.uname};this.type=="photo"?(t.gid="photocomment_"+e.cmtid,t.type=8,t.url="http://photo."+XN.env.domain+"/photo/"+e.ownerid+"/photo-"+this.sourceId):(t.gid="albumcomment_"+e.cmtid,t.type=7,t.url="http://photo."+XN.env.domain+"/photo/"+e.ownerid+"/album-"+this.sourceId);var n="http://like.renren.com/comment/"+(e.isLike?"addlike":"removelike"),r=Object.keys(t).map(function(e){return e+"="+encodeURIComponent(t[e])}).join("&");new XN.net.xmlhttp({url:n,data:r,method:"get",onSuccess:function(t){var n=XN.json.parse(t.responseText);n.code==0?e.callback&&e.callback():XN.DO.showError(n.msg)},onError:function(){new XN.DO.showError("通信错误")}})},likeComment:function(e,t,n,r,i){var s,o,u;i?u=XN.element.parent(i,"#talk"+r):u=$("#talk"+r),s=Sizzle(".photo-comment-like-btn",u),con=Sizzle(".photo-comment-like-container",u)[0];if(!s.length)return;s=s[0],o=Sizzle(".photo-comment-like-count",u)[0];var a=parseInt(s.getAttribute("data-likecount")||"0",10),f=s.getAttribute("data-liked")=="1";f=!f,a+=f?1:-1;var l=this;this.sendLikeComment({uid:e,uname:t,ownerid:n,cmtid:r,isLike:f,callback:function(){o.innerHTML=a||"",s.innerHTML=f?"取消":l.likeText,f?con.addClass("photo-comment-ilike"):con.delClass("photo-comment-ilike"),s.setAttribute("data-likecount",a),s.setAttribute("data-liked",f?"1":"0")}})},_initEditor:function(e,t,n,r,i,s){this.reToId=e?e:"0",this.lightInteract=i||!1,this.commentState=s||0,$(this.toidID)&&($(this.toidID).value=this.reToId),$(this.sourceidID)&&($(this.sourceidID).value=this.sourceId),$(this.replyCommentId)&&($(this.replyCommentId).value=r>0?r:0),this._setEditorValue(t),this._setWhisper(!!n),$(this.cmtBodyID).onfocus=null},_setEditorValue:function(e){var t=$(this.cmtBodyID);if(!e)return t.value="",this._replyPreFix="",!1;var n=t.value,n=n.replace(/回复[\s\S]+：/gi,"");t.value="回复"+e+"："+n},_setWhisper:function(e){var t=$(this.whisperID);if(!t)return!1;t.removeAttribute&&t.removeAttribute("disabled"),t.checked=!!e,$("realWhisper")&&($("realWhisper").value=e?"true":!1),t=$(this.feedCommentID),t&&(t.value=e?"":"true",t.checked=!e)},_setBtnEnable:function(e,t){var n=$(this.editorBtnID);n.disabled=!e,n.value=t?t:e?this.submitBtnVal:"请稍候",n.className=e?"input-button":"input-button gray"},setLock:function(e,t){this._setBtnEnable(e,t),$(this.cmtBodyID).onfocus=function(){XN.DO.showError("禁止留言"),this.blur()}}},CommentManage={_conf:{cmtBodyID:"cmtbody",editorBtnID:"editorFormBtn",errorMsgID:"ajax_msgerror",commContainerID:"commContainer",showMoreID:"showMore",showMoreCommentsID:"showMoreComments",globalNotLazy:!1,comEditorFormID:"commentEditorForm",whisperID:"whisper",feedCommentID:"feedComment",miniEditorID:"miniEditor",miniEditorActionID:"miniEditorAction",isLightInteractID:"lightInteract",toidID:"cmttoid",replyCommentId:"replyCommentId",sourceidID:"sourceid",submitBtnVal:"发表评论",tempLoadingID:"tempLoading",oneCmtTPL:["{{#reportURL}}",'    <span class="float-right"><a target="_blank" href="{{reportURL}}" class="reply-report">举报</a></span>',"{{/reportURL}}",'    <a class="avatar" title="{{name}}" href="{{urlProfile}}"><img onload="clipImage(this)" height="50" width="50" alt="{{name}}"  {{srcAttr}}="{{headUrl}}" class="avatar"/></a>','<div class="info">',"   {{^reportURL}}",'       <span class="float-right"> <a comorder="{type:\'del\',id:\'{{id}}\',owner:\'{{owner}}\'}" class="x-to-hide" onclick="return false;" href="#nogo" alt="删除"></a></span>',"   {{/reportURL}}","   {{#whisper}}",'       <span class="whisper float-right">悄悄话</span>',"   {{/whisper}}",'       <span class="author me"><a title="{{liveUserTitle}}" href="http://www.renren.com/profile.do?id={{author}}" class="{{liveUserClass}}">{{name}}</a></span>',"   {{#isVip}}",'       &nbsp;<a href="{{urlVipActionUrl}}" target="_blank" title="VIP"><img src="{{urlVipIcon}}" alt ="VIP"/></a>',"   {{/isVip}}",'    <span class="time">{{time}}</span>',"</div>",'<div class="reply">','    <p class="content">{{{commentBody}}}',"	 {{#tagComment}}",'	 <span class="circleCommentIcon" data-id="8016305663"></span>',"	 {{/tagComment}}","	 </p>","    {{#isShowReply}}2132134","    &nbsp;<a comorder=\"{type:'reply',id:'{{author}}',whisper:{{whisper}}, cmtid:'{{id}}', lightInteract: {{lightInteract}}, state:{{state}} }\" onclick=\"return false;\" href=\"#nogo\">回复</a>","    {{/isShowReply}}","    {{^lightInteract}}",'        <div class="photo-comment-like-container {{#like}}photo-comment-ilike{{/like}}">',' 	 	    <span class="photo-comment-like-count">{{likecount_str}}</span>','	 	    <a class="photo-comment-like-btn" comorder="{type:\'like\',uid:\'{{author}}\',name:\'{{name}}\',ownerid:\'{{owner}}\',cmtid:\'{{id}}\'}" onclick="return false;" href="#nogo" data-liked="{{like}}" data-likecount="{{likecount}}">',"               {{#like}}取消{{/like}}{{^like}}{{like_text}}{{/like}}","           </a>","	     </div>","    {{/lightInteract}}","</div>"].join("")},getInstance:function(e){var t=$extend(this._conf,e||{});return new SuperComment(t)}},XN.event.enableCustomEvent(SuperComment.prototype)})(),HeadLazyload=function(){function n(n){if(t)return;t=setTimeout(function(){e._loadImgs(n),t=null},100)}var e=this,t=null;this.images=[],this.DATA_SRC="lazyload-src",this.diff=100,this.threshold=this._getThreshold(),XN.event.addEvent(window,"scroll",n),XN.event.addEvent(window,"resize",function(){e.threshold=e._getThreshold(),n(!0)})},HeadLazyload.prototype={init:function(e){this.images=[],this.diff=e||100},addContainer:function(e){var t=e.getElementsByTagName("img"),n=null,r=null,i=this.images,s=this.DATA_SRC;for(var o=0;n=t[o++];)r=n.getAttribute(s),r&&i.push(n);var u=this;setTimeout(function(){u._loadImgs(!0)},100)},_loadImgs:function(e){var t=this._getScroll();if(!e&&t<=this.diff)return;var n=this.images,r=[],i=this.threshold+t,s=null,o=null,u=this.DATA_SRC;for(var a=0;s=n[a++];){var f=$(s).realTop();f<=i&&f>t?(o=s.getAttribute(u),o&&s.src!=o&&(s.src=o,s.removeAttribute(u))):r.push(s)}this.images=r},_getThreshold:function(){var e=self.innerHeight,t=document.compatMode,n=XN.Browser.IE,r=XN.Browser.Opera;return(t||n)&&!r&&(e=t=="CSS1Compat"?document.documentElement.clientHeight:document.body.clientHeight),e},_getScroll:function(){return Math.max(document.documentElement.scrollTop,document.body.scrollTop)}},XN.namespace("ui"),XN.ui.miniEditor=function(e){$extend(this,e),this.getEmoList()},XN.ui.miniEditor.prototype=$extend({},XN.ui.element),$extend(XN.ui.miniEditor.prototype,{_emoRendered:!1,IDofEditor:"miniEditor",IDofForm:"miniEditorForm",IDofAction:"miniEditorAction",IDofEmoHolder:"miniEditorEmoHolder",IDofEmoHeader:"miniEditorEmoTabHolder",IDofEmoTab:"miniEditorEmoTab",IDofEmoList:"miniEditorEmoList",IDofTextarea:"miniEditorTextarea",IDofNotVipTip:"notVipTip",IDofUploadBtn:"addPhotoBtn",emoList:"",_emoList:null,ubbPrefix:"",ubbSuffix:"",_inputPos:{start:0,end:0,item:[0,0]},allowAddLink:!0,allowAddPhoto:!1,isVip:!1,emoAlignType:"3-2",emoOffsetX:0,emoOffsetY:-1,emoType:0,_emoKind:{0:{name:"默认表情"},1:{name:"阿狸"},2:{name:"囧囧熊"}},getEmoList:function(){var e=this,t="http://status."+XN.env.domain+"/getubblist.do?type="+this.emoType;new XN.net.xmlhttp({url:t,method:"GET",onSuccess:function(t){e.emoList=t.responseText,XN.log(e.emoList),window.setTimeout(function(){e.init()},0)},onError:XN.func.empty})},init:function(){var e=this;this.initAction(),this.renderEmotion();try{this.renderUploadPhoto()}catch(t){}XN.event.addEvent($(this.IDofTextarea),"keyup",function(){e.getInputPos()}),XN.event.addEvent($(this.IDofTextarea),"mouseup",function(){e.getInputPos()}),XN.event.addEvent($(this.IDofTextarea),"focus",function(){setTimeout(function(){e.getInputPos()},10)}),$("emoBtn")&&(XN.event.addEvent($("emoBtn"),"click",function(t){XN.event.stop(t||window.event),e._emoRendered||e.renderEmotion(),e.showEmotion()}),XN.event.addEvent($(this.IDofEmoHolder),"click",function(t){var t=t||window.event;t.ctrlKey&&XN.event.stop(t),e.parseEmotion(t)}),XN.event.addEvent(document,"click",function(t){e.hideEmotion(t)}),XN.event.addEvent($(this.IDofEmoHolder),"mouseover",function(t){XN.event.stop(t||window.event),e.previewEmotion(t)}),XN.event.addEvent($(this.IDofEmoHolder),"mouseout",function(t){e.hidePreviewEmotion(t)})),$("addLinkBtn")&&XN.event.addEvent($("addLinkBtn"),"click",function(t){XN.event.stop(t||window.event),e.showAddLinkFlyer()}),XN.log("miniEditor inited")},initAction:function(){this.allowAddLink&&$(this.IDofAction).appendHTML('<a href="###" id="addLinkBtn" class="m-editor-addlink">链接</a>'),this.allowAddPhoto&&$(this.IDofAction).appendHTML('<span href="###" class="m-editor-photo"><span id="'+this.IDofUploadBtn+'"></span><span id="miniEditorPhotoInfo"></span><a id="miniEditorDeletePhoto" href="#nogo" class="delete" style="display:none">删除</a></span>'),$(this.IDofAction).appendHTML('<a href="###" id="emoBtn" class="m-editor-emo">表情</a>')},showEmotion:function(){XN.log("show emotion");var e=this;this._emoClicked||(setTimeout(function(){$(e.IDofEmoList).innerHTML=$(e.IDofEmoList).innerHTML.replace(/emosrc/g,"src")},0),this._emoClicked=!0),this._emoHolder.show()},hideEmotion:function(){XN.log("hide emotion"),this._previewHolder&&this._previewHolder.hide(),this._emoHolder&&this._emoHolder.hide()},renderEmotion:function(){if(!this.emoList){$("emoBtn").hide();return}var e=this._emoList=XN.json.parse(this.emoList).ubbList,t={},n={},r={},i="",s="",o="",u="",a=0,f=[];for(var l in this._emoKind)t[l]=[],n[l]="",r[l]=this._emoKind[l].name;for(var c=0;c<e.length;c++){var h="";XN.browser.IE6&&(h=" onmouseover='this.style.borderColor=\"#808080\"' onmouseout='this.style.borderColor=\"#B8D4E8\"'"),e[c].size==2&&(s=' preview="true" '),e[c].kind==1||e[c].kind==2?o=' forvip="true" ':o=' forvip="false" ',t[e[c].kind].push('<li title="'+e[c].alt+'" '+h+'><img emosrc="http://a.xnimg.cn/'+e[c].src+'" alt="'+e[c].alt+'" emotion="'+e[c].ubb+'"'+s+o+" /></li>")}var p='style="display:block"';for(var l in t)t[l].length>0&&(n[l]='<ul class="emo-list" '+p+' id="emoList'+l+'">',n[l]+=t[l].join(""),n[l]+="</ul>",$(this.IDofEmoList).appendHTML(n[l]),$(this.IDofEmoTab).appendHTML('<li id="emoTab'+l+'"><a href="###" onfocus="this.blur()">'+"&nbsp;"+r[l]+"&nbsp;"+i+"</a></li>"),a++,f.push(l),p='style="display:none"');if(a>1){var d=this;$(this.IDofEmoHeader).show();var v=new XN.ui.tabView({activeClass:"current"});for(var c=0;c<f.length;c++)v.addTab({label:"emoTab"+f[c],active:c==0,onActive:function(e){return function(){var t=v.getCurrentTab().label;$(t.id.replace("emoTab","emoList")).hide(),$("emoList"+f[e]).show(),d._previewHolder&&d._previewHolder.hide(),d.hideNotVip()}}(c)})}var m={alignWith:this.IDofTextarea,tagName:"div",alignType:this.emoAlignType,offsetX:this.emoOffsetX,offsetY:this.emoOffsetY};this._emoHolder=new XN.ui.fixPositionElement(m),this._emoHolder.setContent($(this.IDofEmoHolder)),this._emoHolder.hide(),$(this.IDofEmoHolder).show(),this._emoRendered=!0,XN.log("emotion render ok")},parseEmotion:function(e){var t=XN.event.element(e),n=this;t.tagName.toLowerCase()=="li"&&(t=t.getElementsByTagName("img")[0]);if(t&&t.tagName.toLowerCase()=="img"){var r=t.getAttribute("forvip")==="true",i=t.getAttribute("emotion"),s=n.isVip;r&&!s?n.showNotVip(e):n.addEmotion(i)}},addEmotion:function(e){this._inputHelper||(this._inputHelper=new XN.FORM.inputHelper($(this.IDofTextarea)));var t=$(this.IDofTextarea),n=this._inputPos,r=this;this.ubbPrefix&&(e=this.ubbPrefix+e),this.ubbSuffix&&(e+=this.ubbSuffix);var i=XN.form.help(t).getRealValue();i==""&&XN.form.help(t).focus(),setTimeout(function(){t.value=i.slice(0,n.start)+e+i.slice(n.end),XN.form.help(t).focus(n.start+e.length),r.getInputPos()},10)},showNotVip:function(e){$(this.IDofEmoList).hide(),$(this.IDofNotVipTip).show(),this._previewHolder&&this._previewHolder.hide(),XN.event.stop(e||window.event)},hideNotVip:function(e){$(this.IDofNotVipTip).hide(),$(this.IDofEmoList).show()},previewEmotion:function(e){img=XN.event.element(e);var t=this;img.tagName.toLowerCase()=="a"&&(img=img.getElementsByTagName("img")[0]);if(img&&img.tagName.toLowerCase()=="img"){var n=img.getAttribute("preview");if(n){if(!this._previewHolder){var r={alignWith:this.IDofEmoList,tagName:"div",alignType:"2-2",offsetX:XN.browser.IE6?-1:XN.browser.IE?1:0,offsetY:XN.browser.IE?1:0};this._previewHolder=new XN.ui.fixPositionElement(r),this._previewHolder.container.setStyle("background:#fff;padding:1px;width:50px;height:50px;border:1px solid #B8D4E8;"),this._previewHolder.container.className="meditor-emo-preview",this._previewHolder.container.id="mEditorPreviewHolder",this._previewHolder.setContent('<img id="previewIMG" class="m-editor-preview-img" src="'+img.src+'" />'),XN.event.addEvent($("mEditorPreviewHolder"),"mouseover",function(){var e=t._previewHolder.alignType=="1-1"?"2-2":"1-1";if(XN.browser.IE6){var n=t._previewHolder.alignType=="1-1"?-1:1;t._previewHolder.setOffsetX(n)}t._previewHolder.setAlignType(e)})}this._previewHolder.hide(),$("previewIMG").src=img.src,this._previewHolder.show()}}},hidePreviewEmotion:function(e){el=XN.event.element(e),el.tagName.toLowerCase()=="ul"&&this._previewHolder&&this._previewHolder.hide()},showAddLinkFlyer:function(){var e=this,t=this._inputPos,n="";t.start!=t.end&&(n="display:none");var r='<div style="text-align:center;"><label style="display:block;margin:5px 0;">网址：<input type="text" class="input-text" id="mEditorUrl" style="width:230px;" /></label><label style="display:block;margin:5px 0;'+n+'">文字：<input type="text" class="input-text" id="mEditorTxt" style="width:230px;" /></label>'+"</div>";XN.DO.confirm({msg:r,title:"添加链接",yes:"添加",callBack:function(t){t&&e.addLink()}})},addLink:function(){var e=$("mEditorUrl").value,t="",n=$(this.IDofTextarea),r=this._inputPos,i=this;if(!e)return;this._inputHelper||(this._inputHelper=new XN.FORM.inputHelper($(this.IDofTextarea))),r.start!=r.end?t=n.value.slice(r.start,r.end):(t=$("mEditorTxt").value,t||(t=e)),/^(http:\/\/|https:\/\/)/.test(e)||(e="http://"+e);var s="[url="+encodeURI(e)+"]"+t+"[/url]";n.value=n.value.slice(0,r.start)+s+n.value.slice(r.end),n.blur(),setTimeout(function(){i._inputHelper.focus(r.start+s.length),i.getInputPos()},10)},renderUploadPhoto:function(){var e=$(this.IDofUploadBtn);if(!e)return;if(!window.SWFUpload)return;var t=$(this.IDofUploadBtn).parentNode,n=this,r=new SWFUpload({upload_url:"http://upload."+XN.env.domain+"/uploadservice.fcgi?pagetype=gossipAddPhoto&societyguester="+XN.cookie.get("societyguester")+"&hostid="+XN.cookie.get("id")+"&t="+XN.cookie.get("t"),flash_url:"http://s.xnimg.cn/jspro/swfupload.v2.2.0.1/swfupload.swf",file_size_limit:"10 MB",file_types:"*.jpg;*.jpeg;*.png;*.bmp;*.gif",file_types_description:"All Image Files",file_upload_limit:60,file_queue_limit:0,debug:!1,button_placeholder_id:this.IDofUploadBtn,button_cursor:SWFUpload.CURSOR.HAND,button_width:28,button_height:23,button_image_url:"http://a.xnimg.cn/a.gif",button_text:'<span class="text">图片</span>',button_text_style:".text {text-align:left;color:#005EAC;font-family:tahoma,simsun;font-size:12px;font-family:Tahoma,Verdana,simsun,sans-serif;}",button_text_top_padding:2,button_action:SWFUpload.BUTTON_ACTION.SELECT_FILE,button_cursor:SWFUpload.CURSOR.HAND,button_window_mode:SWFUpload.WINDOW_MODE.TRANSPARENT,file_queued_handler:function(){try{r.setButtonDimensions(0,0)}catch(e){XN.DO.showError("对不起，你的浏览器暂时不支持此功能，请更换浏览器。")}this.startUpload()},upload_error_handler:function(e,t,n){XN.DO.showError(n+""+t+""+e)},upload_progress_handler:function(e,t,n){$("miniEditorPhotoInfo").show(),$("miniEditorPhotoInfo").innerHTML="正在添加... "+parseInt(t/n*100)+"%"},upload_success_handler:function(e,t){function i(){$("emoBtn").show(),r.setButtonDimensions(28,23),r.setButtonText('<span class="text">图片</span>'),$($("miniEditorPhotoInfo").parentNode).delClass("attached"),$("miniEditorDeletePhoto").hide(),$("miniEditorPhotoInfo").hide(),$("gossipLargeUrl").value="",$("gossipHeadUrl").value="",window.commentPost&&(commentPost.hasPhoto=!1),n.fireEvent("uploadDel")}function o(e,t){return t||(t=10),e.length>t?e.substr(0,t)+"...":e}var r=this,s=XN.json.parse(t);if(s.code!=1){XN.DO.showError(s.msg),i();return}$("gossipLargeUrl").value=s.large,$("gossipHeadUrl").value=s.thumbnail,$("emoBtn").hide(),$("miniEditorPhotoInfo").innerHTML=o(e.name.substr(0,e.name.lastIndexOf(".")),10)+e.type,$($("miniEditorPhotoInfo").parentNode).addClass("attached"),$("miniEditorPhotoInfo").className="file-name",$("miniEditorPhotoInfo").show(),$("miniEditorDeletePhoto").show(),$("miniEditorDeletePhoto").onclick=i,this.setButtonDimensions(0,0),window.commentPost&&(commentPost.afterPost=i,commentPost.hasPhoto=!0),n.fireEvent("uploadSus",{restore:i})}})},getInputPos:function(){var e=$(this.IDofTextarea),t=0,n=0;if(typeof e.selectionStart=="number")t=e.selectionStart,n=e.selectionEnd;else if(document.selection){var r=document.selection.createRange();if(r.parentElement()==e){var i=document.body.createTextRange();i.moveToElementText(e);for(t=0;i.compareEndPoints("StartToStart",r)<0;t++)i.moveStart("character",1);for(var s=0;s<=t;s++)e.value.charAt(s)=="\n"&&t++;var i=document.body.createTextRange();i.moveToElementText(e);for(n=0;i.compareEndPoints("StartToEnd",r)<0;n++)i.moveStart("character",1);for(var s=0;s<=n;s++)e.value.charAt(s)=="\n"&&n++}}this._inputPos={start:t,end:n,item:[t,n]},XN.log(this._inputPos)}}),XN.event.enableCustomEvent(XN.ui.miniEditor.prototype),XN.dom.ready(function(){Sizzle(".album-home #cmtbody")[0]&&($("cmtbody").getAttribute("ispv")=="true"?object.use("xn.mention",function(e,t){t.mention.Mention.init([{obj:Sizzle(".album-home #cmtbody")[0],popTop:!0,ugcId:_PCI.albumId,ugcType:"album",ownerId:_PCI.albumOwner||_PCI.ownerId}])}):object.use("xn.mention",function(e,t){t.mention.Mention.init([{obj:Sizzle(".album-home #cmtbody")[0],ugcId:_PCI.albumId,ugcType:"album",ownerId:_PCI.albumOwner||_PCI.ownerId}])}))},!0);