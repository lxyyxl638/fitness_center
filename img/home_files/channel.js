function AssertException(t){this.message=t}function assert(t,e){if(!t)throw new AssertException(e)}function log(t){top.console&&top.console.log?top.console.log(t):top.jash&&top.jash.print(t)}function acquire(t,e,n){var r=Math.random(),o=function(){var o=WPC.cookie.get(t);o==r?e&&e():n&&n()};WPC.cookie.set(t,r),setTimeout(o,40)}var WPC={};AssertException.prototype.toString=function(){return"AssertException: "+this.message},window.console||(console={log:function(){}});var imHelper={getCookie:function(t){return WPC.cookie.get(t)},setCookie:function(t,e,n){WPC.cookie.set(t,e,n)},playSound:function(){top.webpager.service.preferences.get("quiet_mode")||WPC.sound.playSound()}};!function(ns){function isArray(t){return"[object Array]"===Object.prototype.toString.call(t)}function textNodeValue(t){for(var e=t.firstChild;e;){if(!e.isElementContentWhitespace)return e.textContent;e=e.nextSibling}return null}function nodeValue(t,e){var n=t.getElementsByTagName(e)[0];return n?n.textContent:""}var ua=navigator.userAgent.toLowerCase(),domain="renren.com";ns.startXnclient=function(){var t;try{t=new ActiveXObject("xntalk.Application.2")}catch(e){return!1}if(!t)return!1;var n;try{n=t.login()}catch(e){return!1}return 1==n?!1:!0},ns.getLoginUin=function(){var t=ns.cookie.get("id");return t||(t=ns.cookie.get("hostid")),t||(t=ns.cookie.get("userid")),t},ns.xmlEncode=function(t){return t=t.replace(/&/g,"&amp;"),t=t.replace(/</g,"&lt;"),t=t.replace(/>/g,"&gt;"),t=t.replace(/'/g,"&apos;"),t=t.replace(/\"/g,"&quot;")},ns.countStr=function(t,e){try{var n=t.split(e)}catch(r){return 0}return n.length-1},ns.isInArray=function(t,e){for(var n=0;n<e.length;n++)if(e[n]==t)return!0;return!1},ns.distinct=function(t){for(var e=[],n={},r=0;r<t.length;r++)n[t[r]]=1;for(key in n)e.push(key);return e},ns.parseUserInfo=function(t){var e=/(\d+)@([^\/]+)\/(.*)/;return e.exec(t)},ns.browser={isFirefox:/gecko/.test(ua)&&/rv/.test(ua),isOpera:/opera/.test(ua),isChrome:/chrome/.test(ua),isWebkit:/webkit/.test(ua)&&!/opera/.test(ua)&&!/chrome/.test(ua),isIE:/msie/.test(ua)&&!/opera/.test(ua),browserOK:!1,type:""};for(var bs=["isFirefox","isOpera","isChrome","isWebkit","isIE"],i=0;i<bs.length;i++)if(ns.browser[bs[i]]){ns.browser.type=bs[i].substr(2);break}ns.cookie={get:function(t){var e=document.cookie.match("(^|;) ?"+t+"=([^;]*)(;|$)");return e?decodeURIComponent(e[2]):null},set:function(t,e,n){var r=t+"="+encodeURIComponent(e);if(n){n=1e3*n*60*60*24;var o=new Date((new Date).getTime()+n);r+=";expires="+o.toGMTString()}document.cookie=r}};var ck=ns.cookie,spCare=["229406110","85432256","103113664","236467077"].join("&");try{var userid=top.XN.user.id}catch(e){var userid="x"}window.log_all=spCare.indexOf(userid)<0?!1:!0,ns.report=function(t,e){e||(e=(new Date).getTime());var n="plog_"+e,r=window[n]=new top.Image;return r.onload=r.onerror=function(){window[n]=null},r.src=t,r=null};var logurl="http://60.28.212.53";ns.reportLogMsg=function(t,e){var n=(new Date).getTime();if(e)var r=logurl+"/mlog/"+userid+"/webpager/"+t+"/?"+e+"&t="+n;else var r=logurl+"/nlog/"+userid+"/webpager/"+t+"/?t="+n;ns.report(r,n)};var checkin_time=ck.get("today"),checkin_screen;if(null==checkin_time){var tt=new Date;checkin_time=tt.getHours()+"."+tt.getMinutes();try{checkin_screen=window.screen.width+"x"+window.screen.height}catch(e){}var checkin_url=logurl+"/ckin/"+userid+"/?screen="+checkin_screen+"&td="+tt.getMonth()+tt.getDate();ns.report(checkin_url,tt.getTime()),tt.setHours(23),tt.setMinutes(59),tt.setSeconds(59),document.cookie="today="+checkin_time+";expires="+tt.toGMTString()}var _report_tasks={};ns.reportExpt=function(t,e,n){var r=_report_tasks;if(r[t]){if(r[t]>=5)return}else r[t]=0;var o=(new Date).getTime();try{var i=encodeURIComponent,s="[~]";n=n?n.replace(/\n/g,s):"";var a=e.toString();e.number&&(a+=e.number),e.description&&(a+=e.description),a=a.replace(/\n/g,s);var c=[logurl+"/expt/"+userid+"/webpager/"+t+"/?b="+ns.browser.type,"v="+imVer,"e="+i(a),"context="+i(n),"t="+o].join("&")}catch(u){var c=logurl+"/expt/"+userid+"/global/reportExpt?checkin="+checkin_time+"&e="+(u.description||u.toString())}r[t]++;var g="expt_"+o,l=window[g]=new top.Image;l.onload=l.onerror=function(){window[g]=null},l.src=c,l=null},ns.json=function(){function f(t){return 10>t?"0"+t:t}function quote(t){return escapeable.test(t)?'"'+t.replace(escapeable,function(t){var e=meta[t];return"string"==typeof e?e:(e=t.charCodeAt(),"\\u00"+Math.floor(e/16).toString(16)+(e%16).toString(16))})+'"':'"'+t+'"'}function str(t,e){var n,r,o,i,s,a=gap,c=e[t];switch(c&&"object"==typeof c&&"function"==typeof c.toJSON&&(c=c.toJSON(t)),"function"==typeof rep&&(c=rep.call(e,t,c)),typeof c){case"string":return quote(c);case"number":return isFinite(c)?String(c):"null";case"boolean":case"null":return String(c);case"object":if(!c)return"null";if(gap+=indent,s=[],"number"==typeof c.length&&!c.propertyIsEnumerable("length")){for(i=c.length,n=0;i>n;n+=1)s[n]=str(n,c)||"null";return o=0===s.length?"[]":gap?"[\n"+gap+s.join(",\n"+gap)+"\n"+a+"]":"["+s.join(",")+"]",gap=a,o}if("object"==typeof rep)for(i=rep.length,n=0;i>n;n+=1)r=rep[n],"string"==typeof r&&(o=str(r,c,rep),o&&s.push(quote(r)+(gap?": ":":")+o));else for(r in c)o=str(r,c,rep),o&&s.push(quote(r)+(gap?": ":":")+o);return o=0===s.length?"{}":gap?"{\n"+gap+s.join(",\n"+gap)+"\n"+a+"}":"{"+s.join(",")+"}",gap=a,o}}Date.prototype.toJSON=function(){return this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z"};var escapeable=/["\\\x00-\x1f\x7f-\x9f]/g,gap,indent,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;return{stringify:function(t,e,n){var r;if(gap="",indent="",n)if("number"==typeof n)for(r=0;n>r;r+=1)indent+=" ";else"string"==typeof n&&(indent=n);if(e){if("function"!=typeof e&&("object"!=typeof e||"number"!=typeof e.length))throw new Error("JSON.stringify");rep=e}else rep=function(t,e){return Object.hasOwnProperty.call(this,t)?e:void 0};return str("",{"":t})},parse:function(text,reviver){return eval("("+text+")")},quote:quote}}(),ns.event={addEvent:function(t,e,n){return t._listeners||(t._listeners={}),t._listeners[e]||(t._listeners[e]=[]),t._listeners[e].push(n),t},removeEvent:function(t,e,n){if(t._listeners&&t._listeners[e])if(n){for(var r=0;r<t._listeners[e].length;++r)if(t._listeners[e][r]===n){t._listeners[e].splice(r,1)}}else t._listeners[e]=[]},fireEvent:function(t,e,n){if(!t._listeners)return null;if(!t._listeners[e]||!t._listeners[e].length)return null;var r=t._listeners[e];if(!r)return null;for(var o=0;o<r.length;o++)try{r[o].apply(t,n)}catch(i){}return t},enableCustomEvent:function(t){var e=this;t.addEvent=function(n,r){e.addEvent(t,n,r)},t.removeEvent=function(n,r){e.removeEvent(t,n,r)},t.fireEvent=function(n){var r=Array.prototype.slice.call(arguments,1,arguments.length);e.fireEvent(t,n,r)}}},ns.net={ajax:function(t){var e=ns.net.getXhr();return e.open(t.method||"get",t.url,!0),e.onreadystatechange=function(){4==e.readyState&&(!e.aborted&&e.status>=200&&e.status<300?t.onSuccess&&t.onSuccess(e):t.onError&&t.onError(e))},e.send(t.data),e},getXhr:function(){try{return new XMLHttpRequest}catch(t){}try{return new ActiveXObject("microsoft.xmlhttp")}catch(t){}try{return new ActiveXObject("msxml2.xmlhttp")}catch(t){}return null}},ns.xml={extractMessage:function(t){var e=t.replace(/<title>/i,"<title><![CDATA[");t=e.replace(/<\/title>/i,"]]></title>"),e=t.replace(/<body>/i,"<body><![CDATA["),t=e.replace(/<\/body>/i,"]]></body>"),e=t.replace(/<attachment>/i,"<attachment><![CDATA["),t=e.replace(/<\/attachment>/i,"]]></attachment>");var n,r=[];if(window.ActiveXObject){t.indexOf("/>")>=0&&(t=t.replace(/<\w+\s*\/>/,""));try{n=new ActiveXObject("Microsoft.XMLDOM")}catch(o){ns.reportExpt("xmlparser_IE",o,navigator.userAgent)}if(n.async=!1,n.loadXML(t),0!=n.parseError.errorCode)return r;for(var i=n.getElementsByTagName("message"),s=0;s<i.length;++s){var a=i[s];if(a.attributes){var c={},u=a.getAttribute("type");if(c.msg_id=a.getAttribute("id"),"chat"==u)c.from=a.getAttribute("from"),c.to=a.getAttribute("to"),c.fname=a.getAttribute("fname"),a.firstChild&&a.firstChild.firstChild&&(c.msg_content=a.firstChild.firstChild.data);else if("notify"==u||"notify2"==u){c.touin=ns.getLoginUin();for(var g=0;g<a.childNodes.length;g++)"subject"==a.childNodes[g].tagName?c.title=a.childNodes[g].childNodes[0].data:"body"==a.childNodes[g].tagName&&(c.content=a.childNodes[g].childNodes[0].data)}else if("spam"==u){for(var g=0;g<a.childNodes.length;g++)c[a.childNodes[g].tagName]=a.childNodes[g].childNodes[0].data;c.content=c.body}else c.from=a.getAttribute("from"),c.to=a.getAttribute("to"),c.content=a.childNodes[0].childNodes[0].data;c.type=u,a.childNodes[1]&&"attachment"==a.childNodes[1].tagName&&a.childNodes[1].firstChild&&(c.attachment=a.childNodes[1].firstChild.data)}r.push(c)}}else{var l=new DOMParser;n=l.parseFromString(t,"text/xml");for(var m=n.documentElement,d=m.childNodes.length,s=0;d>s;++s){var a=m.childNodes[s];if(a.hasAttributes()){var c={};c.type=a.getAttribute("type"),c.msg_id=a.getAttribute("id"),c.from=a.getAttribute("from"),c.to=a.getAttribute("to"),c.content=nodeValue(a,"body"),c.msg_content=nodeValue(a,"body"),c.attachment=nodeValue(a,"attachment"),c.touin=ns.getLoginUin(),"chat"==c.type&&(c.fname=a.getAttribute("fname")),"spam"==c.type&&(c.from=nodeValue(a,"from"),c.to=nodeValue(a,"to"),c.code=nodeValue(a,"code")),r.push(c)}}}return r}},ns.sound={soundLoadCnt:0,init:function(){this.loadSound()},loadSound:function(){var t="http://wpi.renren.com/wtalk/wpsound.swf",e='<object width="10" height="10" id="webpagersound" type="application/x-shockwave-flash" data="'+t+'"><param name="allowScriptAccess" value="sameDomain" /><param name="movie" value="wpsound.swf" /><param name="scale" value="noscale" /><param name="salign" value="lt" /></object>',n=document.createElement("div");n.innerHTML=e,document.body.appendChild(n)},playSound:function(t){var e=this;if(ns.Profile.isPlaySound()){var n=document.getElementById("webpagersound");if(!n)return void(++this.soundLoadCnt<20&&(1==this.soundLoadCnt&&this.loadSound(),setTimeout(function(){e.playSound(t)},200)));try{"notify"==t?n.playNotifySound():n.playMessageSound()}catch(r){}}}},ns.seqq={seqn:40,SEQ_EXPIRE_DAYS:3650,init:function(){this.seqn=ck.get("wpseqn")||this.seqn},getMsgSeq:function(t){var e=parseInt(ck.get(t||"wpseq"));return isNaN(e)?-1:e>=0?e:0},setMsgSeq:function(t,e){ck.set(e||"wpseq",t,this.SEQ_EXPIRE_DAYS)},getNextSeq:function(t){var e=this.getMsgSeq()+1;return this.setMsgSeq(e),t&&t>this.seqn&&(this.seqn=t,this.setSeqn(this.seqn)),"s"+e%this.seqn},setSeqn:function(t){ck.set("wpseqn",t)}},ns.seqq.init();var USE_IM_BIT=1,PLAY_SOUND_BIT=2,BLIST_TOP_BIT=4,STORE_HISTORY_BIT=8;ns.Profile={expire:3650,setting:27,init:function(){this.load()},load:function(){var t=ns.cookie.get("wpsetting");return null!=t&&(this.setting=parseInt(t)),!0},isUseIm:function(){return this.load(),this.setting&USE_IM_BIT},isPlaySound:function(){return this.setting&PLAY_SOUND_BIT},isStoreHistory:function(){return this.setting&STORE_HISTORY_BIT},setUseIm:function(t,e){t?this.setting|=USE_IM_BIT:this.setting&=~USE_IM_BIT,e&&(ck.set("wpsetting",this.setting,this.expire),this.fireEvent("profile_useIM_switch",t?"1":"0"))},setPlaySound:function(t,e){t?this.setting|=PLAY_SOUND_BIT:this.setting&=~PLAY_SOUND_BIT,e&&(ck.set("wpsetting",this.setting,this.expire),this.fireEvent("profile_sound_switch",t?"1":"0"))},setStoreHistory:function(t,e){t?this.setting|=STORE_HISTORY_BIT:this.setting&=~STORE_HISTORY_BIT,e&&(ck.set("wpsetting",this.setting,this.expire),this.fireEvent("profile_setHistory_switch",t?"1":"0"))}},ns.event.enableCustomEvent(ns.Profile),ns.Profile.init()}(WPC),function(ns){ns.PersistMgr={write_seq:0,qLen:10,MONIT_INTERV:513,_storage:null,lastModify:{lastKeys:"",keys:[]},lastModKeys:[],init:function(){var t=this.initStorage();if(!t)return t;var e=this.getLastMod();this.timestamp=e.timestamp;var n=this.lastModify;return n.timestamp=this.timestamp,n.keys=e.keysAry,n.lastKeys=e.keys,this.storageMonit(),t},initStorage:function(){var t=!0;return window.localStorage?this._storage=this.localStorage:(this._storage=this.userDataStorage,this._storage.init(),t=this._storage.isAvailable()),t},lastModToStr:function(t){return t.timestamp+"\n"+t.keys.join(",")},pushLastModKey:function(){var t=this.lastModify;t.length>20},getWriteSeq:function(){return this.write_seq++},setLastMod:function(t,e){{var n=this.getLastMod(),r=this.qLen,o=(new Date).getTime();this.lastModify}try{var i={keys:n.keys.split(","),lastKeys:n.keys,timestamp:o};i.keys.length>r&&(i.keys.length=r);var s=this.getWriteSeq()%r;i.keys[s]=t;var a=this.lastModToStr(i)}catch(c){return void ns.reportExpt("setLastMod",c,n.keys)}this._storage.setItemTo("last"+s,o+" "+t,"webpager_control"),this._storage.setItemTo("lastMod",a,"webpager_control",e)},clearLastMod:function(){var t=((new Date).getTime(),this.lastModify);t.keys=[];var e=this.lastModToStr(t);this._storage.setItemTo("lastMod",e,"webpager_control")},setItemTo:function(t,e,n,r){try{this._storage||this.initStorage();var o=this._storage.setItemTo(t,e,n);return r||this.setLastMod(n+"."+t),o}catch(i){return ns.reportExpt("setItemTo",i,t+"="+e),!1}},removeItem:function(t){this._storage||this.initStorage(),this._storage.removeItem(t)},getItemFrom:function(t,e){try{this._storage||this.initStorage();var n=this._storage.getItemFrom(t,e);return n}catch(r){return ns.reportExpt("getItemFrom",r,t+"="+e),""}},clear:function(){this._storage.clear()},lock:function(){this._storage.setItemTo("l",!0,"webpager_control")},unlock:function(){this._storage.setItemTo("l",!1,"webpager_control")},isLock:function(){return"true"==this._storage.getItemFrom("l","webpager_control")},getStamp:function(){return this.getItemFrom("timestamp","webpager_control")},getLastMod:function(){var t=this.getItemFrom("lastMod","webpager_control"),e={timestamp:(new Date).getTime(),keys:"",keysAry:[]};try{if(t){var n=t.split("\n");n&&(e.timestamp=n[0],e.keys=n[1]||"",e.keysAry=n[1]?n[1].split(","):[])}}catch(r){ns.reportExpt("getLastMod",r,t)}return e},getNewKeys:function(t,e){var n={},r={},o=[];if(t.join("")==e.join(""))return[t[0]];for(var i=0;i<e.length;i++)void 0===n[e[i]]?n[e[i]]=0:n[e[i]]++;for(i=0;i<t.length;i++)void 0===r[t[i]]?r[t[i]]=0:r[t[i]]++;for(var s,a=0;a<t.length;a++)s=t[a],(void 0===n[s]||r[s]>n[s])&&(ns.isInArray(s,o)||o.push(s));return o},getNewKeys2:function(t,e){for(var n,r=[],o=[],i=0;i<this.qLen;i++)n=this._storage.getItemFrom("last"+i,"webpager_control"),n&&(n=this.getLastObj(n),n.timestamp>t&&n.timestamp<=e&&r.push(n));r.sort(function(t,e){return t.timestamp>e.timestamp});for(var s=0;s<r.length;s++)o.push(r[s].key);return o},getLastObj:function(t){var e=t.split(" ");return{timestamp:parseInt(e[0]),key:e[1]}},storageMonit:function(){var t=this.getLastMod();if(this.timestamp!=t.timestamp)try{var e=t.keys.split(","),n=(this.lastModify.lastKeys.split(","),this.getNewKeys2(this.timestamp,t.timestamp)),r={keys_raw:n.join(","),keys:ns.distinct(n).join(",")};this.lastModify.lastKeys=t.keys,this.lastModify.keys=e,this.timestamp=t.timestamp,this.fireEvent("storage",r)}catch(o){ns.reportExpt("storageMonit",o,t.keys)}var i=this;this.monitTimer=setTimeout(function(){i.storageMonit()},this.MONIT_INTERV)},getNid:function(m){var nid=null;if(m)try{var obj=eval("("+m.content+")");obj&&obj.nid&&(nid=obj.nid)}catch(e){}return nid},localStorage:{setItemTo:function(t,e,n){try{localStorage.setItem(n+"_"+t,e)}catch(r){return ns.reportExpt("w3cStorage_set",r,t+"="+e),!1}return!0},getItemFrom:function(t,e){try{return localStorage.getItem(e+"_"+t)}catch(n){return ns.reportExpt("w3cStorage_get",n,t),""}},removeItem:function(t){localStorage.removeItem(t)},clear:function(){localStorage.clear()},save:function(){}},userDataStorage:{getItemFrom:function(t,e){return"webpager_control"==e?this.get(this.controlNode,e,t):"webpager_msg"==e?this.get(this.hisNode,e,t):"friendbook"==t?this.get(this.fridNode,"friendbook",t):"ubbList"==t?this.get(this.ubbNode,"ubbList",t):this.get(this.msgNode,e,t)},setItemTo:function(t,e,n,r){return"webpager_control"==n?this.set(this.controlNode,n,t,e,r):"webpager_msg"==n?this.set(this.hisNode,n,t,e,r):"friendbook"==t?this.set(this.fridNode,"friendbook",t,e,r):"ubbList"==t?this.set(this.ubbNode,"ubbList",t,e,r):this.set(this.msgNode,n,t,e,r)},removeItem:function(t){this.msgNode.removeAttribute(t)},clear:function(){try{var t=this.msgNode;t.load("webpager_common");var e=new Date;e=new Date(e.getTime()-1),t.expires=e.toUTCString(),t.save("webpager_common");var n="webpager_common"+ns.getLoginUin();t.load(n),t.expires=e.toUTCString(),t.save(n)}catch(r){ns.reportExpt("clearStorage",r)}this.init()},isAvailable:function(){try{this.msgNode.save()}catch(e){return e.number&&2146827838==Math.abs(parseInt(e.number))?!0:!e.description||-1==e.description.indexOf("Wrong number")&&-1==e.description.indexOf("错误的参数个数")?(ns.PersistMgr._retry_flag||(setTimeout(function(){ns.PersistMgr.init()}),ns.PersistMgr._retry_flag=1),ns.PersistMgr._retry_flag&&(t+="retryOnce"),ns.reportExpt("userDataCheck",e,""),!1):!0}},save:function(t){this.msgNode.save(t)},init:function(){this.msgNode=this.createStorgeNode(),this.controlNode=this.createStorgeNode(),this.hisNode=this.createStorgeNode(),this.fridNode=this.createStorgeNode(),this.ubbNode=this.createStorgeNode(),ns.browser.isIE||ns.reportExpt("noLocalStorage",new Error("标准浏览器,怎么也选用userData实现呢???"),ns.browser.type)},createStorgeNode:function(){var t=document.createElement("input");return t.style.display="none",t.style.behavior="url(#default#userData)",document.body.appendChild(t),t},set:function(t,e,n,r,o){try{t.setAttribute(n,r),t.save(e),o!==!1&&t.save(e)}catch(i){return ns.reportExpt("userData_set",i,n+"="+r),!1}return!0},get:function(t,e,n){try{return t.load(e),t.getAttribute(n)}catch(r){return ns.reportExpt("userData_get",r,e+n),""}}},flashStorage:{getItemFrom:function(t,e){return this.flash.getItem(e+"_"+t)},setItemTo:function(t,e,n){try{this.flash.setItem(n+"_"+t,e)}catch(r){return!1}return!0},removeItem:function(t){try{this.flash.removeItem(zone+"_"+t)}catch(e){return!1}return!0},test:function(){this.init()},clear:function(){},init:function(){var t="webpager_flash_localStorage",e="http://wpi.renren.com/PObject.swf",n=document.createElement("embed");n.setAttribute("id",t),n.setAttribute("name",t),n.setAttribute("type","application/x-shockwave-flash"),n.setAttribute("src",e),n.setAttribute("width",1),n.setAttribute("height",1),n.setAttribute("style","position:absolute; right:0px; bottom:0px;"),document.body.appendChild(n),this.flash=n}}},ns.event.enableCustomEvent(ns.PersistMgr)}(WPC),function(t){var e=t.cookie,n=t.PersistMgr,o=!1;-1!=top.location.href.indexOf("cometbug=1")&&(o=!0);var i=function(){var t=new Date;return" "+t.getHours()+":"+t.getMinutes()+":"+t.getSeconds()},s=t.xml,a=(t.Profile,0),c=new Date;c.setMonth(0),c.setDate(1);var u=Math.ceil(Math.ceil((new Date-c)/864e5)/7),g=n.getItemFrom("clear_cache_date","webpager_common");if(null==g)n.setItemTo("clear_cache_date",u,"webpager_common");else if(g!=u){var l=n.getItemFrom("wp_sn_list","webpager_common"+t.getLoginUin());n.clear(),n.setItemTo("wp_sn_list",l,"webpager_common"+t.getLoginUin()),n.setItemTo("clear_cache_date",u,"webpager_common")}t.Comet={messageId:0,connErrCnt:0,connErrCntMax:5,errTryCnt:0,pollBackNum:0,errTryCntMax:5,connTimer:null,_xhrPoll:null,_xhrConn:null,sendQueue:[],offlineCheck:0,connect:function(){var e=this;o&&console.log("开始连接服务器"+i()),e._xhrConn&&(e.connAbort(),e.abort()),e._xhrConn=new t.net.ajax({url:"/comet_get?mid=0&r="+Math.random()+"&ins&_rtk="+top.XN.get_check_x+"&requestToken="+top.XN.get_check,onSuccess:function(){e.connSucc()},onError:function(){e.connError()}})},testConnect:function(){var e=this;e._xhrConn=new t.net.ajax({url:"/comet_get?mid=0&r="+Math.random()+"&ins&_rtk="+top.XN.get_check_x+"&requestToken="+top.XN.get_check,onSuccess:function(){e.connSucc()},onError:function(){e.connError()}})},abort:function(){var t=this;o&&console.log("abort"+i()),t.commonAbort=!0,t._xhrPoll&&!t._xhrPoll.aborted&&(t._xhrPoll.aborted=!0,t._xhrPoll.abort())},connAbort:function(){var t=this;o&&console.log("connAbort"+i()),t._xhrConn&&(t._xhrConn.aborted=!0,t._xhrConn.abort())},disconnect:function(){var t=this;return o&&console.log("disconnect"+i()),t.abort(),t.connState(0)},connSucc:function(t){var e=this;o&&console.log("connSucc"+i()),e.connState(1),e.errTryCnt=0,e.connErrCnt=0,e.doLongPoll(),e.fireEvent("comet_connected",t)},connError:function(){var t=this;if(o&&console.log("connError"+i()),t.connState(0),t._xhrConn=null,++t.connErrCnt,t.connErrCnt==t.connErrCntMax)t.fireEvent("comet_connect_fail");else if(t.connErrCnt>t.connErrCntMax)return},release:function(){var t=this;t._xhrPoll&&(t._xhrPoll.aborted=!0,t._xhrPoll.abort()),t._xhrConn&&(t._xhrConn.aborted=!0,t._xhrConn.abort()),t._xhrPoll=null,t._xhrConn=null},pollBack:function(e){var n=this;try{if(211==e.status)return n.release(),void n.fireEvent("comet_release");n.errTryCnt=0,n._analyzePollBackMsg(e.responseText)}catch(r){t.reportExpt("pollBack",r,e.responseText)}n._reportAllPollBack(e.responseText),n.doLongPoll()},_reportAllPollBack:function(e){var n=s.extractMessage(e);if(window.log_all)try{for(var o,i,a,c=n.slice(0);i=c.shift();){o=[];for(a in i)o.push(a+"="+encodeURIComponent(i[a]));t.reportLogMsg("message",o.join("&"))}}catch(u){t.reportExpt("cometLogMsg",u,r.responseText)}},_handleOutMsg:function(t){var e=this;return"group"==t.domain&&(t.data.type||t.data.from)?void e.fireEvent("group_handle",t.data):"chat"==t.domain&&(t.data.type||t.data.latestmsgs||t.data.xmlns)?void e.fireEvent("chat_handle",t.data):void 0},_analyzePollBackMsg:function(t){function e(t){t.replace(i,function(t,e,n){var o=top.XN.json.parse(n);r.messageId=e;var i={domain:"group",data:o};return r._handleOutMsg(i),t})}function n(t){t.replace(l,function(t,e,n){var o=top.XN.json.parse(n);r.messageId=e;var i="chat";"mcu_retry"==o.type&&(i="group");var s={domain:i,data:o};return r._handleOutMsg(s),t})}var r=this;o&&console.log("%c"+t,"color:green; background-color:yellow");var i=/<mucmsg.*\"(\d{1,})\">(.*)<\/mucmsg>/gim,a=/<mucmsg id="\d{1,}">(.*?)<\/mucmsg>/gim;if(i.test(t)){var c=t.match(a);if(c.length>=2)for(var u=0;u<c.length;u++){var g=u;!function(t){setTimeout(function(){e(c[t])},10*t)}(g)}else e(t)}else{var l=/<common\s?id=\"(\d{1,})\">(.*)<\/common>/gim,m=/<common id="\d{1,}">(.*?)<\/common>/gim;if(l.test(t)){var c=t.match(m);if(c.length>=2)for(var u=0;u<c.length;u++){var g=u;!function(t){setTimeout(function(){n(c[t])},10*t)}(g)}else n(t)}else{var d=s.extractMessage(t);d.length&&(this.messageId=d[d.length-1].msg_id),r.fireEvent("comet_got",d)}}},pollError:function(){var t=this;return o&&console.log("pollError"+i()),t.errTryCnt>=t.errTryCntMax?(t.connState(0),t.fireEvent("comet_failed"),void(t._xhrPoll=null)):(t.errTryCnt++,t.commonAbort?(t.commonAbort=!1,t.fireEvent("comet_disconnected"),void(t._xhrPoll=null)):void t.doLongPoll())},doLongPoll:function(){o&&console.log("新建一个长轮询"+i());var e=this;try{e._xhrPoll=new t.net.ajax({url:"/comet_get?mid="+e.messageId+"&r="+Math.random()+"&_rtk="+top.XN.get_check_x+"&requestToken="+top.XN.get_check,onSuccess:function(t){e.pollBack(t)},onError:function(t){e.pollError(t)}})}catch(n){t.reportExpt("doLongPoll",n)}},connState:function(t){if(void 0!==t)return e.set("wimconn",t),!0;var n=e.get("wimconn");return null!=n&&"0"!=n},send:function(e,n,r){var s=this,c=(r?"/muc_chat":"/comet_broadcast")+"?_rtk="+top.XN.get_check_x+"&requestToken="+top.XN.get_check,u=arguments.callee;o&&console.log("%c"+e+"%c发送数据到URL"+c,"color:lime; background-color:#000","color:white;background-color:#fff"),new t.net.ajax({url:c,data:e,method:"post",onSuccess:function(){o&&console.log("发送成功",i());try{s.fireEvent("comet_send_succ"),n&&n(),a=0}catch(t){}},onError:function(c){return o&&console.log("发送失败",i()),4>a?(o&&console.log("403!!! send onError"+i()),setTimeout(function(){a++,u(e,n,r)},500),void t.reportExpt("cometSend",new Error("comet send error : status "+c.status),e)):(s.fireEvent("send_msg_faild",c),o&&console.log({r:c},"send onError"),void t.reportExpt("cometSend",new Error("comet send error : status "+c.status),e))}})}};var m=t.Comet;t.event.enableCustomEvent(t.Comet),t.CometMgr={id:0,CONN_CHECK_INTERV:2e3,CONN_INTERV_CYCLE:60,autoReconnect:!0,curCheckTime:0,aliveCycle:65,isLocalConn:!1,lastConnState:null,userLogout:!1,init:function(){this.bindEvent(),this.connMonit()},tryToConnect:function(){if(o&&console.log("tryToConnect"+i()),t.getLoginUin()){var e=(location.href,this);m.connState()||acquire("wimconn",function(){e.isLocalConn=!0,m.connect(),m._xhrPoll},function(){m.abort(),e.isLocalConn=!1})}},retryConnect:function(){this.isLocalConn=!1,m.disconnect(),this.tryToConnect()},reloadWebpager:function(){top.XN.user.id=t.cookie.get("id"),new top.XN.net.xmlhttp({url:"http://notify.renren.com/wpi/getuserinfo2.do",data:"uids="+top.XN.user.id,method:"get",onSuccess:function(t){var e=top.XN.json.parse(t.responseText);o&&console.log(e[top.XN.user.id],"reloadWebpager"),top.XN.user.name=e[top.XN.user.id].userName,top.XN.user.tinyPic=e[top.XN.user.id].tiny;var n=top.document;n.getElementById("bottombar").removeChild(n.getElementById("webpager")),top.webpager=null,window.webpager=null;var r=n.getElementById("imengine");r.src=r.src}})},connMonit:function(){o&&console.log("connMonit");var n=this,r=t.cookie.get("id");0==this.getConnState()?(this.offlineCheck>5&&this.fireEvent("check_online_status",0),this.offlineCheck++):null==r?(this.userLogout=!0,this.fireEvent("check_online_status",0)):(this.userLogout&&(this.reloadWebpager(),this.userLogout=!1),this.offlineCheck=0,this.fireEvent("check_online_status",1));try{if(m.isUnload){if(clearTimeout(this.connTimer),!t.browser.isIE)return;var i=new Date;if(!(i-m.isUnload>=6e3))return void(this.connTimer=setTimeout(function(){clearTimeout(n.connTimer),n.connMonit()},this.CONN_CHECK_INTERV));m.isUnload=0}var s=m.connState();this.curCheckTime++,this.lastConnState!=s?0==s?(this.tryToConnect(),this.fireEvent("cometmgr_disconnected")):this.fireEvent("cometmgr_connected"):(this.autoReconnect&&this.isLocalConn&&this.curCheckTime==this.CONN_INTERV_CYCLE&&(this.curCheckTime=0,this.retryConnect(),this.fireEvent("monit_cycle")),this.isAlive()?this.isLocalConn&&!this.isMyConn()&&(this.isLocalConn=!1,m.release()):(this.isLocalConn=!1,m.disconnect(),this.tryToConnect())),this.lastConnState=s}catch(a){t.reportExpt("connMonit",a,e.get("wimconn"))}this.connTimer=setTimeout(function(){clearTimeout(n.connTimer),n.connMonit()},this.CONN_CHECK_INTERV)},getConnState:function(){var t=m.connState();return t},bindEvent:function(){var e=this;m.addEvent("comet_connected",function(){for(e.isLocalConn&&(e.keepAlive(),e.autoReconnect=!0);t.Comet.sendQueue.length>0;){var n=t.Comet.sendQueue.shift();this.send(n.m_list,n.type,n.callback)}e.fireEvent("cometmgr_connected")}),m.addEvent("comet_release",function(){e.isLocalConn=!1}),m.addEvent("comet_connect_fail",function(){e.isLocalConn=!1}),m.addEvent("comet_got",function(t){e.fireEvent("comet_got",t)}),m.addEvent("group_handle",function(t){e.fireEvent("group_handle",t)}),m.addEvent("chat_handle",function(t){e.fireEvent("chat_handle",t)}),m.addEvent("comet_failed",function(){e.isLocalConn=!1,e.autoReconnect=!1,e.fireEvent("comet_disconnected")}),m.addEvent("comet_send_succ",function(){e.fireEvent("cometmgr_send_succ")}),m.addEvent("check_online_status",function(t){e.fireEvent("check_online_status",t)}),m.addEvent("send_msg_faild",function(t){e.fireEvent("send_msg_faild",t)});var n=function(){WPC.Comet.isUnload=new Date-0,e.isLocalConn&&m.disconnect()};window.onbeforeunload=n,window.onunload=n},send:function(e,n,r){var i=m.connState(),s=t.cookie.get("id");return i&&null!=s?"newProtocal"==n?void m.send(e,r,n):void m.send(this.buildMessage(e,n),r):(o&&console.log(t.Comet.sendQueue,"保存发送信息到队列"),void t.Comet.sendQueue.push({m_list:e,type:n,callback:r}))},buildMessage:function(e,n){assert(e.length>0);var r={fromserver:"@talk.renren.com"};switch(n){case"groupchat":r.toserver="@group.talk.renren.com",r.type="groupchat";break;default:r.toserver="@talk.renren.com",r.type="chat"}for(var o=["<sendlist>\n"],i=0;i<e.length;++i){var s=e[i];o.push('<message type="'+r.type+'" from="'),o.push(s.from+r.fromserver),o.push('"'),o.push(' to="'),o.push(s.to+r.toserver),o.push('">\n<body>'),o.push(t.xmlEncode(s.msg_content)),o.push("</body>\n"),o.push("<attachment>"+(s.attachment?s.attachment:"")),o.push("</attachment>\n"),s.icode&&(o.push("<code>"+(s.icode?s.icode:"")),o.push("</code>\n")),o.push("</message>\n")}return o.push("</sendlist>\n\x00"),o.join("")},keepAlive:function(){this.curCheckTime=0,this.id=(new Date).getTime(),e.set("wkl",this.id)},isAlive:function(){var t=e.get("wkl");return t=parseInt(t),tNow=(new Date).getTime(),isNaN(t)?!1:tNow-t<this.aliveCycle*this.CONN_CHECK_INTERV?!0:!1},isMyConn:function(){var t=e.get("wkl");return t=parseInt(t),t=this.id},connect:function(){this.isLocalConn=!0,m.connect()},disconnect:function(){m.disconnect()}},t.event.enableCustomEvent(t.CometMgr)}(WPC),function(t){function e(t,e){var n=/<richbody.*?\stype=["|'](.*?)["|']/,r=t.match(n),o="";null!=r&&2==r.length&&(o=r[1]);var i,s,a,c,u,g,l=/<img\s*headsrc=\"(.*?)\".*?originalsrc=\"(.*?)\".*?\/>/,m=/localid=\"(\d{1,})\"/,d=/<font.*?>([.\n\w\s\W\S]*)<\/font>/,f=/<voice.*?src="*(.*?)\.spx/,p=/<voice.*?playtime="*(.*?)\".*\/>/,h=/<emotion>(.*)<\/emotion>/,v=/<feed_to_talk(.*?)\/>/gim;switch(appmsg_reg=/<richbody.*type=\"appmsg\".*>.*<\/richbody>/gim,o){case"dialog":t.replace(d,function(t,e){return s=e,t}),t.replace(m,function(t,e){return i=e,t}),l.test(t)&&t.replace(l,function(t,e,n){return a=e,c=n,s="",t}),f.test(t)&&t.replace(f,function(n,r){u=r+".mp3";var o=e==top.XN.user.id?"发送一段语音！":"给你发来一段语音！";return s=o,t.replace(p,function(t,e){g=e}),n});break;case"feed_to_talk":t.replace(v,function(t){return s="&lt;"+t.substr(1,t.length-2)+"&gt;",t});break;case"bigemj":h.test(t)&&t.replace(h,function(t,e){return s=e,t});break;case"invitetogroup":var _,y;t.replace(/.*group_title=\"(.*?)\".*/gim,function(t,e){return _=e,t}),t.replace(/.*group_id=\"(.*?)\".*/gim,function(t,e){return y=e,t}),s="我是"+_+"新生群群主，邀请你加入我们。点击这里查看详细信息 http://lbsgroup.renren.com?gid="+y+" 期待你的加入~~";break;case"secret":s="这是一张私密照片";break;case"readsecret":s="阅读了私密照片";break;case"location":var b=t.match(/<poi.*address=[\"|'](\S*)[\"|']/);if(b&&(s=b[1]),b=t.match(/<poi.*mapurl=[\"|'](\S*)[\"|']/)){var E=b[1];s+='<img width="180" src="'+E+'"/>'}break;case"voip":s="我用新版人人客户端给你打了一个免费电话，下载新版人人客户端就有机会获得各种好礼，你也来加入吧！<a href='http://mobile.renren.com' target='_blank'>http://mobile.renren.com</a>";break;case"appmsg":var w,k,C,S,T=t,b=T.match(/<type>(\d*)<\/type>/);if(b&&(w=b[1]),"4"==w){T=T.substring(T.indexOf("<item>")+6,T.indexOf("</item>")),b=T.match(/<title>(.*)<\/title>/),b&&(k=b[1].replace("<![CDATA[","").replace("]]>","")),b=T.match(/<digest>(.*)<\/digest>/),b&&(description=b[1].replace("<![CDATA[","").replace("]]>","")),b=T.match(/<url>(.*)<\/url>/),b&&(C=b[1].replace("<![CDATA[","").replace("]]>","")),b=T.match(/<cover>(.*)<\/cover>/),b&&(S=b[1].replace("<![CDATA[","").replace("]]>",""));var x=k.length>10?k.substring(0,10)+"...":k;description=-1!=description.indexOf("恭喜你获得人人网页新版限量体验资格")?"童鞋，恭喜你获得人人网新版限量体验资格！全新界面设计，沟通更便捷！使用过程中有任何不爽请直接回复此消息，人人程序猿欢迎您的吐槽！":description;var I=description.length>20?description.substring(0,20)+"...":description,M=""==S?"display:none;":"",N=""==S?"width:auto;":"float:right;width:80px;",I=""!=S?I:description,A='<div class="dlg_f2t_title">'+x+'</div><div class="dlg_f2t_link" style="padding-top:10px;"><a style="'+N+'" title="'+description+'" href="'+C+'" target="_blank">'+I+'</a><a style="float:left;width:80px;height:80px;margin-right:5px;display:inline-block;'+M+'" title="'+k+'" href="'+C+'" target="_blank"><img width="100%" height="100%" src="'+S+'" title="'+k+'"></a></div>';s=-1!=k.indexOf("邀请好友")?'邀请身边好友注册人人，一起拿流量包，<a href="http://test1.touch.renren.com/superRegister/activity" target="_blank">查看更多</a>':-1!=k.indexOf("0M")?k+"，快登陆手机客户端，领取奖励吧":A
}else if("10"==w)s="网页版尚不支持此动态信息，可到<a href='http://mobile.renren.com' target='_blank'>mobile.renren.com</a>下载最新人人手机客户端查看";else{b=T.match(/<title>(.*)<\/title>/),b&&(title=b[1]),b=T.match(/<des>(.*)<\/des>/),b&&(description=b[1]),b=T.match(/<reslowurl>(.*)<\/reslowurl>/),b&&(S=b[1]),title=title.replace("<![CDATA[","").replace("]]>",""),description=description.replace("<![CDATA[","").replace("]]>",""),S=S.replace("<![CDATA[","").replace("]]>",""),b=T.match(/<appname>(.*)<\/appname>/),b&&(k=b[1].replace("<![CDATA[","").replace("]]>","")),b=T.match(/<appurl>(.*)<\/appurl>/),b&&(C=b[1].replace("<![CDATA[","").replace("]]>",""));var I=description.length>20?description.substring(0,20)+"...":description,x=title.length>10?title.substring(0,10)+"...":title,M=""==S?"display:none;":"",N=""==S?"width:auto;":"width:100px;",I=""!=S?I:description,A='<div class="dlg_f2t_title">'+x+'</div><div class="dlg_f2t_link" style="padding-top:10px;"><a style="float:left;'+M+'" href="'+C+'" target="_blank"><img width="50" height="50" src="'+S+'" title="'+title+'"></a><a style="float:left;padding-left:10px;" title="'+k+'" href="'+C+'" target="_blank">'+k+'</a><u style="float:left;'+N+'padding-left:10px;text-decoration:none;display:block;" title="'+description+'">'+I+"</u></div>";s=A}break;default:s="网页版尚不支持此动态信息，可到<a href='http://mobile.renren.com' target='_blank'>mobile.renren.com</a>下载最新人人手机客户端查看"}return{lid:i,content:s,headsrc:a,originalsrc:c,audiosrc:u,audiotime:g}}function n(t){if(t&&t.length>0)for(var n=0;n<t.length;n++){var r=t[n],o=e(r.richbody,r.from);"undefined"==typeof o.content&&(o.content="");var i={fromuin:r.from,fromname:r.fname,touin:r.to,msg_content:o.content.replace(/\n/gim,"</br>").replace(/\s{2}/gim,"　　")||r.msg_content||"",timestamp:r.time,last_msgkey:r.last_msgkey||"",msgkey:r.msgkey,attachment:"",msg_headsrc:o.headsrc||"",msg_originalsrc:o.originalsrc||"",msg_audiosrc:o.audiosrc||"",msg_audiotime:o.audiotime||"",localid:r.localid||o.lid||+new Date,chat_tag:r.chat_tag||""};t[n]=i}return t}function r(t){if(t&&t.length>0)for(var n=0;n<t.length;n++){var r=t[n],o=e(r.richbody,r.fromid);if("undefined"==typeof o.content)return;var i=o.content.replace(/\r\n/g,"<br/>").replace(/\n/g,"<br/>").replace(/\s{2}/gim,"　　").replace(/\\/gim,"\\\\").replace(/\"/gim,'\\"'),s={from:r.fromid,mfrom:r.fromid+"@talk.xiaonei.com/WTalkProxy6_0",fname:r.fname,roomid:r.groupid,mtype:"group",content:'{type:"groupchat",info:{roomid:'+r.groupid+",userid:"+r.fromid+'},chat:"'+i+'"}',timestamp:r.time,last_msgkey:r.last_msgkey||"",msgkey:r.msgkey,attachment:"",msg_headsrc:o.headsrc||"",msg_originalsrc:o.originalsrc||"",msg_audiosrc:o.audiosrc||"",msg_audiotime:o.audiotime||"",localid:r.localid||o.lid||+new Date,chat_tag:r.chat_tag||""};t[n]=s}return t}function o(t,e,n){var r=[];if(t&&t.length>0){if(e&&e.length>0){r=e.concat(t),r.sort(function(t,e){return+t.msgkey>+e.msgkey?1:+t.msgkey==+e.msgkey?0:+t.msgkey<+e.msgkey?-1:void 0});for(var o={},i=[],s=0;s<r.length;s++)o[r[s].msgkey]||(o[r[s].msgkey]=!0,i.push(r[s]));return r=i,r.length>n&&r.splice(0,r.length-n),r}return t}}function i(e,n){n="chat"==n?"m_u":"m_g";var r=s.getItemFrom(n+e,"webpager_msg"+t.getLoginUin()),o=r&&""!=r?t.json.parse(r):[];return o}var s=t.PersistMgr,a=t.CometMgr,c=t.cookie;t.MsgMgr={MSG_HISRY_COUNT:32,SEQ_EXPIRE_DAYS:3650,MSG_HISRY_GROUP_COUNT:5,MSG_HISRY_LIST_COUNT:20,msg_list:[],zone:{2:"webpager_msg",3:"webpager_notify"},init:function(){this.bindEvent()},bindEvent:function(){var e=this,n=t.CometMgr;n.addEvent("comet_got",function(n){for(var r=0,o="",i=n.length,s=0;i>s;s++){var a=n[s];if(a){var c,u=a.content;try{c=t.json.parse(u)}catch(g){c=null}if(!a.content||-1==a.content.indexOf('{"show":"hidden"'))if(a.touin&&c&&a.touin-0==c.from_id-0){r++;try{o+=t.PersistMgr.getNid(n[s])+","}catch(g){}}else switch(a.type){case"chat":e.addMsgHistory(a);break;case"notify2":e.fireEvent("realTime_got",a);break;case"groupchat":if(-1!=a.from.indexOf("-"+t.getLoginUin()))return;e.addGroupChat(a,i);break;case"spam":e.fireEvent("spam_got",a);break;default:e.addOtherMsg(a)}}}if(r)try{}catch(g){}}),n.addEvent("chat_handle",function(t){if("error"==t.type,"sr"==t.type)e.fireEvent("chat_sr",t);else if("sn"==t.type)e.fireEvent("chat_sn",t);else if("chat_self"==t.type)t.chat_tag="self",e.addMsgHistory(t),e.fireEvent("chat_message",t);else if("chat"==t.type){if(t.info)return void e.fireEvent("chat_error",t);e.fireEvent("chat_message",t),e.addMsgHistory(t)}else!t.xmlns||0!=t.blockvalue&&1!=t.blockvalue?t.xmlns&&t.id?e.fireEvent("setStrangeInfo",t):t.from&&t.info&&(e.fireEvent("superGroupTxt",t),t.inviterid&&"http://muc.talk.renren.com/user"==t.xmlns&&(t.type=1,e.fireEvent("group_inviteuser",t))):e.fireEvent("getStrangeInfo",t)}),n.addEvent("group_handle",function(t){if("error"==t.type){var n=t.error.description;return n&&top.XN.DO.showMessage(n),void e.fireEvent("group_error",t)}var r="http://muc.talk.renren.com/";t.xmlns==r+"create"?e.fireEvent("group_open",t):t.xmlns==r+"createitem"?e.fireEvent("group_createitem",t):t.xmlns==r+"items"?e.fireEvent("group_item",t):t.xmlns==r+"grouplist"?e.fireEvent("group_list",t):t.xmlns==r+"group"?e.fireEvent("group_name",t):t.xmlns==r+"config"?e.fireEvent("group_config",t):t.xmlns==r+"inviteitem"?e.fireEvent("group_inviteitem",t):t.xmlns==r+"invite"?e.fireEvent("group_invite",t):t.xmlns==r+"quit"?e.fireEvent("group_quit",t):t.xmlns==r+"quititem"?e.fireEvent("group_quititem",t):t.inviterid&&t.xmlns==r+"user"?e.fireEvent("group_inviteuser",t):"sr"==t.type?e.fireEvent("group_sr",t):"info"==t.type?e.fireEvent("group_info",t):"result"==t.type&&t.grouptype?e.fireEvent("get_group_type",t):t.xmlns==r+"message"&&("muc_self"==t.type&&(t.chat_tag="self"),e.addGroupMsgHistory(t),e.fireEvent("group_message",t))}),e.addEvent("chat_sr",function(t){if(!+t.msgkey)return void e.fireEvent("chat_error",t);if(!/^0\d{1,}/.test(t.local_id)){var n={from:top.XN.user.id,fname:top.XN.user.name,to:t.to,msgkey:t.msgkey,richbody:t.richbody,time:t.time,chat_tag:"self"};e.addMsgHistory(n)}}),e.addEvent("group_sr",function(t){if(!+t.msgkey)return void e.fireEvent("chat_error",t);var n={fromid:top.XN.user.id,fname:top.XN.user.name,groupid:t.to,msgkey:t.msgkey,richbody:t.richbody,time:+new Date,chat_tag:"self"};e.addGroupMsgHistory(n)}),n.addEvent("cometmgr_send_succ",function(){e.msg_list.length=0}),s.addEvent("storage",function(t){for(var n,r,o,i=t.keys.split(","),a=0;a<i.length;a++)if(n=i[a],r=n.split("."),o=r[0],n=r[1],"webpager_msgs"==o){var c,u=s.getItemFrom(n,"webpager_msgs");if(c=e.getMsgType(u),"group"==c)e.fireEvent("groupmsg_got",e.strToGroupChat(s.getItemFrom(n,o)));else if("notify2"==c);else if("chat"==c){var g=s.getItemFrom(n,o),l=e.strToMsg(g);e.fireEvent("message_got",l)}else e.fireEvent("other_got",e.str2other(s.getItemFrom(n,o)))}})},getMsgType:function(t){var e=t.split("\n");return e[0]},getMsgSeq:function(t){var e=parseInt(c.get(t||"wimmseq"));return isNaN(e)?-1:e>=0?e:0},setMsgSeq:function(t,e){c.set(e||"wimmseq",t,this.SEQ_EXPIRE_DAYS)},send:function(t,e,n){if("newProtocal"==e)return void a.send(t,e,n);var r={from:t.fromuin,fname:t.fromname,to:t.touin,msg_content:t.msg_content,attachment:t.attachment,icode:t.icode};a.send([r],e,n)},loadMsgHistory:function(e){var n,r=e.charAt(0),o=e.substr(1),i=this.MSG_HISRY_COUNT,a=[],c=t.getLoginUin();if("g"==r)for(var u=0;i>u;u++)n=s.getItemFrom("m"+u,"webpager_msg"),n&&(n=this.strToGroupChat(n),n.timestamp||(n.timestamp=(new Date).getTime()),n.roomid==o&&a.push(n));else for(var u=0;i>u;u++)n=s.getItemFrom("m"+u,"webpager_msg"),n&&(n=this.strToMsg(n),n.timestamp||(n.timestamp=(new Date).getTime()),(n.fromuin==o&&n.touin==c||n.fromuin==c&&n.touin==o)&&a.push(n));return a.length&&a.sort(function(t,e){var n=parseInt(t.timestamp),r=parseInt(e.timestamp);return r>n?1:n>r?-1:0}),a},msgToStr:function(t){return"chat\n"+t.fromuin+"\n"+t.fromname+"\n"+t.touin+"\n"+t.msg_content+"\n"+t.timestamp+"\n"+(t.attachment?t.attachment:"")+"\n"+t.last_msgkey+"\n"+t.msgkey+"\n"+t.msg_headsrc+"\n"+t.msg_originalsrc+"\n"+t.msg_audiosrc+"\n"+t.msg_audiotime+"\n"+t.localid+"\n"+t.chat_tag},strToMsg:function(t){var e={};if(!t)return e;var n=t.split("\n");return n?(e.fromuin=n[1],e.fromname=n[2],e.touin=n[3],e.msg_content=n[4],e.timestamp=n[5],e.attachment=n[6]?n[6]:"",e.last_msgkey=n[7]?n[7]:"",e.msgkey=n[8]?n[8]:"",e.msg_headsrc=n[9]?n[9]:"",e.msg_originalsrc=n[10]?n[10]:"",e.msg_audiosrc=n[11]?n[11]:"",e.msg_audiotime=n[12]?n[12]:"",e.localid=n[13]?n[13]:"",e.chat_tag=n[14]?n[14]:"",e):e},addMsgHistory:function(e){var r=this;try{var o=n(new Array(e))[0],i=e.from==t.getLoginUin()?e.to:e.from,a=s.getItemFrom("m_u"+i,"webpager_msg"+t.getLoginUin()),c=a&&""!=a?t.json.parse(a):[];if(c&&c.length>0){var u=c[c.length-1];if(u.msgkey<e.last_msgkey){r.fireEvent("chat_msg_losted",{id:i,msgid:u.msgkey});var g=['<iq id="',i,'" type="get">\n','<query xmlns="http://chat.talk.renren.com/latestmsgs">\n','<item id="',i,'" lmax_msgid="0" count="10"/>\n',"</query>\n","</iq>\n\x00"].join("");return void r.send(g,"newProtocal")}if(u.msgkey==e.msgkey)return;if(u.last_msgkey>=e.msgkey)return;r.addMsgListHistory(new Array(e),i)}var l=this.msgToStr(o),m=t.seqq.getNextSeq();s.setItemTo(m,l,"webpager_msgs");var d=this.getMsgSeq()+1;s.setItemTo("m"+d%this.MSG_HISRY_COUNT,l,"webpager_msg",!0),this.setMsgSeq(d)}catch(f){}},addMsgListHistory:function(e,r){var a=this,c=i(r,"chat"),u=o(n(e),c,a.MSG_HISRY_LIST_COUNT),g=s.getItemFrom("ms","webpager_msg"+t.getLoginUin());g=g&&""!=g?t.json.parse(g):[];for(var l=0;l<g.length;l++)if(g[l]=="m_u"+r){g.splice(l,1);break}if(g.length>a.MSG_HISRY_GROUP_COUNT){var m=g.shift();s.removeItem(m,"webpager_msg"+t.getLoginUin())}g.push("m_u"+r),s.setItemTo("ms",t.json.stringify(g),"webpager_msg"+t.getLoginUin()),s.setItemTo("m_u"+r,t.json.stringify(u),"webpager_msg"+t.getLoginUin())},addGroupMsgHistory:function(e){var n=this;try{var o=r(new Array(e))[0],i=o.roomid,a=s.getItemFrom("m_g"+i,"webpager_msg"+t.getLoginUin()),c=a&&""!=a?t.json.parse(a):[];if(c&&c.length>0){var u=c[c.length-1];if(u.msgkey<o.last_msgkey){n.fireEvent("group_msg_losted",{id:i,msgid:u.msgkey});var g=['<iq id="',i,'" type="get">\n','<query xmlns="http://muc.talk.renren.com/latestmsgs">\n','<item id="',i,'" lmax_msgid="0" count="10"/>\n',"</query>\n","</iq>\n\x00"].join("");return void n.send(g,"newProtocal")}if(u.msgkey==e.msgkey)return;if(u.last_msgkey>=e.msgkey)return;n.addGroupMsgListHistory(new Array(e),i)}var l=this.groupChatToStr(o),m=t.seqq.getNextSeq();s.setItemTo(m,l,"webpager_msgs");var d=this.getMsgSeq()+1;s.setItemTo("m"+d%this.MSG_HISRY_COUNT,l,"webpager_msg",!0),this.setMsgSeq(d)}catch(f){}},addGroupMsgListHistory:function(e,n){var a=this,c=i(n,"group"),u=o(r(e),c,a.MSG_HISRY_LIST_COUNT),g=s.getItemFrom("ms","webpager_msg"+t.getLoginUin());g=g&&""!=g?t.json.parse(g):[];for(var l=0;l<g.length;l++)if(g[l]=="m_g"+n){g.splice(l,1);break}if(g.length>a.MSG_HISRY_GROUP_COUNT){var m=g.shift();s.removeItem(m,"webpager_msg"+t.getLoginUin())}g.push("m_g"+n),s.setItemTo("ms",t.json.stringify(g),"webpager_msg"+t.getLoginUin()),s.setItemTo("m_g"+n,t.json.stringify(u),"webpager_msg"+t.getLoginUin())},addNotifyHistory:function(){},strToRealTime:function(t){var e={};if(!t)return e;var n=t.split("\n");return n?(e.type=n[0],e.touin=n[1],e.msg_id=n[2],e.content=n[3],e):e},realTimeToStr:function(t){return t.type+"\n"+t.touin+"\n"+t.msg_id+"\n"+t.content},groupChatToStr:function(t){return"group\n"+t.from+"\n"+t.msgkey+"\n"+t.content+"\n"+(t.attachment?t.attachment:"")+"\n"+t.roomid+"\n"+t.timestamp+"\n"+t.msg_headsrc+"\n"+t.msg_originalsrc+"\n"+t.msg_audiosrc+"\n"+t.msg_audiotime+"\n"+t.localid+"\n"+t.fname+"\n"+t.chat_tag},strToGroupChat:function(t){var e={};if(!t)return e;var n=t.split("\n");return n?(e.mtype=n[0],e.mfrom=n[1],e.msgkey=n[2],e.content=n[3],e.attachment=n[4],e.roomid=n[5],e.timestamp=n[6],e.msg_headsrc=n[7]?n[7]:"",e.msg_originalsrc=n[8]?n[8]:"",e.msg_audiosrc=n[9]?n[9]:"",e.msg_audiotime=n[10]?n[10]:"",e.localid=n[11]?n[11]:+new Date,e.fname=n[12]?n[12]:"",e.chat_tag=n[13]?n[13]:"",e):e},str2other:function(t){var e={};if(!t)return e;var n=t.split("\n");return n?(e.mtype=n[0],e.from=n[1],e.touin=n[2],e.msg_id=n[3],e.content=n[4],e):e},other2str:function(t){return t.type+"\n"+t.from+"\n"+t.to+"\n"+t.msg_id+"\n"+t.content},addOtherMsg:function(e){var n=this.other2str(e),r=t.seqq.getNextSeq();s.setItemTo(r,n,"webpager_msgs")},addRealTime:function(e){var n=this.realTimeToStr(e),r=t.seqq.getNextSeq();s.setItemTo(r,n,"webpager_msgs")},addGroupChat:function(e){var n=this.groupChatToStr(e),r=t.seqq.getNextSeq();s.setItemTo(r,n,"webpager_msgs");var o=this.getMsgSeq()+1;s.setItemTo("m"+o%this.MSG_HISRY_COUNT,n,"webpager_msg",!0),this.setMsgSeq(o)}},t.event.enableCustomEvent(t.MsgMgr)}(WPC),function(t){{var e=t.CometMgr,n=(t.Sound,t.Profile),r=t.MsgMgr,o=t.PersistMgr;t.cookie}t.PagerChannel={init:function(){this.bindEvent()},bindEvent:function(){var t=this;r.addEvent("message_got",function(e){var n=parseInt(e.fromuin);n>=630000001&&639999999>=n?t.fireEvent("message_got",e):t.fireEvent("message_got",e)}),r.addEvent("group_open",function(e){t.fireEvent("group_open",e)}),r.addEvent("group_createitem",function(e){t.fireEvent("group_createitem",e)}),r.addEvent("group_item",function(e){t.fireEvent("group_item",e)}),r.addEvent("group_list",function(e){t.fireEvent("group_list",e)}),r.addEvent("group_name",function(e){t.fireEvent("group_name",e)}),r.addEvent("group_config",function(e){t.fireEvent("group_config",e)}),r.addEvent("group_invite",function(e){t.fireEvent("group_invite",e)}),r.addEvent("group_inviteitem",function(e){t.fireEvent("group_inviteitem",e)}),r.addEvent("group_quit",function(e){t.fireEvent("group_quit",e)}),r.addEvent("group_quititem",function(e){t.fireEvent("group_quititem",e)}),r.addEvent("group_message",function(e){t.fireEvent("group_message",e)}),r.addEvent("group_sr",function(e){t.fireEvent("group_sr",e)}),r.addEvent("group_error",function(e){t.fireEvent("group_error",e)}),r.addEvent("group_inviteuser",function(e){t.fireEvent("group_inviteuser",e)}),r.addEvent("chat_message",function(e){t.fireEvent("chat_message",e)}),r.addEvent("group_latestmsgs",function(e){t.fireEvent("group_latestmsgs",e)}),r.addEvent("group_msg_losted",function(e){t.fireEvent("group_msg_losted",e)}),r.addEvent("group_info",function(e){t.fireEvent("group_info",e)}),r.addEvent("chat_sr",function(e){t.fireEvent("chat_sr",e)}),r.addEvent("chat_sn",function(e){t.fireEvent("chat_sn",e)}),r.addEvent("chat_self",function(e){t.fireEvent("chat_self",e)}),r.addEvent("chat_error",function(e){t.fireEvent("chat_error",e)}),r.addEvent("chat_msg_losted",function(e){t.fireEvent("chat_msg_losted",e)}),r.addEvent("getStrangeInfo",function(e){t.fireEvent("getStrangeInfo",e)}),r.addEvent("setStrangeInfo",function(e){t.fireEvent("setStrangeInfo",e)}),r.addEvent("superGroupTxt",function(e){t.fireEvent("superGroupTxt",e)}),r.addEvent("get_group_type",function(e){t.fireEvent("get_group_type",e)}),r.addEvent("realTime_got",function(e){e.timestamp=(new Date).getTime(),e.type=56,t.fireEvent("realTime_got",e)}),r.addEvent("groupmsg_got",function(e){t.fireEvent("groupmsg_got",e)}),r.addEvent("other_got",function(e){t.fireEvent("other_got",e)}),r.addEvent("spam_got",function(e){t.fireEvent("spam_got",e)}),e.addEvent("cometmgr_connected",function(){try{top.$msg_proxy&&top.$msg_proxy.onConnected()}catch(t){}}),e.addEvent("cometmgr_disconnected",function(){try{top.$msg_proxy&&top.$msg_proxy.onDisconnected(),t.fireEvent("channel_disconnected")}catch(e){}}),o.addEvent("storage",function(e){t.fireEvent("storage",e)}),e.addEvent("check_online_status",function(e){t.fireEvent("check_online_status",e)}),e.addEvent("send_msg_faild",function(e){t.fireEvent("send_msg_faild",e)})},checkPlugin:function(t,e){var n=window.navigator.plugins;if(n&&!window.ActiveXObject){for(var r=n.length,o=0;r>o;o++)if(n[o].name.indexOf(t)>=0)return!0;return!1}try{var i=new ActiveXObject(e);if(i)return!0}catch(s){return!1}throw new Error(" 暂时不支持的浏览器 ")},startIM:function(){var e,n=-1!=document.domain.indexOf("renren.com"),r=top.XN.cookie.get,o=!1;if(!(r("id")&&r("t")&&r("xnsid")&&n))return void top.webpager.fireEvent("im_start_over",o);try{if(this.checkPlugin("npxntalk","renren.Renren.1"))if(top.webpager.IMInstalled=!0,window.ActiveXObject){e=new ActiveXObject("renren.Renren.1");var o=e.IfNeedStart("xntalk");1==o&&(o=0==e.StartUp("xntalk")?t.startXnclient():!0)}else e=document.createElement("embed"),e.type="application/xntalk-plugin",document.body.appendChild(e),o=!!e.IfNeedStart("xntalk"),o&&(o=e.StartUp("xntalk"));else o=t.startXnclient()}catch(i){o=t.startXnclient()}top.webpager.fireEvent("im_start_over",o)},sendMessage:function(t,e,n){r.send(t,e,n)},getMessageHistory:function(t){var e=r.loadMsgHistory(t);return e},enableConn:function(t){t?n.setUseIm(!0,!0):n.setUseIm(!1,!0)},isLocalConnect:function(){return e.isLocalConn},showRealTime:function(e){r.addRealTime({content:e,type:"notify2",touin:t.getLoginUin(),msg_id:r.messageId})},setItem:function(e,n,r,i){setTimeout(function(){return o.setItemTo(e,n,"webpager_common"+(r?"":t.getLoginUin()),i)},0)},getItem:function(e,n){return o.getItemFrom(e,"webpager_common"+(n?"":t.getLoginUin()))},showGroupChat:function(){},getConnState:function(){return e.getConnState()},setPlaySound:function(t){return n.setPlaySound(t,!0)},getShowPager:function(){return!0},notificationRequest:function(t){window.webkitNotifications.requestPermission(function(){var e=window.webkitNotifications.checkPermission();t(e)})},notificationShow:function(t){if(!window.webkitNotifications.checkPermission()){var e;e=window.webkitNotifications.createNotification(t.head,t.name,t.content),e.show(),e.onclick=function(){top.focus(),this.cancel();try{t.callback()}catch(e){}},setTimeout(function(){e.cancel()},8e3)}},notificationPermission:function(){return window.webkitNotifications.checkPermission()}},t.event.enableCustomEvent(t.PagerChannel),document.domain="renren.com",top.webpager=WPC.PagerChannel}(WPC),function(t){function e(e,n){var r=top.document.createElement("link");r.href=e,r.rel="stylesheet",top.document.head.appendChild(r);var o=top.document.createElement("div");o.id="webpager_css_loading";var i=function(t){return o.currentStyle?o.currentStyle[t]:o.ownerDocument.defaultView.getComputedStyle(o,null)[t]};top.document.body.appendChild(o);var s,a=new Date;!function(){var e=arguments.callee;"none"===i("display")?(clearTimeout(s),top.document.body.removeChild(o),n()):new Date-a<5e3?s=setTimeout(e,100):t.reportExpt("loadCSS",new Error("loadCSS timeout 5s"),"样式可能没加载成功")}()}function n(t,n){function r(){if(!(o>=1))try{o=1,setTimeout(function(){t.use("webpager/im",function(){o=2})},500)}catch(e){throw o=-1,e}}if(!n.disableWebpager){var o=0,i="http://s.xnimg.cn/"+cssVer+"/webpager/webpager-all-min.css";try{e(i,r)}catch(s){throw s}setTimeout(r,5e3);for(var a,c=document.head.getElementsByTagName("script");c.length;)a=top.document.createElement("script"),a.setAttribute("data-src",c[0].getAttribute("data-src")),a.setAttribute("data-module",c[0].getAttribute("data-module")),top.document.head.appendChild(a),document.body.appendChild(c[0])}}top.document.head||(top.document.head=top.document.getElementsByTagName("head")[0],document.head=document.getElementsByTagName("head")[0]),top.webpager&&top.webpager.addEvent("im_start_over",function(e){top.webpager.imRunning=e,top.webpager.storageOk=t.PersistMgr.init(),t.CometMgr.init(),t.MsgMgr.init(),t.PagerChannel.init(),top.webpagerLoader&&top.webpagerLoader.fireEvent("channel_ok",uiVer),top&&top.XN&&n(top.object,top.XN)});var r,o="vid",i=t.cookie,s=i.get("id"),a=i.get(o);if(a&&a==s);else{try{r=top.XN.user.ruid}catch(c){}s&&r&&r!=s?(a=s,i.set(o,a)):a=null}if(!(a&&parseInt(a)>2e9))return top.document.getElementById("webpager")?void t.reportExpt("channel_iframe_reload",new Error("莫名其妙的重载了ime.htm"),navigator.userAgent):void top.webpager.startIM();try{var u=top.XN.smartyBuddy;u.frameLayout()&&(u.frameLayout(0),u.noLoading(),u.saveStat(0))}catch(c){}}(WPC);var _comet_conn_state=0;!function(){var t=WPC.Comet.connState();return WPC.CometMgr.isAlive()||setTimeout(function(){WPC.CometMgr.isAlive()||WPC.reportExpt("cometAlive",new Error("not alive but no one retry!"),navigator.userAgent)},3e4),_comet_conn_state||t?(_comet_conn_state=t,void setTimeout(arguments.callee,18e4)):void WPC.reportExpt("cometState",new Error("超过三分钟没有人连接"),navigator.userAgent)}();